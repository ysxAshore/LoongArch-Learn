# C7 äº”çº§æµæ°´MC CPUçš„AXIæ€»çº¿æ¥å£

## ç›®å½•

-   [1 AMBA AXIæ€»çº¿æ¥å£åŸºæœ¬ä»‹ç»](#1-AMBA-AXIæ€»çº¿æ¥å£åŸºæœ¬ä»‹ç»)
-   [2 AXIæ€»çº¿æ¥å£å®ç°](#2-AXIæ€»çº¿æ¥å£å®ç°)
    -   [2.1 ç±»SRAMæ€»çº¿](#21-ç±»SRAMæ€»çº¿)
        -   [2.1.1 ç±»SRAMæ€»çº¿æ¥å£ç›¸å…³](#211-ç±»SRAMæ€»çº¿æ¥å£ç›¸å…³)
            -   [2.1.1.1 ä¸»æ–¹å’Œä»æ–¹](#2111-ä¸»æ–¹å’Œä»æ–¹)
            -   [2.1.1.2 ç±»SRAMæ€»çº¿æ¥å£ä¿¡å·å®šä¹‰](#2112-ç±»SRAMæ€»çº¿æ¥å£ä¿¡å·å®šä¹‰)
            -   [2.1.1.3 ç±»SRAMæ€»çº¿çš„è¯»å†™æ—¶åº](#2113-ç±»SRAMæ€»çº¿çš„è¯»å†™æ—¶åº)
            -   [2.1.1.4 ç±»SRAMæ€»çº¿çš„çº¦æŸ](#2114-ç±»SRAMæ€»çº¿çš„çº¦æŸ)
        -   [2.1.2 ç±»SRAMæ€»çº¿æ¥å£è®¾è®¡](#212-ç±»SRAMæ€»çº¿æ¥å£è®¾è®¡)
            -   [2.1.2.1 ç±»SRAMæ€»çº¿æ¥å£](#2121-ç±»SRAMæ€»çº¿æ¥å£)
            -   [2.1.2.2 å–æŒ‡è®¾è®¡](#2122-å–æŒ‡è®¾è®¡)
            -   [2.1.2.3 è®¿å­˜è®¾è®¡](#2123-è®¿å­˜è®¾è®¡)
        -   [2.1.3 ç±»SRAM-AXIè½¬æ¢æ¡¥](#213-ç±»SRAM-AXIè½¬æ¢æ¡¥)
            -   [2.1.3.1 è½¬æ¢æ¡¥å®ç°](#2131-è½¬æ¢æ¡¥å®ç°)

# 1 AMBA AXIæ€»çº¿æ¥å£åŸºæœ¬ä»‹ç»

1.  AXIå³Advanced Extensible Interface
2.  AXIçš„åœ°å€/æ§åˆ¶å’Œæ•°æ®æ€»çº¿åˆ†ç¦»ï¼Œè¯»å†™é€šé“ä¹Ÿæ˜¯åˆ†ç¦»çš„ï¼Œæ”¯æŒä¹±åºè®¿é—®ï¼Œæ”¯æŒä¸å¯¹é½çš„æ•°æ®ä¼ è¾“ï¼ŒåŒæ—¶åœ¨çªå‘ä¼ è¾“[^æ³¨é‡Š1]ä¸­åªéœ€è¦å‘é€é¦–åœ°å€æ¥æé«˜æ•°æ®ä¼ è¾“ç‡
3.  AXIæ€»çº¿ä¸»è®¾å¤‡çš„ä¸»è¦ä¿¡å·å®šä¹‰å¦‚ä¸‹è¡¨æ‰€ç¤ºâ€”â€”å°†AXIæ€»çº¿åˆ†æˆç‹¬ç«‹çš„5ä¸ªé€šé“ï¼šå†™è¯·æ±‚ã€å†™æ•°æ®ã€å†™å“åº”ã€è¯»è¯·æ±‚ã€è¯»å“åº”ã€‚æ¯ä¸ªé€šé“å‡é‡‡ç”¨æ¡æ‰‹åè®®ç‹¬ç«‹ä¼ è¾“ã€‚å…¶ä¸­ä¸‹åˆ’çº¿çš„æ˜¯å¿…é¡»è¦æŒæ¡çš„
    | é€šé“åç§°             | å¼•è„šåç§°          | æ–¹å‘   | æè¿°                  | è®¾è®¡å»ºè®®                                                    |
    | ---------------- | ------------- | ---- | ------------------- | ------------------------------------------------------- |
    |                  | ACLK          | è¾“å…¥   | AXIæ—¶é’Ÿä¿¡å·             |                                                         |
    |                  | ARESETN       | è¾“å…¥   | AXIå¤ä½ä¿¡å·ï¼Œä½ç”µå¹³æœ‰æ•ˆ       |                                                         |
    | å†™è¯·æ±‚é€šé“/&#xA;å†™åœ°å€é€šé“ | AWID\[3:0]    | è¾“å‡º   | å†™è¯·æ±‚æ ‡è¯†å·              | å›ºå®šä¸º1                                                    |
    |                  | AWADDR\[31:0] | è¾“å‡º   | å†™è¯·æ±‚åœ°å€               |                                                         |
    |                  | AWSIZE\[2:0]  | è¾“å‡º   | å†™è¯·æ±‚æ•°æ®å®½åº¦â€”â€”æ¯èŠ‚æ‹ä¼ è¾“æ•°æ®å­—èŠ‚æ•° |                                                         |
    |                  | AWLEN\[7:0]   | è¾“å‡º   | å†™è¯·æ±‚æ•°æ®é•¿åº¦â€”â€”ä¼ è¾“æ•°æ®èŠ‚æ‹æ•°    | å›ºå®šä¸º0                                                    |
    |                  | AWBURST\[1:0] | è¾“å‡º   | å†™è¯·æ±‚ç±»å‹               | å›ºå®šä¸º2â€™b01                                                |
    |                  | AWLOCK\[1:0]  | è¾“å‡º   | å†™è¯·æ±‚åŸå­é”              | å›ºå®šä¸º0                                                    |
    |                  | AWCACHE\[3:0] | è¾“å‡º   | å†™è¯·æ±‚Cacheå±æ€§          | å›ºå®šä¸º0                                                    |
    |                  | AWPROT\[2:0]  | è¾“å‡º   | å†™è¯·æ±‚ä¿æŠ¤å±æ€§             | å›ºå®šä¸º0                                                    |
    |                  | AWVALID       | è¾“å‡º   | å†™è¯·æ±‚åœ°å€æœ‰æ•ˆä¿¡å·           |                                                         |
    |                  | AWREADY       | è¾“å…¥   | ä»è®¾å¤‡å†™è¯·æ±‚æ¥æ”¶å‡†å¤‡å¥½ä¿¡å·       |                                                         |
    | å†™æ•°æ®é€šé“            | WID\[3:0]     | è¾“å‡º   | å†™æ•°æ®æ ‡è¯†å·,ä¸å†™è¯·æ±‚æ ‡è¯†å·å¯¹åº”    | å›ºå®šä¸º1                                                    |
    |                  | WDATA\[31:0]  | è¾“å‡º   | å†™æ•°æ®                 |                                                         |
    |                  | WSTRB\[3:0]   | è¾“å‡º   | å†™æ•°æ®å­—èŠ‚é€‰é€šä¿¡å·ï¼Œ1ä½å¯¹åº”8ä¸ªæ•°æ®ä½ |                                                         |
    |                  | WLAST         | è¾“å‡º   | å†™è¯·æ±‚æœ€åä¸€æ‹æ•°æ®çš„æŒ‡ç¤ºä¿¡å·      | å›ºå®šä¸º1                                                    |
    |                  | WVALID        | è¾“å‡º   | å†™æ•°æ®æœ‰æ•ˆä¿¡å·             |                                                         |
    |                  | WREADY        | è¾“å…¥   | ä»è®¾å¤‡å†™æ•°æ®æ¥æ”¶å‡†å¤‡å¥½ä¿¡å·       |                                                         |
    | å†™å“åº”é€šé“            | BID\[3:0]     | è¾“å…¥   | å†™å“åº”æ ‡è¯†å·ï¼Œä¸å†™è¯·æ±‚æ ‡è¯†å·å¯¹åº”    | å¯å¿½ç•¥                                                     |
    |                  | BRESP\[1:0]   | è¾“å…¥   | å†™å“åº”çŠ¶æ€ï¼Œæœ¬æ¬¡å†™è¯·æ±‚æ˜¯å¦æˆåŠŸå®Œæˆ   | å¯å¿½ç•¥                                                     |
    |                  | BVALID        | è¾“å…¥   | å†™å“åº”æœ‰æ•ˆä¿¡å·             |                                                         |
    |                  | BREADY        | è¾“å‡º   | å†™å“åº”æ¥æ”¶å‡†å¤‡å¥½ä¿¡å·          |                                                         |
    | è¯»è¯·æ±‚é€šé“/&#xA;è¯»åœ°å€é€šé“ | ARID\[3:0]    | è¾“å‡º   | è¯»è¯·æ±‚æ ‡è¯†å·              | å–æŒ‡è®¾ä¸º0ï¼Œå–æ•°è®¾ä¸º1                                             |
    |                  | ARADDR\[31:0] | è¾“å‡º   | è¯»è¯·æ±‚åœ°å€               |                                                         |
    |                  | ARSIZE\[2:0]  | è¾“å‡º   | è¯»è¯·æ±‚æ•°æ®å®½åº¦â€”â€”æ•°æ®ä¼ è¾“æ¯æ‹å­—èŠ‚æ•°  |                                                         |
    |                  | ARLEN\[7:0]   | è¾“å‡º   | è¯»è¯·æ±‚ä¼ è¾“çš„é•¿åº¦â€”â€”æ•°æ®ä¼ è¾“æ‹æ•°    | å›ºå®šä¸º0&#xA;å› ä¸ºè¿˜æ²¡æœ‰Cacheï¼Œæ‰€æœ‰çš„è¯»è¯·æ±‚éƒ½åªéœ€è¦ä¸€æ¬¡æ€»çº¿ä¼ è¾“å°±èƒ½å®Œæˆï¼Œç›¸åº”çš„ arlen å°±ä¸º 0 |
    |                  | ARBURST\[1:0] | è¾“å‡º   | è¯»è¯·æ±‚ç±»å‹               | å›ºå®šä¸º2'b01                                                |
    |                  | ARLOCK\[1:0]  | è¾“å‡º   | è¯»è¯·æ±‚åŸå­é”              | å›ºå®šä¸º0                                                    |
    |                  | ARPROT        | è¾“å‡º   | è¯»è¯·æ±‚ä¿æŠ¤å±æ€§             | å›ºå®šä¸º0                                                    |
    |                  | ARCACHE\[3:0] | è¯´è¿‡ä¸€æ¬¡ | è¯»è¯·æ±‚Cacheå±æ€§          | å›ºå®šä¸º0                                                    |
    |                  | ARVALID       | è¾“å‡º   | è¯»è¯·æ±‚æœ‰æ•ˆä¿¡å·             |                                                         |
    |                  | ARREADY       | è¾“å…¥   | è¯»è¯·æ±‚æ¥æ”¶å‡†å¤‡å¥½ä¿¡å·          |                                                         |
    | è¯»å“åº”é€šé“            | RID\[3:0]     | è¾“å…¥   | è¯»æ•°æ®æ ‡è¯†å·ï¼Œä¸è¯»è¯·æ±‚æ ‡è¯†å·å¯¹åº”    | å–æŒ‡æ˜¯0ï¼›å–æ•°æ˜¯1                                               |
    |                  | RDATA\[31:0]  | è¾“å…¥   | è¯»æ•°æ®                 |                                                         |
    |                  | RRESP\[1:0]   | è¾“å…¥   | è¯»å“åº”çŠ¶æ€ï¼Œæœ¬æ¬¡è¯»è¯·æ±‚æ˜¯å¦æˆåŠŸå®Œæˆ   | å¯å¿½ç•¥                                                     |
    |                  | RLAST         | è¾“å…¥   | è¯»è¯·æ±‚æœ€åä¸€æ‹æ•°æ®çš„æŒ‡ç¤ºä¿¡å·      | å¯å¿½ç•¥                                                     |
    |                  | RVALID        | è¾“å…¥   | è¯»æ•°æ®æœ‰æ•ˆä¿¡å·             |                                                         |
    |                  | RREADY        | è¾“å‡º   | è¯»æ•°æ®æ¥æ”¶å‡†å¤‡å¥½ä¿¡å·          |                                                         |
4.  AXIåè®®ç‰¹ç‚¹
    1.  å•å‘é€šé“ä½“ç³»ç»“æ„

        å•å·¥ï¼Œä¿¡å·è¦ä¹ˆç¡®å®šæ˜¯è¾“å…¥è¦ä¹ˆç¡®å®šæ˜¯è¾“å‡ºï¼Œåªä»¥å•æ–¹å‘ä¼ è¾“
    2.  æ”¯æŒå¤šé¡¹æ•°æ®äº¤æ¢

        AXIåè®®æ”¯æŒçš„æ•°æ®å®½åº¦å¾ˆå®½ï¼Œæœ€å¤§æ”¯æŒåˆ°1024ä½

        å¯ä»¥å¹¶è¡Œæ‰§è¡Œçªå‘æ“ä½œï¼Œæå¤§æé«˜æ•°æ®ååèƒ½åŠ›
    3.  ç‹¬ç«‹çš„åœ°å€/æ§åˆ¶å’Œæ•°æ®é€šé“

        åœ°å€/æ§åˆ¶å’Œæ•°æ®é€šé“åˆ†å¼€ä¾¿äºå•ç‹¬è¿›è¡Œä¼˜åŒ–ï¼Œè€Œä¸”æ–¹ä¾¿æ’å…¥æµæ°´çº¿ä¸­
5.  AXIæ¶æ„
    1.  AXIåè®®æ˜¯ä¸»ä»åè®®â€”â€”æ¯å¥—AXIæ€»çº¿çš„ä¸»è®¾å¤‡å’Œä»è®¾å¤‡æ˜¯å›ºå®šçš„ï¼Œåªæœ‰ä¸»è®¾å¤‡æ‰å¯ä»¥å‘èµ·è¯»å†™å‘½ä»¤(request)
    2.  ä¸€å¥—AXIæ€»çº¿åŒ…å«äº”ä¸ªé€šé“[^æ³¨é‡Š2]ï¼Œæ¯ä¸ªé€šé“çš„ä¿¡å·å®šä¹‰è§[2ä¸­çš„è¡¨æ ¼](https://www.wolai.com/aurora_420/a4NQef8H2GcGxyi4tdDbch#teHCcM4rDkDwdZdVy68Vme "2ä¸­çš„è¡¨æ ¼")
    3.  AXIåè®®çš„ä¸€æ¬¡å®Œæ•´çš„è¯»æˆ–å†™è¿‡ç¨‹æ˜¯ä¸€ä¸ªæ€»çº¿äº‹åŠ¡
    4.  ä¸‹å›¾åˆ†åˆ«è¯´æ˜äº†è¯»å†™äº‹åŠ¡æ˜¯å¦‚ä½•é€šè¿‡å¯¹åº”çš„é€šé“è¿›è¡Œçš„

        ![](image/image_iJiC0L7dYk.png)
    5.  AXIåè®®æ˜¯åŒå‘æ¡æ‰‹çš„ï¼Œæ¯æ¬¡ä¼ è¾“ä¹Ÿéƒ½éœ€è¦ä¸»ä»åŒæ–¹ç»™å‡ºç¡®è®¤ä¿¡å·â€”â€”æ•°æ®çš„æ¥æºæ–¹è®¾ç½®æœ‰æ•ˆValidä¿¡å·ï¼Œæ•°æ®çš„æ¥æ”¶æ–¹è®¾ç½®å‡†å¤‡å¥½Readyä¿¡å·ã€‚åªæœ‰Validå’ŒReadyå‡æœ‰æ•ˆæ—¶ï¼Œæ‰ä¼šä¼ è¾“æ•°æ®
    6.  è‹¥é‡‡ç”¨Brustä¼ è¾“ï¼Œé‚£ä¹ˆè¯»è¯·æ±‚é€šé“å’Œå†™æ•°æ®é€šé“è¿˜å„åŒ…å«ä¸€ä¸ªç»“æŸä¿¡å·[^æ³¨é‡Š3]æ¥æŒ‡å®šä¸€æ¬¡çªå‘ä¼ è¾“çš„æœ€åä¸€ä¸ªä¼ è¾“å‘¨æœŸ
6.  AXIäº’è¿

    å¤„ç†å™¨ç³»ç»Ÿä¸­çš„å¤šä¸ªä¸»è®¾å¤‡å’Œä»è®¾å¤‡ä¹‹é—´å¯ä»¥ä½¿ç”¨äº’è¿æ€»çº¿è¿›è¡Œè¿æ¥å¦‚ä¸‹å›¾ã€‚åœ¨è¯¥äº’è¿ç»“æ„ä¸­ï¼Œä»»æ„ä¸€ä¸ªä¸»è®¾å¤‡éƒ½å¯ä»¥è®¿é—®æ‰€æœ‰çš„ä»è®¾å¤‡

    ![](image/image_XCMnOoKhJq.png)
7.  AXIé«˜é¢‘è®¾è®¡

    å› ä¸ºAXIåè®®çš„äº”ä¸ªé€šé“éƒ½æ˜¯å•å‘çš„ä¿¡æ¯ä¼ é€’ï¼Œå¹¶ä¸”å„ä¸ªé€šé“ä¹‹é—´æ²¡æœ‰è§„å®šç‰¹å®šçš„é¡ºåºå…³ç³»ï¼Œä¸å­˜åœ¨åŒæ­¥ï¼Œæ‰€ä»¥å¯ä»¥å¾ˆå®¹æ˜“åœ°åœ¨é€šé“ä¹‹é—´æ’å…¥å¯„å­˜å™¨ç¼“å†²ï¼Œä¾¿äºè¿›è¡Œé«˜é¢‘è®¾è®¡
8.  AXIåŸºæœ¬äº‹åŠ¡
    > ğŸ“ŒAXIåè®®çš„ä¸»è¦ç‰¹ç‚¹æ˜¯
    >
    > 1.  ä½¿ç”¨VALID[^æ³¨é‡Š4]å’ŒREADY[^æ³¨é‡Š5]æ¡æ‰‹æœºåˆ¶è¿›è¡Œä¼ è¾“ï¼Œåœ°å€å’Œæ•°æ®ä¿¡æ¯éƒ½åªæœ‰åœ¨VALIDå’ŒREADYä¿¡å·åŒæ—¶ä¸ºé«˜ç”µå¹³æ—¶æ‰è¿›è¡Œä¼ è¾“
    > 2.  ä½¿ç”¨åˆ†ç¦»çš„åœ°å€/æ•°æ®é€šé“ï¼Œè¯»äº‹åŠ¡å’Œå†™äº‹åŠ¡éƒ½åŒ…å«ç‹¬ç«‹çš„åœ°å€é€šé“[^æ³¨é‡Š6]å’Œæ•°æ®é€šé“
    1.  çªå‘è¯»äº‹åŠ¡â€”â€”RLASTä¿¡å·ç»“æŸçªå‘ä¼ è¾“

        ![](image/image_xc_NLTQ9SY.png)

        Aå¼€å¤´çš„ä¿¡å·è¡¨ç¤ºè¯»åœ°å€/è¯·æ±‚é€šé“ï¼Œä¸å¸¦Açš„æ˜¯è¯»æ•°æ®é€šé“

        è¯»äº‹åŠ¡çš„æ•°æ®æ¥æ”¶ç«¯æ˜¯ä¸»è®¾å¤‡ï¼Œå‘é€ç«¯æ˜¯ä»è®¾å¤‡ã€‚å› æ­¤ä¸»è®¾å¤‡æ˜¯READYä¿¡å·ï¼Œä»è®¾å¤‡æ˜¯VALIDä¿¡å·

        è¯»è¯·æ±‚é€šé“ï¼šT1\~T2æ—¶ï¼Œä¸»è®¾å¤‡ç»™å‡ºçš„ARREADYä¿¡å·å’Œä»è®¾å¤‡ç»™å‡ºçš„AVALIDä¿¡å·å‡ä¸ºé«˜ç”µå¹³ï¼Œå› æ­¤åœ°å€ARADDRå¯ä»¥ç»ä¸»è®¾å¤‡ä¼ è¾“ç»™ä»è®¾å¤‡

        è¯»æ•°æ®é€šé“ï¼šé‡‡ç”¨çªå‘ä¼ è¾“æ–¹å¼ï¼Œå½“ä¸»è®¾å¤‡ç»™å‡ºRREADYä¿¡å·ï¼Œä»è®¾å¤‡ç»™å‡ºRVALIDä¿¡å·æœ‰æ•ˆæ—¶ï¼Œæ•°æ®RDATAå¯ä»¥ç”±ä»è®¾å¤‡ä¼ è¾“è‡³ä¸»è®¾å¤‡ã€‚åˆ°æœ€åä¸€ä¸ªæ•°æ®ä¼ è¾“æ—¶ï¼Œéœ€è¦ä»è®¾å¤‡ç½®RLASTä¿¡å·é«˜ç”µå¹³
    2.  é‡å çš„è¯»äº‹åŠ¡â€”â€”æ ¹æ®äº‹åŠ¡IDåŒºåˆ†

        ![](image/image_iCUECU6QDF.png)
        > âœ¨AXIæ”¯æŒé‡å äº‹åŠ¡çš„æ€§è´¨ä½¿å¾—ä»è®¾å¤‡å¯ä»¥åœ¨å‰é¢çš„æ•°æ®æ²¡æœ‰ä¼ è¾“å®Œæˆæ—¶å°±å¼€å§‹å¤„ç†åé¢çš„äº‹åŠ¡ï¼Œä»è€Œé™ä½åé¢äº‹åŠ¡çš„å®Œæˆæ—¶é—´
        > ä¸Šå›¾ä¸­ï¼Œåœ¨T4æ—¶ï¼ŒAäº‹åŠ¡çš„æ•°æ®è¿˜æ²¡æœ‰è¯»å®Œï¼Œå°±ç»™å‡ºäº†Bäº‹åŠ¡çš„åœ°å€ä¿¡æ¯ã€‚å› ä¸ºé‡å äº‹åŠ¡çš„æ€§è´¨ï¼Œä»è®¾å¤‡å¯ä»¥åœ¨Aè®¾å¤‡çš„æ•°æ®å‡ä¼ è¾“å®Œæˆåï¼Œå¾…RVALIDå’ŒRREADYå‡æœ‰æ•ˆåç«‹åˆ»å¼€å§‹Bäº‹åŠ¡æ•°æ®çš„ä¼ è¾“
    3.  å†™äº‹åŠ¡

        ![](image/image_gYGzSaz1e0.png)

        å†™äº‹åŠ¡æ˜¯ä¸»è®¾å¤‡å°†æ•°æ®å†™è‡³ä»è®¾å¤‡ï¼Œå› æ­¤ä¸»è®¾å¤‡æ˜¯æ•°æ®æä¾›æ–¹ï¼Œå‘å‡ºVALIDä¿¡å·ï¼›ä»è®¾å¤‡æ˜¯æ•°æ®æ¥æ”¶æ–¹ï¼Œå‘å‡ºREADYä¿¡å·

        å†™äº‹åŠ¡æ¶‰åŠå†™åœ°å€AWã€å†™æ•°æ®Wã€å†™å“åº”Bä¸‰ä¸ªé€šé“

        T2æ—¶ï¼ŒAWVALIDå’ŒAWREADYä¿¡å·å‡æœ‰æ•ˆï¼Œä¸»è®¾å¤‡å°†AWADDRä¼ è¾“è‡³ä»è®¾å¤‡

        T4ã€T6ã€T8ã€T9æ—¶ï¼ŒWVALIDã€WREADYä¿¡å·å‡æœ‰æ•ˆï¼Œä¸»è®¾å¤‡å°†æ•°æ®WDATAå†™è‡³ä»è®¾å¤‡

        T10æ—¶ï¼ŒBVALIDã€BREADYä¿¡å·å‡æœ‰æ•ˆï¼Œä»è®¾å¤‡å°†BRESPä¿¡å·ä¼ è¾“è‡³ä¸»è®¾å¤‡
9.  è¯»å†™äº‹åŠ¡é¡ºåºâ€”â€”AXIåè®®æ”¯æŒè¯»å†™äº‹åŠ¡ä¹±åºå®Œæˆ

    AXIæ€»çº¿çš„æ¯ä¸€ä¸ªè¯»å†™äº‹åŠ¡éƒ½æœ‰ä¸€ä¸ªIDæ ‡ç­¾ã€‚åŒIDçš„è¯»äº‹åŠ¡æˆ–è€…åŒIDçš„å†™äº‹åŠ¡å¿…é¡»æŒ‰ç…§å‘ç”Ÿçš„é¡ºåºæŒ‰åºå®Œæˆï¼Œä¸åŒIDçš„äº‹åŠ¡å¯ä»¥ä¹±åºå®Œæˆ
10. AXIåè®®çš„å…¶å®ƒç‰¹ç‚¹
    1.  æ”¯æŒä¸åŒçš„çªå‘ä¼ è¾“ç±»å‹â€”â€”å›ç»•ã€é¡ºåºã€å›ºå®š

        å›ç»•é€‚åˆé«˜é€Ÿç¼“å­˜è¡Œä¼ è¾“

        é¡ºåºé€‚åˆè¾ƒé•¿çš„å†…å­˜è®¿é—®

        å›ºå®šé€‚åˆå¯¹å¤–è®¾FIFOè®¿é—®
    2.  çªå‘ä¼ è¾“é•¿åº¦å¯å˜â€”â€”1\~16
    3.  ä¼ è¾“æ•°æ®å®½åº¦å¯å˜â€”â€”8\~1024ä½
    4.  æ”¯æŒéå¯¹é½çš„è®¿é—®â€”â€”ä½†æ˜¯LA32Ræ¶æ„å¹¶ä¸å®ç°è¿™ä¸ªï¼Œä»ç„¶æœ‰ALEå¼‚å¸¸
    5.  æ”¯æŒåŸå­æ“ä½œã€å®‰å…¨å’Œç‰¹æƒè®¿é—®ã€é”™è¯¯æŠ¥å‘Š

# 2 AXIæ€»çº¿æ¥å£å®ç°

æ ¹æ®æ‰¾åˆ°çš„èµ„æ–™æ±ªæ–‡ç¥¥è€å¸ˆçš„ã€ŠCPUè®¾è®¡å®æˆ˜ MIPSç‰ˆã€‹ï¼Œå¯¹AXIæ€»çº¿æ¥å£çš„å®ç°å¯ä»¥ç®€åŒ–ä¸ºä»¥ä¸‹ä¸‰æ­¥[^æ³¨é‡Š7]ï¼š

1.  å°†åŸæœ‰CPUè®¿é—®SRAMçš„æ¥å£è°ƒæ•´ä¸ºç±»SRAMæ€»çº¿æ¥å£[^æ³¨é‡Š8]
2.  è®¾è®¡å®ç°â€œç±»SRAM-AXIâ€çš„è½¬æ¢æ¡¥ï¼Œæ‹¼æ¥1.æ‰€å®ç°çš„CPUï¼Œè¿è¡ŒAXIå›ºå®šå»¶è¿ŸéªŒè¯
3.  å®Œå–„2.çš„CPUï¼Œå®ŒæˆAXIéšæœºå»¶è¿ŸéªŒè¯

## 2.1 ç±»SRAMæ€»çº¿

### 2.1.1 ç±»SRAMæ€»çº¿æ¥å£ç›¸å…³

#### 2.1.1.1 ä¸»æ–¹å’Œä»æ–¹

è¯»å’Œå†™è¿™ä¸¤ç§äº¤äº’è¡Œä¸ºçš„å‘èµ·æ–¹ç§°ä¸ºâ€œä¸»æ–¹â€[^æ³¨é‡Š9]ï¼Œå“åº”æ–¹ç§°ä¸ºâ€œä»æ–¹â€[^æ³¨é‡Š10]

è¯»æ“ä½œï¼šä¸»æ–¹æå‡ºè¯»è¯·æ±‚ï¼Œä»æ–¹æ¥æ”¶è¯·æ±‚å¹¶è¿”å›æ•°æ®
å†™æ“ä½œï¼šä¸»æ–¹æå‡ºå†™è¯·æ±‚å¹¶å‘å‡ºæ•°æ®ï¼Œä»æ–¹æ¥æ”¶è¯·æ±‚å’Œæ•°æ®å¹¶å“åº”

#### 2.1.1.2 ç±»SRAMæ€»çº¿æ¥å£ä¿¡å·å®šä¹‰

**ä¿¡å·çš„è¾“å…¥ã€è¾“å‡ºæ˜¯é’ˆå¯¹äºCPU(ä¸»è®¾å¤‡)æ¥è¯´çš„**

ä¸‹è¡¨åˆ—å‡ºäº†ç±»SRAMæ€»çº¿æ¥å£ä¿¡å·çš„è¯´æ˜ï¼š

| ä¿¡å·       | ä½å®½ | æ–¹å‘     | åŠŸèƒ½                                     |
| -------- | -- | ------ | -------------------------------------- |
| clk      | 1  | input  | æ—¶é’Ÿä¿¡å·                                   |
| req      | 1  | output | äº¤äº’è¯·æ±‚ä¿¡å·ï¼Œé«˜ç”µå¹³è¡¨ç¤ºæœ‰è¯»å†™è¯·æ±‚                      |
| wr       | 1  | output | å†™è¯·æ±‚ä¿¡å·ï¼Œé«˜ç”µå¹³æ—¶è¡¨ç¤ºå†™è¯·æ±‚ï¼Œä½ç”µå¹³ä¸”reqä¸ºé«˜ç”µå¹³è¡¨ç¤ºè¯»è¯·æ±‚       |
| size     | 2  | è¾“å‡º     | è¯¥æ¬¡è¯·æ±‚ä¼ è¾“çš„å­—èŠ‚æ•°&#xA;0:1Bã€1:2Bã€2:4B          |
| addr     | 32 | è¾“å‡º     | è¯¥æ¬¡è¯·æ±‚çš„åœ°å€                                |
| wstrb    | 4  | è¾“å‡º     | è¯¥æ¬¡å†™è¯·æ±‚çš„å­—èŠ‚å†™ä½¿èƒ½                            |
| wdata    | 32 | è¾“å‡º     | è¯¥æ¬¡å†™è¯·æ±‚çš„å†™æ•°æ®                              |
| addr\_ok | 1  | è¾“å…¥     | è¯¥æ¬¡è¯·æ±‚çš„åœ°å€ä¼ è¾“OK&#xA;è¯»è¯·æ±‚ï¼šåœ°å€è¢«æ¥æ”¶ï¼›å†™è¯·æ±‚ï¼šåœ°å€å’Œæ•°æ®è¢«æ¥æ”¶ |
| data\_ok | 1  | è¾“å…¥     | è¯¥æ¬¡è¯·æ±‚çš„æ•°æ®ä¼ è¾“OK&#xA;è¯»ï¼šæ•°æ®è¿”å›ç»™ä¸»æ–¹&#xA;å†™ï¼šæ•°æ®å†™å…¥å®Œæˆ |
| rdata    | 32 | è¾“å…¥     | è¯¥æ¬¡è¯»è¯·æ±‚è¿”å›çš„æ•°æ®                             |

å…¶ä¸­clkå¯¹åº”åŸæ¥Data SRAMçš„cpu\_clkã€reqå¯¹åº”åŸæ¥Data SRAMçš„data\_sram\_enã€addrå¯¹åº”åŸæ¥Data SRAMçš„data\_sram\_addr\[17:2]ã€wstrbå¯¹åº”åŸæ¥Data SRAMçš„data\_sram\_weã€wdataå¯¹åº”åŸæ¥Data SRAMçš„data\_sram\_wdataã€rdataå¯¹åº”åŸæ¥Data SRAMçš„data\_sram\_rdata

**wrã€sizeã€addr\_okã€data\_ok**æ˜¯æ–°å¢çš„ä¿¡å·

1.  wrä¿¡å·
    1.  å–æŒ‡æ—¶ï¼Œwrä¸º1'b0
    2.  è®¿å­˜æ—¶ï¼Œwrä¿¡å·æ ¹æ®M\_memWriteEè®¾ç½®ï¼ŒM\_memWriteEä¸º1æ—¶è®¾ç½®ä¸º1
2.  sizeä¿¡å·
    1.  å–æŒ‡æ—¶ï¼Œsizeä¸º2'b10
    2.  è®¿å­˜æ—¶ï¼Œsizeä¿¡å·å¯ä»¥æ ¹æ®M\_memReadW,M\_memWriteWè®¾ç½®ã€‚LBã€LBUã€SBä¸º2'b00ï¼ŒLHã€LHUã€SHä¸º2'b01ï¼ŒLWã€SWä¸º2'b10
3.  addr\_okä¿¡å·ç”¨äºå’Œreqä¿¡å·ä¸€èµ·å®Œæˆè¯»å†™è¯·æ±‚çš„æ¡æ‰‹

    åªæœ‰åœ¨clkçš„ä¸Šå‡æ²¿åŒæ—¶çœ‹åˆ°reqå’Œaddr\_okä¸ºé«˜ç”µå¹³æ—¶æ‰æ˜¯ä¸€æ¬¡æˆåŠŸçš„è¯·æ±‚æ¡æ‰‹
4.  data\_okä¿¡å·

    å¯¹åº”è¯»äº‹åŠ¡æ—¶ï¼Œdata\_okæ˜¯æ•°æ®è¿”å›çš„æœ‰æ•ˆä¿¡å·
    å¯¹åº”å†™äº‹åŠ¡æ—¶ï¼Œdata\_okæ˜¯å†™å…¥å®Œæˆçš„æœ‰æ•ˆä¿¡å·

    **åœ¨ç±»SRAMæ¥å£ä¸­ï¼Œä¸»æ–¹å¯¹äºdata\_okä¿¡å·æ€»æ˜¯å¯ä»¥æ¥å—åˆ°çš„ï¼Œå› æ­¤ä¸å†è®¾ç½®data\_okçš„æ¡æ‰‹ä¿¡å·**

#### 2.1.1.3 ç±»SRAMæ€»çº¿çš„è¯»å†™æ—¶åº

![](image/image_JJ3kQpNh1r.png)

å·¦å›¾ä¸ºç±»SRAMæ€»çº¿ä¸Šçš„ä¸€æ¬¡è¯»äº‹åŠ¡æ—¶åºå…³ç³»

åœ¨clkä¸Šå‡æ²¿æ—¶ï¼Œè‹¥addr\_okå’Œreqå‡ä¸ºé«˜ç”µå¹³åˆ™è¯´æ˜åœ°å€æ¡æ‰‹æˆåŠŸâ€”â€”è¯»åœ°å€å·²æˆåŠŸä¼ é€’ç»™ä»æ–¹

åœ¨clkä¸Šå‡æ²¿æ—¶ï¼Œè‹¥data\_okä¸ºé«˜ç”µå¹³åˆ™è¯´æ˜æ•°æ®å·²æˆåŠŸä¼ è¾“ç»™ä¸»æ–¹ï¼Œæ­¤æ—¶çš„rdataå³ä¸ºç»™å®šä½ç½®è¯»å‡ºçš„æ•°æ®

![](image/image_ddZYmGcTBD.png)

å·¦å›¾ä¸ºç±»SRAMæ€»çº¿ä¸Šçš„ä¸€æ¬¡å†™äº‹åŠ¡æ—¶åºå…³ç³»

åœ¨clkä¸Šå‡æ²¿æ—¶ï¼Œè‹¥addr\_okå’Œreqå‡ä¸ºé«˜ç”µå¹³åˆ™è¯´æ˜åœ°å€æ¡æ‰‹æˆåŠŸâ€”â€”è¯»åœ°å€å·²æˆåŠŸä¼ é€’ç»™ä»æ–¹

åœ¨clkä¸Šå‡æ²¿æ—¶ï¼Œè‹¥data\_okä¸ºé«˜ç”µå¹³åˆ™è¯´æ˜æ•°æ®å·²æˆåŠŸå†™å…¥è‡³ä»æ–¹

> ğŸ“Œ**è¿ç»­å†™è¯»æ—¶ï¼Œä»æ–¹è¿”å›çš„data\_okæ˜¯ä¸¥æ ¼æŒ‰ç…§è¯·æ±‚å‘å‡ºçš„é¡ºåºè¿”å›çš„**
>
> **ä¸ºäº†ç®€åŒ–è®¾è®¡ï¼Œéœ€è¦æ§åˆ¶è¿ç»­å†™è¯»çš„æ•°ç›®ï¼Œå¯ä»¥****åœ¨ä¸»æ–¹æ‹‰ä½reqä¿¡å·****æ¥æš‚åœå‘é€æ–°äº‹åŠ¡çš„è¯·æ±‚ï¼Œ****åœ¨ä»æ–¹æ‹‰ä½addr\_ok****ä¿¡å·æ¥æš‚åœæ¥æ”¶æ–°äº‹åŠ¡çš„è¯·æ±‚**

![](image/image_ZaqMUnDepC.png)

å·¦å›¾ä¸ºç±»SRAMæ€»çº¿ä¸Šçš„è¿ç»­å†™è¯»çš„æ—¶åºå…³ç³»ã€‚

åœ¨å·¦å›¾ä¸­ï¼Œå†™è¯·æ±‚æ¡æ‰‹æˆåŠŸååˆé©¬ä¸Šè¿›è¡Œè¯»è¯·æ±‚çš„æ¡æ‰‹ï¼Œå› æ­¤å“åº”çš„data\_okä¹Ÿæ˜¯å…ˆå“åº”å†™è¯·æ±‚ï¼Œå†å“åº”è¯»è¯·æ±‚

#### 2.1.1.4 ç±»SRAMæ€»çº¿çš„çº¦æŸ

ä¸ºé™ä½ç±»SRAMæ€»çº¿çš„è®¾è®¡å¤æ‚åº¦ï¼Œå¯¹ç±»SRAMæ€»çº¿åšå‡ºä»¥ä¸‹çº¦æŸï¼š

1.  ä»æ–¹å‘å‡ºçš„addr\_okå€¼ä¸èƒ½ä¾èµ–ä¸»æ–¹å‘å‡ºçš„reqå€¼â€”â€”**ç”Ÿæˆaddr\_okçš„é€»è¾‘ä¸èƒ½çœ‹reqä¿¡å·**
2.  **åœ¨reqä¸ºé«˜ç”µå¹³ä¸”addr\_okä¸ºä½ç”µå¹³æ—¶ï¼Œå…è®¸ä¸»æ–¹æ›´æ”¹wrã€sizeã€addrã€wstrbå’Œwdata**

    ç±»SRAMæ€»çº¿åœ¨åœ°å€è¯·æ±‚æœªå¾—åˆ°å“åº”æ—¶ï¼Œå¯ä»¥æ›´æ¢è¯·æ±‚çš„ä¿¡æ¯ï¼›ä½†AXIæ€»çº¿è¦æ±‚ï¼šä¸»æ–¹ä¸€æ—¦å‘èµ·æŸä¸€åœ°å€æˆ–æ•°æ®çš„ä¼ è¾“ï¼Œåœ¨è¯¥ä¼ è¾“æ¡æ‰‹æˆåŠŸå‰ï¼Œä¸å¾—æ›´æ”¹ä¼ è¾“çš„åœ°å€æˆ–æ•°æ®

### 2.1.2 ç±»SRAMæ€»çº¿æ¥å£è®¾è®¡

æœ¬å°èŠ‚éœ€è¦å°†æ‰€å®ç°çš„å…·æœ‰ç²¾ç¡®ä¸­æ–­æœºåˆ¶çš„äº”çº§æµæ°´MC CPUçš„å–æŒ‡å’Œè®¿å­˜æ‰€ä½¿ç”¨çš„æ ‡å‡†çš„SRAMæ¥å£æ”¹é€ ä¸ºç±»SRAMæ€»çº¿æ¥å£

#### 2.1.2.1 ç±»SRAMæ€»çº¿æ¥å£

åœ¨é¡¹ç›®soc\_hs\_bramä¸­å·²ç»å®Œæˆäº†ç±»SRAMæ€»çº¿å¯¹ins\_ramçš„æ¥å£ï¼Œå¦‚ä¸‹ï¼š

```verilog
//for func test, no define RUN_PERF_TESTï¼ŒæœªæŒ‡å®šå€¼é»˜è®¤ä¸º1
`define _RUN_PERF_TEST

module sram_wrap (
    input wire clk,    //å¤–éƒ¨æ—¶é’Ÿè¾“å…¥
    input wire resetn, //å¤–éƒ¨å¤ä½ä¿¡å·ã€ä½ç”µå¹³

    input  wire         req,      //å¤–éƒ¨è¾“å…¥çš„è¯·æ±‚ä¿¡å·
    input  wire         wr,       //å¤–éƒ¨è¾“å…¥çš„è¯»å†™ä¿¡å·ï¼Œinstæ—¶å§‹ç»ˆä¸º0
    input  wire [1 : 0] size,     //è®¿é—®æ•°æ®å¤§å°
    input  wire [3 : 0] wstrb,    //å†™ä½é€‰é€šä¿¡å·
    input  wire [ 31:0] addr,     //è®¿å­˜åœ°å€
    input  wire [ 31:0] wdata,    //å†™æ•°æ®
    output wire         addr_ok,  //è¾“å‡ºçš„åœ°å€okä¿¡å·
    output wire         data_ok,  //å·²å¾—åˆ°æ•°æ®okä¿¡å·
    output wire [ 31:0] rdata,    //è¯»å‡ºçš„æ•°æ®

    //slave ç»™SRAMçš„æ¥å£
    output wire ram_en,
    output wire [3 : 0] ram_we,
    output wire [31:0] ram_addr,
    output wire [31:0] ram_wdata,
    input wire [31:0] ram_rdata,
    //from confreg
    input  wire [1 : 0] ram_random_mask  //ä»¿çœŸæ—¶ç”¨ä½œçš„æ©ç ä¿¡å·ï¼Œç”¨äºaddr_okï¼Œdata_okçš„ç”Ÿæˆ
);
  wire addr_and;
  wire data_and;
  //mask
`ifdef RUN_PERF_TEST  //ä»¿çœŸæ—¶è®¾ç½®ä¸º1ï¼Œä¸Šæ¿æ—¶æ ¹æ®å¼€å…³æ¥è®¾ç½®
  assign addr_and = 1'b1;
  assign data_and = 1'b1;
`else
  assign addr_and = ram_random_mask[1];
  assign data_and = ram_random_mask[0];
`endif

  //to ram

  //size_decode
  //è®¿é—®å­—èŠ‚æ•°æ®æ—¶ï¼Œåœ°å€æœ«ä¸¤ä½3,2,1,0åˆ†åˆ«å¯¹åº”size_decodeå¯¹åº”32ä½å¯¹åº”çš„31~24,23~16,15~8,7~0
  //è®¿é—®åŠå­—æ•°æ®æ—¶ï¼Œåœ°å€æœ«ä¸¤ä½ä¸º00æ—¶å¯¹åº”15~0,10æ—¶å¯¹åº”31~16
  //è®¿é—®å­—æ•°æ®æ—¶ï¼Œå¯¹åº”31~0,å‡ä¸º4'b1111
  wire [3:0] size_decode = size==2'd0 ? {addr[1:0]==2'd3,addr[1:0]==2'd2,addr[1:0]==2'd1,addr[1:0]==2'd0} :
                         size==2'd1 ? {addr[1],addr[1],~addr[1],~addr[1]} :
                                      4'hf;

  assign ram_en = req && addr_ok;  //å½“reqå’Œaddr_okåŒæ—¶æœ‰æ•ˆæ—¶ï¼Œå³å¯ä»¥è®¿é—®å­˜å‚¨å™¨
  assign ram_we    = {4{wr}} & wstrb & size_decode;//wrã€wstrbï¼ˆåŸå®ç°æ˜¯å§‹ç»ˆæ˜¯4'b1111ï¼‰ã€size_decodeç›¸ä¸ç”Ÿæˆå†™å­˜ä½å®½ä¿¡å·
  assign ram_addr = addr;
  assign ram_wdata = wdata;

  reg ram_en_r;  //å»¶ç¼“ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸï¼Œå’ŒBRAMéœ€è¦ä¸€ä¸ªå‘¨æœŸå¾—åˆ°å­˜å‚¨æ•°æ®åŒæ­¥
  always @(posedge clk) begin
    ram_en_r <= ram_en;
  end


  //è¯»ç¼“å†²
  reg [2 : 0] buf_wptr;  //æ€»çº¿çš„å†™æŒ‡é’ˆâ€”â€”ç±»ä¼¼äºåŒæŒ‡é’ˆå¾ªç¯é˜Ÿåˆ—çš„æ€æƒ³ 4ä¸ªé€šé“éœ€è¦ä¸¤ä½ï¼Œå†å¢åŠ ä¸€ä½åˆ¤æ–­é˜Ÿåˆ—ç©ºæ»¡
  reg [2 : 0] buf_rptr;  //æ€»çº¿çš„è¯»æŒ‡é’ˆ
  reg [31:0] buf_rdata[3:0];  //4ä¸ª32ä½å®½çš„æ€»çº¿

  wire buf_empty = buf_wptr == buf_rptr;  //å½“è¯»å†™æŒ‡é’ˆç›¸ç­‰æ—¶é˜Ÿåˆ—ç©º
  wire buf_full = buf_wptr == {~buf_rptr[2], buf_rptr[1:0]}; //å½“è¯»å†™æŒ‡é’ˆä½ä¸¤ä½ç›¸åŒä½†æœ€é«˜ä½ä¸åŒæ—¶è¡¨ç¤ºé˜Ÿåˆ—æ»¡

  wire fast_return = ram_en_r && data_ok && buf_empty;//å½“è®¿å­˜ä¸”data_okæ¡æ‰‹ä¸”bufç©ºæ—¶ï¼Œç›´æ¥è¿”å›sramæ•°æ®ï¼Œä¸ç”¨å†™sram

  always @(posedge clk) begin
    if (!resetn) begin  //å¤ä½æ—¶ï¼Œå†™æŒ‡é’ˆæ¸…0
      buf_wptr <= 3'd0;
    end else if (ram_en_r && !fast_return) begin
      buf_wptr <= buf_wptr + 1'b1;
    end

    if (ram_en_r && !fast_return) begin  //å°†æ•°æ®åŠ è½½åˆ°bufä¸­ï¼Œå†™bufï¼Œè¿™ä¸ªå¯ä»¥æ”¾åœ¨ä¸Šé¢çš„else-ifä¸­ï¼Œ<=åŒæ­¥èµ‹å€¼
      buf_rdata[buf_wptr[1:0]] <= ram_rdata;
    end

    if (!resetn) begin  //å¤ä½æ—¶ï¼Œè¯»æŒ‡é’ˆæ¸…0
      buf_rptr <= 3'd0;
    end else if (!buf_empty && data_ok) begin//é˜Ÿåˆ—ä¸ç©ºæ—¶ï¼Œdata_okè¡¨ç¤ºè¯¥æ•°æ®å·²è¯»å‡ºï¼Œå¯ä»¥å¢åŠ è¯»æŒ‡é’ˆ
      buf_rptr <= buf_rptr + 1'b1;
    end
  end
  
  assign addr_ok = 1'b1 && addr_and && !buf_full;//addr_andä¸º1æ—¶ï¼Œåªè¦é˜Ÿåˆ—ä¸æ»¡å°±å¯ä»¥æ¥å—addr
  assign data_ok = 1'b1 && data_and && (!buf_empty || ram_en_r);//data_andä¸º1æ—¶ï¼Œå½“bufç©ºæ—¶ï¼Œéœ€è¦ç­‰å¾…1ä¸ªæ—¶é’Ÿå‘¨æœŸæ‰èƒ½å®Œæˆè¯»å–/å†™å…¥ï¼Œå› æ­¤æ˜¯ram_en_rï¼›å½“bufä¸ç©ºæ—¶ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨bufä¸­çš„æ•°æ®è¿”å›ï¼Œä¸éœ€è¦ç­‰å¾…ä¸€ä¸ªæ—¶é’Ÿå³å¯æœ‰data_okä¿¡å·
  assign rdata = buf_empty ? ram_rdata : buf_rdata[buf_rptr[1:0]];//bufç©ºæ—¶ï¼Œç›´æ¥è¯»sramè¯»å‡ºçš„æ•°æ®ï¼Œå¦åˆ™è¯»bufçš„
endmodule

```

```verilog
//for func test, no define RUN_PERF_TESTï¼ŒæœªæŒ‡å®šå€¼é»˜è®¤ä¸º1
`define _RUN_PERF_TEST

module sram_wrap (
    input wire clk,    //å¤–éƒ¨æ—¶é’Ÿè¾“å…¥
    input wire resetn, //å¤–éƒ¨å¤ä½ä¿¡å·ã€ä½ç”µå¹³

    input  wire         req,      //å¤–éƒ¨è¾“å…¥çš„è¯·æ±‚ä¿¡å·
    input  wire         wr,       //å¤–éƒ¨è¾“å…¥çš„è¯»å†™ä¿¡å·ï¼Œinstæ—¶å§‹ç»ˆä¸º0
    input  wire [1 : 0] size,     //è®¿é—®æ•°æ®å¤§å°
    input  wire [3 : 0] wstrb,    //å†™ä½é€‰é€šä¿¡å·
    input  wire [ 31:0] addr,     //è®¿å­˜åœ°å€
    input  wire [ 31:0] wdata,    //å†™æ•°æ®
    output wire         addr_ok,  //è¾“å‡ºçš„åœ°å€okä¿¡å·
    output wire         data_ok,  //å·²å¾—åˆ°æ•°æ®okä¿¡å·
    output wire [ 31:0] rdata,    //è¯»å‡ºçš„æ•°æ®

    //slave ç»™SRAMçš„æ¥å£
    output wire ram_en,
    output wire [3 : 0] ram_we,
    output wire [31:0] ram_addr,
    output wire [31:0] ram_wdata,
    input wire [31:0] ram_rdata,
    //from confreg
    input  wire [1 : 0] ram_random_mask  //ä»¿çœŸæ—¶ç”¨ä½œçš„æ©ç ä¿¡å·ï¼Œç”¨äºaddr_okï¼Œdata_okçš„ç”Ÿæˆ
);
  wire addr_and;
  wire data_and;
  //mask
`ifdef RUN_PERF_TEST  //ä»¿çœŸæ—¶è®¾ç½®ä¸º1ï¼Œä¸Šæ¿æ—¶æ ¹æ®å¼€å…³æ¥è®¾ç½®
  assign addr_and = 1'b1;
  assign data_and = 1'b1;
`else
  assign addr_and = ram_random_mask[1];
  assign data_and = ram_random_mask[0];
`endif

  //to ram

  //size_decode
  //è®¿é—®å­—èŠ‚æ•°æ®æ—¶ï¼Œåœ°å€æœ«ä¸¤ä½3,2,1,0åˆ†åˆ«å¯¹åº”size_decodeå¯¹åº”32ä½å¯¹åº”çš„31~24,23~16,15~8,7~0
  //è®¿é—®åŠå­—æ•°æ®æ—¶ï¼Œåœ°å€æœ«ä¸¤ä½ä¸º00æ—¶å¯¹åº”15~0,10æ—¶å¯¹åº”31~16
  //è®¿é—®å­—æ•°æ®æ—¶ï¼Œå¯¹åº”31~0,å‡ä¸º4'b1111
  wire [3:0] size_decode = size==2'd0 ? {addr[1:0]==2'd3,addr[1:0]==2'd2,addr[1:0]==2'd1,addr[1:0]==2'd0} :
                         size==2'd1 ? {addr[1],addr[1],~addr[1],~addr[1]} :
                                      4'hf;

  assign ram_en = req && addr_ok;  //å½“reqå’Œaddr_okåŒæ—¶æœ‰æ•ˆæ—¶ï¼Œå³å¯ä»¥è®¿é—®å­˜å‚¨å™¨
  assign ram_we    = {4{wr}} & wstrb & size_decode;//wrã€wstrbï¼ˆåŸå®ç°æ˜¯å§‹ç»ˆæ˜¯4'b1111ï¼‰ã€size_decodeç›¸ä¸ç”Ÿæˆå†™å­˜ä½å®½ä¿¡å·
  assign ram_addr = addr;
  assign ram_wdata = wdata;

  reg ram_en_r;  //å»¶ç¼“ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸï¼Œå’ŒBRAMéœ€è¦ä¸€ä¸ªå‘¨æœŸå¾—åˆ°å­˜å‚¨æ•°æ®åŒæ­¥
  always @(posedge clk) begin
    ram_en_r <= ram_en;
  end


  //è¯»ç¼“å†²
  reg [2 : 0] buf_wptr;  //æ€»çº¿çš„å†™æŒ‡é’ˆâ€”â€”ç±»ä¼¼äºåŒæŒ‡é’ˆå¾ªç¯é˜Ÿåˆ—çš„æ€æƒ³ 4ä¸ªé€šé“éœ€è¦ä¸¤ä½ï¼Œå†å¢åŠ ä¸€ä½åˆ¤æ–­é˜Ÿåˆ—ç©ºæ»¡
  reg [2 : 0] buf_rptr;  //æ€»çº¿çš„è¯»æŒ‡é’ˆ
  reg [31:0] buf_rdata[3:0];  //4ä¸ª32ä½å®½çš„æ€»çº¿

  wire buf_empty = buf_wptr == buf_rptr;  //å½“è¯»å†™æŒ‡é’ˆç›¸ç­‰æ—¶é˜Ÿåˆ—ç©º
  wire buf_full = buf_wptr == {~buf_rptr[2], buf_rptr[1:0]}; //å½“è¯»å†™æŒ‡é’ˆä½ä¸¤ä½ç›¸åŒä½†æœ€é«˜ä½ä¸åŒæ—¶è¡¨ç¤ºé˜Ÿåˆ—æ»¡

  wire fast_return = ram_en_r && data_ok && buf_empty;//å½“è®¿å­˜ä¸”data_okæ¡æ‰‹ä¸”bufç©ºæ—¶ï¼Œç›´æ¥è¿”å›sramæ•°æ®ï¼Œä¸ç”¨å†™sram

  always @(posedge clk) begin
    if (!resetn) begin  //å¤ä½æ—¶ï¼Œå†™æŒ‡é’ˆæ¸…0
      buf_wptr <= 3'd0;
    end else if (ram_en_r && !fast_return) begin
      buf_wptr <= buf_wptr + 1'b1;
    end

    if (ram_en_r && !fast_return) begin  //å°†æ•°æ®åŠ è½½åˆ°bufä¸­ï¼Œå†™bufï¼Œè¿™ä¸ªå¯ä»¥æ”¾åœ¨ä¸Šé¢çš„else-ifä¸­ï¼Œ<=åŒæ­¥èµ‹å€¼
      buf_rdata[buf_wptr[1:0]] <= ram_rdata;
    end

    if (!resetn) begin  //å¤ä½æ—¶ï¼Œè¯»æŒ‡é’ˆæ¸…0
      buf_rptr <= 3'd0;
    end else if (!buf_empty && data_ok) begin//é˜Ÿåˆ—ä¸ç©ºæ—¶ï¼Œdata_okè¡¨ç¤ºè¯¥æ•°æ®å·²è¯»å‡ºï¼Œå¯ä»¥å¢åŠ è¯»æŒ‡é’ˆ
      buf_rptr <= buf_rptr + 1'b1;
    end
  end
  
  assign addr_ok = 1'b1 && addr_and && !buf_full;//addr_andä¸º1æ—¶ï¼Œåªè¦é˜Ÿåˆ—ä¸æ»¡å°±å¯ä»¥æ¥å—addr
  assign data_ok = 1'b1 && data_and && (!buf_empty || ram_en_r);//data_andä¸º1æ—¶ï¼Œå½“bufç©ºæ—¶ï¼Œéœ€è¦ç­‰å¾…1ä¸ªæ—¶é’Ÿå‘¨æœŸæ‰èƒ½å®Œæˆè¯»å–/å†™å…¥ï¼Œå› æ­¤æ˜¯ram_en_rï¼›å½“bufä¸ç©ºæ—¶ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨bufä¸­çš„æ•°æ®è¿”å›ï¼Œä¸éœ€è¦ç­‰å¾…ä¸€ä¸ªæ—¶é’Ÿå³å¯æœ‰data_okä¿¡å·
  assign rdata = buf_empty ? ram_rdata : buf_rdata[buf_rptr[1:0]];//bufç©ºæ—¶ï¼Œç›´æ¥è¯»sramè¯»å‡ºçš„æ•°æ®ï¼Œå¦åˆ™è¯»bufçš„
endmodule

```

åœ¨[2.1.1.2](https://www.wolai.com/ysx_ashore/a4NQef8H2GcGxyi4tdDbch#vB7Fbd8HsXN9gwpR1qY7Lm "2.1.1.2")ä¸­åˆ†ææ‰€å¾—ï¼Œå°†æ ‡å‡†SRAMæ¥å£æ”¹é€ ä¸ºç±»SRAMæ€»çº¿æ¥å£åªéœ€è¦å¢åŠ å››ä¸ªä¿¡å·ï¼šwrã€sizeã€addr\_okã€data\_okã€‚è€Œwrã€sizeçš„è®¾ç½®è¾ƒä¸ºç®€å•ï¼Œä¸»è¦æ˜¯addr\_okå’Œdata\_okè¿™ä¸¤ä¸ªä¿¡å·ï¼Œåˆ†åˆ«å¯¹åŸCPUè®¾è®¡ä¸­çš„å–æŒ‡å’Œè®¿å­˜ä¿®æ”¹

#### 2.1.2.2 å–æŒ‡è®¾è®¡

å–æŒ‡é˜¶æ®µæ˜¯IFé˜¶æ®µå‘å‡ºè¯·æ±‚ï¼ŒIDé˜¶æ®µæ¥æ”¶è¯»åˆ°çš„æ•°æ®

åªæœ‰æ”¶åˆ°addr\_okæ—¶æ‰èƒ½æ›´æ–°Fæµæ°´çº¿å¯„å­˜å™¨ï¼Œå¦åˆ™é˜»å¡

åªæœ‰å½“æ”¶åˆ°data\_okæ—¶æ‰èƒ½æ›´æ–°IDæµæ°´å¯„å­˜å™¨ï¼Œå¦åˆ™é˜»å¡

å½“æ²¡æœ‰Fæµæ°´å¯„å­˜å™¨çš„é˜»å¡ä¿¡å·æ—¶ï¼Œæ‰å¯ä»¥å‘é€reqä¿¡å·

#### 2.1.2.3 è®¿å­˜è®¾è®¡

å½“æ²¡æœ‰é˜»å¡+æ¸…ç©ºä¿¡å·æ—¶ï¼Œæ‰å¯ä»¥å‘é€reqä¿¡å·

åªæœ‰å½“æ”¶åˆ°addr\_okæ—¶ï¼Œæ‰èƒ½æ›´æ–°MEMé˜¶æ®µçš„æµæ°´å¯„å­˜å™¨

åªæœ‰å½“æ”¶åˆ°data\_okæ—¶ï¼Œæ‰èƒ½æ›´æ–°WBé˜¶æ®µçš„æµæ°´å¯„å­˜å™¨

ä½†æ˜¯åœ¨ä»¿çœŸè¿‡ç¨‹ä¸­é‡åˆ°äº†ä»¥ä¸‹é—®é¢˜ï¼š

1.  addr\_okçš„æ›´æ–°ä¹Ÿä¼šä½¿å¾—idçš„F\_pcAddrä¸€ç›´æ”¹å˜ï¼Œå› ä¸ºåŸè®¾è®¡æ˜¯å–æŒ‡ç«‹åˆ»æœ‰ç»“æœï¼Œå› æ­¤ä¼ é€’ä¸€ä¸ªclkçš„F\_pcAddræ­£å¥½æ˜¯æŒ‡ä»¤çš„pcã€‚ä½†æ˜¯è¿™ç§å®ç°å› ä¸ºdata\_okçš„ä¸ç¡®å®šå¯¼è‡´idé˜¶æ®µè·å¾—çš„å¯¹åº”æŒ‡ä»¤çš„pcä¹Ÿä¸ç¡®å®š
2.  ç„¶åæˆ‘æƒ³çš„æ˜¯å°†IDé˜¶æ®µF\_pcAddrçš„è¾“å…¥ç”±IFé˜¶æ®µæ›´æ”¹åˆ°inst\_ramçš„è®¿å­˜åœ°å€ï¼Œä½†æ˜¯è¿™ç§æƒ…å†µå¿½ç•¥äº†data\_okçš„æœ‰æ•ˆâ€”â€”ä»¿çœŸçœ‹åˆ°çš„
3.  ç°åœ¨çš„æƒ³æ³•æ˜¯ï¼šå› ä¸ºæ¥å£ä¸­æœ‰è¯»ç¼“å†²é˜Ÿåˆ—ï¼Œæ‰€ä»¥æƒ³çš„æ˜¯åœ¨ifé˜¶æ®µä¹ŸåŠ ä¸€ä¸ªè¯»ç¼“å†²é˜Ÿåˆ—ï¼Œæ¯æœ‰ä¸€ä¸ªaddr\_okå°±å°†F\_pcAddrå‹å…¥ï¼Œæ¯æœ‰ä¸€ä¸ªdata\_okå°±å–å‡ºä¸€ä¸ªâ€”â€”é™¤å¤•å®Œäº†åšä¸€ä¸‹

### 2.1.3 ç±»SRAM-AXIè½¬æ¢æ¡¥

#### 2.1.3.1 è½¬æ¢æ¡¥å®ç°

```verilog
module axi_wrap (

    //CPU->axiè½¬æ¢æ¡¥çš„ä¿¡å· master
    input  wire         m_aclk,     //axiæ—¶é’Ÿ
    input  wire         m_aresetn,  //axiå¤ä½ä¿¡å·
    //ar è¯»è¯·æ±‚é€šé“
    input  wire [3 : 0] m_arid,
    input  wire [ 31:0] m_araddr,
    input  wire [7 : 0] m_arlen,
    input  wire [2 : 0] m_arsize,
    input  wire [1 : 0] m_arburst,
    input  wire [1 : 0] m_arlock,
    input  wire [3 : 0] m_arcache,
    input  wire [2 : 0] m_arprot,
    input  wire         m_arvalid,
    output wire         m_arready,
    //r è¯»å“åº”é€šé“
    output wire [3 : 0] m_rid,
    output wire [ 31:0] m_rdata,
    output wire [1 : 0] m_rresp,
    output wire         m_rlast,
    output wire         m_rvalid,
    input  wire         m_rready,
    //aw å†™è¯·æ±‚é€šé“
    input  wire [3 : 0] m_awid,
    input  wire [ 31:0] m_awaddr,
    input  wire [7 : 0] m_awlen,
    input  wire [2 : 0] m_awsize,
    input  wire [1 : 0] m_awburst,
    input  wire [1 : 0] m_awlock,
    input  wire [3 : 0] m_awcache,
    input  wire [2 : 0] m_awprot,
    input  wire         m_awvalid,
    output wire         m_awready,
    //w å†™æ•°æ®é€šé“
    input  wire [3 : 0] m_wid,
    input  wire [ 31:0] m_wdata,
    input  wire [3 : 0] m_wstrb,
    input  wire         m_wlast,
    input  wire         m_wvalid,
    output wire         m_wready,
    //b å†™å“åº”é€šé“
    output wire [3 : 0] m_bid,
    output wire [1 : 0] m_bresp,
    output wire         m_bvalid,
    input  wire         m_bready,


    //axiè½¬æ¢æ¡¥ç»™åˆ°å¤–è®¾çš„ä¿¡å· slave
    output wire         s_aclk,
    output wire         s_aresetn,
    //ar
    output wire [3 : 0] s_arid,
    output wire [ 31:0] s_araddr,
    output wire [7 : 0] s_arlen,
    output wire [2 : 0] s_arsize,
    output wire [1 : 0] s_arburst,
    output wire [1 : 0] s_arlock,
    output wire [3 : 0] s_arcache,
    output wire [2 : 0] s_arprot,
    output wire         s_arvalid,
    input  wire         s_arready,
    //r
    input  wire [3 : 0] s_rid,
    input  wire [ 31:0] s_rdata,
    input  wire [1 : 0] s_rresp,
    input  wire         s_rlast,
    input  wire         s_rvalid,
    output wire         s_rready,
    //aw
    output wire [3 : 0] s_awid,
    output wire [ 31:0] s_awaddr,
    output wire [7 : 0] s_awlen,
    output wire [2 : 0] s_awsize,
    output wire [1 : 0] s_awburst,
    output wire [1 : 0] s_awlock,
    output wire [3 : 0] s_awcache,
    output wire [2 : 0] s_awprot,
    output wire         s_awvalid,
    input  wire         s_awready,
    //w
    output wire [3 : 0] s_wid,
    output wire [ 31:0] s_wdata,
    output wire [3 : 0] s_wstrb,
    output wire         s_wlast,
    output wire         s_wvalid,
    input  wire         s_wready,
    //b
    input  wire [3 : 0] s_bid,
    input  wire [1 : 0] s_bresp,
    input  wire         s_bvalid,
    output wire         s_bready
);
  assign s_aclk = m_aclk;
  assign s_aresetn = m_aresetn;
  //ar
  assign s_arid = m_arid;
  assign s_araddr = m_araddr;
  assign s_arlen = m_arlen;
  assign s_arsize = m_arsize;
  assign s_arburst = m_arburst;
  assign s_arlock = m_arlock;
  assign s_arcache = m_arcache;
  assign s_arprot = m_arprot;
  assign s_arvalid = m_arvalid;
  assign m_arready = s_arready;
  //r
  assign m_rid     = m_rvalid ? s_rid : 4'd0;  //validæœ‰æ•ˆåˆ™è¡¨ç¤ºä»è®¾å¤‡å·²å°†æ•°æ®ç»™å‡ºï¼Œèµ‹å€¼s_rid
  assign m_rdata = m_rvalid ? s_rdata : 32'd0;
  assign m_rresp = m_rvalid ? s_rresp : 2'd0;
  assign m_rlast = m_rvalid ? s_rlast : 1'd0;
  assign m_rvalid = s_rvalid;
  assign s_rready = m_rready;
  //aw
  assign s_awid = m_awid;
  assign s_awaddr = m_awaddr;
  assign s_awlen = m_awlen;
  assign s_awsize = m_awsize;
  assign s_awburst = m_awburst;
  assign s_awlock = m_awlock;
  assign s_awcache = m_awcache;
  assign s_awprot = m_awprot;
  assign s_awvalid = m_awvalid;
  assign m_awready = s_awready;
  //w
  assign s_wid = m_wid;
  assign s_wdata = m_wdata;
  assign s_wstrb = m_wstrb;
  assign s_wlast = m_wlast;
  assign s_wvalid = m_wvalid;
  assign m_wready = s_wready;
  //b
  assign m_bid = m_bvalid ? s_bid : 4'd0;
  assign m_bresp = m_bvalid ? s_bresp : 2'd0;
  assign m_bvalid = s_bvalid;
  assign s_bready = m_bready;
endmodule

```

[^æ³¨é‡Š1]: çªå‘ä¼ è¾“å³Burst transmissionï¼Œæ˜¯æŒ‡åœ¨åŒä¸€è¡Œç›¸é‚»çš„å­˜å‚¨å•å…ƒä¹‹é—´è¿ç»­è¿›è¡Œæ•°æ®ä¼ è¾“çš„æ–¹å¼ï¼Œè¿ç»­ä¼ è¾“çš„å‘¨æœŸæ•°å°±æ˜¯çªå‘é•¿åº¦Burst Length(BL)

[^æ³¨é‡Š2]: å†™åœ°å€ã€å†™æ•°æ®ã€å†™å“åº”ã€è¯»åœ°å€ã€è¯»å“åº”

    å†™åœ°å€ã€è¯»åœ°å€é€šé“ç”¨äºä¼ é€è¯»å†™çš„ç›®æ ‡åœ°å€ã€æ•°æ®å®½åº¦ã€ä¼ è¾“é•¿åº¦å’Œå…¶ä»–æ§åˆ¶ä¿¡æ¯
    å†™æ•°æ®é€šé“ç”¨äºç”±ä¸»è®¾å¤‡å‘ä»è®¾å¤‡ä¼ é€å†™æ•°æ®ï¼ŒAXIä¹Ÿæ”¯æŒå¸¦æ©ç çš„å†™æ“ä½œ
    å†™å“åº”é€šé“ç”¨æ¥ä¼ é€å†™å®Œæˆä¿¡æ¯
    è¯»å“åº”é€šé“ç”¨äºä¼ é€ä»è®¾å¤‡è¯»å‡ºçš„æ•°æ®ä»¥åŠå“åº”ä¿¡æ¯

[^æ³¨é‡Š3]: è¡¨æ ¼ä¸­æ²¡æœ‰

[^æ³¨é‡Š4]: æä¾›æ•°æ®çš„è®¾å¤‡ç«¯è¾“å‡ºçš„ä¿¡å·

[^æ³¨é‡Š5]: æ¥æ”¶æ•°æ®çš„è®¾å¤‡ç«¯è¾“å‡ºçš„ä¿¡å·

[^æ³¨é‡Š6]: ç”¨æ¥ä¼ è¾“åœ°å€å’Œå…¶ä»–æ§åˆ¶ä¿¡æ¯

[^æ³¨é‡Š7]: ä½¿ç”¨è¿™ç§æ–¹æ³•çš„åŸå› ï¼š
    1\. ä¸€éƒ¨åˆ†åˆå­¦è€…å®Œå…¨ä¸çŸ¥é“å¦‚ä½•ä»ç°æœ‰å–æŒ‡å’Œè®¿å­˜çš„SRAMæ¥å£æ”¹å‡ºAXIæ¥å£
    2\. ä¸€éƒ¨åˆ†åˆå­¦è€…è¿‡äºæ¿€è¿›åœ°ä½¿ç”¨AXIåè®®ç‰¹æ€§ï¼Œå®ç°è¿‡äºå¤æ‚å‡ºç°å¤§é‡é”™è¯¯

[^æ³¨é‡Š8]: åªæ˜¯åœ¨SRAMæ¥å£çš„åŸºç¡€ä¸Šå¢åŠ äº†æ¡æ‰‹ä¿¡å·

[^æ³¨é‡Š9]: CPU

[^æ³¨é‡Š10]: ä»è®¾å¤‡
