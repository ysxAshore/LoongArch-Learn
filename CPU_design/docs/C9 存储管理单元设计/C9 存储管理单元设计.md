# C9 å­˜å‚¨ç®¡ç†å•å…ƒè®¾è®¡

## ç›®å½•

- [1 MMUç›¸å…³è§„èŒƒå®šä¹‰](#1-MMUç›¸å…³è§„èŒƒå®šä¹‰)
  - [1.1 æŒ‡ä»¤é›†æ‰‹å†Œç›¸å…³è§„å®š](#11-æŒ‡ä»¤é›†æ‰‹å†Œç›¸å…³è§„å®š)
  - [1.2 CPU ç¡¬ä»¶æ–¹é¢åœ¨è¿›è¡Œè®¿å­˜è™šå®åœ°å€è½¬æ¢æ—¶åŸºæœ¬è¿‡ç¨‹](#12-CPU-ç¡¬ä»¶æ–¹é¢åœ¨è¿›è¡Œè®¿å­˜è™šå®åœ°å€è½¬æ¢æ—¶åŸºæœ¬è¿‡ç¨‹)
  - [1.3 è™šå®åœ°å€è½¬æ¢è¿‡ç¨‹ä¸­æ‰€éœ€çš„ä¿¡æ¯è½¯ä»¶æ–¹é¢æ˜¯å¦‚ä½•è¿›è¡Œé…ç½®çš„](#13-è™šå®åœ°å€è½¬æ¢è¿‡ç¨‹ä¸­æ‰€éœ€çš„ä¿¡æ¯è½¯ä»¶æ–¹é¢æ˜¯å¦‚ä½•è¿›è¡Œé…ç½®çš„)
  - [1.4 å¼•å…¥æ˜ å°„åœ°å€ç¿»è¯‘æ¨¡å¼è€Œåœ¨å®ç°ä¸­éœ€è¦æ–°å¢çš„å¼‚å¸¸](#14-å¼•å…¥æ˜ å°„åœ°å€ç¿»è¯‘æ¨¡å¼è€Œåœ¨å®ç°ä¸­éœ€è¦æ–°å¢çš„å¼‚å¸¸)
- [2 TLBæ¨¡å—è®¾è®¡åˆ†æ](#2-TLBæ¨¡å—è®¾è®¡åˆ†æ)
  - [2.1 åˆ†æè¦ç‚¹](#21-åˆ†æè¦ç‚¹)
  - [2.2 è®¾è®¡å®ç°](#22-è®¾è®¡å®ç°)
- [3 MMUç›¸å…³CSRä¸æŒ‡ä»¤çš„å®ç°](#3-MMUç›¸å…³CSRä¸æŒ‡ä»¤çš„å®ç°)
  - [3.1 MMUç›¸å…³CSRè®¾è®¡å®ç°](#31-MMUç›¸å…³CSRè®¾è®¡å®ç°)
  - [3.2 MMUç›¸å…³çš„TLBæŒ‡ä»¤å®ç°](#32-MMUç›¸å…³çš„TLBæŒ‡ä»¤å®ç°)
    - [3.2.1 TLBSRCH](#321-TLBSRCH)
    - [3.2.2 TLBWRã€TLBFILL](#322-TLBWRTLBFILL)
    - [3.2.3 TLBRDæŒ‡ä»¤](#323-TLBRDæŒ‡ä»¤)
    - [3.2.4 INVTLB](#324-INVTLB)
    - [3.2.5 è®¾è®¡ç»¼è¿°](#325-è®¾è®¡ç»¼è¿°)
- [4 MMU åœ°å€è½¬æ¢ä»¥åŠç›¸å…³å¼‚å¸¸çš„å®ç°](#4-MMU-åœ°å€è½¬æ¢ä»¥åŠç›¸å…³å¼‚å¸¸çš„å®ç°)
  - [4.1 åœ°å€è½¬æ¢çš„å®ç°](#41-åœ°å€è½¬æ¢çš„å®ç°)
    - [4.1.1 preIFå–æŒ‡çš„åœ°å€è½¬æ¢](#411-preIFå–æŒ‡çš„åœ°å€è½¬æ¢)
    - [4.1.2 EXEè®¿å­˜çš„åœ°å€è½¬æ¢](#412-EXEè®¿å­˜çš„åœ°å€è½¬æ¢)
  - [4.2 TLBå¼‚å¸¸çš„æ·»åŠ ](#42-TLBå¼‚å¸¸çš„æ·»åŠ )
    - [4.2.1 preIFæ—¶çš„PPIã€TLBRã€PPF](#421-preIFæ—¶çš„PPITLBRPPF)
    - [4.2.2 exeæ—¶çš„PPLã€PPSã€TLBRã€PPIã€PME](#422-exeæ—¶çš„PPLPPSTLBRPPIPME)

å­˜å‚¨ç®¡ç†å•å…ƒMMUå³CPUä¸­å‚ä¸å­˜å‚¨ç®¡ç†çš„é€»è¾‘å•å…ƒ

ä¹‹å‰æ‰€è®¾è®¡çš„CPUé‡‡ç”¨çš„å­˜å‚¨ç®¡ç†æ¨¡å¼æ˜¯ç›´æ¥åœ°å€ç¿»è¯‘æ¨¡å¼ï¼Œæœ¬ç« è®²å®ŒæˆMMUçš„å…¶ä½™éƒ¨åˆ†è®¾è®¡ã€‚å°†æ•´ä¸ªè®¾è®¡åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š

1. è®¾è®¡TLBæ¨¡å—
2. å°†TLBæ¨¡å—é›†æˆè‡³ä¹‹å‰æ‰€è®¾è®¡çš„CPUï¼Œå¹¶å®ç°MMUç›¸å…³æŒ‡ä»¤å’ŒCSR
3. æ·»åŠ MMUç›¸å…³å¼‚å¸¸çš„æ”¯æŒ

## 1 MMUç›¸å…³è§„èŒƒå®šä¹‰

### 1.1 æŒ‡ä»¤é›†æ‰‹å†Œç›¸å…³è§„å®š

[5 å­˜å‚¨ç®¡ç†](https://www.wolai.com/3Bi7YfUMYQzaS1pwQ8hsLC "5 å­˜å‚¨ç®¡ç†")

### 1.2 CPU ç¡¬ä»¶æ–¹é¢åœ¨è¿›è¡Œè®¿å­˜è™šå®åœ°å€è½¬æ¢æ—¶åŸºæœ¬è¿‡ç¨‹

1. æ ¹æ®CSR.CRMD.PGå’ŒCSR.CRMD.DAåˆ¤æ–­å½“å‰MMUçš„åœ°å€ç¿»è¯‘æ¨¡å¼

   PG=0.DA=1â†’ç›´æ¥åœ°å€ç¿»è¯‘æ¨¡å¼

   PG=1.DA=0â†’æ˜ å°„åœ°å€ç¿»è¯‘æ¨¡å¼
2. å¦‚æœæ˜¯ç›´æ¥åœ°å€ç¿»è¯‘æ¨¡å¼ï¼Œé‚£ä¹ˆè™šåœ°å€å³ä¸ºç‰©ç†åœ°å€ï¼Œä¸è¶³è¡¥0
3. å¦‚æœæ˜¯æ˜ å°„åœ°å€ç¿»è¯‘æ¨¡å¼
   1. å…ˆçœ‹è™šåœ°å€æ˜¯å¦æœ‰å‘½ä¸­ç›´æ¥æ˜ å°„é…ç½®çª—å£ï¼Œå¦‚æœæœ‰åˆ™ä½¿ç”¨è¯¥é…ç½®çª—å£è¿›è¡Œåœ°å€è½¬æ¢

      å‘½ä¸­çš„åˆ¤å®šï¼šva\[31:29]==CSR.DMW0/1.VSEGä¸”CSR.CRMD.PLVå…è®¸è®¿é—®è¯¥çª—å£
   2. å¦‚æœæ²¡å‘½ä¸­åˆ™æŸ¥æ‰¾TLBï¼Œå¦‚æœ TLB ä¸­å¯ä»¥æ‰¾åˆ°ä¸€ä¸ªåˆæ³•é¡µè¡¨é¡¹åˆ™åŸºäºè¯¥é¡µè¡¨é¡¹ä¿¡æ¯è½¬æ¢å‡ºç‰©ç†åœ° å€ï¼Œå¦åˆ™å°†è§¦å‘ç›¸åº”çš„å¼‚å¸¸ç”±ç³»ç»Ÿè½¯ä»¶åšè¿›ä¸€æ­¥å¤„ç†

      TLB foundçš„åˆ¤å®šï¼šTLBé¡¹æœ‰æ•ˆä¸”ASIDç›¸ç­‰æˆ–è€…ä¸ç”¨åˆ¤æ–­ASIDä¸”è™šåœ°å€ç›¸ç­‰

      å¦‚æœæ²¡æ‰¾åˆ°åˆ™è§¦å‘TLBR

      å¦‚æœæ‰¾åˆ°äº†ä½†æ˜¯é¡µè¡¨é¡¹æ— æ•ˆï¼Œé‚£ä¹ˆæ ¹æ®è®¿å­˜ç±»å‹è§¦å‘è¡¨é¡¹æ— æ•ˆå¼‚å¸¸PIFã€PILã€PIS

      å¦‚æœæ‰¾åˆ°äº†ä¸”è¡¨é¡¹æœ‰æ•ˆï¼Œä½†ç‰¹æƒç­‰çº§ä¸å…è®¸ï¼Œåˆ™è§¦å‘PPI

      å¦‚æœæ‰¾åˆ°äº†ä¸”è¡¨é¡¹æœ‰æ•ˆä¸”ç‰¹æƒç­‰çº§å…è®¸ï¼Œä½†æ˜¯å½“å‰æ˜¯storeæ“ä½œä½†é¡µè¡¨é¡¹ä¸å…è®¸ä¿®æ”¹D=0ï¼Œåˆ™è§¦å‘PME

      éƒ½æ²¡æœ‰è§¦å‘åˆ™è¿›è¡Œåœ°å€è½¬æ¢

### 1.3 è™šå®åœ°å€è½¬æ¢è¿‡ç¨‹ä¸­æ‰€éœ€çš„ä¿¡æ¯è½¯ä»¶æ–¹é¢æ˜¯å¦‚ä½•è¿›è¡Œé…ç½®çš„

1. å¯¹äºç”¨æ¥åŒºåˆ†ç›´æ¥åœ°å€ç¿»è¯‘æ¨¡å¼å’Œæ˜ å°„åœ°å€ç¿»è¯‘æ¨¡å¼çš„åŒºåˆ† CSR.CRMD. PG/DA ï¼Œæ ¸å¿ƒæ€è½¯ä»¶å¯ä»¥ç”¨ CSR æŒ‡ä»¤è¿›è¡Œä¿®æ”¹
2. ç›´æ¥æ˜ å°„çª—å£çš„ä¿¡æ¯éƒ½å­˜æ”¾åœ¨ DMW0 å’Œ DMW1 ä¸­ï¼Œæ ¸å¿ƒæ€è½¯ä»¶ä½¿ç”¨ CSR æŒ‡ä»¤è¿›è¡Œä¿®æ”¹
3. TLBè¯»æ—¶ï¼Œå…ˆè¦ç”¨TLBRDæŒ‡ä»¤å°†TLBè¡¨é¡¹çš„å†…å®¹è¯»å‡ºåˆ°å¯¹åº”çš„CSRä¸­ï¼Œç„¶åæ ¸å¿ƒæ€è½¯ä»¶å†ç”¨CSRè¯»æŒ‡ä»¤ä»CSRä¸­è¯»å‡º
4. TLBå†™æ—¶ï¼Œæ ¸å¿ƒæ€è½¯ä»¶å…ˆè¦ç”¨CSRå†™æŒ‡ä»¤å†™å¯¹åº”çš„CSRï¼Œç„¶åå†ç”¨TLBWRæˆ–è€…TLBFILLå°†CSRä¸­çš„ä¿¡æ¯å†™TLB

### 1.4 å¼•å…¥æ˜ å°„åœ°å€ç¿»è¯‘æ¨¡å¼è€Œåœ¨å®ç°ä¸­éœ€è¦æ–°å¢çš„å¼‚å¸¸

> LA64ä¸­ï¼Œæ˜ å°„æ¨¡å¼ä¸‹ä¼šæœ‰åˆæ³•è™šæ‹Ÿåœ°å€çš„æ¦‚å¿µï¼Œå› æ­¤ADEFã€ADEMçš„åˆ¤å®šæ¡ä»¶éœ€è¦å¢åŠ â€”â€”æ— æ³•å‘½ä¸­ç›´æ¥æ˜ å°„çª—å£æ—¶çš„éæ³•è™šæ‹Ÿåœ°å€è§¦å‘åœ°å€é”™å¼‚å¸¸
>
> ä½†æ˜¯åœ¨LA32Rä¸­ï¼Œæ•´ä¸ªè™šæ‹Ÿåœ°å€ç©ºé—´éƒ½æ˜¯åˆæ³•çš„ï¼Œä¸ç”¨å¢åŠ è¿™ä¸ªåˆ¤å®š

TLBç›¸å…³çš„å¼‚å¸¸éœ€è¦å†™CSR.BADVï¼Œä»¥åŠTLBRçš„æœåŠ¡ç¨‹åºå…¥å£åœ°å€ç”±CSR.TLBENRTYé…ç½®

## 2 TLBæ¨¡å—è®¾è®¡åˆ†æ

### 2.1 åˆ†æè¦ç‚¹

1. æ¯ä¸€ä¸ªTLBè¡¨é¡¹åŒ…æ‹¬ä¸¤éƒ¨åˆ†ï¼šæ¯”è¾ƒéƒ¨åˆ†+ç‰©ç†è½¬æ¢éƒ¨åˆ†ã€‚TLBçš„é¡¹æ•°è‡ªå®šä¹‰

   æ¯”è¾ƒéƒ¨åˆ†çš„ä¿¡æ¯åŒ…æ‹¬ï¼šEã€VPPNã€PSã€ASIDã€Gï¼Œæ—¢å‚ä¸è¯»å†™åˆå‚ä¸æŸ¥æ‰¾

   ç‰©ç†è½¬æ¢éƒ¨åˆ†åŒ…æ‹¬ä¸¤ä¸ªç›¸é‚»çš„å¥‡å¶é¡µè¡¨ï¼šPPN0ã€PLV0ã€MAT0ã€D0ã€V0å’ŒPPN1ã€PLV1ã€MAT1ã€D1ã€V1ï¼Œåªå‚ä¸è¯»å†™
2. TLB æ¨¡å—è¦æ”¯æŒå–æŒ‡å’Œè®¿å­˜ä¸¤ä¸ªéƒ¨åˆ†çš„è™šå®åœ°å€è½¬æ¢éœ€æ±‚ï¼Œå³ä¸¤éƒ¨åˆ†éƒ½éœ€è¦å¯¹ TLB æ¨¡å—è¿›è¡ŒæŸ¥æ‰¾ï¼Œä¸”ä¸¤éƒ¨åˆ†å¯¹åº”çš„æŸ¥æ‰¾åŠŸèƒ½ä¸€è‡´ã€‚ä¸”ä¸ºäº†æµæ°´æ•ˆç‡ï¼Œéœ€è¦æ”¯æŒåŒæ—¶æŸ¥æ‰¾

   è®¾ç½®ä¸¤å¥—æŸ¥æ‰¾ç«¯å£

   æŸ¥æ‰¾ç«¯å£çš„è¾“å…¥æ˜¯`s_vppn`ï¼ˆé»˜è®¤æ˜¯31...13ï¼Œå½“pså¤§äº4KBæ—¶ï¼Œæˆªå–é«˜ä½ï¼Œps-13ä½œä¸ºvaï¼‰ï¼Œ`s_va_bit12`ï¼ˆé»˜è®¤æ˜¯12ï¼Œ4KBï¼‰å’Œ`s_asid`ï¼ˆCSR.ASID.ASIDï¼‰

   æŸ¥æ‰¾ç«¯å£çš„è¾“å‡ºæ˜¯`s_found`ï¼Œ`s_ppn`ï¼Œ`s_ps`ï¼Œ`s_plv`ï¼Œ`s_mat`ï¼Œ`s_d`å’Œ`s_v`ä»¥åŠæ‰¾åˆ°çš„ç´¢å¼•å·
3. TLBæ¨¡å—éœ€è¦æ”¯æŒTLBSRCHæŒ‡ä»¤çš„æŸ¥æ‰¾æ“ä½œ

   å¤ç”¨2çš„æŸ¥æ‰¾ç«¯å£ï¼Œå³è¾“å…¥å¤ç”¨è®¿å­˜çš„s\_vppnã€s\_asidï¼Œè¾“å‡ºå¤ç”¨s\_foundâ€”â€”ä¸éœ€è¦ä»ç‰©ç†è½¬æ¢éƒ¨åˆ†ä¸­å¾—åˆ°è½¬æ¢ä¿¡æ¯ï¼Œå› æ­¤ä¸éœ€è¦s\_va\_bit12ã€‚æ­¤å¤–éœ€è¦è¾“å‡ºè¡¨é¡¹ç´¢å¼•è‡³s\_indexç”¨äºå¡«å……CSR.TLBIDX
4. TLBæ¨¡å—éœ€è¦æ”¯æŒTLBWRå’ŒTLBFILLæŒ‡ä»¤çš„å†™æ“ä½œï¼ŒCSRå¯¹åº”å†…å®¹èµ‹å€¼ç»™è¿™äº›å†™ä¿¡å·

   è®¾ç«‹å•ç‹¬çš„å†™ç«¯å£ï¼Œå†™TLBè¡¨é¡¹çš„å…¨éƒ¨å†…å®¹

   éœ€è¦æœ‰å†™ä½¿èƒ½weã€å†™åœ°å€w\_indexä»¥åŠå¯¹åº”å†…å®¹çš„å†™ä¿¡å·w\_eã€w\_vppnã€w\_psã€ w\_asidã€w\_gã€w\_ppn0ã€w\_plv0ã€w\_mat0ã€w\_d0ã€w\_v0ã€w\_ppn1ã€w\_mat1ã€w\_mat1ã€w\_d1ã€ w\_v1
5. TLBæ¨¡å—éœ€è¦æ”¯æŒTLBRDæŒ‡ä»¤çš„è¯»æ“ä½œï¼Œè¯»çš„å†…å®¹èµ‹å€¼ç»™CSRå¯¹åº”å†…å®¹

   è®¾ç«‹å•ç‹¬çš„è¯»ç«¯å£ï¼Œè¯»TLBè¡¨é¡¹çš„å…¨éƒ¨å†…å®¹

   éœ€è¦æœ‰è¯»åœ°å€r\_indexä»¥åŠå¯¹åº”å†…å®¹çš„å†™ä¿¡å·r\_eã€r\_vppnã€r\_psã€r\_asidã€ r\_gã€r\_ppn0ã€r\_plv0ã€r\_mat0ã€r\_d0ã€r\_v0ã€r\_ppn1ã€r\_plv1ã€r\_mat1ã€r\_d1ã€r\_v1
6. TLB æ¨¡å—éœ€è¦æ”¯æŒ INVTLB æŒ‡ä»¤çš„æŸ¥æ‰¾ã€æ— æ•ˆæ“ä½œ

   å¤ç”¨è®¿å­˜çš„æŸ¥æ‰¾ç«¯å£s\_vppnã€s\_asid

   åŒæ—¶éœ€è¦è¾“å…¥opï¼Œæ ¹æ®opçš„å€¼æ¥å°†ç¬¦åˆåˆ¤æ–­æ¡ä»¶çš„TLBè¡¨é¡¹Eå¤ä½

### 2.2 è®¾è®¡å®ç°

1. é‡‡ç”¨ç»„åˆé€»è¾‘ï¼ŒåŠ å¿«é€Ÿåº¦ï¼ŒåŒæ—¶æ¯”å¯¹æ‰€æœ‰è¡¨é¡¹ï¼Œæ¯ä¸€é¡¹çš„æ¯”å¯¹ç»“æœå€¼å­˜æ”¾åˆ°ä¸€ä¸ªæ•°ç»„çš„è¯¥è¡¨é¡¹ç´¢å¼•å€¼å¤„ã€‚foundä¿¡å·åˆ™ä¸º|æ•°ç»„
2. æ¯”å¯¹æ¡ä»¶æ˜¯ï¼š`è¡¨é¡¹æœ‰æ•ˆ & (G| ASIDåŒ¹é…) & (è™šåœ°å€åŒ¹é…)`ï¼Œå…¶ä¸­è™šåœ°å€åŒ¹é…éœ€è¦å‚è€ƒPSå€¼åšä¸åŒçš„æ¯”å¯¹å¤„ç†

   å› ä¸ºLA32Rçš„é¡µå¤§å°åªèƒ½æ˜¯4KBå’Œ4MBï¼Œæ‰€ä»¥å¯¹åº”çš„PSå€¼åªèƒ½æ˜¯12å’Œ21ï¼Œå¯¹åº”çš„è™šåœ°å€æ¯”è¾ƒä¹Ÿåªæœ‰ä¸¤ç§ï¼š12æ—¶s\_vppnï¼Œ21æ—¶s\_vppn\[18:9]

   æ•´åˆå‘ç°12å’Œ22æ—¶éƒ½æ¯”è¾ƒs\_vppn\[18:9]
3. å¯¹invtlb opæ‰€è¿›è¡Œçš„å„ç§æ£€ç´¢è®¾ç½®åŸå­ï¼Œç„¶åæŒ‰ç…§å¯¹åº”çš„opå¯¹æ¯”è¾ƒä¿¡æ¯çš„æ•°ç»„è¿›è¡ŒæŒ‰ä½ç»„åˆï¼Œç„¶åæ¸…é™¤å¯¹åº”çš„é¡µè¡¨é¡¹E

   ![](image/image_XuWUjvjqlr.png)

   æ ¹æ®ä¸Šè¡¨æ‰€ç¤ºï¼Œå…±æœ‰4ç§åŸå­ï¼šG=1ã€G=0ã€ASIDç›¸ç­‰ã€VAç›¸ç­‰&#x20;

   0x0å’Œ0x1æ˜¯å…¨éƒ¨è¡¨é¡¹
   0x2æ˜¯G=1
   0x3æ˜¯G=0
   0x4æ˜¯G=0 & ASID\_EQU
   0x5æ˜¯G=0 & ASID\_EQU & VA\_EQU
   0x6æ˜¯(G=1 | ASID\_EQU) & VA\_EQU
4. éœ€è¦æ³¨æ„ä¸èƒ½æœ‰å¤šä¸ªfoundï¼Œç¡¬ä»¶è®¾ç½®å°åºä¼˜å…ˆ
5. è¯»å‡ºæ•°æ®æ—¶çš„å¥‡å¶é¡µé€‰æ‹©

   å¦‚æœpsæ˜¯12ï¼Œé‚£ä¹ˆæ ¹æ®ç»™å®šçš„s0/1\_va\_bit12é€‰æ‹©

   å¦‚æœpsæ˜¯21ï¼Œé‚£ä¹ˆæ ¹æ®æ­¤æ—¶è™šé¡µå·æœ€ä½ä½æ˜¯åŸæ¥vaçš„\[21]ä½ï¼Œæ¢ç®—åˆ°ç»™å®šçš„s0/1\_vppnå°±æ˜¯å¤šäº†8ä½ï¼Œå³\[8]

```verilog
module tlb #(
    parameter NUM = 32
) (
    input clk,
    //ä¸ç”¨ç¡¬ä»¶åˆå§‹åŒ–ï¼Œå› æ­¤ä¸éœ€è¦èµ‹å€¼ä¿¡å· 

    //å–æŒ‡
    input wire [18:0] s0_vppn,
    input wire s0_va_bit12,
    input wire [9:0] s0_asid,
    output wire s0_found,
    output wire [19:0] s0_ppn,
    output wire [5:0] s0_ps,
    output wire [1:0] s0_plv,
    output wire [1:0] s0_mat,
    output wire s0_d,
    output wire s0_v,
    output wire [$clog2(
NUM
)-1:0] s0_findex,  //è¾“å‡ºindexï¼Œé»˜è®¤æ˜¯5ä½â€”â€”TLBHIé‡Œçš„indexä¹Ÿè®¾ç½®äº†5ä½

    //è®¿å­˜
    input wire [18:0] s1_vppn,
    input wire s1_va_bit12,
    input wire [9:0] s1_asid,
    output wire s1_found,
    output wire [19:0] s1_ppn,
    output wire [5:0] s1_ps,
    output wire [1:0] s1_plv,
    output wire [1:0] s1_mat,
    output wire s1_d,
    output wire s1_v,
    output wire [$clog2(NUM)-1:0] s1_findex,

    //TLBSRCH ç´¢å¼•ç«¯å£å·²ç»åˆ—å‡º

    //TLBWRã€TLBFILL
    input wire we,
    input wire [$clog2(NUM)-1:0] w_index,
    input wire w_e,
    input wire [18:0] w_vppn,
    input wire [5:0] w_ps,
    input wire [9:0] w_asid,
    input wire w_g,
    input wire [19:0] w_ppn0,
    input wire [1:0] w_plv0,
    input wire [1:0] w_mat0,
    input wire w_d0,
    input wire w_v0,
    input wire [19:0] w_ppn1,
    input wire [1:0] w_plv1,
    input wire [1:0] w_mat1,
    input wire w_d1,
    input wire w_v1,

    //TLBRD
    input wire [$clog2(NUM)-1:0] r_index,
    output wire r_e,
    output wire [18:0] r_vppn,
    output wire [5:0] r_ps,
    output wire [9:0] r_asid,
    output wire r_g,
    output wire [19:0] r_ppn0,
    output wire [1:0] r_plv0,
    output wire [1:0] r_mat0,
    output wire r_d0,
    output wire r_v0,
    output wire [19:0] r_ppn1,
    output wire [1:0] r_plv1,
    output wire [1:0] r_mat1,
    output wire r_d1,
    output wire r_v1,

    //INVTLB
    input wire invtlb_valid,  //è¡¨ç¤ºè¿›è¡Œinvtlbæ“ä½œ
    input [4:0] op  //è¶…è¿‡6æ—¶è§¦å‘ine
);
  reg        tlb_e   [NUM-1:0];
  reg [18:0] tlb_vppn[NUM-1:0];
  reg [ 5:0] tlb_ps  [NUM-1:0];
  reg [ 9:0] tlb_asid[NUM-1:0];
  reg        tlb_g   [NUM-1:0];
  reg [19:0] ppn0    [NUM-1:0];
  reg [ 1:0] plv0    [NUM-1:0];
  reg [ 1:0] mat0    [NUM-1:0];
  reg        d0      [NUM-1:0];
  reg        v0      [NUM-1:0];
  reg [19:0] ppn1    [NUM-1:0];
  reg [ 1:0] plv1    [NUM-1:0];
  reg [ 1:0] mat1    [NUM-1:0];
  reg        d1      [NUM-1:0];
  reg        v1      [NUM-1:0];

  //WRITE
  always @(posedge clk) begin
    if (we) begin
      tlb_e[w_index] <= w_e;
      tlb_vppn[w_index] <= w_vppn;
      tlb_ps[w_index] <= w_ps;
      tlb_asid[w_index] <= w_asid;
      tlb_g[w_index] <= w_g;
      ppn0[w_index] <= w_ppn0;
      plv0[w_index] <= w_plv0;
      mat0[w_index] <= w_mat0;
      d0[w_index] <= w_d0;
      v0[w_index] <= w_v0;
      ppn1[w_index] <= w_ppn1;
      plv1[w_index] <= w_plv1;
      mat1[w_index] <= w_mat1;
      d1[w_index] <= w_d1;
      v1[w_index] <= w_v1;
    end
  end

  //READ
  assign r_e = tlb_e[r_index];
  assign r_vppn = tlb_vppn[r_index];
  assign r_ps = tlb_ps[r_index];
  assign r_asid = tlb_asid[r_index];
  assign r_g = tlb_g[r_index];
  assign r_ppn0 = ppn0[r_index];
  assign r_plv0 = plv0[r_index];
  assign r_mat0 = mat0[r_index];
  assign r_d0 = d0[r_index];
  assign r_v0 = v0[r_index];
  assign r_ppn1 = ppn1[r_index];
  assign r_plv1 = plv1[r_index];
  assign r_mat1 = mat1[r_index];
  assign r_d1 = d1[r_index];
  assign r_v1 = v1[r_index];

  //TLBSRCHã€å–æŒ‡ã€è®¿å­˜
  wire [NUM-1:0] match_item0;  //å–æŒ‡
  wire [NUM-1:0] match_item1;  //è®¿å­˜+TLBSRCH

  //æ‰¾ä¸€ä¸ªå‘½ä¸­çš„å°±è¡Œï¼Œå‡ºç°å¤šä¸ªå‘½ä¸­æ—¶å¤„ç†å™¨çš„ç»“æœä¸ç¡®å®š è¿™é‡Œç»™å®šä¸€ä¸ªä¼˜å…ˆçº§ åºå·å°çš„å…ˆè¢«æ‰¾åˆ°
  assign match_item0[0] = tlb_e[0] 
                            & (tlb_g[0] | tlb_asid[0] == s0_asid) 
                            & tlb_vppn[0][18:9] == s0_vppn[18:9] & (tlb_ps[0] == 6'd21 | tlb_vppn[0][8:0] == s0_vppn[8:0]);
  assign match_item1[0] = tlb_e[0] 
                            & (tlb_g[0] | tlb_asid[0] == s1_asid) 
                            & tlb_vppn[0][18:9] == s1_vppn[18:9] & (tlb_ps[0] == 6'd21 | tlb_vppn[0][8:0] == s1_vppn[8:0]);

  genvar i;
  generate
    for (i = 1; i < NUM; i = i + 1) begin
      assign match_item0[i] = tlb_e[i] 
                             & (tlb_g[i] | tlb_asid[i] == s0_asid) 
                             & tlb_vppn[i][18:9] == s0_vppn[18:9] & (tlb_ps[i] == 6'd21 | tlb_vppn[i][8:0] == s0_vppn[8:0])
                             & ~|match_item0[i-1:0];//ä¹‹å‰çš„æ²¡æœ‰å‘½ä¸­çš„

      assign match_item1[i] = tlb_e[i] 
                             & (tlb_g[i] | tlb_asid[i] == s1_asid) 
                             & tlb_vppn[i][18:9] == s1_vppn[18:9] & (tlb_ps[i] == 6'd21 | tlb_vppn[i][8:0] == s1_vppn[8:0])
                             & ~|match_item1[i-1:0];//ä¹‹å‰çš„æ²¡æœ‰å‘½ä¸­çš„
    end
  endgenerate

  assign s0_found = |match_item0;
  assign s1_found = |match_item1;

  parameter WIDTH = 32 + $clog2(NUM);

  //æ ¹æ®è¢«æŸ¥æ‰¾è™šé¡µå·çš„æœ€ä½ä½                                                                              
  wire [WIDTH-1:0] res_temp0[NUM-1:0];
  wire [WIDTH-1:0] res_temp1[NUM-1:0];
  assign res_temp0[0] = {WIDTH{match_item0[0]}} & {tlb_ps[0] == 6'd12 & s0_va_bit12 |  tlb_ps[0] == 6'd21 & s0_vppn[8] ? ppn1[0] : ppn0[0],
                                                                                        tlb_ps[0],
                                                                                        tlb_ps[0] == 6'd12 & s0_va_bit12 | tlb_ps[0] == 6'd21 & s0_vppn[8] ? plv1[0] : plv0[0],
                                                                                        tlb_ps[0] == 6'd12 & s0_va_bit12 | tlb_ps[0] == 6'd21 & s0_vppn[8] ? mat1[0] : mat0[0],
                                                                                        tlb_ps[0] == 6'd12 & s0_va_bit12 | tlb_ps[0] == 6'd21 & s0_vppn[8] ? d1[0] : d0[0],
                                                                                        tlb_ps[0] == 6'd12 & s0_va_bit12 | tlb_ps[0] == 6'd21 & s0_vppn[8] ? v1[0] : v0[0],
                                                                                        {$clog2(
      NUM
  ) {1'b0}}};
  assign res_temp1[0] = {WIDTH{match_item1[0]}} & {tlb_ps[0] == 6'd12 & s1_va_bit12 |  tlb_ps[0] == 6'd21 & s1_vppn[8] ? ppn1[0] : ppn0[0],
                                                                                        tlb_ps[0],
                                                                                        tlb_ps[0] == 6'd12 & s1_va_bit12 | tlb_ps[0] == 6'd21 & s1_vppn[8] ? plv1[0] : plv0[0],
                                                                                        tlb_ps[0] == 6'd12 & s1_va_bit12 | tlb_ps[0] == 6'd21 & s1_vppn[8] ? mat1[0] : mat0[0],
                                                                                        tlb_ps[0] == 6'd12 & s1_va_bit12 | tlb_ps[0] == 6'd21 & s1_vppn[8] ? d1[0] : d0[0],
                                                                                        tlb_ps[0] == 6'd12 & s1_va_bit12 | tlb_ps[0] == 6'd21 & s1_vppn[8] ? v1[0] : v0[0],
                                                                                        {$clog2(
      NUM
  ) {1'b0}}};
  genvar j;
  generate
    for (j = 1; j < NUM; j = j + 1) begin
      assign res_temp0[j] = res_temp0[j-1] | {{WIDTH{match_item0[j]}}} & {tlb_ps[j] == 6'd12 & s0_va_bit12 | tlb_ps[j] == 6'd21 & s0_vppn[8] ? ppn1[j] : ppn0[j],
                                                                             tlb_ps[j],
                                                                             tlb_ps[j] == 6'd12 & s0_va_bit12 | tlb_ps[j] == 6'd21 & s0_vppn[8] ? plv1[j] : plv0[j],
                                                                             tlb_ps[j] == 6'd12 & s0_va_bit12 | tlb_ps[j] == 6'd21 & s0_vppn[8] ? mat1[j] : mat0[j],
                                                                             tlb_ps[j] == 6'd12 & s0_va_bit12 | tlb_ps[j] == 6'd21 & s0_vppn[8] ? d1[j] : d0[j],
                                                                             tlb_ps[j] == 6'd12 & s0_va_bit12 | tlb_ps[j] == 6'd21 & s0_vppn[8] ? v1[j] : v0[j],
                                                                             j[$clog2(
          NUM
      )-1:0]};
      assign res_temp1[j] = res_temp1[j-1] | {{WIDTH{match_item1[j]}}} & {tlb_ps[j] == 6'd12 & s1_va_bit12 | tlb_ps[j] == 6'd21 & s1_vppn[8] ? ppn1[j] : ppn0[j],
                                                                             tlb_ps[j],
                                                                             tlb_ps[j] == 6'd12 & s1_va_bit12 | tlb_ps[j] == 6'd21 & s1_vppn[8] ? plv1[j] : plv0[j],
                                                                             tlb_ps[j] == 6'd12 & s1_va_bit12 | tlb_ps[j] == 6'd21 & s1_vppn[8] ? mat1[j] : mat0[j],
                                                                             tlb_ps[j] == 6'd12 & s1_va_bit12 | tlb_ps[j] == 6'd21 & s1_vppn[8] ? d1[j] : d0[j],
                                                                             tlb_ps[j] == 6'd12 & s1_va_bit12 | tlb_ps[j] == 6'd21 & s1_vppn[8] ? v1[j] : v0[j],
                                                                             j[$clog2(
          NUM
      )-1:0]};
    end
  endgenerate

  assign {s0_ppn, s0_ps, s0_plv, s0_mat, s0_d, s0_v, s0_findex} = res_temp0[NUM-1];
  assign {s1_ppn, s1_ps, s1_plv, s1_mat, s1_d, s1_v, s1_findex} = res_temp1[NUM-1];

  // invtlb è¿™æ ·çš„ç»¼åˆç»“æœæ˜¯ï¼Ÿ
  integer k;
  always @(posedge clk) begin
    if (invtlb_valid) begin
      for (k = 0; k < NUM; k = k + 1) begin
        if (op == 5'h0 | op == 5'h1) begin
          tlb_e[k] <= 1'b0;
        end else if (op == 5'h2 & tlb_g[k]) begin
          tlb_e[k] <= 1'b0;
        end else if (op == 5'h3 & ~tlb_g[k]) begin
          tlb_e[k] <= 1'b0;
        end else if (op == 5'h4 & ~tlb_g[k] & tlb_asid[k] == s1_asid) begin
          tlb_e[k] <= 1'b0;
        end else if (op == 5'h5 & ~tlb_g[k] & tlb_asid[k] == s1_asid & tlb_vppn[k][18:9] == s1_vppn[18:9] & (tlb_ps[0] == 6'd21 | tlb_vppn[k][8:0] == s1_vppn[8:0])) begin
          tlb_e[k] <= 1'b0;
        end else if (op == 5'h6 & (tlb_g[k] | tlb_asid[k] == s1_asid) & tlb_vppn[k][18:9] == s1_vppn[18:9] & (tlb_ps[0] == 6'd21 | tlb_vppn[k][8:0] == s1_vppn[8:0])) begin
          tlb_e[k] <= 1'b0;
        end
      end
    end
  end
endmodule
```

## 3 MMUç›¸å…³CSRä¸æŒ‡ä»¤çš„å®ç°

### 3.1 MMUç›¸å…³CSRè®¾è®¡å®ç°

ä¸MMUç›¸å…³çš„CSRåŒ…æ‹¬ï¼šCRMD.DAã€CRMD.PGã€DMW0ã€DMW1ã€ASIDã€TLBEHIã€TLBELO0ã€TLBELO1ã€TLBIDXã€PGDLã€PGDHã€PGD

å‚è€ƒ7.4 TLBç›¸å…³CSRåŠ ä»¥å®ç°

1. CRMD.DAå’ŒCRMD.PG

   å¤ä½åï¼ŒCRMD.DAä¸º1ï¼ŒCRMD.PGä¸º0

   å½“è§¦å‘é‡å¡«å¼‚å¸¸æ—¶excp\_tlbrefillæœ‰æ•ˆï¼Œåˆ™ç½®DAä¸º1ï¼ŒPGä¸º0

   å½“æ‰§è¡ŒERTNè¿”å›æ—¶ï¼Œè‹¥CSR.ESTAST.Ecode=0x3f[^æ³¨é‡Š1]ï¼Œåˆ™DA=0ï¼ŒPG=1
   ```verilog
     always @(posedge clk) begin
       if (~resetn) begin
         csr_crmd[`PLV]  <= 2'b0;
         csr_crmd[`IE]   <= 1'b0;
         csr_crmd[`DA]   <= 1'b1;
         csr_crmd[`PG]   <= 1'b0;
         csr_crmd[`DATF] <= 2'b0;
         csr_crmd[`DATM] <= 2'b0;
         csr_crmd[31:9]  <= 23'b0;
       end else if (excp) begin
         csr_crmd[`PLV] <= 2'b0;
         csr_crmd[`IE]  <= 1'b0;
         if (excp_tlbrefill) begin
           csr_crmd[`DA] <= 1'b1;
           csr_crmd[`PG] <= 1'b0;
         end
       end else if (ertn) begin
         csr_crmd[`PLV] <= csr_prmd[`PPLV];
         csr_crmd[`IE]  <= csr_prmd[`PIE];
         if (csr_estat[`ECODE] == 6'h3f) begin  //é‡å¡«å¼‚å¸¸
           csr_crmd[`DA] <= 1'b0;
           csr_crmd[`PG] <= 1'b1;
         end
       end else if (crmd_wen) begin
         csr_crmd[`PLV]  <= csrWData[`PLV];
         csr_crmd[`IE]   <= csrWData[`IE];
         csr_crmd[`DA]   <= csrWData[`DA];
         csr_crmd[`PG]   <= csrWData[`PG];
         csr_crmd[`DATF] <= csrWData[`DATF];
         csr_crmd[`DATM] <= csrWData[`DATM];
       end
     end
   ```
2. DMW0\~1

   åªéœ€è¦æŒ‰ç…§æŒ‡å¯¼æ‰‹å†Œå®Œæˆè¯»å†™ã€å¤ä½å³å¯
   ```verilog
     //dmw0
     always @(posedge clk) begin
       if (~resetn) begin
         csr_dmw0[`DMW_PLV0] <= 1'b0;
         csr_dmw0[2:1] <= 2'b0;
         csr_dmw0[`DMW_PLV3] <= 1'b0;
         csr_dmw0[24:6] <= 19'b0;
         csr_dmw0[28] <= 1'b0;
       end else if (dmw0_wen) begin
         csr_dmw0[`DMW_PLV0] <= csrWData[`DMW_PLV0];
         csr_dmw0[`DMW_PLV3] <= csrWData[`DMW_PLV3];
         csr_dmw0[`DMW_MAT]  <= csrWData[`DMW_MAT];
         csr_dmw0[`DMW_PSEG] <= csrWData[`DMW_PSEG];
         csr_dmw0[`DMW_VSEG] <= csrWData[`DMW_VSEG];
       end
     end

     //dmw1
     always @(posedge clk) begin
       if (~resetn) begin
         csr_dmw1[`DMW_PLV0] <= 1'b0;
         csr_dmw1[2:1] <= 2'b0;
         csr_dmw1[`DMW_PLV3] <= 1'b0;
         csr_dmw1[24:6] <= 19'b0;
         csr_dmw1[28] <= 1'b0;
       end else if (dmw1_wen) begin
         csr_dmw1[`DMW_PLV0] <= csrWData[`DMW_PLV0];
         csr_dmw1[`DMW_PLV3] <= csrWData[`DMW_PLV3];
         csr_dmw1[`DMW_MAT]  <= csrWData[`DMW_MAT];
         csr_dmw1[`DMW_PSEG] <= csrWData[`DMW_PSEG];
         csr_dmw1[`DMW_VSEG] <= csrWData[`DMW_VSEG];
       end
     end
   ```
3. ASID

   ASIDçš„å€¼éœ€è¦è¾“å‡ºä½œä¸ºæŸ¥è¯¢TLBçš„ä¾æ®ï¼Œä¸”é™¤äº†CSRæŒ‡ä»¤å¤–ï¼ŒTLBRDæŒ‡ä»¤ä¹Ÿè¦å°†æ‰€è¯»å–çš„TLBè¡¨é¡¹çš„ASIDå€¼å†™åˆ°è¿™é‡Œ

   å› æ­¤ASIDéœ€è¦å¤ä½ã€éœ€è¦è¾“å‡ºCSR.ASIDå€¼ã€éœ€è¦æ ¹æ®TLB.RDæŒ‡ä»¤å°†è¾“å…¥çš„ASIDå€¼æ›´æ–°åˆ°è¯¥åŸŸ
   ```verilog
       //ASIDè¯»å†™
       output [9:0]asid_out,
       input [9:0] asid_in,
       input tlb_rd_wen,
   ```
   ```verilog
     //asid 
     always @(posedge clk) begin
       if (~resetn) begin
         csr_asid[15:10] <= 6'b0;
         csr_asid[31:24] <= 8'b0;
         //ASIDåŸŸä½å®½ä¸º10â€”â€”9:0
         csr_asid[`TLB_ASIDBITS] <= 8'd10;
       end else if(asid_wen) begin
         csr_asid[`TLB_ASID] <= asid_in;
       end
       else else if (asid_wen) begin
         csr_asid[`TLB_ASID] <= csrWData[`TLB_ASID];
       end
     end

     assign asid_out = csr_asid[`TLB_ASID];

   ```
4. TLBEHI

   TLBEHIä¸­çš„VPPNæ—¢éœ€è¦æä¾›ç»™TLBSRCHã€TLBWRã€WLBFILLè¾“å…¥ç»™TLBæ¨¡å—ï¼Œä¹Ÿéœ€è¦å°†TLBRDæŒ‡ä»¤è¯»å‡ºçš„TLBæ¨¡å—VPPNå†™åˆ°æ­¤å¤„ï¼›åŒæ—¶åœ¨è§¦å‘TLBRã€PILã€PIFã€PISã€PIIã€PMEç­‰å¼‚å¸¸æ—¶ï¼Œå°†è™šåœ°å€çš„\[31:13]ä½è®°å½•åœ¨VPPNä¸­

   å› æ­¤éœ€è¦å¢åŠ TLBEHI.VPPNçš„è¾“å‡ºç«¯å£ä»¥åŠè¾“å…¥é‡ï¼Œè™šåœ°å€çš„\[31:13]ä½å¯ä»¥å¤ç”¨å¡«å…¥CSR.BADVçš„badv\_addr(å¯èƒ½æ˜¯pcä¹Ÿå¯èƒ½æ˜¯addr)
   ```verilog
       output [18:0] vppn_out,
       input [18:0] vppn_in,
   ```
   ```verilog
     assign vppn_out = csr_tlbehi[`VPPN];


       //tlbehi
     always @(posedge clk) begin
       if (~resetn) begin
         csr_tlbehi[12:0] <= 13'b0;
       end else if(tlb_rd_wen) begin //è¿™å‡ ä¸ªæ¡ä»¶æ˜¯äº’æ–¥çš„
         csr_tlbehi[`VPPN] <= vppn_in;
       end else if (excpAboutAddr) begin
         csr_tlbehi[`VPPN] <= badv_addr[31:13];
       end else if (tlbehi_wen) begin
         csr_tlbehi[`VPPN] <= csrWData[`VPPN];
       end
     end

   ```
5. TLBELO0\~TLBELO1

   TLBELO0å’ŒTLBELO1ä¸­åŒ…å«çš„æ˜¯TLBæŒ‡ä»¤è¯»å†™TLBè¡¨é¡¹æ—¶çš„ä¸€äº›è®°å½•ä¿¡æ¯ï¼Œå› æ­¤è¿™äº›ä¿¡æ¯éœ€è¦è¾“å…¥ç«¯å£ä¹Ÿéœ€è¦è¾“å‡ºç«¯å£ã€‚å¥‡æ•°é¡µçš„ç‰©ç†è½¬æ¢ä¿¡æ¯å­˜æ”¾åœ¨TLBELO1ä¸­ï¼Œå¶æ•°é¡µçš„ç‰©ç†è½¬æ¢ä¿¡æ¯å­˜æ”¾åœ¨TLBELO0ä¸­
   ```verilog
       //TLBELO
       output [31:0] tlbelo0_out,
       output [31:0] tlbelo1_out,
       input [31:0] tlbelo0_in,
       input [31:0] tlbelo1_in,
   ```
   ```verilog
     assign tlbelo0_out = csr_tlbelo0;
     assign tlbelo1_out = csr_tlbelo1;
     
     //tlbelo0
     always @(posedge clk) begin
       if (~resetn) begin
         csr_tlbelo0[7] <= 1'b0;
       end else if(tlb_rd_wen) begin
         csr_tlbelo0[31:8] <= tlbelo0_in[31:8];
         csr_tlbelo0[6:0] <= tlbelo0_in[6:0];
       end else if (tlbelo0_wen) begin
         csr_tlbelo0[`TLB_V]   <= csrWData[`TLB_V];
         csr_tlbelo0[`TLB_D]   <= csrWData[`TLB_D];
         csr_tlbelo0[`TLB_PLV] <= csrWData[`TLB_PLV];
         csr_tlbelo0[`TLB_MAT] <= csrWData[`TLB_MAT];
         csr_tlbelo0[`TLB_G]   <= csrWData[`TLB_G];
         csr_tlbelo0[`TLB_PPN] <= csrWData[`TLB_PPN];
       end
     end

     //tlbelo1
     always @(posedge clk) begin
       if (~resetn) begin
         csr_tlbelo1[7] <= 1'b0;
       end else if(tlb_rd_wen) begin
         csr_tlbelo1[31:8] <= tlbelo1_in[31:8];
         csr_tlbelo1[6:0] <= tlbelo1_in[6:0];
       end else if (tlbelo0_wen) begin
         csr_tlbelo1[`TLB_V]   <= csrWData[`TLB_V];
         csr_tlbelo1[`TLB_D]   <= csrWData[`TLB_D];
         csr_tlbelo1[`TLB_PLV] <= csrWData[`TLB_PLV];
         csr_tlbelo1[`TLB_MAT] <= csrWData[`TLB_MAT];
         csr_tlbelo1[`TLB_G]   <= csrWData[`TLB_G];
         csr_tlbelo1[`TLB_PPN] <= csrWData[`TLB_PPN];
       end
     end
   ```
6. TLBIDX

   TLBIDXä¸­çš„indexã€psã€neå‡éœ€è¦è¯»å‡ºï¼Œä¾›TLBWRã€TLBFILLå†™TLBè¡¨é¡¹ï¼›è€Œä¹Ÿéœ€è¦å°†TLBRDè¯»å‡ºçš„TLBè¡¨é¡¹å†…å®¹å†™è‡³æ­¤å¤„

   ä¸”å¯¹äºTLBIDX.NEï¼Œæ‰§è¡Œ TLBWR æˆ– TLBFILL æŒ‡ä»¤æ—¶ï¼Œè‹¥ CSR.ESTAT.Ecode!=0x3Fï¼Œå°†è¯¥ä½çš„å€¼å–ååå†™å…¥åˆ°è¢«å†™ TLB é¡¹çš„ E ä½ï¼›è‹¥æ­¤æ—¶ CSR.ESTAT.Ecode=0x3Fï¼Œé‚£ä¹ˆè¢«å†™å…¥çš„TLBé¡¹çš„Eä½æ€»æ˜¯ç½®ä¸º 1ï¼Œä¸è¯¥ä½çš„å€¼æ— å…³

   æ³¨æ„TLBè¡¨é¡¹ä¸­çš„æ˜¯tlb\_eï¼Œè€ŒCSRä¸­çš„æ˜¯neï¼Œå†™å…¥å–å‡ºæ—¶è®°å¾—å–å
   ```verilog
       //TLBIDX 5ä½
       output [4:0]index_out,
       output [6:0]ps_out,
       output e_out,
       input [4:0]index_in,
       input [6:0]ps_in,
       input e_in,
       
       input tlb_srch_wen,
   ```
   ```verilog
     assign index_out = csr_tlbidx[`INDEX];
     assign ps_out = csr_tlbidx[`PS];
     assign e_out = csr_estat[`ECODE] != 6'h3f ? ~csr_tlbidx[`NE] : 1'b1;
     
     always @(posedge clk) begin
       if (~resetn) begin
         csr_tlbidx[23:5] <= 11'b0;
         csr_tlbidx[30]   <= 1'b0;
       end else if (tlb_rd_wen) begin
         csr_tlbidx[`INDEX] <= index_in;
         csr_tlbidx[`PS] <= ps_in;
         csr_tlbidx[`NE] <= ~e_in;
       end else if (tlb_srch_wen) begin
         csr_tlbidx[`INDEX] <= index_in;
         csr_tlbidx[`NE] <= ~e_in;
       end else if (tlbidx_wen) begin
         csr_tlbidx[`INDEX] <= csrWData[`INDEX];
         csr_tlbidx[`PS] <= csrWData[`PS];
         csr_tlbidx[`NE] <= csrWData[`NE];
       end
     end
   ```
7. PGDL
   ```verilog
     //pgdl
     always @(posedge clk) begin
       if (~resetn) begin
         csr_pgdl[11:0] <= 12'b0;
       end else if (pgdl_wen) begin
         csr_pgdl[`PGDL_BASE] <= csrWData[`PGDL_BASE];
       end
     end
   ```
8. PGDH
   ```verilog
     //pgdh
     always @(posedge clk) begin
       if (~resetn) begin
         csr_pgdh[11:0] <= 12'b0;
       end else if (pgdh_wen) begin
         csr_pgdh[`PGDH_BASE] <= csrWData[`PGDH_BASE];
       end
     end
   ```
9. PGD
   ```verilog
     //pgd
     assign csr_pgd = csr_badv[31] ? csr_pgdh : csr_pgdl;
   ```

> PGDLã€PGDHã€PGDä¸»è¦æ˜¯æ§åˆ¶é¡µè¡¨éå†è¿‡ç¨‹çš„ï¼Œæ˜¯å­˜æ”¾é¡µç›®å½•è¡¨çš„åŸºåœ°å€
>
> æ¯ä¸ªè¿›ç¨‹çš„PGDè¡¨åŸºåœ°å€å­˜æ”¾åœ¨è¿›åœºä¸Šä¸‹æ–‡ä¸­ï¼Œå†…æ ¸è¿›ç¨‹è¿›è¡Œåˆ‡æ¢æ—¶æŠŠPGDè¡¨çš„åŸºåœ°å€å†™å…¥CSR.PGDH.BASEï¼Œç”¨æˆ·è¿›åœºè¿›è¡Œåˆ‡æ¢æ—¶æŠŠPGDè¡¨çš„åŸºåœ°å€å†™å…¥CSR.PGDL.BASE

> ğŸ“ŒMMU CSRå¼•å‘çš„å†²çªå¤„ç†
>
> å› ä¸ºpreIFçº§çš„å–æŒ‡è¯·æ±‚éœ€è¦å‚è€ƒCRMD.DA/PGã€DMW0ã€DMW1ã€ASIDæ¥é€‰æ‹©åœ°å€ç¿»è¯‘æ¨¡å¼å¹¶è¿›è¡Œæ˜ å°„ï¼Œè€Œè¿™äº›CSRå¯„å­˜å™¨å¯èƒ½ä¼šè¢«ä¹‹å‰çš„CSRå†™æŒ‡ä»¤å’ŒTLBè¯»æŒ‡ä»¤è¿›è¡Œä¿®æ”¹ã€‚
>
> å¾ˆæ˜¾ç„¶ä¸èƒ½ç”¨é˜»å¡æ¥è§„é¿è¿™ç§å†²çªï¼Œå› ä¸ºæœ€æ—©åœ¨ ID çº§æ‰èƒ½çŸ¥é“ä¸€æ¡ CSR æŒ‡ä»¤æ˜¯å¦ä¿®æ”¹äº†ä¸Šè¿°æ§åˆ¶å¯„å­˜å™¨ï¼Œä½†æ­¤æ—¶ IF çº§æœ‰å¯èƒ½å·²ç»æœ‰ä¸€æ¡æ ¹æ®æ—§çš„ MMU ä¿¡æ¯è¿›è¡Œè™šå®åœ°å€è½¬æ¢è€Œå–å›çš„æŒ‡ä»¤äº†ï¼Œæ˜¾ç„¶è¿™æ¡æŒ‡ä»¤è¦è¢«å–æ¶ˆç„¶åé‡å–
>
> ä¸€ä¸ªå¯è¡Œçš„æ–¹æ¡ˆæ˜¯ï¼Œå½“æœ‰æ£€æµ‹åˆ°CSRå†™æŒ‡ä»¤å’ŒTLBè¯»æŒ‡ä»¤å¯¹è¿™äº›å¯„å­˜å™¨æœ‰ä¿®æ”¹æ—¶ï¼Œé‚£ä¹ˆå°±å°†è¿™äº›æŒ‡ä»¤ä¹‹åè¿›å…¥æµæ°´çš„æŒ‡ä»¤è®¾ç½®ä¸Šä¸€ä¸ªé‡å–æ ‡è¯†â€”â€”å¸¦æœ‰é‡å–æ ‡è¯†çš„æŒ‡ä»¤ä¸èƒ½äº§ç”Ÿä»»ä½•çš„æ‰§è¡Œç»“æœä¸”é˜»å¡æµæ°´çº¿ä¸­å®ƒåé¢çš„æŒ‡ä»¤äº§ç”Ÿæ‰§è¡Œç»“æœï¼Œå½“å®ƒè¾¾åˆ°MEM[^æ³¨é‡Š2]çº§æ—¶é‡å–æ›´æ–°nextPC
>
> å¯¹DAã€PGã€DMWä¿®æ”¹å°±ç›´æ¥è®¾ç½®é‡å–
> å¯¹ASIDç­‰TLBçš„CSRä¿®æ”¹ï¼Œå½“ç›´æ¥æ˜ å°„æ— æ•ˆæ—¶å†è®¾ç½®é‡å–

### 3.2 MMUç›¸å…³çš„TLBæŒ‡ä»¤å®ç°

#### 3.2.1 TLBSRCH

TLBSRCHæŒ‡ä»¤çš„æ‰§è¡Œå¤ç”¨è®¿å­˜TLBç¿»è¯‘é€»è¾‘ï¼Œå› æ­¤è®¾ç½®TLBSRCHåœ¨EXEçº§å‘èµ·æŸ¥æ‰¾è¯·æ±‚

ä½†æ˜¯TLBSRCHæŒ‡ä»¤æŸ¥æ‰¾æ‰€ç”¨åˆ°çš„CSR.ASIDã€TLBEHIä¼šè¢«å¯èƒ½åœ¨MEMçº§çš„CSRå†™æŒ‡ä»¤æˆ–è€…TLBRDæŒ‡ä»¤ä¿®æ”¹â€”â€”ä½†æ˜¯å› ä¸ºè®¾ç½®CSRçš„è¯»å†™åœ¨MEMçº§â€”â€”ç´§é‚»çš„å¯ä»¥å†™å›ç»„åˆé€»è¾‘å–å‡ºç”¨ï¼Œè€ŒTLBWRã€TLBFILLã€INVTLBä¹Ÿä¼šæ›´æ”¹æ‰€è¦æŸ¥æ‰¾çš„è¡¨é¡¹â€”â€”è¿™ä¸ªæ›´æ–°ä¸åœ¨EXEçº§

å› ä¸ºTLBRDã€TLBWRã€TLBFILLã€INVTLBå‡ä¼šé‡‡ç”¨å–æ¶ˆé‡å–çš„æœºåˆ¶ï¼Œæ‰€ä»¥è¿™ç§TLBSRCHå¯ä»¥æ­£å¸¸æ”¾åœ¨EXEçº§è¯·æ±‚

#### 3.2.2 TLBWRã€TLBFILL

å› ä¸ºTLBWRã€TLBFILLéœ€è¦ç”¨åˆ°TLBç›¸å…³çš„CSRï¼Œæ‰€ä»¥è®¾ç½®TLBWRã€TLBFILLçš„æ—¶æœºåœ¨MEMçº§

å› ä¸ºTLBWRã€TLBFILLå‡ä¼šæ›´æ”¹TLBé¡¹ï¼Œè€Œå–æŒ‡å’Œè®¿å­˜çš„åœ°å€ç¿»è¯‘å¯èƒ½ç”¨åˆ°TLB

æ‰€ä»¥ä¸ºäº†è§£å†³è¿™ç§å†²çªï¼Œè®¾ç½®TLBWRã€TLBFILLä¹‹åçš„ç¬¬ä¸€ä¸ªéœ€è¦åœ°å€ç¿»è¯‘çš„å–æŒ‡ã€è®¿å­˜æŒ‡ä»¤å–æ¶ˆé‡å–

#### 3.2.3 TLBRDæŒ‡ä»¤

å› ä¸ºTLBRDéœ€è¦è¯»å–CSR.TLBIDXçš„indexä½œä¸ºè¯»åœ°å€ï¼Œè€Œè¿™ä¸ªå€¼å¯èƒ½ä¼šè¢«MEMçº§çš„CSRå†™æŒ‡ä»¤å’ŒTLBSRCHä¿®æ”¹ï¼Œæ‰€ä»¥è®¾ç½®TLBRDæŒ‡ä»¤åœ¨MEMçº§è¯»TLBå¹¶æ›´æ–°CSR

è€ŒTLBRDå¯¹TLBç›¸å…³CSRçš„æ›´æ”¹åˆä¼šä½¿å¾—ä¹‹åçš„ç¬¬ä¸€ä¸ªéœ€è¦åœ°å€ç¿»è¯‘çš„å–æŒ‡ã€è®¿å­˜å†²çªï¼Œå› æ­¤è®¾ç½®TLBRDä¹‹åçš„ç¬¬ä¸€ä¸ªéœ€è¦åœ°å€ç¿»è¯‘çš„å–æŒ‡ã€è®¿å­˜æŒ‡ä»¤å–æ¶ˆé‡å–

#### 3.2.4 INVTLB

INTVLBæŒ‡ä»¤éœ€è¦è¯»å¯„å­˜å™¨æ“ä½œæ•°ï¼Œè€Œä¸”éœ€è¦å¤ç”¨è®¿å­˜çš„TLBç«¯å£ï¼Œå› æ­¤è®¾ç½®åœ¨EXEçº§å‘é€è¯·æ±‚ï¼Œè‡³äºå…¶ä½¿ç”¨çš„é€šç”¨å¯„å­˜å™¨å·²ç»åœ¨IDé˜¶æ®µå‰é€’å–å‡ºï¼Œè€Œè¢«ä¿®æ”¹çš„CSRå› ä¸ºæ˜¯åœ¨MEMçº§ï¼Œæ‰€ä»¥ä¹Ÿä¸ç”¨è€ƒè™‘é˜»å¡

åªéœ€è¦è€ƒè™‘INVTLBå¯¹TLBè¡¨é¡¹çš„ä¿®æ”¹ï¼Œåˆä¼šä½¿å¾—ä¹‹åçš„ç¬¬ä¸€ä¸ªéœ€è¦åœ°å€ç¿»è¯‘çš„å–æŒ‡ã€è®¿å­˜æŒ‡ä»¤å–æ¶ˆé‡å–

> ğŸ“Œè™½ç„¶ï¼Œæœ‰çš„åªæ˜¯ä¿®æ”¹äº†é¡µè¡¨æ˜ å°„æ‰€éœ€è¦ä½¿ç”¨çš„CSRæˆ–è€…TLBè¡¨é¡¹ï¼Œå¹¶ä¸ä¸€å®šä¼šå¯¼è‡´ä¹‹åçš„æ‰€æœ‰æŒ‡ä»¤éƒ½é‡å–ã€‚ä½†æ˜¯ä¸ºäº†è®¾è®¡æ›´åŠ æ–¹ä¾¿ï¼Œè®¾ç½®TLBRDã€TLBWRã€TLBFILLã€INVTLBä»¥åŠCSRå†™CRMD.DAã€PGã€ASIDç­‰CSRæ—¶éƒ½è®¾ç½®å–æ¶ˆé‡å–â€”â€”æ•ˆç‡ä¹Ÿå¹¶æ²¡æœ‰æŸå¤±å¾ˆå¤šï¼Œå› ä¸ºæƒ…å†µå¹¶ä¸é¢‘ç¹

#### 3.2.5 è®¾è®¡ç»¼è¿°

1. IFé˜¶æ®µéœ€è¦æ ¹æ®MEMçº§ä¼ å›çš„refetchä¿¡å·å’Œpcé‡å–ï¼Œæ­¤å¤–é‡å–ç±»ä¼¼å¼‚å¸¸ï¼Œä¸ºäº†æ›´æ–°nextpcéœ€è¦ä¿æŒç¼“å­˜
   ```verilog
     //æ‹†è§£MEMä¼ é€’è¿‡æ¥çš„æ•°æ®
     wire excp;
     wire ertn;
     wire refetch;
     wire [31:0] refetch_pc;
     assign {refetch_pc,refetch,excp, ertn} = mem_to_if_bus_r_valid ? mem_to_if_bus_r : mem_to_if_bus;

   ```
   æ³¨æ„ä¸è¦å¿˜è®°refetchä¹Ÿéœ€è¦æ›´æ–°ä¸‹é¢çš„ä¿¡å·+ç¼“å­˜ï¼Œåªæœ‰è¿™æ ·æ‰èƒ½å®ç°åƒå¼‚å¸¸ä¸€æ ·çš„å–æ¶ˆåç»­æŒ‡ä»¤
   ```verilog
     wire if_reflush;
     assign if_reflush = mem_to_if_bus[2] | mem_to_if_bus[1] | mem_to_if_bus[0];
     wire if_reflush_r;
     assign if_reflush_r = excp | ertn | refetch;
   ```
   ```verilog
     //brä¿¡æ¯ä¹Ÿéœ€è¦ä¿æŒåˆ°ç¼“å­˜ï¼Œä»¥åœ¨preIF_ready_goæ— æ•ˆæ—¶ä¿æŒè¿›å…¥åˆ°IFï¼ŒåŒæ ·MEMåˆ°IDçš„æ›´æ–°nextpcçš„ä¿¡æ¯ä¹Ÿéœ€è¦ä¿æŒ 
     //å¢åŠ äº†refetchï¼Œé‚£ä¹ˆä¸ºäº†ä¿ç•™reftechæ—¶readygoæ— æ•ˆä¸èƒ½æ›´æ–°PCçš„æƒ…å†µï¼Œéœ€è¦ä¿æŒç¼“å­˜
     reg [`MEM_TO_ID_WD-1:0] mem_to_if_bus_r;
     reg mem_to_if_bus_r_valid;
     always @(posedge clk) begin
       if (~resetn) begin
         mem_to_if_bus_r_valid <= 1'b0;
       end else if (~mem_to_if_bus_r_valid & (mem_to_if_bus[2] | mem_to_if_bus[1] | mem_to_if_bus[0]) & ~preIF_ready_go) begin
         mem_to_if_bus_r <= mem_to_if_bus;  //è¿™ä¹Ÿåº”è¯¥åŠ ä¸€ä¸ªif_allowinå§ï¼Ÿä¸ç”¨ï¼Œå¼‚å¸¸é’ˆå¯¹if_readygoä¸ä¸º1æœ‰å¤„ç†
         mem_to_if_bus_r_valid <= 1'b1;
       end else if (mem_to_if_bus_r_valid & preIF_ready_go) begin
         mem_to_if_bus_r_valid <= 1'b0;
       end
     end
   ```
2. IDé˜¶æ®µè¿›è¡ŒæŒ‡ä»¤è¯‘ç å¹¶æ›´æ”¹æ§åˆ¶ä¿¡å·ï¼Œä¼ è¾“TLBç›¸å…³ä¿¡å·åˆ°EXEçº§ï¼›
   ```verilog
     wire inst_tlbsrch = op_31_26_d[6'h01] &op_25_22_d[4'h9] &op_21_20_d[2'h0] & op_19_15_d[5'h10] & id_inst[14:10] == 5'h0a & id_inst[9:0] == 10'b0;
     wire inst_tlbrd = op_31_26_d[6'h01] &op_25_22_d[4'h9] &op_21_20_d[2'h0] & op_19_15_d[5'h10] & id_inst[14:10] == 5'h0b & id_inst[9:0] == 10'b0;
     wire inst_tlbwr = op_31_26_d[6'h01] &op_25_22_d[4'h9] &op_21_20_d[2'h0] & op_19_15_d[5'h10] & id_inst[14:10] == 5'h0c & id_inst[9:0] == 10'b0;
     wire inst_tlbfill = op_31_26_d[6'h01] &op_25_22_d[4'h9] &op_21_20_d[2'h0] & op_19_15_d[5'h10] & id_inst[14:10] == 5'h0d & id_inst[9:0] == 10'b0;
     wire inst_invtlb = op_31_26_d[6'h01] & op_25_22_d[4'h9] & op_21_20_d[2'h0] & op_19_15_d[5'h11];

   ```
   ```verilog
     assign id_regW = ~inst_st_w & ~inst_st_b & ~inst_st_h & ~inst_beq & ~inst_bne & ~inst_blt & ~inst_bge & ~inst_bltu & ~inst_bgeu & ~inst_b & ~inst_syscall & ~inst_break & ~inst_ertn & ~inst_tlbsrch & ~inst_tlbrd & ~inst_tlbwr & ~inst_tlbfill & ~inst_invtlb & ~id_ADEF_EXCP;

     assign need_rj = ~inst_b & ~inst_bl & ~inst_lu12i & ~inst_pcaddu12i & ~inst_csrrd & ~inst_csrwr & ~inst_syscall & ~inst_break & ~inst_ertn & ~inst_rdcntid & ~inst_rdcntvl & ~inst_rdcntvh & ~inst_tlbsrch & ~inst_tlbrd & ~inst_tlbwr & ~inst_tlbfill;
     assign need_rkd = ~inst_slli & ~inst_srli & ~inst_srai & ~inst_addi & ~inst_slti & ~inst_sltui & ~inst_andi & ~inst_ori & ~inst_xori
                     & ~inst_lu12i & ~inst_pcaddu12i & ~inst_ld_w & ~inst_ld_b & ~inst_ld_bu & ~inst_ld_h & ~inst_ld_hu & ~inst_jirl & ~inst_b & ~inst_bl
                     & ~inst_csrrd & ~inst_syscall & ~inst_break & ~inst_ertn & ~inst_rdcntid & ~inst_rdcntvl & ~inst_rdcntvh & ~inst_tlbsrch & ~inst_tlbrd & ~inst_tlbwr & ~inst_tlbfill;
     
     
     assign inst_ine = ~inst_rdcntid & ~inst_rdcntvl & ~inst_rdcntvh & ~inst_add & ~inst_sub & ~inst_slt & ~inst_sltu & ~inst_nor & ~inst_and & ~inst_or & ~inst_xor & ~inst_sll
                     & ~inst_srl & ~inst_sra & ~inst_mul & ~inst_mulh & ~inst_mulhu & ~inst_div & ~inst_mod & ~inst_divu & ~inst_modu
                     & ~inst_break & ~inst_syscall & ~inst_slli & ~inst_srli & ~inst_srai & ~inst_slti & ~inst_sltui & ~inst_addi 
                     & ~inst_andi & ~inst_ori & ~inst_xori & ~inst_csrrd & ~inst_csrwr & ~inst_csrxchg & ~inst_tlbsrch & ~inst_tlbrd
                     & ~inst_tlbwr & ~inst_tlbfill & ~inst_invtlb & ~inst_ertn & ~inst_lu12i
                     & ~inst_pcaddu12i & ~inst_ld_b & ~inst_ld_h & ~inst_ld_w & ~inst_st_b & ~inst_st_h & ~inst_st_w & ~inst_ld_bu
                     & ~inst_ld_hu & ~inst_jirl & ~inst_b & ~inst_bl & ~inst_beq & ~inst_bne & ~inst_blt & ~inst_bge & ~inst_bltu 
                     & ~inst_bgeu;
     assign INE_EXCP = id_valid & inst_ine | (inst_invtlb ? rd > 5'h06 : 1'b0);

   ```
   ```verilog
     //TLB INS
     wire [2:0]tlb_ins_rec = {3{inst_tlbsrch}} & 3'b001 |
                             {3{inst_tlbrd}}   & 3'b010 |
                             {3{inst_tlbwr}}   & 3'b011 |
                             {3{inst_tlbfill}} & 3'b100 |
                             {3{inst_invtlb}}  & 3'b101 ;
     //å°åŒ…idç»„åˆé€»è¾‘ä¼ é€’ç»™exe_regçš„æ•°æ®
     assign id_to_exe_bus = {
       alu_op,
       res_from_mem,
       id_regW,
       id_memW,
       id_regWAddr,
       forwardDataB,
       DataA,
       DataB,
       div_signed,
       mul_signed,
       div,
       aluMD_resSelect,
       memINS_rec,
       load_sign,
       csr_num,
       csr_instRec,
       id_ertn,
       id_excp,
       excp_num,
       rdcnt_REC,
       tlb_ins_rec,
       rd,
       id_pc
     };
   ```
3. EXEé˜¶æ®µå‘å‡ºTLBSRCHã€INVTLBçš„è¯·æ±‚ï¼Œä¸”éœ€è¦æ ¹æ®memçº§ä¼ è¿‡æ¥çš„åˆ·æ–°ä¿¡å·ç¦æ­¢tlbæ“ä½œä»¥åŠå†™æ“ä½œ
   1. è§£æIDä¼ è¿‡æ¥çš„æ•°æ®
      ```verilog
        //è§£å‹ç¼©idç»„åˆé€»è¾‘ä¼ é€’ç»™exe_regçš„ä¿¡å·
        wire [11:0] alu_op;
        wire res_from_mem;
        wire exe_regW_temp;
        wire exe_memW;
        wire [4:0] exe_regWAddr;
        wire [31:0] DataA;
        wire [31:0] forwardDataB;
        wire [31:0] DataB;
        wire div_signed;
        wire mul_signed;
        wire div;
        wire [2:0] aluMD_resSelect;
        wire [1:0] memINS_rec;
        wire [13:0] csr_num;
        wire [1:0] csr_instRec;
        wire exe_ertn;
        wire exe_excp_temp;
        wire load_sign;
        wire [5:0] excp_num_temp;
        wire [1:0] rdcnt_REC;
        wire [4:0] code;
        wire [2:0] tlb_ins_rec;
        wire [31:0] exe_pc;

        assign {alu_op, res_from_mem, exe_regW_temp, exe_memW, exe_regWAddr, forwardDataB, DataA, DataB, div_signed, mul_signed, div, aluMD_resSelect, 
                memINS_rec, load_sign, csr_num, csr_instRec, exe_ertn, exe_excp_temp, excp_num_temp, rdcnt_REC, tlb_ins_rec, code, exe_pc} = exe_data;
      ```
   2. è§£æCSRä¼ é€’è¿‡æ¥çš„æ•°æ®
      ```verilog
        //è§£å‹ç¼©CSRä¼ é€’è¿‡æ¥çš„ä¿¡å·
        wire [18:0] vppn;
        wire [ 9:0] asid;

        assign {vppn, asid} = csr_to_exe_bus;

      ```
   3. å‘é€è¯·æ±‚â€”â€”ä¼ é€’åˆ°TLB
      ```verilog
        //TLB SRCH INVTLB
        wire invtlb_valid = tlb_ins_rec == 3'b101 & ~mem_to_exe_flush_excp_ertn;
        wire [18:0] s1_vppn = {19{tlb_ins_rec == 3'b001}} & vppn |
                              {19{tlb_ins_rec == 3'b101}} & DataB[31:13];  //è¿™é‡Œå…ˆä¸è€ƒè™‘è®¿å­˜ï¼Œåªè€ƒè™‘tlbsrchã€invtlbçš„vppnã€asidå€¼
        wire [9:0] s1_asid = {19{tlb_ins_rec == 3'b001}} & asid | {19{tlb_ins_rec == 3'b101}} & DataA[9:0];

      ```
      ```verilog
        //å°åŒ…exeä¼ é€’ç»™tlbçš„æ•°æ®
        assign exe_to_tlb_bus = {s1_vppn, s1_asid, invtlb_valid, code};
      ```
4. MEMçº§å‘å‡ºTLBRDã€TLBWRã€TLBFILLè®¾ç½®CSRçš„ä¿®æ”¹ä»¥åŠå–æ¶ˆé‡å–çš„æ ‡è¯†
   1. è·å–EXEçº§ä¼ è¿‡æ¥çš„æ•°æ®
      ```verilog
        //æ‹†è§£mem_regæ•°æ®
        wire mem_memW;
        wire mem_regW;
        wire [4:0] mem_regWAddr;
        wire res_from_mem;
        wire [31:0] mem_aluResult;
        wire [1:0] memINS_rec;
        wire load_sign;
        wire [31:0] DataA;
        wire [31:0] DataB;
        wire [13:0] csr_num;
        wire [1:0] csr_instRec;
        wire mem_excp;
        wire mem_ertn;
        wire [5:0] excp_num;
        wire [1:0] rdcnt_REC;
        wire [2:0] tlb_ins_rec;
        wire [31:0] mem_pc;

        assign {mem_memW,mem_regW, mem_regWAddr, res_from_mem, mem_aluResult, memINS_rec, load_sign, DataA, DataB, 
                csr_num, csr_instRec, mem_excp, mem_ertn, excp_num, rdcnt_REC, tlb_ins_rec, mem_pc} = mem_data;
      ```
   2. è·å–CSRä¼ é€’è¿‡æ¥çš„æ•°æ®â€”â€”å¢åŠ äº†ç”¨äºTLBWRã€TLBFILLçš„ä¿¡å·
      ```verilog
        //æ‹†è§£CSRä¼ é€’è¿‡æ¥çš„æ•°æ®
        wire [31:0] csrRData;
        wire [31:0] tid_out;
        wire [63:0] timer_64_out;
        wire [$clog2(`TLB_NUM)-1:0] tlb_index;
        wire e;
        wire [5:0] ps;
        wire g;
        wire [19:0] ppn0;
        wire [1:0] plv0;
        wire [1:0] mat0;
        wire d0;
        wire v0;
        wire [19:0] ppn1;
        wire [1:0] plv1;
        wire [1:0] mat1;
        wire d1;
        wire v1;

        assign {csrRData, tid_out, timer_64_out, tlb_index, e, ps, g, ppn0, plv0, mat0, d0, v0, ppn1, plv1, mat1, d1, v1} = csr_to_mem_bus;
      ```
   3. è·å–TLBä¼ é€’è¿‡æ¥çš„æ•°æ®â€”â€”å¢åŠ äº†RDã€SRCHå¾—åˆ°çš„ä¿¡å·
      ```verilog
        //æ‹†è§£TLBä¼ é€’è¿‡æ¥çš„æ•°æ®
        wire r_e;
        wire [18:0] r_vppn;
        wire [5:0] r_ps;
        wire [9:0] r_asid;
        wire r_g;
        wire [19:0] r_ppn0;
        wire [1:0] r_plv0;
        wire [1:0] r_mat0;
        wire r_d0;
        wire r_v0;
        wire [19:0] r_ppn1;
        wire [1:0] r_plv1;
        wire [1:0] r_mat1;
        wire r_d1;
        wire r_v1;
        wire [$clog2(NUM)-1:0] s1_findex;
        wire s1_found;

        assign {r_e, r_vppn, r_ps, r_asid, r_g, r_ppn0, r_plv0, r_mat0, r_d0, r_v0, r_ppn1, r_plv1, r_mat1, r_d1, r_v1, s1_findex,s1_found} = tlb_to_mem_bus;
      ```
   4. è®¾ç½®TLBWRã€TLBFILLå†™ä¿¡å·
      ```verilog
        //TLB WR FILL
        wire we = tlb_ins_rec == 3'b001 | tlb_ins_rec == 3'b100;
        wire [$clog2(`TLB_NUM)-1:0] w_index = tlb_index;
        wire w_e = e;
        wire [18:0] w_vppn = vppn;
        wire [5:0] w_ps = ps;
        wire [9:0] w_asid = asid;
        wire w_g = g;
        wire [19:0] w_ppn0 = ppn0;
        wire [1:0] w_plv0 = plv0;
        wire [1:0] w_mat0 = mat0;
        wire w_d0 = d0;
        wire w_v0 = v0;
        wire [19:0] w_ppn1 = ppn1;
        wire [1:0] w_plv1 = plv1;
        wire [1:0] w_mat1 = mat1;
        wire w_d1 = d1;
        wire w_v1 = v1;
      ```
   5. è®¾ç½®TLBRDä¿¡å·
      ```verilog
        //TLB R
        wire r_index = tlb_index;
      ```
   6. å¤„ç†æ¥å—åˆ°çš„RDã€SRCHä¿¡å·

      å½“RDå¾—åˆ°çš„TLBè¡¨ç°æœ‰æ•ˆæ—¶ï¼Œå†™è¯»åˆ°çš„æ•°æ®ï¼›å¦åˆ™å†™å…¨0

      SRCHéœ€è¦æ ¹æ®foundå†™neï¼Œä¸”è‹¥foundæœ‰æ•ˆéœ€è¦å†™index
      ```verilog
        //TLB RD SRCHå¾—åˆ°çš„æ•°æ®å¤„ç†
        wire [31:0] tlbelo0_in = r_e ? {r_ppn0, 1'b0, r_g, r_mat0, r_plv0, r_d0, r_v0} : 32'b0;
        wire [31:0] tlbelo1_in = r_e ? {r_ppn1, 1'b1, r_g, r_mat1, r_plv1, r_d1, r_v1} : 32'b0;
        wire [9:0] asid_in = r_e ? r_asid : 10'b0;
        wire [18:0] vppn_in = r_e ? r_vppn : 19'b0;
        wire [5:0] ps_in = r_e ? r_ps : 6'b0;

        wire [$clog(TLB_NUM)-1:0] index_in = s1_findex;  //åªæœ‰SRCHæ›´æ–°index
        wire e_in = tlb_ins_rec == 3'b001 ? s1_found : r_e;
      ```
   7. é‡å–ï¼Œå¹¶è®¾ç½®åˆ·æ–°ä¹‹å‰çš„EXEã€IDé˜¶æ®µï¼Œä¼ é€’åˆ°IFçº§
      ```verilog
      //refetch pc
        wire [31:0] refetch_pc = mem_pc + 32'h4;
        wire refetch = mem_valid & (tlb_ins_rec != 3'b0 | (csr_instRec == 2'b10 | csr_instRec == 2'b11) & (csr_num == 14'h0 | csr_num == 14'h10 | csr_num == 14'h11 | csr_num== 14'h12 | csr_num == 14'h13 | csr_num == 14'h18 | csr_num == 14'h19 | csr_num == 14'h1a));
      ```
      ```verilog
        //è§¦å‘å¼‚å¸¸ã€ertnåˆ™åˆ·æ–°IDã€EXEï¼Œå¹¶ç½®preIFçš„nextä¸ºæ–°å€¼
        assign flush_excp_ertn = (mem_excp | mem_ertn | refetch) & mem_valid;
        assign mem_to_id_flush_excp_ertn = flush_excp_ertn;
        assign mem_to_exe_flush_excp_ertn = flush_excp_ertn;
        assign mem_to_if_bus = {
          refetch_pc, mem_valid & refetch, mem_valid & mem_excp, mem_valid & mem_ertn
        };
      ```
   8. ä¼ è¾“TLBå†™æ•°æ®ç»™TLB
      ```verilog
        //å°åŒ…ä¼ é€’ç»™TLBçš„æ•°æ®
        assign mem_to_tlb_bus = {
          r_index,
          we,
          w_index,
          w_e,
          w_vppn,
          w_ps,
          w_asid,
          w_g,
          w_ppn0,
          w_plv0,
          w_mat0,
          w_d0,
          w_v0,
          w_ppn1,
          w_plv1,
          w_mat1,
          w_d1,
          w_v1
        };
      ```
   9. ä¼ é€’RDã€SRCHæ•°æ®ç»™CSR
      ```verilog
      //å°åŒ…ä¼ é€’ç»™CSRçš„æ•°æ®
        assign mem_to_csr_bus = {
          csrRAdd,
          csrWen & mem_valid,
          csrWAdd,
          csrWData,
          mem_excp & mem_valid,
          mem_ertn & mem_valid,
          era,
          subcode,
          code,
          excpAboutAddr & mem_valid,
          badv_addr,
          asid_in,
          vppn_in,
          tlbelo0_in,
          tlbelo1_in,
          index_in,
          ps_in,
          e_in,
          tlb_ins_rec == 3'b001,
          tlb_ins_rec == 3'b010
        };
      ```
5. åŒçº§åˆ«ä¾‹åŒ–TLB
   ```verilog
   //tlb
     wire [18:0] s1_vppn;
     wire [9:0] s1_asid;
     wire invtlb_valid;
     wire [4:0] op;

     assign {s1_vppn, s1_asid, invtlb_valid, op} = exe_to_tlb_bus;

     wire r_e;
     wire [18:0] r_vppn;
     wire [5:0] r_ps;
     wire [9:0] r_asid;
     wire r_g;
     wire [19:0] r_ppn0;
     wire [1:0] r_plv0;
     wire [1:0] r_mat0;
     wire r_d0;
     wire r_v0;
     wire [19:0] r_ppn1;
     wire [1:0] r_plv1;
     wire [1:0] r_mat1;
     wire r_d1;
     wire r_v1;
     wire [$clog2(`TLB_NUM)-1:0] s1_findex;
     wire s1_found;

     assign tlb_to_mem_bus = {
       r_e,
       r_vppn,
       r_ps,
       r_asid,
       r_g,
       r_ppn0,
       r_plv0,
       r_mat0,
       r_d0,
       r_v0,
       r_ppn1,
       r_plv1,
       r_mat1,
       r_d1,
       r_v1,
       s1_findex,
       s1_found
     };

     wire r_index;
     wire we;
     wire [$clog2(`TLB_NUM)-1:0] w_index;
     wire w_e;
     wire [18:0] w_vppn;
     wire [5:0] w_ps;
     wire [9:0] w_asid;
     wire w_g;
     wire [19:0] w_ppn0;
     wire [1:0] w_plv0;
     wire [1:0] w_mat0;
     wire w_d0;
     wire w_v0;
     wire [19:0] w_ppn1;
     wire [1:0] w_plv1;
     wire [1:0] w_mat1;
     wire w_d1;
     wire w_v1;

     assign {r_index,
       we,
       w_index,
       w_e,
       w_vppn,
       w_ps,
       w_asid,
       w_g,
       w_ppn0,
       w_plv0,
       w_mat0,
       w_d0,
       w_v0,
       w_ppn1,
       w_plv1,
       w_mat1,
       w_d1,
       w_v1} = mem_to_tlb_bus;

     tlb u_tlb (
         .clk         (aclk),
         .s0_vppn     (s0_vppn),
         .s0_va_bit12 (s0_va_bit12),
         .s0_asid     (s0_asid),
         .s0_found    (s0_found),
         .s0_ppn      (s0_ppn),
         .s0_ps       (s0_ps),
         .s0_plv      (s0_plv),
         .s0_mat      (s0_mat),
         .s0_d        (s0_d),
         .s0_v        (s0_v),
         .s0_findex   (s0_findex),
         .s1_vppn     (s1_vppn),
         .s1_va_bit12 (s1_va_bit12),
         .s1_asid     (s1_asid),
         .s1_found    (s1_found),
         .s1_ppn      (s1_ppn),
         .s1_ps       (s1_ps),
         .s1_plv      (s1_plv),
         .s1_mat      (s1_mat),
         .s1_d        (s1_d),
         .s1_v        (s1_v),
         .s1_findex   (s1_findex),
         .we          (we),
         .w_index     (w_index),
         .w_e         (w_e),
         .w_vppn      (w_vppn),
         .w_ps        (w_ps),
         .w_asid      (w_asid),
         .w_g         (w_g),
         .w_ppn0      (w_ppn0),
         .w_plv0      (w_plv0),
         .w_mat0      (w_mat0),
         .w_d0        (w_d0),
         .w_v0        (w_v0),
         .w_ppn1      (w_ppn1),
         .w_plv1      (w_plv1),
         .w_mat1      (w_mat1),
         .w_d1        (w_d1),
         .w_v1        (w_v1),
         .r_index     (r_index),
         .r_e         (r_e),
         .r_vppn      (r_vppn),
         .r_ps        (r_ps),
         .r_asid      (r_asid),
         .r_g         (r_g),
         .r_ppn0      (r_ppn0),
         .r_plv0      (r_plv0),
         .r_mat0      (r_mat0),
         .r_d0        (r_d0),
         .r_v0        (r_v0),
         .r_ppn1      (r_ppn1),
         .r_plv1      (r_plv1),
         .r_mat1      (r_mat1),
         .r_d1        (r_d1),
         .r_v1        (r_v1),
         .invtlb_valid(invtlb_valid),
         .op          (op)
     );
   ```

ä¹‹å‰å®ç°å¼‚å¸¸æ—¶ï¼Œå¯¹äºineå¼‚å¸¸æ²¡åšä¸èƒ½æ›´æ”¹PCã€MEMçš„è®¾ç½®

ä»¥åŠæµ‹è¯•ç”¨ä¾‹ç”¨çš„æ˜¯16ä¸ªTLBï¼Œæˆ‘è®¾ç½®çš„32ä¸ªï¼Œç„¶åä¸ºäº†æ–¹ä¾¿æ›´æ”¹ï¼Œå¯¹æ‰€æœ‰æ–‡ä»¶çš„indexç­‰ä»¥åŠcsrçš„ç½®0èŒƒå›´éƒ½ç”¨ç»Ÿä¸€çš„å®å˜é‡åšäº†ç®¡ç†

ç„¶åè¿˜æœ‰ä¸€äº›ç²—å¿ƒçš„é”™è¯¯â€”â€”æ•°æ²¡æ•°å¯¹â€”â€”è¿™ä¸ªä¸»è¦æ˜¯csr.vhä¸­å®šä¹‰TLBELOçš„PALENå®šä¹‰æˆäº†36,ä½†æ˜¯åº”è¯¥æ˜¯32,ä»è€Œä½¿å¾—PPNå¤šç®—äº†3ä½ï¼›è¿˜æœ‰invtlbæŒ‡ä»¤è¯‘ç çœ‹é”™äº†ï¼›è¿˜æœ‰ä¸€äº›ä¿¡å·ä½å®½è®¾ç½®æˆäº†1è¿™äº›ï¼›ç„¶åè¿˜æœ‰å†™åªèƒ½ä¸€æ¬¡æœ‰æ•ˆï¼Œæ‰€ä»¥ä¸€èˆ¬éƒ½è®¾ç½®äº†\&valid

æŸ¥æ‰¾TLBSRCHçš„è¯ï¼Œä¸ºäº†å¾—åˆ°æœ€ç»ˆçš„indexä¸èƒ½è®©s1\_valid12bitä¸ºé«˜é˜»æ€ï¼Œè®¾ä¸º1æˆ–è€…0éƒ½è¡Œ

## 4 MMU åœ°å€è½¬æ¢ä»¥åŠç›¸å…³å¼‚å¸¸çš„å®ç°

> æ•´ä½“æ€è·¯ï¼š
>
> 1. å–æŒ‡è¯·æ±‚åœ¨preIFçº§å‘å‡º
>
>    é‡‡ç”¨ç»„åˆé€»è¾‘å®ç°ç›´æ¥åœ°å€ç¿»è¯‘ã€ç›´æ¥æ˜ å°„çª—å£ç¿»è¯‘å’ŒTLBåœ°å€ç¿»è¯‘
>
>    å°†`nextPC`åˆ†åˆ«é€å¾€è¿™ä¸‰ç§æ–¹å¼è¿›è¡Œè™šå®åœ°å€è½¬æ¢ç„¶åå†æ ¹æ®è½¬æ¢æ–¹å¼é€‰æ‹©æœ€ç»ˆçš„å®åœ°å€
> 2. è®¿å­˜è¯·æ±‚åœ¨EXEçº§å‘å‡º
>
>    ç±»ä¼¼äºpreIFï¼Œåªä¸è¿‡æ˜¯å°†`aluResult`é€å¾€è¿™å‡ ç§æ–¹å¼çš„ç»„åˆé€»è¾‘
> 3. æ ¹æ®å–æŒ‡å’Œè®¿å­˜æ—¶TLBæ¨¡å—çš„è¾“å‡ºä¿¡æ¯ï¼Œç»“åˆè‡ªèº«çš„è®¿é—®ç±»å‹ï¼Œç»™å®šå¼‚å¸¸çš„åˆ¤æ–­ç»“æœ
> 4. å½“MMUç›¸å…³å¼‚å¸¸å‘ç”Ÿæ—¶ï¼Œç¦æ­¢å‘å‡ºæ€»çº¿è¯·æ±‚

### 4.1 åœ°å€è½¬æ¢çš„å®ç°

#### 4.1.1 preIFå–æŒ‡çš„åœ°å€è½¬æ¢

1. ç›´æ¥åœ°å€ç¿»è¯‘äº§ç”Ÿçš„å®åœ°å€å³ä¸ºè™šåœ°å€â€”â€”ä¸ç”¨å†å¢åŠ é€»è¾‘äº§ç”Ÿ
2. ç›´æ¥æ˜ å°„çª—å£äº§ç”Ÿçš„å®åœ°å€éœ€è¦ä½¿ç”¨DMWè®¡ç®—

   ç›´æ¥åœ°å€æ˜ å°„æ¨¡å¼çš„å‘½ä¸­æ¡ä»¶æ˜¯â€œå¿…é¡»åœ¨å¯¹åº”çš„PLVä¸‹VSEGç­‰äºè™šåœ°å€é«˜ä¸‰ä½â€

   å®åœ°å€çš„ç”Ÿæˆå³ä¸ºâ€œ`{PSEG,è™šåœ°å€[28:0]}`â€
   ```verilog
     //ç›´æ¥æ˜ å°„åœ°å€æ¨¡å¼
     wire [31:0] dmw_pc;
     wire [ 1:0] dmw_select;  //2'b01è¡¨ç¤ºå‘½ä¸­DMW0 2'b10è¡¨ç¤ºå‘½ä¸­DMW1 

     assign dmw_select[0] = dmw0_vseg == nextpc[31:29] & (dmw0_plv3 == 1'b1 & cur_plv == 2'b11 | dmw0_plv1 == 1'b1 & cur_plv == 2'b0);//åªæœ‰å¯¹åº”ç­‰çº§çš„plvæ‰èƒ½ä½¿ç”¨å¯¹åº”çš„çª—å£
     assign dmw_select[1] = dmw1_vseg == nextpc[31:29] & (dmw1_plv3 == 1'b1 & cur_plv == 2'b11 | dmw1_plv1 == 1'b1 & cur_plv == 2'b0);

     assign dmw_pc = {32{dmw_select[0]}} & {dmw0_pseg, nextpc[28:0]} | {32{dmw_select[1]}} & {dmw1_pseg,nextpc[28:0]};
   ```
3. TLBæ˜ å°„äº§ç”Ÿçš„å®åœ°å€

   éœ€è¦æ ¹æ®æ‰€è½¬æ¢å¾—åˆ°çš„é¡µå¤§å°s0\_pså’Œs0\_ppnæ¥ç”Ÿæˆ

   å½“é¡µè¡¨å¤§å°ä¸º21æ—¶ï¼Œé¡µå†…åœ°å€å³ä¸ºnextPC\[20:0]ï¼Œé¡µå·ä¸ºs0\_ppn\[19:9]

   å½“é¡µè¡¨å¤§å°ä¸º12æ—¶ï¼Œä¸šå†…åœ°å€å³ä¸ºnextPC\[11:0]ï¼Œé¡µå·ä¸ºs0\_ppn\[19:0]
   ```verilog
     //TLBæ˜ å°„åœ°å€æ¨¡å¼
     wire [31:0] tlb_pc;
     assign tlb_pc = s0_ps == 6'b21 ? {s0_ppn[19:9],nextpc[20:0]} : {s0_ppn[19:0],nextpc[11:0]};
   ```
4. å‘å‡ºTLBè½¬æ¢è¯·æ±‚ï¼Œä»¥åŠæ¥å—å…¶è½¬æ¢ç»“æœ
   1. éœ€è¦ä½¿ç”¨CSRçš„asidã€daã€pgä»¥åŠDMW
      ```verilog
       //æ‹†è§£CSRä¼ é€’è¿‡æ¥çš„æ•°æ®
        wire [31:0] era;
        wire [31:0] eentry_out;
        wire [9:0] asid_out;
        wire crmd_da;
        wire crmd_pg;
        wire [2:0] dmw0_vseg,dmw1_vseg,dmw0_pseg,dmw1_pseg;
        wire dmw0_plv0,dmw0_plv3,dmw1_plv0,dmw1_plv3;
          wire [1:0] cur_plv;
        assign {eentry_out, era, asid_out, crmd_pa, crmd_pg, dmw0_vseg, dmw1_vseg, dmw0_pseg, dmw1_pseg, dmw0_plv0, dmw1_plv1, dmw0_plv3, dmw1_plv3, cur_plv} = csr_to_if_bus;
      ```
   2. å‘å‡ºè¯·æ±‚
      ```verilog
        //TLBè½¬æ¢
        wire [18:0] s0_vppn = nextpc[31:13];
        wire s0_va_asid = nextpc[12];
        assign if_to_tlb_bus = {s0_vppn, asid_out, s0_va_asid};
      ```
   3. æ¥å—è½¬æ¢ç»“æœ
      ```verilog
       //æ‹†è§£TLBä¼ é€’è¿‡æ¥çš„æ•°æ®
        wire s0_found;
        wire [19:0] s0_ppn;
        wire [5:0] s0_ps;
        wire [1:0] s0_plv;
        wire [1:0] s0_mat;
        wire s0_d;
        wire s0_v;
        wire [$clog2(NUM)-1:0] s0_findex;
        assign {s0_found, s0_ppn, s0_ps, s0_plv, s0_mat, s0_d, s0_v, s0_findex} = tlb_to_if_bus;
      ```
5. åœ°å€èµ‹å€¼
   ```verilog
     assign inst_sram_addr = crmd_da == 1'b & crmd_pg == 1'b0 ? nextpc :
                             dmw_select != 2'b0 ? dmw_pc :
                             tlb_pc;
   ```

#### 4.1.2 EXEè®¿å­˜çš„åœ°å€è½¬æ¢

1. ç›´æ¥åœ°å€ç¿»è¯‘äº§ç”Ÿçš„å®åœ°å€å³ä¸ºè™šåœ°å€â€”â€”ä¸ç”¨å†å¢åŠ é€»è¾‘äº§ç”Ÿ
2. ç›´æ¥æ˜ å°„çª—å£äº§ç”Ÿçš„å®åœ°å€éœ€è¦ä½¿ç”¨DMWè®¡ç®—
   1. CSRæ•°æ®ä¼ é€’
      ```verilog
      //è§£å‹ç¼©CSRä¼ é€’è¿‡æ¥çš„ä¿¡å·
        wire [18:0] vppn;
        wire [9:0] asid;
        wire crmd_da;
        wire crmd_pg;
        wire [2:0] dmw0_vseg, dmw1_vseg, dmw0_pseg, dmw1_pseg;
        wire dmw0_plv0, dmw0_plv3, dmw1_plv0, dmw1_plv3;
        wire [1:0] cur_plv;

        assign {vppn, asid,crmd_pa, crmd_pg, dmw0_vseg, dmw1_vseg, dmw0_pseg, dmw1_pseg, dmw0_plv0, dmw1_plv1, dmw0_plv3, dmw1_plv3, cur_plv} = csr_to_exe_bus;
      ```
   2. åœ°å€è®¡ç®—
      ```verilog
      //dmw_addr
        wire [31:0] dmw_addr;
        wire [1:0] dmw_select;  //2'b01è¡¨ç¤ºå‘½ä¸­DMW0 2'b10è¡¨ç¤ºå‘½ä¸­DMW1 

        assign dmw_select[0] = dmw0_vseg == exe_aluResult[31:29] & (dmw0_plv3 == 1'b1 & cur_plv == 2'b11 | dmw0_plv1 == 1'b1 & cur_plv == 2'b0);//åªæœ‰å¯¹åº”ç­‰çº§çš„plvæ‰èƒ½ä½¿ç”¨å¯¹åº”çš„çª—å£
        assign dmw_select[1] = dmw1_vseg == exe_aluResult[31:29] & (dmw1_plv3 == 1'b1 & cur_plv == 2'b11 | dmw1_plv1 == 1'b1 & cur_plv == 2'b0);

        assign dmw_addr = {32{dmw_select[0]}} & {dmw0_pseg, exe_aluResult[28:0]} | {32{dmw_select[1]}} & {dmw1_pseg,exe_aluResult[28:0]};
      ```
3. TLBåœ°å€è®¡ç®—
   ```verilog
   //tlb_addr
     wire [31:0] tlb_addr;
     assign tlb_addr = s1_ps == 6'b21 ? {s1_ppn[19:9],exe_aluResult[20:0]} : {s1_ppn[19:0],exe_aluResult[11:0]};
   ```
4. TLBè¯·æ±‚
   ```verilog
     wire [18:0] s1_vppn = {19{tlb_ins_rec == 3'b001}} & vppn |
                           {19{tlb_ins_rec == 3'b101}} & DataB[31:13]
                           {19{exe_valid & (exe_memW | res_from_mem)}} & exe_aluResult[31:13];  //è¿™é‡Œå…ˆä¸è€ƒè™‘è®¿å­˜ï¼Œåªè€ƒè™‘tlbsrchã€invtlbçš„vppnã€asidã€ä¹Ÿéœ€è¦è€ƒè™‘12bitå€¼ï¼Œä¸ç„¶è¯»ä¸å‡ºæ¥
     wire [9:0] s1_asid = {10{tlb_ins_rec == 3'b001}} & asid | {10{tlb_ins_rec == 3'b101}} & DataA[9:0] | {10{exe_valid & (exe_memW | res_from_mem)}} & asid;
     wire s1_va_bit12 = exe_aluResult[12];
     
     //å°åŒ…exeä¼ é€’ç»™tlbçš„æ•°æ®
     assign exe_to_tlb_bus = {s1_vppn, s1_asid, s1_va_bit12, invtlb_valid, code};
   ```
5. è½¬æ¢TLBå¾—åˆ°çš„ä¿¡æ¯
   ```verilog
    //æ‹†è§£TLBä¼ é€’è¿‡æ¥çš„æ•°æ®
     wire s1_found;
     wire [19:0] s1_ppn;
     wire [5:0] s1_ps;
     wire [1:0] s1_plv;
     wire [1:0] s1_mat;
     wire s1_d;
     wire s1_v;
     wire [$clog2(NUM)-1:0] s1_findex;
     assign {s1_found, s1_ppn, s1_ps, s1_plv, s1_mat, s1_d, s1_v, s1_findex} = tlb_to_exe_bus;
   ```
6. åœ°å€èµ‹å€¼
   ```verilog
     assign data_sram_addr = crmd_da == 1'b1 & crmd_pg == 1'b0 ? exe_aluResult :
                             dmw_select != 2'b0 ? dmw_addr :
                             tlb_addr;
   ```

### 4.2 TLBå¼‚å¸¸çš„æ·»åŠ 

#### 4.2.1 preIFæ—¶çš„PPIã€TLBRã€PPF

1. å£°æ˜å¹¶èµ‹å€¼å¼‚å¸¸

   åªæœ‰å½“åªèƒ½ä½¿ç”¨TLBï¼Œä½†å‡ºç°å„ç§é—®é¢˜æ—¶æ‰è§¦å‘è¿™äº›å¼‚å¸¸
   ```verilog
     wire TLBR;
     wire PPI;
     wire PPF;
     
      assign TLBR = crmd_da == 1'b0 & crmd_pg == 1'b1 & dmw_select == 2'b0 & ~s0_found;//åªèƒ½é‡‡ç”¨TLBï¼Œä½†TLBæ²¡æ‰¾åˆ°
     assign PIF = crmd_da == 1'b0 &  crmd_pg == 1'b1 & dmw_select == 2'b0 & s0_found & ~s0_v;
     assign PPI = crmd_da == 1'b0 & crmd_pg == 1'b1 & dmw_select == 2'b00 & s0_found & s0_v & cur_plv > s0_plv;
   ```
2. åœ¨åŸæ¥ADEFæ›´æ”¹çš„åœ°æ–¹ä¹ŸåŠ ä¸Šè¿™ä¸‰ä¸ªå¼‚å¸¸çš„æ›´æ”¹
3. åœ¨IDçº§æ›´æ”¹åŸæ¥çš„æ•°ç»„ä»¥åŠexcpä¿¡å·â€”â€”æ‰€æœ‰æœ‰id\_adef\_excpçš„åœ°æ–¹éƒ½åŠ ä¸Šè¿™ä¸‰ä¸ªå¼‚å¸¸
4. ä¹‹ååˆ°EXEçº§äº†ï¼Œæ‰€æœ‰çš„å¼‚å¸¸å¤„ç†ä¸€æ ·

#### 4.2.2 exeæ—¶çš„PPLã€PPSã€TLBRã€PPIã€PME

1. å£°æ˜å¹¶èµ‹å€¼å¼‚å¸¸
   ```verilog
   assign TLBR = (exe_memW | res_from_mem) & crmd_da == 1'b0 & crmd_pg == 1'b1 & dmw_select == 2'b0 & ~s1_found;
     assign PIL = (res_from_mem) & crmd_da == 1'b0 &  crmd_pg == 1'b1 & dmw_select == 2'b0 & s1_found & ~s1_v;
     assign PIS = (exe_memW) & crmd_da == 1'b0 &  crmd_pg == 1'b1 & dmw_select == 2'b0 & s1_found & ~s1_v;
     assign PPI = (exe_memW | res_from_mem) & crmd_da == 1'b0 & crmd_pg == 1'b1 & dmw_select == 2'b0 & ~s1_found & s1_found & s1_v & cur_plv > s1_plv;
     assign PME = (exe_memW) & crmd_da == 1'b0 & crmd_pg == 1'b1 & dmw_select == 2'b0 & ~s1_found & s1_found & s1_v & cur_plv <= s1_plv & ~s1_d;
   ```
2. åœ¨åŸæ¥ALEæ›´æ”¹çš„åœ°æ–¹ä¹ŸåŠ ä¸Šè¿™å‡ ä¸ªå¼‚å¸¸çš„æ›´æ”¹
3. æ›´æ”¹åŸæ¥çš„æ•°ç»„ã€excpä¿¡å·
4. åˆ°è¾¾MEMçº§æ—¶ï¼Œå¯¹tlbrå•ç‹¬æœ‰ä¿¡å·è¡¨ç¤ºï¼Œç„¶åbadvçš„åˆ†ç±»å¤„ç†ï¼Œcodeã€scodeåˆ†ç±»

[^æ³¨é‡Š1]: ä»TLBé‡å¡«å¼‚å¸¸å¤ä½ç¨‹åºè¿”å›

[^æ³¨é‡Š2]: å› ä¸ºè®¾ç½®åœ¨MEMçº§æ›´æ–°CSR
