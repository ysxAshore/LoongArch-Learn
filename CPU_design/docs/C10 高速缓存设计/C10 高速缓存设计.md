# C10 é«˜é€Ÿç¼“å­˜è®¾è®¡

## ç›®å½•

- [1 Cacheæ¨¡å—çš„è®¾è®¡](#1-Cacheæ¨¡å—çš„è®¾è®¡)
  - [1.1 Cacheçš„è®¾è®¡è§„æ ¼](#11-Cacheçš„è®¾è®¡è§„æ ¼)
  - [1.2 Cacheæ¨¡å—çš„æ•°æ®é€šè·¯è®¾è®¡](#12-Cacheæ¨¡å—çš„æ•°æ®é€šè·¯è®¾è®¡)
    - [1.2.1 è¯»å†™æ“ä½œè®¿é—®Cacheçš„æ‰§è¡Œè¿‡ç¨‹](#121-è¯»å†™æ“ä½œè®¿é—®Cacheçš„æ‰§è¡Œè¿‡ç¨‹)
    - [1.2.2 Cacheè¡¨çš„ç»„ç»‡ç®¡ç†](#122-Cacheè¡¨çš„ç»„ç»‡ç®¡ç†)
    - [1.2.3 Cacheæ¨¡å—åŠŸèƒ½è¾¹ç•Œçš„åˆ’åˆ†](#123-Cacheæ¨¡å—åŠŸèƒ½è¾¹ç•Œçš„åˆ’åˆ†)
    - [1.2.4 Cacheæ¨¡å—å†…é™¤Cacheè¡¨ä¹‹å¤–çš„æ•°æ®é€šè·¯](#124-Cacheæ¨¡å—å†…é™¤Cacheè¡¨ä¹‹å¤–çš„æ•°æ®é€šè·¯)
  - [1.3 Cacheæ¨¡å—å†…éƒ¨çš„æ§åˆ¶é€»è¾‘è®¾è®¡](#13-Cacheæ¨¡å—å†…éƒ¨çš„æ§åˆ¶é€»è¾‘è®¾è®¡)
    - [1.3.1 Cacheæ¨¡å—è‡ªèº«çš„çŠ¶æ€æœºè®¾è®¡](#131-Cacheæ¨¡å—è‡ªèº«çš„çŠ¶æ€æœºè®¾è®¡)
    - [1.3.2 Cacheè¡¨çš„ç‰‡é€‰å’Œå†™ä½¿èƒ½](#132-Cacheè¡¨çš„ç‰‡é€‰å’Œå†™ä½¿èƒ½)
    - [1.3.3 Request/Miss Bufferå„ä¸ªåŸŸçš„å†™ä½¿èƒ½](#133-RequestMiss-Bufferå„ä¸ªåŸŸçš„å†™ä½¿èƒ½)
    - [1.3.4 æ¨¡å—æ¥å£è¾“å‡ºçš„æ§åˆ¶ä¿¡æ¯](#134-æ¨¡å—æ¥å£è¾“å‡ºçš„æ§åˆ¶ä¿¡æ¯)
  - [1.4 Cacheçš„ç¡¬ä»¶åˆå§‹åŒ–](#14-Cacheçš„ç¡¬ä»¶åˆå§‹åŒ–)
  - [1.5 è®¾è®¡ç»¼è¿°](#15-è®¾è®¡ç»¼è¿°)
- [2 å°† Cache é›†æˆè‡³ CPU ä¸­](#2-å°†-Cache-é›†æˆè‡³-CPU-ä¸­)
  - [2.1 Cacheä¸æ€»çº¿æ¥å£æ–¹é¢çš„äº¤äº’é€‚é…é—®é¢˜](#21-Cacheä¸æ€»çº¿æ¥å£æ–¹é¢çš„äº¤äº’é€‚é…é—®é¢˜)
  - [2.2 Cacheä¸CPUæµæ°´çº¿çš„äº¤äº’é€‚é…é—®é¢˜](#22-Cacheä¸CPUæµæ°´çº¿çš„äº¤äº’é€‚é…é—®é¢˜)
    - [2.2.1 CPU HITæƒ…å†µä¸‹](#221-CPU-HITæƒ…å†µä¸‹)
    - [2.2.2 CPU MISSæƒ…å†µä¸‹](#222-CPU-MISSæƒ…å†µä¸‹)
  - [2.3 éç¼“å­˜è®¿é—®çš„å¤„ç†](#23-éç¼“å­˜è®¿é—®çš„å¤„ç†)
    - [2.3.1 å­˜å‚¨è®¿é—®ç±»å‹çš„åˆ¤å®š](#231-å­˜å‚¨è®¿é—®ç±»å‹çš„åˆ¤å®š)
    - [2.3.2 åœ¨ Cache æ¨¡å—ä¸­å¤„ç†SUC](#232-åœ¨-Cache-æ¨¡å—ä¸­å¤„ç†SUC)
- [3 Cacheç»´æŠ¤æŒ‡ä»¤ CACOP](#3-Cacheç»´æŠ¤æŒ‡ä»¤-CACOP)
  - [3.1 CACOPâ€”â€”ç”¨äºCacheçš„åˆå§‹åŒ–å’Œä¸€è‡´æ€§ç»´æŠ¤](#31-CACOPç”¨äºCacheçš„åˆå§‹åŒ–å’Œä¸€è‡´æ€§ç»´æŠ¤)
  - [3.2 è®¾è®¡å»ºè®®](#32-è®¾è®¡å»ºè®®)
  - [3.3 è®¾è®¡å®ç°](#33-è®¾è®¡å®ç°)
    - [3.3.1 å¯¹ICacheçš„ä¿®æ”¹](#331-å¯¹ICacheçš„ä¿®æ”¹)
    - [3.3.2 å¯¹DCacheçš„ä¿®æ”¹](#332-å¯¹DCacheçš„ä¿®æ”¹)
    - [3.3.3 CPUå®ç°cacopæŒ‡ä»¤](#333-CPUå®ç°cacopæŒ‡ä»¤)
- [4 ä»¿çœŸé‡åˆ°çš„é—®é¢˜](#4-ä»¿çœŸé‡åˆ°çš„é—®é¢˜)

> åœ¨ç»™CPUæ·»åŠ æ€»çº¿æœºåˆ¶å¹¶å»é™¤æŒ‡ä»¤RAMå’Œæ•°æ®RAMåï¼Œå®ƒçš„è¿è¡Œæ•ˆç‡ç›¸æ¯”ä¹‹å‰å·®äº†å¾ˆå¤š
>
> ä½†æ˜¯è¿™å¹¶ä¸æ„å‘³ç€è®¾è®¡çš„å€’é€€â€”â€”æŒ‡ä»¤RAMå’Œæ•°æ®RAMçš„ä½¿ç”¨è¦æ±‚è½¯ä»¶äººå‘˜å¿…é¡»æ˜ç¡®æŒæ¡ç‰©ç†å†…å­˜çš„å®¹é‡ã€èµ·å§‹åœ°å€ï¼Œå¢åŠ äº†å¼€å‘çš„éš¾åº¦ã€‚è¿™ç§ç›´æ¥ä½¿ç”¨æŒ‡ä»¤RAMå’Œæ•°æ®RAMçš„ç¡¬ä»¶æ¶æ„ä»…åœ¨å¯¹äºè§„æ¨¡ä¸å¤§ï¼Œç¨‹åºè¡Œä¸ºç›¸å¯¹ç¡®å®šçš„æˆæœ¬ã€åŠŸè€—æˆ–æ‰§è¡Œå»¶è¿Ÿçš„ç¡®å®šæ€§æä¸ºæ•æ„Ÿçš„ä½ç«¯åµŒå…¥å¼é¢†åŸŸä¸­ä½¿ç”¨
>
> å› æ­¤ä¸ºäº†å¢åŠ è¿™ç§è¿›æ­¥çš„æœºåˆ¶çš„å…è®¸æ•ˆç‡ï¼Œè§£å†³æ€è·¯æ˜¯å¢åŠ é«˜é€Ÿç¼“å­˜Cache

å›´ç»•Cacheçš„ä¼˜åŒ–æŠ€æœ¯å¾ˆå¤šï¼Œå¯¼è‡´Cacheè®¾è®¡çš„å¤æ‚åº¦å˜åŒ–å¾ˆå¤§ã€‚ä¸ºäº†æ–¹ä¾¿è®¾è®¡ï¼Œå°†Cacheçš„è®¾è®¡å¤æ‚åº¦æ§åˆ¶åœ¨å…¥é—¨æ°´å¹³ï¼Œå¹¶åˆ†ä¸ºå››ä¸ªé˜¶æ®µæ¥å®ç°ï¼š

1. è®¾è®¡ Cache æ¨¡å—
2. å°† Cache æ¨¡å—ä½œä¸º ICacheï¼ˆæŒ‡ä»¤ Cacheï¼‰é›†æˆåˆ° CPU ä¸­ï¼Œå®Œæˆä¸ CPU å–æŒ‡çš„é… åˆã€è°ƒæ•´ï¼Œå¹¶å®Œæˆæ€»çº¿æ¥å£æ¨¡å—çš„è®¾è®¡è°ƒæ•´
3. å°† Cache æ¨¡å—ä½œä¸º DCacheï¼ˆæŒ‡ä»¤ Cacheï¼‰é›†æˆåˆ° CPU ä¸­ï¼Œå®Œæˆä¸ CPU è®¿å­˜çš„ é…åˆã€è°ƒæ•´ï¼Œå¹¶å®Œæˆæ€»çº¿æ¥å£æ¨¡å—çš„è®¾è®¡è°ƒæ•´
4. å®ç°å¯¹ Cache æŒ‡ä»¤çš„æ”¯æŒ

## 1 Cacheæ¨¡å—çš„è®¾è®¡

### 1.1 Cacheçš„è®¾è®¡è§„æ ¼

æœ¬ç« æ‰€è®¾è®¡çš„Cacheè§„æ ¼æ˜ç¡®å¦‚ä¸‹ï¼š

1. CPU å†…éƒ¨é›†æˆä¸€ä¸ªæŒ‡ä»¤ Cache å’Œä¸€ä¸ªæ•°æ® Cache

   æŒ‡ä»¤å’Œæ•°æ®åˆ†ç¦»ï¼Œæ¶ˆé™¤ç»“æ„ç›¸å…³ï¼Œå®ç°æµæ°´çº¿åŒæ—¶æ”¯æŒå–æŒ‡å’Œè®¿å­˜
2. æŒ‡ä»¤ Cache å’Œæ•°æ® Cache çš„å®¹é‡å‡ä¸º 8KBï¼Œå‡ä¸ºä¸¤è·¯ç»„ç›¸è”ï¼ŒCache è¡Œ/å—å¤§å°å‡ä¸º 16B

   è®¾ç½®æŒ‡ä»¤Cacheå’Œæ•°æ®Cacheè§„æ ¼ç›¸åŒï¼Œä½¿å¾—ä¸ç”¨æŠŠCacheæ¨¡å—è®¾ç½®æˆå¯å‚æ•°åŒ–é…ç½®çš„ï¼Œç›´æ¥å¯ä»¥æ¨¡å—ä¾‹åŒ–ä¸¤ä¸ªæ¥åˆ†åˆ«ä½œä¸ºæŒ‡ä»¤Cacheå’Œæ•°æ®Cahce

   é‡‡ç”¨å¤šè·¯ç»„ç›¸è”æ¶æ„ï¼Œé€‰æ‹©å…¶ä¸­å¤æ‚åº¦æœ€ä½ä¸”æœ‰ä»£è¡¨æ€§çš„ä¸¤è·¯ç»„ç›¸è”

   å°†æ¯ä¸€è·¯å®šä¹‰ä¸º4KBï¼ˆä¸¤è·¯å®¹é‡å³ä¸º8KBï¼‰æ˜¯ä¸ºäº†åœ¨é‡‡ç”¨VIPTè®¿é—®æ–¹å¼æ—¶é¿å…Cacheåˆ«åé—®é¢˜
   > VIPT
   >
   > <https://zhuanlan.zhihu.com/p/577138649>
   >
   > [ å›¾è§£ | CPU-Cache | 2-è…¾è®¯äº‘å¼€å‘è€…ç¤¾åŒº-è…¾è®¯äº‘ åœ¨ã€Šå›¾è§£ | CPU-Cacheã€‹ä¸€æ–‡ä¸­ä»‹ç»äº†VIVTã€PIPTã€VIPTä¸‰ç§æŸ¥æ‰¾æ–¹å¼ã€‚ä¸‹é¢åˆ†æä¸€ä¸‹å…¶æ­§ä¹‰åˆ«åé—®é¢˜ã€‚ https://cloud.tencent.com/developer/article/1843909](https://cloud.tencent.com/developer/article/1843909 " å›¾è§£ | CPU-Cache | 2-è…¾è®¯äº‘å¼€å‘è€…ç¤¾åŒº-è…¾è®¯äº‘ åœ¨ã€Šå›¾è§£ | CPU-Cacheã€‹ä¸€æ–‡ä¸­ä»‹ç»äº†VIVTã€PIPTã€VIPTä¸‰ç§æŸ¥æ‰¾æ–¹å¼ã€‚ä¸‹é¢åˆ†æä¸€ä¸‹å…¶æ­§ä¹‰åˆ«åé—®é¢˜ã€‚ https://cloud.tencent.com/developer/article/1843909")
   >
   > ![](image/image_85G83jhsgj.png)
   >
   > 1. VIPTæ˜¯æŒ‡â€œCacheçš„Tagæ˜¯å®åœ°å€ä¸­çš„PFNï¼Œè€ŒCacheçš„indexæ˜¯VAçš„ä¸€éƒ¨åˆ†â€ã€‚è¿™æ ·æ“ä½œCacheçš„ç´¢å¼•å’ŒTLBçš„ç¿»è¯‘æ˜¯å¯ä»¥åŒæ—¶è¿›è¡Œçš„
   > 2. å› ä¸ºVIPTæœºåˆ¶ä¸­ï¼ŒCacheçš„Tagæ¥è‡ªäºPFNï¼Œæ˜¯å”¯ä¸€çš„ï¼Œæ‰€ä»¥Tagä¸ä¼šå¼•èµ·æ­§ä¹‰
   >    å¦‚æœindex+offset\<pagesizeï¼Œé‚£ä¹ˆindexå³åœ¨pagesizeå†…éƒ¨ï¼Œpagesizeå†…éƒ¨çš„æ˜¯ç›´æ¥äº§ç”ŸPAâ†’PIPT
   >    å¦‚æœindex+offset=pagesizeï¼ŒåŒä¸Š
   >    å¦‚æœindex+offset>pagesizeï¼Œé‚£ä¹ˆindexå°±ä¼šä½¿ç”¨ä¸€éƒ¨åˆ†çš„Tagï¼Œä»è€Œä¼šå­˜åœ¨å¥½å‡ ä¸ªindexé«˜ä½ä¸åŒçš„å¯¹åº”ä¸€ä¸ªTAGï¼Œå‡ºç°æ­§ä¹‰
   >    > ğŸ“Œå› æ­¤åŸºäºVIPTçš„åˆ«åé—®é¢˜æ€»ç»“èµ·æ¥å°±æ˜¯ï¼šå¦‚æœcacheçš„sizeé™¤ä»¥WAYæ•°ï¼Œå°äºç­‰äº1ä¸ªpageçš„å¤§å°ï¼Œåˆ™VI=PIï¼Œæ— åˆ«åé—®é¢˜ï¼›å¦‚æœcacheçš„sizeé™¤ä»¥WAYæ•°ï¼Œå¤§äº1ä¸ªpageçš„å¤§å°ï¼Œåˆ™VIâ‰ PIï¼Œæœ‰åˆ«åé—®é¢˜
   >    > ä¸€èˆ¬é¡µå†…å¤§å°æ˜¯4KBï¼Œä¸¤è·¯åˆ™å®šä¹‰Cacheå¤§å°æ˜¯8KB
   >    > Cacheè¡Œ/å—å¤§å°å®šä¹‰ä¸º16Bï¼Œè€Œä¸æ˜¯å•†ç”¨å¸¸è§çš„64Bï¼Œæ˜¯ä¸ºäº†æŠŠ Cache Data éƒ¨åˆ†çš„åˆ†ä½“æ•°ç›®æ§åˆ¶åœ¨ä¸€ä¸ªé€‚ä¸­çš„ è§„æ¨¡
3. æŒ‡ä»¤ Cache å’Œæ•°æ® Cache é‡‡ç”¨ Tag å’Œ Data åŒæ­¥è®¿é—®çš„å½¢å¼

   Cache é‡‡ç”¨ Tag å’Œ Data åŒæ­¥è®¿é—®çš„å½¢å¼æ˜¯ä¸ºäº†é™ä½ Cache å‘½ä¸­æƒ…å†µä¸‹çš„æ‰§è¡Œå‘¨æœŸæ•°ï¼Œå¦åˆ™åœ¨ Tag å’Œ Data ä¸²è¡Œè®¿é—®æ–¹å¼ä¸‹ï¼Œè¯»ä¸€ä¸ªæ•°æœ€å¿«ä¹Ÿéœ€è¦ 3 ä¸ªå‘¨æœŸã€‚ç„¶è€Œï¼Œç°æœ‰ CPU ä¸­è®¿é—®æŒ‡ä»¤ RAM å’Œæ•°æ® RAM éƒ½åªéœ€è¦ä¸¤ä¸ªå‘¨æœŸï¼Œ3 ä¸ªå‘¨æœŸçš„è®¿é—®å»¶è¿Ÿéœ€è¦å¯¹ CPU æµæ°´çº¿è¿›è¡Œè¾ƒå¤§å¹…åº¦çš„è®¾è®¡è°ƒæ•´
   > ğŸ“ŒTAGå’ŒDataä¸²è¡Œè®¿é—®çš„æ–¹å¼
   >
   > ![](image/image_Ivw-F2lMtC.png)
   >
   > å…ˆæ ¹æ®Indexå»è®¿é—®TAG SRAMï¼Œç”¨tagåˆ¤æ–­é€‰æ‹©å“ªä¸€ç»„çš„å“ªä¸€è·¯
   >
   > ç„¶åå†æ ¹æ®é€‰çš„è·¯æ•°ï¼Œå’Œindexå»è®¿é—®Data SRAMå¾—åˆ°å¯¹åº”çš„æ•°æ®
   >
   > æœ€å¿«ä¹Ÿéœ€è¦3ä¸ªclkï¼šç¬¬ä¸€ä¸ªclkå‘TAG RAMè¯·æ±‚ï¼Œç¬¬äºŒä¸ªclkåˆ¤æ–­å‘½ä¸­ï¼Œå¦‚æœå‘½ä¸­é‚£ä¹ˆæ ¹æ®å¾—åˆ°çš„è·¯ä¿¡æ¯ä»¥åŠindexå»å‘Data RAMè¯·æ±‚ï¼Œç¬¬ä¸‰ä¸ªclkå¾—åˆ°æ•°æ®
   > TAGå’ŒDataå¹¶è¡Œè®¿é—®çš„æ–¹å¼
   >
   > ![](image/image_x6YBz5rQJW.png)
   >
   > æ ¹æ®indexåŒæ—¶è®¿é—®TAG RAMå’ŒData RAMï¼Œç„¶åå†æ¯”è¾ƒå¾—åˆ°çš„tagåˆ¤æ–­å‘½ä¸­ï¼Œå¹¶æ ¹æ®æ¯”è¾ƒç»“æœè¾“å‡ºåˆ°dataå¤šè·¯é€‰æ‹©å™¨è¿›è¡Œè·¯æ•°æ®çš„é€‰æ‹©
   >
   > éœ€è¦ä¸¤ä¸ªclkå³å¯ï¼šç¬¬ä¸€ä¸ªclkå‘å‡ºtag ramå’Œdata ramçš„è®¿é—®è¯·æ±‚ï¼Œç¬¬äºŒä¸ªclkæ ¹æ®æ‰€å¾—åˆ°çš„ä¿¡æ¯åˆ¤æ–­å‘½ä¸­ä»¥åŠæ•°æ®çš„é€‰æ‹©
4. æŒ‡ä»¤ Cache å’Œæ•°æ® Cache å‡é‡‡ç”¨ â€œè™š Index å® Tagâ€ï¼ˆç®€ç§° VIPTï¼‰çš„è®¿é—®å½¢å¼

   å®ç°TLBå’ŒCacheçš„åŒæ—¶è¿›è¡Œ
5. æŒ‡ä»¤ Cache å’Œæ•°æ® Cache å‡é‡‡ç”¨ä¼ªéšæœºæ›¿æ¢ç®—æ³•

   Cache é‡‡ç”¨ä¼ªéšæœºæ›¿æ¢ç®—æ³•æ˜¯å› ä¸ºè¿™æ˜¯æœ€ç®€å•å®ç”¨çš„ Cache æ›¿æ¢ç®—æ³•

   LRU ç®—æ³•è™½ç„¶å¹³å‡æ€§èƒ½æ›´ä½³ï¼Œä½†æ¶‰åŠ LRU ä¿¡æ¯çš„ç»´æŠ¤é—®é¢˜ï¼Œä¼šå¢åŠ è®¾è®¡çš„å¤æ‚åº¦
6. æ•°æ® Cache é‡‡ç”¨å†™å›å†™åˆ†é…çš„ç­–ç•¥
   > å†™å›å†™åˆ†é…
   >
   > å†™å›æ³•ï¼šå½“å†™å‘½ä¸­æ—¶ï¼Œå…ˆå†™Cacheï¼›å½“Cacheå†…çš„è¯¥å—è¦è¢«æ›¿æ¢å‡ºæ—¶ï¼Œå†å†™å­˜å‚¨
   >
   > å†™åˆ†é…ï¼šå½“å†™ä¸å‘½ä¸­æ—¶ï¼Œéœ€è¦å…ˆå°†è¯¥å—æ•°æ®ç”±å­˜å‚¨è°ƒå…¥Cacheï¼Œå†å†™Cache
   > ä½¿ç”¨å†™å›å†™åˆ†é…ç­–ç•¥ï¼Œä½¿å¾—å†™æ“ä½œåœ¨å‘ç”Ÿ Cache Miss æ—¶çš„å¤„ç†æµç¨‹å’Œè¯»æ“ä½œå‘ç”Ÿ Cache Miss æ—¶çš„å¤„ç†æµç¨‹å‡ ä¹æ˜¯ä¸€æ ·çš„ï¼Œä»è€Œç®€åŒ–æ§åˆ¶é€»è¾‘çš„è®¾è®¡
7. æŒ‡ä»¤ Cache å’Œæ•°æ® Cache å‡é‡‡ç”¨é˜»å¡å¼ï¼ˆBlockingï¼‰è®¾è®¡ï¼Œå³ä¸€æ—¦å‘ç”Ÿ Cache Missï¼ˆæœªå‘½ä¸­ï¼‰ï¼Œåˆ™é˜»å¡åç»­è®¿é—®ç›´è‡³æ•°æ®å¡«å› Cache
8. &#x20;Cache ä¸é‡‡ç”¨ â€œå…³é”®å­—ä¼˜å…ˆâ€ æŠ€æœ¯ï¼Œé™ä½AXIæ€»çº¿çš„ç»“åˆéš¾åº¦

   ![](image/image_BWLSAq_Jal.png)

   è¯·æ±‚å­—å¤„ç†æŠ€æœ¯

> ğŸ“Œå› æ­¤å¯ä»¥å¾—åˆ°Cacheçš„ç¼“å­˜å®¹é‡æ˜¯8KBï¼ŒCacheå—å¤§å°æ˜¯16Bï¼Œä¸€å…±æœ‰$2^9$å—ï¼Œåˆ†ä¸¤è·¯ï¼Œæ¯è·¯$2^8$ä¸ªå—
>
> å› æ­¤å—å†…åç§»offsetä¸º4ä½ã€ç»„ç´¢å¼•indexä¸º8ä½ï¼Œå…¶ä½™ä¸ºTAG 20ä½
>
> ![](image/image_Fti36yhJS4.png)
>
> å› æ­¤åœ¨VIPTä¸‹ï¼Œä½¿ç”¨è™šåœ°å€çš„\[11:4]ä½œä¸ºindexã€å®åœ°å€çš„\[31:12]ä½œä¸ºTAGè®¿é—®Cache

### 1.2 Cacheæ¨¡å—çš„æ•°æ®é€šè·¯è®¾è®¡

#### 1.2.1 è¯»å†™æ“ä½œè®¿é—®Cacheçš„æ‰§è¡Œè¿‡ç¨‹

1. è¯»æ“ä½œ

   è¯»æ“ä½œåœ¨ç¬¬ä¸€æ‹æ—¶ï¼Œå°†è¯·æ±‚ä¸­çš„è™šåœ°å€çš„\[11:4]ä½ä½œä¸ºCacheçš„indexå»è®¿é—®Cacheï¼Œå°†ä¸¤è·¯Cacheä¸­å¯¹åº”è¯¥indexçš„ä¸¤ä¸ªCacheè¡Œéƒ½è¯»å‡ºæ¥ï¼›åŒæ—¶å°†è¯»æ“ä½œçš„è¿™ä¸ªè™šåœ°å€é€MMUè¿›è¡Œåœ°å€è½¬æ¢ï¼Œå¾—åˆ°ç‰©ç†åœ°å€â€”â€”è¿™ä¸ªç‰©ç†åœ°å€éœ€è¦å¯„å­˜ä¸‹æ¥ä¾›ç¬¬äºŒæ‹ä½¿ç”¨

   è¯»æ“ä½œåœ¨ç¬¬äºŒæ‹æ—¶ï¼Œå°†å¯„å­˜ä¸‹æ¥çš„ç‰©ç†åœ°å€çš„\[31:12]ä½ä¸è¯»å‡ºçš„ä¸¤ä¸ªCacheè¡Œçš„Tagè¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœæœ‰ç›¸ç­‰ä¸”è¯¥Cacheçš„æœ‰æ•ˆä½ä¸º1é‚£ä¹ˆè¯´æ˜å‘½ä¸­ï¼Œé€‰æ‹©è¿™ä¸ªCacheè¡Œçš„å¯¹åº”çš„å—å†…åç§»åœ°å€è®¿é—®[^æ³¨é‡Š1]ï¼›å¦‚æœæ²¡æœ‰å‘½ä¸­ï¼Œé‚£ä¹ˆåˆ™æ ¹æ®å¯„å­˜ä¸‹æ¥çš„ç‰©ç†åœ°å€å‘èµ·è®¿å­˜è¯·æ±‚å¹¶ç­‰å¾…ç»“æœè¿”å›Cache[^æ³¨é‡Š2]å¹¶è¯»å‡ºâ€”â€”å‘½ä¸­è¯»å‡ºæ•°æ®éœ€è¦ä¸¤æ‹ï¼Œä¸å‘½ä¸­éœ€è¦ä¸‰æ‹ï¼ˆoffsetä¸º0ï¼‰ã€å››æ‹ï¼ˆoffsetä¸º1ï¼‰ã€äº”æ‹ï¼ˆoffsetä¸º2ï¼‰ã€å…­æ‹ï¼ˆoffsetä¸º3ï¼‰
2. å†™æ“ä½œ

   å†™æ“ä½œå¼€å§‹æ—¶å¯ä»¥ä¸è¯»å–Cacheçš„Dataä¿¡æ¯ï¼Œåªéœ€è¦è¯»Tagã€Væ¥åˆ¤æ–­æ˜¯å¦å‘½ä¸­

   å†™æ“ä½œç¬¬ä¸€æ‹æ—¶ï¼Œå°†è¯·æ±‚ä¸­çš„è™šåœ°å€çš„\[11:4]ä½ä½œä¸ºCacheçš„indexå»è®¿é—®Cacheï¼Œå°†ä¸¤è·¯Cacheä¸­å¯¹åº”è¯¥indexçš„ä¸¤ä¸ªCacheè¡Œçš„Tagã€Véƒ½è¯»å‡ºæ¥ï¼›åŒæ—¶å°†è¯»æ“ä½œçš„è¿™ä¸ªè™šåœ°å€é€MMUè¿›è¡Œåœ°å€è½¬æ¢ï¼Œå¾—åˆ°ç‰©ç†åœ°å€â€”â€”è¿™ä¸ªç‰©ç†åœ°å€éœ€è¦å¯„å­˜ä¸‹æ¥ä¾›ç¬¬äºŒæ‹ä½¿ç”¨

   å†™æ“ä½œåœ¨ç¬¬äºŒæ‹æ—¶ï¼Œå°†å¯„å­˜ä¸‹æ¥çš„ç‰©ç†åœ°å€çš„\[31:12]ä½ä¸è¯»å‡ºçš„ä¸¤ä¸ªCacheè¡Œçš„Tagè¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœæœ‰ç›¸ç­‰ä¸”è¯¥Cacheçš„æœ‰æ•ˆä½ä¸º1é‚£ä¹ˆè¯´æ˜å‘½ä¸­ï¼Œé‚£ä¹ˆå°†è¦å†™çš„æ•°æ®å†™åˆ°Write Bufferä¸­[^æ³¨é‡Š3]ï¼Œç„¶ååœ¨ç¬¬ä¸‰æ‹ç”±Write Bufferå‘Cacheå‘å‡ºå†™è¯·æ±‚ï¼Œå†™Cacheå¯¹åº”indexçš„å¯¹åº”è·¯çš„å—çš„å¯¹åº”åç§»å­—ï¼Œå¹¶å°†è¿™ä¸€Cacheå—çš„è„ä½Dç½®1ï¼›å¦‚æœæœªå‘½ä¸­ï¼Œåˆ™éœ€è¦é€šè¿‡æ€»çº¿å‘å¤–å‘èµ·è®¿å­˜è¯·æ±‚ï¼Œç„¶ åç­‰è®¿å­˜ç»“æœè¿”å› Cache æ¨¡å—ï¼Œæœ€åå°† store è¦å†™çš„æ•°æ®å’Œå†…å­˜é‡å¡«çš„æ•°æ®æ‹¼åˆåœ¨ä¸€èµ·ï¼Œä¸€å¹¶å†™å…¥ Cache ä¸­â€”â€”å‘½ä¸­ä¸‰æ‹å†™åˆ°Cacheã€ä¸å‘½ä¸­å¯èƒ½å››æ‹ã€äº”æ‹ã€å…­æ‹ã€ä¸ƒæ‹

> ğŸ“ŒCacheè¯»ã€å†™ä¸å‘½ä¸­æ—¶çš„å¤„ç†
>
> 1. è®°å½•Cacheæœªå‘½ä¸­çš„åœ°å€(TAG+index+offsrt)ä»¥åŠæ“ä½œç±»å‹ï¼ˆå†™æ“ä½œè¿˜éœ€è¦è®°å½•å†™æ•°æ®ï¼‰
>
>    è¿™äº›ä¿¡æ¯å…¶å®è¿˜æ˜¯è®°å½•åœ¨request bufferä¸­
> 2. é€šè¿‡AXIæ€»çº¿å‘å¤–å‘èµ·å¯¹è¯¥ç¼ºå¤±å—çš„è®¿é—®ï¼Œè®¿é—®çš„åœ°å€æ˜¯ç¼ºå¤±çš„Cacheå—çš„èµ·å§‹åœ°å€ï¼ˆoffsetä¸º4'b0ï¼‰ï¼Œç„¶åå¤§å°æ˜¯ä¸€ä¸ªCacheå—çš„å¤§å°type=3'b100
> 3. åœ¨æ‰§è¡Œç¬¬äºŒæ­¥çš„åŒæ—¶æˆ–è€…æ˜¯ç­‰å¾…è¯»å“åº”çš„è¿‡ç¨‹ä¸­ï¼Œæ ¹æ®æ›¿æ¢ç®—æ³•ï¼Œåœ¨å¯¹åº”indexçš„ä¸¤è·¯Cacheå—ä¸­ï¼Œé€‰æ‹©ä¸€ä¸ªè¯»å‡ºï¼Œè®°å½•é€‰çš„å“ªä¸€è·¯replace\_wayï¼›å¦‚æœå‘ç°è¯¥Cacheå—çš„V=1ä¸”D=1ï¼Œé‚£ä¹ˆéœ€è¦å°†è¿™ä¸ªCacheå—çš„æ•°æ®é€šè¿‡AXIæ€»çº¿æ¥å£å†™å›å»â€”â€”å†™è¯·æ±‚v\&dï¼›å¦åˆ™ä¸åšä»»ä½•å¤„ç†
> 4. å¾…ç¬¬äºŒæ­¥çš„æ•°æ®è¿”å›å›æ¥åï¼Œç”Ÿæˆè¦å¡«å†™åˆ°Cacheçš„Cacheå—ä¿¡æ¯â€”â€”å¤ç”¨Write hitçš„é€šé“
>
>    Cache V=1,Tagæ˜¯è¯¥ç‰©ç†åœ°å€çš„\[31:12]
>
>    è‹¥æ˜¯Write Missé‚£ä¹ˆD=1ï¼ŒDataç­‰äºè¯»å‡ºçš„æ•°æ®ä¸å†™æ•°æ®çš„ç»„åˆ
>
>    å¦åˆ™D=0ï¼ŒDataå°±æ˜¯è¯»å‡ºçš„æ•°æ®
> 5. å°†è¯¥Cacheå—å†™å…¥ç¬¬ä¸‰æ­¥è®°å½•ä¸‹æ¥çš„indexè¡Œçš„å¯¹åº”è·¯ä¸­

#### 1.2.2 Cacheè¡¨çš„ç»„ç»‡ç®¡ç†

![](image/image_VjRbwI-HsB.png)

å·¦å›¾æ˜¯ç›®å‰ä¸»è¦æµè¡Œçš„Cacheè¡¨ç»“æ„

ä½†æ˜¯è¿™ç§ç”»æ³•ç¦»å®ç°è¿˜æœ‰ä¸€äº›å·®è·ï¼Œä¸‹é¢è¿›è¡Œè¡¥å……

1. æŒ‰ç…§Cacheè¡Œä¸­çš„ä¿¡æ¯â€œTagã€Vã€Dã€Dataâ€ï¼Œé‚£ä¹ˆå¯¹äºä¹‹å‰å·²ç»è§„å®šå¥½è§„æ ¼çš„Cacheæ¥è¯´ï¼Œå®ƒæœ‰ä¸¤å¼ 256é¡¹\*20bitçš„Tagè¡¨ã€ä¸¤å¼ 256\*1bitçš„Vè¡¨ã€ä¸¤å¼ 256\*1bitçš„Dè¡¨ä»¥åŠä¸¤å¼ 256é¡¹\*16Bçš„Dataè¡¨
2. æ‰€æœ‰ Cache æ¨¡å—çš„æ“ä½œï¼ˆè¯»ã€å†™ä»¥åŠè¯»ä¸å‘½ä¸­å†™ä¸å‘½ä¸­çš„æƒ…å†µï¼‰åˆ†è§£ä¹‹åï¼Œè½å®åˆ°è¿™äº›è¡¨ä¸Šçš„åªæœ‰è¯»å’Œå†™

   ä¾æ®åœ¨è¯»ã€å†™æ“ä½œè®¿é—® Cache æ‰§è¡Œè¿‡ç¨‹ä¸­æ‰€å±çš„ä¸åŒé˜¶æ®µï¼Œå°†å¯¹ Cache æ¨¡å—è¿›è¡Œçš„è®¿é—®å½’çº³ä¸ºå››ç§ï¼šLook Upã€Hit Writeã€Replace å’Œ Refill

   Look UPï¼šè¯»å†™æ“ä½œåœ¨ç¬¬ä¸€æ‹æ—¶åšçš„æ“ä½œï¼›æ ¹æ®indexè¯»Cacheè¡Œä¸¤è·¯çš„Tagã€Vã€Dataçš„éƒ¨åˆ†å­—ï¼ˆåˆ¤æ–­å‘½ä¸å‘½ä¸­ï¼‰[^æ³¨é‡Š4]

   Hit Writeï¼šæ˜¯åœ¨å†™å‘½ä¸­æ—¶çš„å†™Cacheå¯¹åº”è·¯ï¼›åªéœ€è¦æ›´æ–°å‘½ä¸­è·¯Dataçš„éƒ¨åˆ†æ•°æ®ï¼Œä¸”æ›´æ–°è¯¥å‘½ä¸­è·¯D=1

   Replaceï¼šæ˜¯åœ¨è¯»ä¸å‘½ä¸­ã€å†™ä¸å‘½ä¸­è¿›è¡Œå†™åˆ†é…æ—¶çš„æ ¹æ®æ›¿æ¢ç®—æ³•ï¼Œé€‰æ‹©å½“å‰Cacheè¡Œçš„æŸè·¯è¯»å‡ºï¼Œå¹¶æ ¹æ®è¯¥è·¯çš„Vã€Då†³å®šæ˜¯å¦å†™å›ä¸»å­˜ï¼›éœ€è¦è¯»å¾…æ›¿æ¢è·¯çš„å…¨éƒ¨Dataã€ä»¥åŠDã€Vã€Tag

   Refillï¼šæ˜¯åœ¨è¯»/å†™ä¸å‘½ä¸­ä»¥åï¼Œå°†è°ƒæ¢å‡ºæ¥çš„å—å†™åˆ°è¢«æ›¿æ¢çš„indexå¯¹åº”è·¯ä¸Šã€‚éœ€è¦å†™è¢«æ›¿æ¢è·¯çš„å…¨éƒ¨

   è¿™å››ç§ä¸åŒCacheè®¿é—®å¯¹Cacheå„éƒ¨åˆ†çš„è®¿é—®è¡Œä¸ºåˆ†æè¡¨å¦‚ä¸‹ï¼š
   |      | Look up      | Hit Write     | Replace          | Refill                |
   | ---- | ------------ | ------------- | ---------------- | --------------------- |
   | Tag  | è¯»æ‰€æœ‰è·¯         | X             | è¯»è¢«æ›¿æ¢è·¯            | å†™è¢«æ›¿æ¢è·¯                 |
   | V    | è¯»æ‰€æœ‰è·¯         | X             | è¯»è¢«æ›¿æ¢è·¯            | å†™è¢«æ›¿æ¢è·¯                 |
   | Data | è¯»æ¯è·¯Dataçš„éƒ¨åˆ†æ•°æ® | å†™å‘½ä¸­è·¯Dataçš„éƒ¨åˆ†æ•°æ® | è¯»è¢«æ›¿æ¢è·¯&#xA;å…¨éƒ¨Data | å†™è¢«æ›¿æ¢è·¯å…¨éƒ¨Data           |
   | D    | X            | æ›´æ–°å‘½ä¸­è·¯Dä¸º1      | è¯»è¢«æ›¿æ¢è·¯            | å†™è¢«æ›¿æ¢è·¯&#xA;W=1&#xA;R=0 |
3. Cacheè¡¨åˆå¹¶ä»¥åŠå£°æ˜

   ç»“åˆ1å’Œ2å¯ä»¥å¾—åˆ°ï¼ŒRefillåœ¨Replaceä¹‹åï¼Œä¸ä¼šåŒæ—¶å‘ç”Ÿå³Replaceå’ŒRefillå¯¹{Tagã€V}çš„è¯»å†™ä¸ä¼šåŒæ—¶å‡ºç°ï¼›è€ŒReplaceåˆæ˜¯åœ¨Look upæ¯”è¾ƒå¾—çŸ¥å‘½ä¸å‘½ä¸­ä¹‹åï¼Œæ‰€ä»¥Look upå’ŒReplaceå¯¹{Tagã€V}çš„è¯»ä¹Ÿä¸ä¼šåŒæ—¶å‘ç”Ÿï¼Œå› æ­¤{Tagã€V}åŒä¸€æ—¶åˆ»åªèƒ½æ¥å—ä¸€ä¸ªè¯»/å†™è¯·æ±‚ï¼›
   DåŒç†

   è‡³äºDataçš„è¯ä¼šå­˜åœ¨ç›¸å…³ï¼Œå› ä¸ºä¸€ä¸ªè¯»æ“ä½œçš„Look Up å’Œæ¥è‡ªä¸€ä¸ªå†™æ“ä½œçš„ Hit Write å¯èƒ½åŒæ—¶å‘ç”Ÿï¼Œä¸€ç§ç®€å•é«˜æ•ˆä½†åº•å±‚ç”µè·¯å®ç°ä¸å‹å¥½çš„æ–¹å¼æ˜¯â€œè®© Data è¡¨åŒæ—¶æ”¯æŒä¸€ä¸ªè¯»è¯·æ±‚å’Œä¸€ä¸ªå†™è¯·æ±‚â€ã€‚å› æ­¤é€‰æ‹©å¦ä¸€ç§è§£å†³æ€è·¯â€œåªè¦å‘ç”ŸHit Write å°±é˜»å¡è¯»æ“ä½œçš„ Look Upâ†’åªè¦å‘ç”Ÿçš„Hit Writeå’ŒLook upçš„è¯»å†™å­—ä¸å†²çªï¼Œå°±å¯ä»¥åŒæ—¶è¿›è¡Œâ€â€”â€”å› æ­¤åé¢è§„å®šäº†Write Bufferæ—¶åªèƒ½é˜»å¡

   è¿›ä¸€æ­¥ä¸¥æ ¼é˜»å¡æ¡ä»¶â†’**å› ä¸ºç›®å‰çš„è¯»å†™éƒ½ä¸è¶…è¿‡1ä¸ª32ä½çš„å­—ï¼Œæ‰€ä»¥æŠŠ Data è¡¨æ¨ªå‘æ‹†åˆ†æˆå››ç­‰ä»½ï¼Œæ¯å¼ å­è¡¨åœ¨åŒä¸€æ—¶åˆ»è¿˜æ˜¯è‡³å¤šæ¥æ”¶ä¸€ä¸ªè¯»è¯·æ±‚æˆ–ä¸€ä¸ªå†™è¯·æ±‚ï¼Œæ¯ä»½å‡ç§°ä¸ºBankè¡¨ï¼ŒBankè¡¨æ”¯æŒå­—èŠ‚çº§çš„å†™ç²’åº¦**â€”â€”*å¯¹äºLook upå’ŒHit missåŒæ—¶è®¿é—®ä¸€ä¸ªBankæ—¶ï¼Œé˜»å¡Look up*

   é‚£è¿™æ ·å› ä¸ºåé¢å¯¹äºæ€»çº¿çš„è¯»é‡‡ç”¨Brustï¼Œæ‰€ä»¥å¯ä»¥è®¾ç½®ä¸€ä¸ªè®¡æ•°å™¨ï¼Œä»0è®¡æ•°ï¼Œæ¯è¯»ä¸€ä¸ªæ•°æ®å°†è®¡æ•°å™¨åŠ 1ï¼Œå½“è®¡æ•°å™¨å€¼å’Œoffsetå€¼ä¸€æ ·æ—¶å³å¾—åˆ°è¦è¯»å†™çš„è¿™ä¸ªbankæ•°æ®ï¼ˆå†™çš„è¯æ¶‰åŠåˆ°ç»„åˆï¼‰ï¼Œå…¶ä»–bankå†™æ•°æ®å€¼åˆ™æ ¹æ®è®¡æ•°å™¨å€¼é€‰æ‹©å†™bank

> ğŸ“Œå› æ­¤ï¼Œç»è¿‡ä¸Šé¢ä¸‰ç‚¹çš„å™è¿°ï¼Œå®é™…ä¸ŠCacheçš„é€»è¾‘å®ç°è¡¨ä¸€å…±æœ‰$(1+1+4)\times 2=12$å¼ è¡¨â€”â€”æ¯ä¸€è·¯éƒ½æœ‰ä¸€å¼ {Tag,V}ã€ä¸€å¼ {D}ã€Dataçš„4å¼ Bank
>
> ![](image/image_PNzYB6uGqz.png)
>
> è€Œå®¹é‡å¤§çš„è¡¨ï¼Œæ¯”å¦‚Bankã€{Tag,V}é‡‡ç”¨Block RAMå®ç°ï¼ˆWIDTHæ˜¯32,DEPTHæ˜¯256ï¼‰
> &#x20;å®¹é‡å°çš„è¡¨ï¼Œæ¯”å¦‚Dç”¨regfileå®ç°
>
> ä¸ºäº†è®¾è®¡çš„ç®€å•ï¼ŒRAM/Regfileä¸é€»è¾‘è¡¨æ˜¯ä¸€ä¸€æ˜ å°„çš„å…³ç³»[^æ³¨é‡Š5]
>
> ![](image/image_OU5i7Wvil1.png)

#### 1.2.3 Cacheæ¨¡å—åŠŸèƒ½è¾¹ç•Œçš„åˆ’åˆ†

ä¸ºäº†æ˜ç¡®è§„å®šCacheæ¨¡å—å†…éƒ¨è¿˜éœ€è¦å®ç°å“ªäº›æ•°æ®é€šè·¯ï¼Œå¿…é¡»å…ˆåˆ’åˆ†å‡ºåŠŸèƒ½è¾¹ç•Œ

1. **Cacheä¸CPUé—´â€”â€”** â€‹**åˆ©ç”¨CPUå‘å‡ºçš„ç±»SRAMæ¥å£è®¾ç½®Cacheç›¸å…³éœ€è¦çš„ç«¯å£**

   å€¾å‘äºCacheä¸CPUæµæ°´çº¿ä¹‹é—´çš„åŠŸèƒ½ç•Œé™å’Œç°æœ‰çš„â€œç±»SRMA-AXIâ€è½¬æ¥æ¡¥å’ŒCPUæµæ°´çº¿ä¹‹é—´çš„åŠŸèƒ½è¾¹ç•Œåˆ’åˆ†ä¿æŒä¸€è‡´â€”â€”CPU æµæ°´çº¿å‘ Cache æ¨¡å—å‘é€è¯·æ±‚ï¼ŒCache æ¨¡å—ç»™ CPU æµæ°´çº¿è¿”å›æ•°æ®æˆ–æ˜¯å†™æˆåŠŸçš„å“åº”[^æ³¨é‡Š6]

   ä¸ç®€å•è¡¨æ ¼å·®ä¸å¤ªå¤šï¼Œç±»SRMAçš„addræ¢æˆäº†indexã€tagã€offsetè¿™äº›ä¿¡æ¯ã€‚å…¶ä»–åŸºæœ¬ç›¸å½“äºæ¢äº†ä¸ªå[^æ³¨é‡Š7]
   | åç§°       | ä½å®½ | ç›¸å¯¹äºCache&#xA;æ¨¡å—è‡ªèº«æ–¹å‘ | æè¿°                              |
   | -------- | -- | ------------------- | ------------------------------- |
   | valid    | 1  | in                  | è¯»å†™è¯·æ±‚æœ‰æ•ˆï¼ˆç±»sram reqï¼‰               |
   | op       | 1  | in                  | 1è¡¨ç¤ºå†™ï¼›0è¡¨ç¤ºè¯»ï¼ˆç±»sram wrï¼‰             |
   | index    | 8  | in                  | va\[11:4]                       |
   | tag      | 20 | in                  | pa\[31:12]                      |
   | offset   | 4  | in                  | va\[3:0]                        |
   | wstrb    | 4  | in                  | å†™å­—èŠ‚ä½¿èƒ½ï¼ˆç±»sram wstrbï¼‰              |
   | wdata    | 32 | in                  | å†™æ•°æ®                             |
   | addr\_ok | 1  | out                 | è¯¥æ¬¡è¯·æ±‚çš„åœ°å€ä¼ è¾“ OKï¼Œè¯»ï¼šåœ°å€è¢«æ¥æ”¶ï¼›å†™ï¼šåœ°å€å’Œæ•°æ®è¢«æ¥æ”¶ |
   | data\_ok | 1  | out                 | è¯¥æ¬¡è¯·æ±‚çš„æ•°æ®ä¼ è¾“ OKï¼Œè¯»ï¼šæ•°æ®è¿”å›ï¼›å†™ï¼šæ•°æ®å†™å…¥å®Œæˆ    |
   | rdata    | 32 | out                 | è¯»æ•°æ®                             |
   1. validå¯¹åº”sram\_req
   2. opå¯¹åº”sram\_wr
   3. indexå¯¹åº”sram\_addr\[11:4]
   4. tagå¯¹åº”sram\_addr\[31:12]
   5. offsetå¯¹åº”sram\_addr\[3:0]
   6. wstrbå¯¹åº”sram\_wstrb
   7. wdataå¯¹åº”sram\_wdata
   8. addr\_okå¯¹åº”sram\_addr\_ok
   9. data\_okå¯¹åº”sram\_data\_ok
   10. rdataå¯¹åº”sram\_rdata
2. **Cacheä¸AXIé—´â€”â€”ä¿ç•™åŸæ¥çš„â€œaxi\_bridgeâ€æ¨¡å—ï¼Œå¯¹å¤–è¿˜æ˜¯axiçš„äº”ä¸ªé€šé“ï¼Œå°†å¯¹å†…çš„ä¿¡å·ç”±ç±»SRAMä¿¡å·æ”¹ä¸ºCacheä¿¡å·**

   è‡³äºCacheå’ŒAXIç›´æ¥çš„æ•°æ®äº¤æ¢ï¼Œç»™å‡ºä»¥ä¸‹è®¾è®¡å»ºè®®ï¼š

   å¯¹äºè¯»æ“ä½œï¼ŒAXIå’ŒCacheä¹‹é—´é‡‡ç”¨Brustä¼ è¾“ã€‚AXIæ€»çº¿æ¥å£æ¨¡å—æ¯ä¸ªå‘¨æœŸè‡³å¤šç»™Cacheæ¨¡å—è¿”å›32ä½æ•°æ®ï¼ˆéœ€è¦è®¡æ•°å€¼å®ç°ä¸bankå’Œè¯»å†™offsetçš„åŒ¹é…ï¼‰ï¼ŒCacheæ¨¡å—å°†è¿”å›çš„æ•°æ®å¡«å…¥Cacheçš„Bank RAMä¸­æˆ–è€…ç›´æ¥è¿”å›ç»™CPUæµæ°´çº¿

   å¯¹äºå†™æ“ä½œï¼ŒCache æ¨¡å—åœ¨ä¸€ä¸ªå‘¨æœŸå†…ç›´æ¥å°†ä¸€ä¸ª Cache è¡Œçš„æ•°æ®ä¼ ç»™ AXI æ€»çº¿æ¥å£æ¨¡å—ï¼ŒAXI æ€»çº¿æ¥å£æ¨¡å—å†…éƒ¨è®¾ä¸€ä¸ª 16 å­—èŠ‚çš„å†™ç¼“å­˜[^æ³¨é‡Š8]ä¿å­˜è¿™äº›æ•°ï¼Œç„¶åå†æ…¢æ…¢åœ°ä»¥ Burst æ–¹å¼å‘å‡ºå»ï¼ˆé‚£ä¹ˆaxi\_bridgeå†…éƒ¨éœ€è¦è®¾ç½®waitå’Œnumä¿¡å·æ¥ç¡®å®šå†™åˆ°äº†ç¬¬å‡ ä¸ªä»¥åŠè®¾ç½®wlastå¹¶åˆ©ç”¨waitè®¾ç½®w\_validè¿›è¡Œå†™æ•°æ®è¯·æ±‚ä¼ è¾“ï¼‰â€”â€”AXIè½¬æ¥æ¡¥è¿˜æ˜¯ä¸å¤ªæ‡‚ï¼Ÿ

   å› æ­¤AXIå’ŒCacheä¹‹é—´çš„äº¤äº’ä¿¡å·æœ‰ï¼šï¼ˆè¿™äº›ä¿¡å·å³æ˜¯axi\_bridgeçš„å¯¹å†…ä¿¡å·â€”â€”æŒ‡ä»¤çš„è¯»æ¥å£å’Œæ•°æ®çš„è¯»å†™æ¥å£ï¼‰
   | åç§°         | ä½å®½  | ç›¸å¯¹äºCacheçš„æ–¹å‘ | å«ä¹‰                                                                                                |
   | ---------- | --- | ----------- | ------------------------------------------------------------------------------------------------- |
   | rd\_req    | 1   | è¾“å‡º          | è¯»è¯·æ±‚æœ‰æ•ˆä¿¡å·ï¼Œé«˜æœ‰æ•ˆ                                                                                       |
   | rd\_type   | 3   | è¾“å‡º          | è¯»è¯·æ±‚ç±»å‹â€”â€”ç›¸å½“äºåŸæ¥çš„size&#xA;3'b000â€”â€”å­—èŠ‚ï¼Œ3'b001â€”â€”åŠå­—ï¼Œ3'b010â€”â€”å­—ï¼Œ3'b100â€”â€”Cache è¡Œ                             |
   | rd\_addr   | 32  | è¾“å‡º          | è¯»è¯·æ±‚çš„èµ·å§‹åœ°å€                                                                                          |
   | rd\_rdy    | 1   | è¾“å…¥          | è¯»è¯·æ±‚èƒ½å¦è¢«æ¥å—çš„æ¡æ‰‹ä¿¡å·â€”â€”æˆåŠŸæ¡æ‰‹ä»¥åCacheçš„ä¸»çŠ¶æ€æœºæ‰èƒ½ç”±REPLACEâ†’REFILL                                                  |
   | ret\_valid | 1   | è¾“å…¥          | è¯»æ•°æ®æœ‰æ•ˆä¿¡å·ï¼Œé«˜æœ‰æ•ˆ                                                                                       |
   | ret\_last  | 2   | è¾“å…¥          | å½“å‰è¯»æ•°æ®æ˜¯å¦æ˜¯è¯»è¯·æ±‚å¯¹åº”çš„æœ€åä¸€ä¸ªæ•°æ®                                                                              |
   | ret\_data  | 32  | è¾“å…¥          | æ¯ä¸€å‘¨æœŸçš„è¯»æ•°æ®                                                                                          |
   | wr\_req    | 1   | è¾“å‡º          | å†™è¯·æ±‚æœ‰æ•ˆä¿¡å·ï¼Œé«˜æœ‰æ•ˆâ€”â€”åœ¨æ”¶åˆ°w\_rdyåï¼Œå¦‚æœè¢«æ›¿æ¢çš„Cacheå—æœ‰æ•ˆä¸”è„æ—¶å‘èµ·å†™è¯·æ±‚                                                    |
   | wr\_type   | 3   | è¾“å‡º          | å†™è¯·æ±‚ç±»å‹â€”â€”ç›¸å½“äºåŸæ¥çš„size&#xA;3'b000â€”â€”å­—èŠ‚ï¼Œ3'b001â€”â€”åŠå­—ï¼Œ3'b010â€”â€”å­—ï¼Œ3'b100â€”â€”Cache è¡Œ                             |
   | wr\_addr   | 32  | è¾“å‡º          | å†™è¯·æ±‚çš„èµ·å§‹åœ°å€                                                                                          |
   | wr\_wstrb  | 4   | è¾“å‡º          | å†™å­—èŠ‚æ©ç &#xA;ä»…åœ¨wr\_typeä¸º3'b000ã€3'b001ã€3'b010æ—¶æœ‰æ„ä¹‰[^æ³¨é‡Š9]                                               |
   | wr\_data   | 128 | è¾“å‡º          | å†™æ•°æ®â€”â€”ä¸€ä¸ªå‘¨æœŸå†…å°±ä¼ è¾“16B                                                                                  |
   | wr\_rdy    | 1   | è¾“å…¥          | å†™è¯·æ±‚è¢«æˆåŠŸæ¥å—ä¿¡å·&#xA;è¦æ±‚ wr\_rdy è¦å…ˆäº wr\_req ç½®èµ·ï¼Œwr\_req çœ‹åˆ° wr\_rdy åæ‰å¯èƒ½ç½®ä¸Šâ€”â€”wr\_rdyæœ‰æ•ˆï¼Œä¸»çŠ¶æ€æœºæ‰èƒ½ç”±MISSâ†’REPLACE |

ä¿ç•™åŸæ¥çš„â€œaxi\_bridgeâ€æ¨¡å—ï¼Œå¯¹å¤–è¿˜æ˜¯axiçš„äº”ä¸ªé€šé“ï¼Œå°†å¯¹å†…çš„ä¿¡å·ç”±ç±»SRAMä¿¡å·æ”¹ä¸ºCacheä¿¡å·â€”â€”æŒ‡ä»¤Cacheçš„è¯»é€šé“ã€æ•°æ®Cacheçš„è¯»å†™é€šé“

#### 1.2.4 Cacheæ¨¡å—å†…é™¤Cacheè¡¨ä¹‹å¤–çš„æ•°æ®é€šè·¯

æ¥ä¸‹æ¥åœ¨åˆ’åˆ†å¥½Cacheæ¨¡å—ä¸å¤–éƒ¨çš„åŠŸèƒ½è¾¹ç•ŒåŸºç¡€ä¸Šï¼Œå°±å¯ä»¥æŠŠCacheæ¨¡å—å†…éƒ¨ä½™ä¸‹çš„æ•°æ®é€šè·¯çš„è®¾è®¡ç¡®å®šä¸‹æ¥&#x20;

Cacheæ¨¡å—çš„è®¿é—®å¯ä»¥å½’çº³ä¸º4ç§ï¼šLook Upã€Hit Writeã€Replaceã€Refill

é˜»å¡Cacheä½¿å¾—è¿™é‡Œçš„Look UPå’ŒReplace & Refillå› ä¸ºä¸å¯èƒ½åŒæ—¶å­˜åœ¨ï¼Œæ‰€ä»¥å¯¹äºLook upå’ŒReplaceéƒ½è¯·æ±‚è¯»äº†Tagã€Dataã€Vçš„æ•°æ®é€šè·¯å¯ä»¥å¤ç”¨

å°†æ¯ä¸ªè®¿é—®æ‰€åšçš„å·¥ä½œç»†åˆ†åˆ°æ¨¡å—ï¼Œé‚£ä¹ˆCache Look UPå’ŒReplace & Refillçš„æ ¸å¿ƒæ˜¯Request Bufferã€Tag Compareã€Data Selectã€Miss Bufferå’ŒLSFRï¼›è€ŒWrite Hitçš„æ ¸å¿ƒæ˜¯Write Buffer

1. Request Buffer

   Request Bufferè´Ÿè´£å°†CPUè¾“å…¥çš„opã€indexã€tagã€offsetã€wstrbã€wdataé”å­˜ä¸‹æ¥

   é”å­˜çš„åŸå› æ˜¯å› ä¸ºRAMé‡‡ç”¨Block RAMï¼Œè¯»è®¿é—®ä¼šè·¨è¶Šä¸¤æ‹ï¼Œä¸ºäº†ä¿è¯Request Bufferçš„è¾“å‡ºå’ŒRAMè¯»å‡ºçš„Tagã€Vã€Dataç­‰ä¿¡æ¯å±äºåŒä¸€æ‹ï¼Œéœ€è¦é”å­˜è¿™äº›ä¿¡æ¯
2. Tag Compare

   Tag Compareè´Ÿè´£å°†æ¯ä¸€è·¯ Cache ä¸­è¯»å‡ºçš„ Tag å’Œ Request Buffer å¯„å­˜ä¸‹æ¥çš„ tag ï¼ˆè®°ä¸º reg\_tagï¼‰è¿›è¡Œç›¸ç­‰æ¯”è¾ƒï¼Œç”Ÿæˆæ˜¯å¦å‘½ä¸­çš„ç»“æœï¼ˆå¦‚æœUncacheï¼Œé‚£ä¹ˆä¸€å®šä¸å‘½ä¸­ï¼‰
   ```verilog
   assign way0_hit = way0_v && (way0_tag == reg_tag); 
   assign way1_hit = way1_v && (way1_tag == reg_tag); 
   assign cache_hit = (way0_hit || way1_hit) & ~requestBuffer_uncache;
   ```
3. Data Select

   Data Selectæ•°æ®é€šè·¯æ˜¯å¯¹ä¸¤è·¯ Cache ä¸­è¯»å‡ºçš„ Data ä¿¡æ¯è¿›è¡Œé€‰æ‹©ï¼Œå¾—åˆ°å„ç§è®¿é—®æ“ä½œéœ€è¦çš„ç»“æœ

   å¯¹åº”å‘½ä¸­çš„è¯» Load æ“ä½œï¼Œé¦–å…ˆç”¨åœ°å€çš„ \[3:2] ä»æ¯ä¸€è·¯ Cache è¯»å‡ºçš„ Data æ•°æ®ä¸­é€‰æ‹©ä¸€ä¸ªå­—ï¼Œç„¶åæ ¹æ® Cache å‘½ä¸­çš„ç»“æœä»ä¸¤ä¸ªå­—ä¸­é€‰æ‹©å‡º Load çš„ç»“æœï¼ˆæ­¤å¤„æœªè€ƒè™‘ Miss æƒ…å†µï¼Œå¦‚æœ Missï¼ŒLoad çš„æœ€ç»ˆç»“æœæ¥è‡ª AXI æ¥å£çš„è¿”å›ï¼Œå› æ­¤è¿™é‡Œè¦ä¹ˆæ˜¯ä¸€ä¸ªä¸‰é€‰ä¸€é€»è¾‘è¦ä¹ˆåé¢å†äºŒé€‰ä¸€ï¼‰
   å¯¹åº” Replace æ“ä½œï¼Œåªéœ€è¦æ ¹æ®æ›¿æ¢ç®—æ³•å†³å®šçš„è·¯ä¿¡æ¯ï¼Œå°†è¯»å‡ºçš„ Data é€‰æ‹©å‡ºæ¥å³å¯
   ```verilog
   assign way0_load_word = way0_data[pa[3:2]*32 +: 32]; //ä»[3:2]*32ä½å¼€å§‹ï¼Œè¯»32ä½æ•°æ®
   assign way1_load_word = way1_data[pa[3:2]*32 +: 32]; 
   assign load_res = {32{way0_hit}} & way0_load_word | 
                     {32{way1_hit}} & way1_load_word; //å¦‚æœè€ƒè™‘missï¼Œ åº”è¯¥æ˜¯ä¸‰é€‰ä¸€ï¼Œä¹Ÿå¯ä»¥åé¢å†äºŒé€‰ä¸€
   ```
4. Miss Buffer

   Miss Bufferè®°å½•äº†ç¼ºå¤±Cacheè¡Œå‡†å¤‡è¦æ›¿æ¢çš„å¯¹åº”è·¯çš„ä¿¡æ¯â€”â€”æ›¿æ¢çš„å“ªä¸€è·¯ï¼ˆregï¼‰å…¶ä»–dataã€dã€vã€tagä»ä¿å­˜åœ¨requestBufferä¸­ï¼Œä»¥åŠå·²ç»ä»AXIæ€»çº¿è¿”å›äº†å‡ ä¸ª 32 ä½æ•°æ®â€”â€”å› ä¸ºè¦ç”Ÿæˆè¯»ä¸å‘½ä¸­æ—¶çš„data\_okå’Œå†™ä¸å‘½ä¸­æ—¶çš„ä¸å†™æ•°æ®ç»“åˆ

   Miss å¤„ç†æ—¶éœ€è¦çš„åœ°å€ã€æ˜¯å¦æ˜¯ Store æŒ‡ä»¤ç­‰ä¿¡æ¯ä¾ç„¶ç»´æŠ¤åœ¨ Request Buffer ä¸­
5. LSFR

   LFSRæ˜¯çº¿æ€§åé¦ˆç§»ä½å¯„å­˜å™¨ï¼Œç”¨äºä½œä¸ºä¼ªéšæœºæ›¿æ¢ç®—æ³•çš„ä¼ªéšæœºæº

   [ ï¼ˆä¹ï¼‰è¯¦è§£çº¿æ€§åé¦ˆç§»ä½å¯„å­˜å™¨ï¼ˆLFSRï¼‰ æœ¬æ–‡æ˜¯ã€Šç°ä»£å¯†ç å­¦ã€‹è¯¾ç¨‹ç¬”è®°ä¸“æ çš„ç¬¬9ç¯‡ï¼Œæ¬¢è¿å…³æ³¨æœ¬ä¸“æ ï¼š ã€Šç°ä»£å¯†ç å­¦ã€‹è¯¾ç¨‹ç¬”è®° ä¸ŠèŠ‚è¯¾æåˆ°ï¼Œæµå¯†ç çš„æµå¯†é’¥äº§ç”Ÿå™¨å¯ä»¥é€šè¿‡çº¿æ€§é©±åŠ¨å’Œéçº¿æ€§ç»„åˆä¸¤éƒ¨åˆ†æ¥å®ç°ã€‚è€Œçº¿æ€§é©±åŠ¨éƒ¨åˆ†å¯ä»¥ç”±çº¿æ€§åé¦ˆç§»ä½å¯„å­˜å™¨ï¼ˆLFSâ€¦ https://zhuanlan.zhihu.com/p/366067972](https://zhuanlan.zhihu.com/p/366067972 " ï¼ˆä¹ï¼‰è¯¦è§£çº¿æ€§åé¦ˆç§»ä½å¯„å­˜å™¨ï¼ˆLFSRï¼‰ æœ¬æ–‡æ˜¯ã€Šç°ä»£å¯†ç å­¦ã€‹è¯¾ç¨‹ç¬”è®°ä¸“æ çš„ç¬¬9ç¯‡ï¼Œæ¬¢è¿å…³æ³¨æœ¬ä¸“æ ï¼š ã€Šç°ä»£å¯†ç å­¦ã€‹è¯¾ç¨‹ç¬”è®° ä¸ŠèŠ‚è¯¾æåˆ°ï¼Œæµå¯†ç çš„æµå¯†é’¥äº§ç”Ÿå™¨å¯ä»¥é€šè¿‡çº¿æ€§é©±åŠ¨å’Œéçº¿æ€§ç»„åˆä¸¤éƒ¨åˆ†æ¥å®ç°ã€‚è€Œçº¿æ€§é©±åŠ¨éƒ¨åˆ†å¯ä»¥ç”±çº¿æ€§åé¦ˆç§»ä½å¯„å­˜å™¨ï¼ˆLFSâ€¦ https://zhuanlan.zhihu.com/p/366067972")
6. Write Buffer

   Write Bufferéœ€è¦åœ¨Hit Write(Look UPæ—¶æ£€æµ‹åˆ°å‘½ä¸­ä¸”æ˜¯Storeæ“ä½œ)æ—¶å¯åŠ¨ï¼Œä¼šå¯„å­˜Store è¦å†™å…¥çš„ wayã€bankã€indexã€bank å†…å­—èŠ‚å†™ä½¿èƒ½å’Œå†™æ•°æ®ï¼Œç„¶åä½¿ç”¨å¯„å­˜åçš„å€¼å†™å…¥ Cache ä¸­

> Cacheè¡¨çš„è¾“å…¥ç”Ÿæˆé€»è¾‘
>
> ç”±äºæ¯ä¸ªè¡¨éƒ½æ˜¯é‡‡ç”¨å•ç«¯å£çš„ Regfile æˆ– RAM å®ç°ï¼Œä½†æ˜¯æ¯ä¸ªè¡¨çš„è®¿é—®åœ°å€ã€å†™æ•°æ®å’Œå†™å­—èŠ‚ä½¿èƒ½å¯èƒ½æ¥è‡ªå¤šä¸ªåœ°æ–¹ï¼Œå› æ­¤è¦é€šè¿‡å¤šè·¯é€‰æ‹©å™¨è¿›è¡Œé€‰æ‹©ä¹‹åï¼Œå†è¿æ¥åˆ° Regfile æˆ– RAM çš„è¾“å…¥ç«¯å£ä¸Š
>
> | è¡¨       | ç«¯å£    | Look UP      | Write Hit    | Replace                       | Refill                 |
> | ------- | ----- | ------------ | ------------ | ----------------------------- | ---------------------- |
> | {Tag,V} | åœ°å€    | index[^æ³¨é‡Š10] | X            | Request Buffer                | Request Buffer         |
> |         | å†™æ•°æ®   | X            | X            | X                             | Request Buffer         |
> | D       | åœ°å€    | X            | Write Buffer | Request Buffer & Missbuffer   | Request Buffer         |
> |         | å†™æ•°æ®   | X            | 1'b1         | X                             | Request Bufferçš„OP      |
> | Data    | åœ°å€    | index[^æ³¨é‡Š11] | Write Buffer | Request Buffer and Missbuffer | Request Buffer         |
> |         | å†™æ•°æ®   | X            | Write Buffer | X                             | AXIæ¨¡å—è¾“å…¥& RequestBuffer |
> |         | å†™å­—èŠ‚ä½¿èƒ½ | X            | Write Buffer | X                             | Request Buffer         |

### 1.3 Cacheæ¨¡å—å†…éƒ¨çš„æ§åˆ¶é€»è¾‘è®¾è®¡

#### 1.3.1 Cacheæ¨¡å—è‡ªèº«çš„çŠ¶æ€æœºè®¾è®¡

> è¿˜æ˜¯æŒ‰ç…§ä¹‹å‰å¯¹Look UPã€Replaceã€Refillçš„å™è¿°ï¼Œå®ƒä»¬å¯ä»¥å…±ç”¨ä¸€ä¸ªçŠ¶æ€æœºâ€”â€”ä¸»çŠ¶æ€æœº
> è€ŒWrite Hitéœ€è¦ä¸€ä¸ªå•ç‹¬çš„çŠ¶æ€æœºâ€”â€”Write BufferçŠ¶æ€æœº

1. ä¸»çŠ¶æ€æœº

   ![](image/image_5TFZZiBLxD.png)

   å…±æœ‰5ä¸ªçŠ¶æ€ï¼š

   `IDLE`ï¼šCache æ¨¡å—å½“å‰æ²¡æœ‰ä»»ä½•æ“ä½œ

   `LOOKUP`ï¼šCache æ¨¡å—å½“å‰æ­£åœ¨æ‰§è¡Œä¸€ä¸ªæ“ä½œä¸”å¾—åˆ°äº†å®ƒçš„æŸ¥è¯¢ç»“æœ[^æ³¨é‡Š12]

   `MISS`ï¼šCache æ¨¡å—å½“å‰å¤„ç†çš„æ“ä½œ Cache ç¼ºå¤±ï¼Œä¸”æ­£åœ¨ç­‰å¾… AXI æ€»çº¿çš„ wr\_rdy ä¿¡å· [^æ³¨é‡Š13]

   `REPLACE`ï¼šå¾…æ›¿æ¢çš„ Cache è¡Œå·²ç»ä» Cache ä¸­è¯»å‡ºï¼Œä¸”æ­£åœ¨ç­‰å¾… AXI æ€»çº¿çš„ rd\_rdy ä¿¡å·&#x20;

   `REFILL`ï¼šCache ç¼ºå¤±çš„è®¿å­˜è¯·æ±‚å·²å‘å‡ºï¼Œå‡†å¤‡/æ­£åœ¨å°†ç¼ºå¤±çš„ Cache è¡Œæ•°æ®å†™å…¥ Cache ä¸­

   IDLEâ†’IDLEï¼šè¿™ä¸€æ‹æ²¡æœ‰æ–°çš„Cacheè¯·æ±‚ï¼Œæˆ–è€…æœ‰è¯·æ±‚ä½†ä¸Hit Writeå†²çª[^æ³¨é‡Š14]æ— æ³•è¢«Cacheæ¥æ”¶

   IDLEâ†’LOOKUPï¼šè¿™ä¸€æ‹ï¼ŒCacheæ¥å—åˆ°ä¸€ä¸ªæ–°çš„ä¸Write Hitä¸å†²çªçš„è®¿å­˜è¯·æ±‚

   LOOKIPâ†’IDLEï¼šå½“å‰å¤„ç†çš„æ“ä½œæ˜¯ Cache å‘½ä¸­çš„ï¼Œä¸”è¿™ä¸€æ‹æµæ°´çº¿æ²¡æœ‰æ–°çš„ Cache è®¿é—®è¯·æ±‚ï¼Œæˆ–è€…æœ‰è¯·æ±‚ä½†å› è¯¥è¯·æ±‚ä¸ Hit Write å†²çªè€Œæ— æ³•è¢« Cache æ¥æ”¶

   LOOKUPâ†’LOOKUPï¼šå½“å‰å¤„ç†çš„æ“ä½œæ˜¯ Cache å‘½ä¸­çš„ï¼Œä¸”è¿™ä¸€æ‹ Cache æ¥æ”¶äº†ä¸€ä¸ªæ–°çš„ä¸Write Hitæ— å†²çªçš„ Cache è®¿é—®è¯·æ±‚

   LOOKUPâ†’MISSï¼šå½“å‰å¤„ç†çš„æ“ä½œæœªå‘½ä¸­

   MISSâ†’MISSï¼šAXI æ€»çº¿æ¥å£æ¨¡å—åé¦ˆå›æ¥çš„ wr\_rdy ä¸º 0ï¼ˆwr\_rdyå…ˆäºwr\_reqç½®ä½ï¼‰

   MISSâ†’REPLACEï¼šAXI æ€»çº¿æ¥å£æ¨¡å—åé¦ˆå›æ¥çš„ wr\_rdy ä¸º 1ï¼Œå‘èµ·å¯¹Cacheçš„æ›¿æ¢è¯»è¯·æ±‚ï¼Œå¹¶è½¬åˆ°REPLACE

   REPLACEâ†’REPLACEï¼šAXI æ€»çº¿æ¥å£æ¨¡å—åé¦ˆå›æ¥çš„ rd\_rdy ä¸º 0

   åˆšè¿›å…¥ REPLACE çš„ç¬¬ä¸€æ‹ï¼Œä¼šå¾—åˆ°è¢«æ›¿æ¢çš„ Cache è¡Œæ•°æ®ï¼Œå¹¶å¦‚æœD=1,å‘èµ·wr\_req é€åˆ° AXI æ€»çº¿æ¥å£ã€‚ç”±äº wr\_rdy ä¸º 1ï¼Œæ•… wr\_req ä¸€å®šä¼šè¢«æ¥æ”¶ã€‚åŒæ—¶ï¼Œå¯¹ AXI æ€»çº¿å‘èµ·ç¼ºå¤± Cache çš„è¯»è¯·æ±‚

   REPLACEâ†’REFILLï¼šAXI æ€»çº¿æ¥å£æ¨¡å—åé¦ˆå›æ¥çš„ rd\_rdy ä¸º 1ï¼Œè¡¨ç¤ºå¯¹ AXI æ€»çº¿å‘èµ·çš„ç¼ºå¤± Cache çš„è¯»è¯·æ±‚å°†è¢«æ¥æ”¶

   REFILLâ†’REFILLï¼šç¼ºå¤± Cache è¡Œçš„æœ€åä¸€ä¸ª 32 ä½æ•°æ®ï¼ˆret\_valid=1\&ret\_last=1ï¼‰å°šæœªè¿”å›

   REFILLâ†’IDLEï¼šç¼ºå¤± Cache è¡Œçš„æœ€åä¸€ä¸ª 32 ä½æ•°æ®ï¼ˆret\_valid=1\&ret\_last=1ï¼‰ä» AXI æ€»çº¿æ¥å£æ¨¡å—è¿”å›
2. Write Buffer

   ![](image/image_tDIlVmnnZi.png)

   `IDLE`ï¼šWrite Buffer å½“å‰æ²¡æœ‰å¾…å†™çš„æ•°æ®

   `WRITE`ï¼šå°†å¾…å†™æ•°æ®å†™å…¥åˆ° Cache ä¸­

   åœ¨ä¸»çŠ¶æ€æœºå¤„äº LOOKUP çŠ¶æ€ä¸”å‘ç° Store æ“ä½œå‘½ä¸­ Cache æ—¶ï¼Œè§¦å‘ Write Buffer çŠ¶æ€æœºè¿›å…¥ WRITE çŠ¶æ€ï¼ŒåŒæ—¶ Write Buffer ä¼šå¯„å­˜ Store è¦å†™å…¥çš„ Indexã€è·¯å·ã€offsetã€å†™ä½¿èƒ½ï¼ˆå†™ 32 ä½æ•°æ®é‡Œçš„å“ªäº›å­—èŠ‚ï¼‰å’Œå†™æ•°æ®â€”â€”æ–¹ä¾¿å‰é€’

   IDLEâ†’IDLEï¼šè¿™ä¸€æ‹ï¼ŒWrite Buffer æ²¡æœ‰å¾…å†™çš„æ•°æ®ï¼Œå¹¶ä¸”ä¸»çŠ¶æ€æœºæ²¡æœ‰æ–°çš„ Hit Write

   IDLEâ†’WRITEï¼šè¿™ä¸€æ‹ï¼ŒWrite Buffer æ²¡æœ‰å¾…å†™çš„æ•°æ®ï¼Œå¹¶ä¸”ä¸»çŠ¶æ€æœºå‘ç°æ–°çš„ Hit Write

   WRITEâ†’WRITEï¼šè¿™ä¸€æ‹ï¼ŒWrite Buffer æœ‰å¾…å†™çš„æ•°æ®ï¼Œå¹¶ä¸”ä¸»çŠ¶æ€æœºå‘ç°æ–°çš„ Hit Write

   WRITEâ†’IDLEï¼šè¿™ä¸€æ‹ï¼ŒWrite Buffer æœ‰å¾…å†™çš„æ•°æ®ï¼Œå¹¶ä¸”ä¸»çŠ¶æ€æœºæ²¡æœ‰æ–°çš„ Hit Write

> ğŸ“Œä¸Write Hitå†²çªçš„æƒ…å†µ
>
> 1. ä¸»çŠ¶æ€æœºå¤„äº LOOPUP çŠ¶æ€ä¸”å‘ç° Store æ“ä½œå‘½ä¸­ Cacheï¼Œæ­¤æ—¶æµæ°´çº¿å‘æ¥çš„ä¸€ä¸ªæ–°çš„ Load ç±»çš„ Cache è®¿é—®è¯·æ±‚ï¼Œå¹¶ä¸”è¯¥ Load è¯·æ±‚ä¸ LOOKUP çŠ¶æ€çš„ Store è¯·æ±‚åœ°å€å­˜åœ¨å†™åè¯»ç›¸å…³â€”â€”å¯ä»¥å‰é€’ä¹Ÿå¯ä»¥é˜»å¡
> 2. Write Buffer çŠ¶æ€æœºå¤„äº WRITE çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯æ­£åœ¨å†™å…¥ä¸€ä¸ªå¾…å†™æ•°æ®åˆ° Cache ä¸­ï¼Œæ­¤æ—¶æµæ°´çº¿å‘æ¥çš„ä¸€ä¸ªæ–°çš„ Load ç±»çš„ Cache è®¿é—®è¯·æ±‚ï¼Œå¹¶ä¸”è¯¥ Load è¯·æ±‚ä¸ Write Buffer é‡Œçš„å¾…å†™è¯·æ±‚çš„åœ°å€é‡å [^æ³¨é‡Š15]â€”â€”åªèƒ½é˜»å¡ï¼Œå› ä¸ºBlock RAMæ²¡æ³•åŒæ—¶å“åº”è¯»å†™

> ğŸ“Œæ³¨æ„ï¼ï¼ï¼
>
> 1. ä¸ºäº†é¿å…â€œLOOKUPâ†’LOOKUPâ€å¼•å…¥RAMè¾“å‡ºç«¯åˆ°RMAè¾“å…¥ç«¯çš„è·¯å¾„ï¼Œè®¾ç½®ä¸ç®¡ LOOPUP çŠ¶æ€çš„è¯·æ±‚æ˜¯å¦å‘½ä¸­ Cacheï¼Œæ§åˆ¶ â€œHit Write å†²çªâ€ å’Œæ–°çš„ RAM ä½¿èƒ½ç”Ÿæˆæ—¶åº”è§†ä¸ºå‘½ä¸­æ¥è€ƒè™‘
> 2. åœ¨MISSâ†’REPLACEçš„çŠ¶æ€è¦æ±‚æ˜¯æ”¶åˆ°AXIçš„wreadyä¿¡å·ï¼Œè¿™æ˜¯å› ä¸ºåœ¨å®ç°ä¸­æ€»æ˜¯æ— æ¡ä»¶åœ°å°†æ€»çº¿æ¥å£æ¨¡å—è¿”å›çš„æ•°æ®ç›´æ¥å†™å…¥ Cache ä¸­ï¼Œæ‰€ä»¥åªæœ‰ç¡®è®¤è¢«å†™å…¥ä½ç½®çš„è„æ•°æ®ä¸€å®šèƒ½å¤Ÿå†™å›å†…å­˜ï¼Œè¿™ç§æ— æ¡ä»¶çš„å†™æ‰æ˜¯å®‰å…¨çš„
> 3. å¯¹äºæŒ‡ä»¤Cacheï¼Œå¯ä»¥å°†wr\_rdyæ€»è®¾ç½®ä¸º1â€”â€”æ­¤æ—¶MISSåªä¼šæŒç»­ä¸€æ‹ï¼Œå› ä¸ºICacheæ˜¯ä¸ä¼šæœ‰è„æ•°æ®çš„

#### 1.3.2 Cacheè¡¨çš„ç‰‡é€‰å’Œå†™ä½¿èƒ½

| è¡¨       | ç«¯å£  | Look UP                    | Write Hit                  | Replace      | Refill                       |
| ------- | --- | -------------------------- | -------------------------- | ------------ | ---------------------------- |
| {Tag,V} | ç‰‡é€‰  | ä¸¤è·¯&#xA;åœ¨IDLEæ—¶è¯»å‡ºä»¥ä¾¿LOOKUPæ—¶åˆ¤æ–­ | X                          | ä¹‹å‰çš„LOOKUPå·²è¯»å‡º | ä¸¤è·¯addrok                     |
|         | å†™ä½¿èƒ½ | X                          | X                          | X            | åœ¨RefillçŠ¶æ€ä¸”æ•°æ®å·²è¯»å®Œä¸”é€‰ä¸­å¯¹åº”æ›¿æ¢çš„è·¯     |
| D       | ç‰‡é€‰  | X                          | åœ¨å½“å‰WriteçŠ¶æ€                 | ä¹‹å‰çš„LOOKUPå·²è¯»å‡º | ç»„åˆé€»è¾‘ç›´æ¥è¯»å¯„å­˜å™¨å€¼å°±å¥½                |
|         | å†™ä½¿èƒ½ | X                          | Write Bufferè®°å½•çš„é‚£ä¸€è·¯         | X            | åœ¨RefillçŠ¶æ€ä¸”æ•°æ®å·²è¯»å®Œä¸”é€‰ä¸­å¯¹åº”æ›¿æ¢çš„è·¯     |
| Data    | ç‰‡é€‰  | ä¸¤è·¯&#xA;åœ¨IDLEæ—¶è¯»å‡ºä»¥ä¾¿LOOKUPæ—¶åˆ¤æ–­ | ä¸¤è·¯&#xA;åœ¨IDLEæ—¶è¯»å‡ºä»¥ä¾¿LOOKUPæ—¶åˆ¤æ–­ | LOOKUPå·²è¯»å‡º    | ä¸¤è·¯addrok                     |
|         | å†™ä½¿èƒ½ | X                          | åœ¨å½“å‰WriteçŠ¶æ€ä¸”é€‰ä¸­å¯¹åº”çš„Bank       | X            | åœ¨RefillçŠ¶æ€ä¸”å¯¹åº”bankçš„æ•°æ®å·²è¯»å‡ºä¸”é€‰ä¸­å¯¹åº”è·¯ |

#### 1.3.3 Request/Miss Bufferå„ä¸ªåŸŸçš„å†™ä½¿èƒ½

Request Buffer ä¸­è®°å½•æ¥è‡ªæµæ°´çº¿æ–¹å‘çš„è¯·æ±‚ä¿¡æ¯çš„åŸŸçš„å†™ä½¿èƒ½å°±æ˜¯ Cache æ¨¡å—çŠ¶æ€æœº `IDLEâ†’LOOKUP`å’Œ`LOOKUPâ†’LOOKUP` ä¸¤ç»„çŠ¶æ€è½¬æ¢å‘ç”Ÿæ¡ä»¶çš„å¹¶é›†

Miss Buffer ä¸­è®°å½•ç¼ºå¤± Cache è¡Œå‡†å¤‡è¦æ›¿æ¢çš„è·¯ä¿¡æ¯ï¼ˆç”± LFSR ç”Ÿæˆæ›¿æ¢çš„è·¯å·æˆ–è€…æ— æ•ˆçš„Cacheå—ï¼‰çš„åŸŸçš„å†™ä½¿èƒ½å°±æ˜¯ Cache æ¨¡å—çŠ¶æ€æœº `MISSâ†’REPLACE`çŠ¶æ€è½¬æ¢å‘ç”Ÿæ¡ä»¶ï¼›è®°å½•å·²ç»ä»æ€»çº¿è¿”å›äº†å‡ ä¸ªæ•°æ®çš„å†™ä½¿èƒ½ï¼Œä¸€æ–¹é¢æ¥è‡ª Cache æ¨¡å—çŠ¶æ€æœº`REPLACEâ†’REFILL` çŠ¶æ€è½¬æ¢å‘ç”Ÿæ¡ä»¶ï¼ˆç”¨äºæ¸… 0ï¼‰ï¼Œå¦ä¸€æ–¹é¢æ¥è‡ªæ€»çº¿æ–¹å‘è¾“å…¥çš„`ret_valid`ï¼ˆç”¨äºè®¡æ•°å¢åŠ ï¼‰

#### 1.3.4 æ¨¡å—æ¥å£è¾“å‡ºçš„æ§åˆ¶ä¿¡æ¯

1. addr\_ok

   Cacheä¸»çŠ¶æ€æœºå¤„äºIDLEçŠ¶æ€ä¸‹å¹¶å°†è¿›è¡ŒIDLEâ†’LOOKUPçš„è½¬å˜
   Cacheä¸»çŠ¶æ€æœºå¤„äºLOOKUPå¹¶å°†è¿›è¡ŒLOOKUPâ†’LOOKUPçš„è½¬å˜
2. data\_ok

   Cache å½“å‰çŠ¶æ€ä¸º LOOKUP ä¸” Cache å‘½ä¸­
   Cache å½“å‰çŠ¶æ€ä¸º LOOKUP ä¸”å¤„ç†çš„æ˜¯å†™æ“ä½œ
   Cache å½“å‰çŠ¶æ€ä¸º REFILL ä¸” ret\_valid=1ä¸”è¿›è¡Œçš„æ˜¯è¯»æ“ä½œï¼ŒåŒæ—¶ Miss Buffer ä¸­è®°å½•çš„è¿”å›å­—ä¸ªæ•°ä¸ Cache ç¼ºå¤±åœ°å€çš„ \[3:2] ç›¸ç­‰
   > ä¸ºä»€ä¹ˆå†™æ“ä½œä¸ç®¡å‘½ä¸å‘½ä¸­éƒ½ç›´æ¥è¿”å›äº†data\_ok
   >
   > 1. å†™å‘½ä¸­æ—¶ï¼Œè¿›å…¥äº†write\_bufferä¼šé˜»å¡ä¹‹åçš„è¯»è¯·æ±‚ï¼›å¦‚æœè¿˜åœ¨LOOKUPé‚£ä¹ˆæ˜¯å¯ä»¥å‰é€’çš„
   >    åé¢çš„è¯»æ˜¯ä¸ä¼šè¿”å›é”™è¯¯å€¼çš„ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥è¿”å›dataok
   > 2. å½“å†™ä¸å‘½ä¸­æ—¶ï¼Œè¿›å…¥äº†MISSã€‚ç”±äºä½¿ç”¨çš„æ˜¯é˜»å¡Cacheï¼Œä¼šç­‰åˆ°REFILLå®Œåˆ°IDLEæ—¶å†å“åº”æ–°çš„è¯·æ±‚ã€‚æ‰€ä»¥è¿”å›dataokå¯¹äºåé¢çš„è¯»ç›¸å…³æ ¹æœ¬ä¸ä¼šå“åº”
3. AXIæ¥å£æ–¹å‘ä¸Šçš„rd\_reqä¿¡å·

   å½“Cacheæ¨¡å—ä¸»çŠ¶æ€æœºå¤„äºREPLACEçŠ¶æ€æ—¶ï¼Œç»„åˆé€»è¾‘å°†rd\_reqç½®1
4. AXIæ¥å£æ–¹å‘ä¸Šçš„wr\_reqä¿¡å·

   å¤ä½æœŸé—´æ¸…0

   å½“ä¸»çŠ¶æ€æœºç”±MISSâ†’REPLACEæ—¶ï¼Œè‹¥D=1 V=1å°†å…¶ç½®1ï¼Œéšååœ¨MAIN\_REPLACEå°†å…¶æ¸…0

### 1.4 Cacheçš„ç¡¬ä»¶åˆå§‹åŒ–

åœ¨æ²¡æœ‰å¯¹æ¥CacheæŒ‡ä»¤CACOPæ—¶ï¼Œæ— æ³•è¿›è¡ŒCacheçš„è½¯ä»¶åˆå§‹åŒ–ï¼Œå› æ­¤éœ€è¦è€ƒè™‘ç¡¬ä»¶åˆå§‹åŒ–çš„é—®é¢˜â€”â€”åœ¨ç”ŸæˆBlock RAM IPæ—¶é€‰æ‹©å°†å…¶å‰©ä½™å†…å®¹å¡«å……0

### 1.5 è®¾è®¡ç»¼è¿°

1. è®¾è®¡æ¨¡å—ç«¯å£è¾“å…¥è¾“å‡º

   Cacheæ¨¡å—è¾“å…¥CPUä¸Cacheäº¤äº’çš„è®¿å­˜ä¿¡å·â€”â€”å–æŒ‡+è®¿å­˜

   ç®€å•è¡¨æ ¼

   Cacheæ¨¡å—è¾“å‡ºCacheä¸AXIè½¬æ¥æ¡¥äº¤äº’çš„ä¿¡å·

   ç®€å•è¡¨æ ¼
   ```verilog
   module cache (
       input clk,
       input resetn,

       //ä¸CPUäº¤äº’çš„ä¿¡å·
       input  wire        valid,    //è®¿å­˜æœ‰æ•ˆä¿¡å·
       input  wire        op,       //é«˜è¡¨ç¤ºå†™ï¼Œä½è¡¨ç¤ºè¯»
       input  wire [ 7:0] index,    //va[11:4]
       input  wire [19:0] tag,      //pa[31:12]
       input  wire [ 3:0] offset,   //va[3:0]
       input  wire [ 3:0] wstrb,    //å­—èŠ‚å†™é€š
       input  wire [31:0] wdata,    //å†™æ•°æ®
       output wire        addr_ok,  //æ¡æ‰‹ä¿¡å·â€”â€”ç±»ä¼¼ç±»SRAM
       output wire        data_ok,
       output wire [31:0] rdata,    //è¯»æ•°æ®

       //ä¸AXIäº¤äº’
       output wire rd_req,  //å‘é€ç»™AXIæ€»çº¿è½¬æ¥æ¡¥çš„è¯»è¯·æ±‚ä¿¡å·
       output wire [2:0] rd_type,  //è¯»ç±»å‹ï¼Œä¹Ÿè¡¨ç¤ºäº†åŸæ¥ç±»SRAM-AXIè½¬æ¥æ¡¥çš„sizeä¿¡å·
       output wire [31:0] rd_addr,  //è¯»åœ°å€
       input wire rd_rdy,  //è½¬æ¥æ¡¥è¿”å›çš„æ¡æ‰‹ä¿¡å·ï¼Œè¯·æ±‚å¯ä»¥è¢«æ¥å—
       input wire ret_valid,  //è¿”å›çš„æ˜¯æœ‰æ•ˆæ•°æ®
       input wire [1:0] ret_last,  //æ˜¯å¦æ˜¯æœ€åä¸€ä¸ªæœ‰æ•ˆæ•°æ®è¿”å›
       input wire [31:0] ret_data,  //è¯»æ•°æ®
       output wire wr_req,  //å†™AXIè¯·æ±‚
       output wire [2:0] wr_type,  //å†™ç±»å‹
       output wire [31:0] wr_addr,
       output wire [3:0] wr_wstrb,
       output wire [127:0] wr_data,
       input wire wr_rdy //å› ä¸ºå†™æ˜¯ä¸€æ¬¡æ€§å°†128ä¸ªå…¨å†™åˆ°AXIæ€»çº¿çš„å†™ç¼“å†²ä¸Šï¼Œç”±å®ƒæ¥Brustï¼Œæ‰€ä»¥éœ€è¦æœ‰å†™ç¼“å†²ç©ºå¯ä»¥æ¥æ”¶æ–°è¯·æ±‚çš„wr_rdyä¿¡å·
   );
   ```
2. å®šä¹‰Cacheè¡¨

   Dç”¨å¯„å­˜å™¨æ¥è¡¨ç¤ºâ€”â€”ä¸¤ä¸ª256ä½å®½çš„å¯„å­˜å™¨

   {Tag,V}ç”¨ä¸€ä¸ªSRAMè¡¨ç¤ºâ€”â€”ä¸¤ä¸ªtagv ram

   16B Dataä¸ºäº†æ›´ç»†åˆ†ç›¸å…³ï¼Œåˆ’åˆ†ä¸º4ä¸ªBankâ€”â€”8ä¸ªBank ram
   ```verilog
     //D
     reg [255:0] way0_D;
     reg [255:0] way1_D;

     //Tag 20:1 V 0
     wire way0_tagv_ena;
     wire way0_tagv_wea;
     wire [7:0] way0_tagv_addra;
     wire [20:0] way0_tagv_dina;
     wire [20:0] way0_tagv_dout;

     wire way1_tagv_ena;
     wire way1_tagv_wea;
     wire [7:0] way1_tagv_addra;
     wire [20:0] way1_tagv_dina;
     wire [20:0] way1_tagv_dout;

     //Data Bank
     wire way0_bank0_ena;
     wire [3:0] way0_bank0_wea;  //å­—èŠ‚å†™
     wire [7:0] way0_bank0_addr;
     wire [31:0] way0_bank0_dina;
     wire [31:0] way0_bank0_dout;

     wire way0_bank1_ena;
     wire [3:0] way0_bank1_wea;  //å­—èŠ‚å†™
     wire [7:0] way0_bank1_addr;
     wire [31:0] way0_bank1_dina;
     wire [31:0] way0_bank_dout;

     wire way0_bank2_ena;
     wire [3:0] way0_bank2_wea;  //å­—èŠ‚å†™
     wire [7:0] way0_bank2_addr;
     wire [31:0] way0_bank2_dina;
     wire [31:0] way0_bank2_dout;

     wire way0_bank0_ena;
     wire [3:0] way0_bank3_wea;  //å­—èŠ‚å†™
     wire [7:0] way0_bank3_addr;
     wire [31:0] way0_bank3_dina;
     wire [31:0] way0_bank3_dout;

     wire way1_bank0_ena;
     wire [3:0] way1_bank0_wea;  //å­—èŠ‚å†™
     wire [7:0] way1_bank0_addr;
     wire [31:0] way1_bank0_dina;
     wire [31:0] way1_bank0_dout;

     wire way1_bank1_ena;
     wire [3:0] way1_bank1_wea;  //å­—èŠ‚å†™
     wire [7:0] way1_bank1_addr;
     wire [31:0] way1_bank1_dina;
     wire [31:0] way1_bank1_dout;

     wire way1_bank2_ena;
     wire [3:0] way1_bank2_wea;  //å­—èŠ‚å†™
     wire [7:0] way1_bank2_addr;
     wire [31:0] way1_bank2_dina;
     wire [31:0] way1_bank2_dout;

     wire way1_bank3_ena;
     wire [3:0] way1_bank3_wea;  //å­—èŠ‚å†™
     wire [7:0] way1_bank3_addr;
     wire [31:0] way1_bank3_dina;
     wire [31:0] way1_bank3_dout;
   ```
   ä¾‹åŒ–
   ```verilog
    /*----------------------------------------------------ä¾‹åŒ–æ¨¡å—--------------------------------------------*/
     data_way0_bank0 way0_bank0 (
         .addra(way0_bank0_addr),
         .clka (clk),
         .dina (way0_bank0_dina),
         .douta(way0_bank0_dout),
         .ena  (way0_bank0_ena),
         .wea  (way0_bank0_wea)
     );

     data_way0_bank1 way0_bank1 (
         .addra(way0_bank1_addr),
         .clka (clk),
         .dina (way0_bank1_dina),
         .douta(way0_bank1_dout),
         .ena  (way0_bank1_ena),
         .wea  (way0_bank1_wea)
     );

     data_way0_bank2 way0_bank2 (
         .addra(way0_bank2_addr),
         .clka (clk),
         .dina (way0_bank2_dina),
         .douta(way0_bank2_dout),
         .ena  (way0_bank2_ena),
         .wea  (way0_bank2_wea)
     );

     data_way0_bank3 way0_bank3 (
         .addra(way0_bank3_addr),
         .clka (clk),
         .dina (way0_bank3_dina),
         .douta(way0_bank3_dout),
         .ena  (way0_bank3_ena),
         .wea  (way0_bank3_wea)
     );

     data_way1_bank0 way1_bank0 (
         .addra(way1_bank0_addr),
         .clka (clk),
         .dina (way1_bank0_dina),
         .douta(way1_bank0_dout),
         .ena  (way1_bank0_ena),
         .wea  (way1_bank0_wea)
     );

     data_way1_bank1 way1_bank1 (
         .addra(way1_bank1_addr),
         .clka (clk),
         .dina (way1_bank1_dina),
         .douta(way1_bank1_dout),
         .ena  (way1_bank1_ena),
         .wea  (way1_bank1_wea)
     );

     data_way1_bank2 way1_bank2 (
         .addra(way1_bank2_addr),
         .clka (clk),
         .dina (way1_bank2_dina),
         .douta(way1_bank2_dout),
         .ena  (way1_bank2_ena),
         .wea  (way1_bank2_wea)
     );

     data_way1_bank3 way1_bank3 (
         .addra(way1_bank3_addr),
         .clka (clk),
         .dina (way1_bank3_dina),
         .douta(way1_bank3_dout),
         .ena  (way1_bank3_ena),
         .wea  (way1_bank3_wea)
     );

     //[20:1] tag     [0:0] v
     tagv_way0 way0_tagv (
         .addra(way0_tagv_addra),
         .clka (clk),
         .dina (way0_tagv_dina),
         .douta(way0_tagv_dout),
         .ena  (way0_tagv_ena),
         .wea  (way0_tagv_wea)
     );

     tagv_way1 way1_tagv (
         .addra(way1_tagv_addra),
         .clka (clk),
         .dina (way1_tagv_dina),
         .douta(way1_tagv_dout),
         .ena  (way1_tagv_ena),
         .wea  (way1_tagv_wea)
     );

     lfsr lfsr (
         .clk       (clk),
         .resetn    (resetn),
         .random_val(chosen_way)
     );
   ```
3. CacheçŠ¶æ€æœº
   1. å®šä¹‰çŠ¶æ€å¸¸é‡
      ```verilog
        //çŠ¶æ€å¸¸é‡å®šä¹‰
        parameter MAIN_IDLE = 3'b000;
        parameter MAIN_LOOKUP = 3'b001;
        parameter MAIN_MISS = 3'b010;
        parameter MAIN_REPLACE = 3'b011;
        parameter MAIN_REFILL = 3'b100;
        parameter WRITE_IDLE = 1'b0;
        parameter WRITE_WRITE = 1'b1;
      ```
   2. å®šä¹‰å…¨å±€çŠ¶æ€è¡¨ç¤ºå˜é‡
      ```verilog
        reg [2:0] cache_state;  //ä¸»çŠ¶æ€æœºå½“å‰çŠ¶æ€
        reg write_state;
      ```
   3. å®šä¹‰çŠ¶æ€å†…éƒ¨éœ€è¦çš„é€»è¾‘ä¿¡å·
      ```verilog
        //Write Bufferç›¸å…³ä¿¡æ¯
        reg wirteBuffer_way;
        reg [3:0] writeBuffer_offset;
        reg [7:0] writeBuffer_index;
        reg [3:0] writeBuffer_wstrb;
        reg [31:0] writeBuffer_wdata;
        
         /* -------------------------IDLEç›¸å…³ä¿¡å·-------------------------------*/
        wire idle2lookup_able;  //å½“å†™å·²ç»è¿›å…¥Write Bufferå‘å‡ºå†™è¯·æ±‚æ—¶çš„é˜»å¡

        /* -------------------------LOOKUPç›¸å…³ä¿¡å·-----------------------------*/
        //Request Bufferç›¸å…³ä¿¡æ¯
        reg requestBuffer_op;
        reg [7:0] requestBuffer_index;
        reg [19:0] requestBuffer_tag;
        reg [3:0] requestBuffer_offset;
        reg [3:0] requestBuffer_wstrb;
        reg [31:0] requestBuffer_wdata;

        //Tag Compareç›¸å…³ä¿¡æ¯
        wire way0_v;
        wire way1_v;
        wire [19:0] way0_tag;
        wire [19:0] way1_tag;
        wire way0_hit;
        wire way1_hit;
        wire cache_hit;

        //Data Selectç›¸å…³ä¿¡æ¯
        wire [127:0] way0_data;
        wire [127:0] way1_data;
        wire [31:0] way0_load_word;
        wire [31:0] way1_load_word;
        wire [127:0] replace_data;

        wire lookup2lookup_able;  //å½“å†™å·²ç»è¿›å…¥Write Bufferå‘å‡ºå†™è¯·æ±‚æ—¶çš„é˜»å¡
        reg loadForward;
        wire [31:0] forwardData;
        wire [31:0] hitData;
        wire [31:0] load_res;

        /* -------------------------MISS and REPLACEç›¸å…³ä¿¡å·-----------------------------*/
        wire chosen_way;
        wire replace_way;
        wire way0_d;
        wire way1_d;
        wire replace_d;
        wire replace_v;
        wire [19:0] replace_tag;

        //Miss Bufferç›¸å…³ä¿¡æ¯
        reg missBuffer_replaceWay;  //å› ä¸ºåˆ°è¾¾refillæ—¶æœ‰å¥½å‡ ä¸ªæ—¶é’Ÿï¼Œæ‰€ä»¥éœ€è¦ç¼“å­˜
        reg [1:0] missBuffer_retNum;  //è¿™é‡Œå‚è€ƒç­”æ¡ˆçš„ç”¨äº†ä¸€ä¸ªwire å¼‚æˆ–å¯¹å®ƒè¿›è¡Œèµ‹å€¼

        /* -------------------------REFILLç›¸å…³ä¿¡å·-----------------------------*/
        wire [31:0] write_in;
        wire [31:0] refill_data;
        wire refill_write_way0;
        wire refill_write_way1;
        
        reg rd_req_buffer; //ç¼“å­˜rd_req,å½“æ²¡æœ‰rd_reqæ—¶ï¼ŒREFILLç›´æ¥åˆ°IDLE

        //Write Bufferå†™bankåŒ¹é…ä¿¡å·
        wire match_way0_bank0;
        wire match_way0_bank1;
        wire match_way0_bank2;
        wire match_way0_bank3;
        wire match_way1_bank0;
        wire match_way1_bank1;
        wire match_way1_bank2;
        wire match_way1_bank3;

        wire [31:0] bank_dina;//è¾“å…¥åˆ°bankä¸­çš„æ•°æ®ï¼Œæ¶‰åŠåˆ°å¤šé€‰1
      ```
   4. å®šä¹‰çŠ¶æ€è½¬ç§»

      ä¸»çŠ¶æ€æœº
      ```verilog
      //ä¸»çŠ¶æ€æœº
        always @(posedge clk) begin
          if (~resetn) begin
            cache_state           <= MAIN_IDLE;

            requestBuffer_op      <= 1'b0;
            requestBuffer_index   <= 8'b0;
            requestBuffer_tag     <= 20'b0;
            requestBuffer_offset  <= 4'b0;
            requestBuffer_wstrb   <= 4'b0;
            requestBuffer_wdata   <= 32'b0;

            missBuffer_replaceWay <= 1'b0;

            wr_req                <= 1'b0;
          end else begin
            case (cache_state)
              MAIN_IDLE: begin
                if (valid & idle2lookup_able) begin
                  cache_state          <= MAIN_LOOKUP;

                  requestBuffer_op     <= op;
                  requestBuffer_index  <= index;
                  requestBuffer_tag    <= tag;
                  requestBuffer_offset <= offset;
                  requestBuffer_wstrb  <= wstrb;
                  requestBuffer_wdata  <= wdata;
                end
              end

              MAIN_LOOKUP: begin
                if (valid & lookup2lookup_able) begin
                  cache_state          <= MAIN_LOOKUP;

                  requestBuffer_op     <= op;
                  requestBuffer_index  <= index;
                  requestBuffer_tag    <= tag;
                  requestBuffer_offset <= offset;
                  requestBuffer_wstrb  <= wstrb;
                  requestBuffer_wdata  <= wdata;
                end else if (~cache_hit) begin
                  cache_state <= MAIN_MISS;
                end else begin
                  cache_state <= MAIN_IDLE;
                end
              end

              MAIN_MISS: begin
                if (wr_rdy) begin  //reqè¦åœ¨rdyä¹‹åæœ‰æ•ˆ
                  cache_state <= MAIN_REPLACE;

                  missBuffer_replaceWay <= replace_way;
                  wr_req <= replace_d & replace_v;
                end
              end

              MAIN_REPLACE: begin
                if (rd_rdy) begin
                  cache_state <= MAIN_REFILL;

                  //å¼€å§‹è®°å½•è¯»äº†å‡ ä¸ª å½“æ˜¯100æ—¶å·²è¯»å®Œ
                  missBuffer_retNum <= 2'b0;
                end
                if (wr_req) begin
                  wr_req <= 1'b0;
                end
              end

              MAIN_REFILL: begin
                if (ret_valid & ret_last == 1'b1 | ~rd_req_buffer) begin  //ç­”æ¡ˆä¸Šå¤šäº†ä¸€ä¸ªç¼“å­˜åˆ¤æ–­æ˜¯å¦æœ‰è¯»è¯·æ±‚
                  cache_state <= MAIN_IDLE;
                end else if (ret_valid) begin
                  missBuffer_retNum <= missBuffer_retNum + 2'b01;
                end
              end
              default: cache_state <= MAIN_IDLE;
            endcase
          end
        end
      ```
      1. å¤ä½åï¼Œä¸»çŠ¶æ€æœºéœ€å¤„äºIDLEçŠ¶æ€ï¼Œä¸”éœ€è¦å¤ä½request bufferå’Œwr\_req
      2. IDLEè¿›å…¥LOOKUPçš„æ¡ä»¶æ˜¯å½“å‰æœ‰æœ‰æ•ˆè®¿å­˜ï¼ˆæŒ‡ä»¤/æ•°æ®ï¼‰ä¸”æ²¡æœ‰é˜»å¡çš„Write Hit
         è¿›å…¥åï¼Œéœ€è¦æ›´æ–°çŠ¶æ€å¹¶ä¿å­˜è¯·æ±‚ä¿¡æ¯åˆ°request buffer
      3. LOOKUPçŠ¶æ€æ›´æ–°æ¯”è¾ƒå¤æ‚

         å¦‚æœå½“å‰æœ‰æœ‰æ•ˆè®¿å­˜ï¼ˆæŒ‡ä»¤/æ•°æ®ï¼‰ä¸”æ²¡æœ‰é˜»å¡çš„Write Hité‚£ä¹ˆä»èƒ½è¿›å…¥LOOKUPå¹¶æ›´æ–°request buffer

         å¦‚æœæœªå‘½ä¸­ï¼Œé‚£ä¹ˆéœ€è¦è¿›å…¥MISS

         å¦åˆ™è¿›å…¥IDLEï¼Œç­‰å¾…æœ‰æ•ˆè¯·æ±‚ä¸”ä¸é˜»å¡
      4. MISSâ†’REPLACEçš„æ›´æ–°æ¡ä»¶æ˜¯wr\_rdyæœ‰æ•ˆ

         é‚£ä¹ˆå¯¹äºä¸€äº›ä¸éœ€è¦æ›¿æ¢çš„è¯·æ±‚ï¼Œå°±ä¸éœ€è¦ç­‰å¾…wr\_rdy[^æ³¨é‡Š16]

         æ­¤æ—¶ä¼šæ›´æ–°çŠ¶æ€ã€æ¸…0è¿”å›æ•°æ®è®¡æ•°å™¨å¹¶æ ¹æ®replaceè·¯çš„dã€vå‘é€å†™è¯·æ±‚
      5. REPLACEâ†’REFILLçš„æ›´æ–°æ¡ä»¶æ˜¯rd\_rdyæœ‰æ•ˆ

         é‚£ä¹ˆå¯¹äºä¸€äº›ä¸éœ€è¦è¯»æ•°æ®å³rd\_reqæ— æ•ˆæ—¶[^æ³¨é‡Š17]ï¼Œé‚£ä¹ˆå°±ä¸ç”¨ç­‰å¾…rd\_rdyä¿¡å·

         æ­¤æ—¶ä¼šæ›´æ–°çŠ¶æ€ï¼Œå¹¶æ ¹æ®rd\_validå’Œrd\_lastå¤„ç†çŠ¶æ€æ›´æ–°ä»¥åŠæ›´æ–°è®¡æ•°å™¨
         å†™çŠ¶æ€æœº
      ```verilog
      //WriteçŠ¶æ€æœº
        always @(posedge clk) begin
          if (~resetn) begin
            write_state <= WRITE_IDLE;

            wirteBuffer_way <= 1'b0;
            writeBuffer_index <= 8'b0;
            writeBuffer_wstrb <= 4'b0;
            writeBuffer_wdata <= 32'b0;
            writeBuffer_offset <= 4'b0;
          end else begin
            case (write_state)
              WRITE_IDLE: begin
                if (cache_state == MAIN_LOOKUP & cache_hit & requestBuffer_op) begin
                  write_state <= WRITE_WRITE;

                  wirteBuffer_way <= way1_hit;
                  writeBuffer_index <= requestBuffer_index;
                  writeBuffer_wstrb <= requestBuffer_wstrb;
                  writeBuffer_wdata <= requestBuffer_wdata;
                  writeBuffer_offset <= requestBuffer_offset;
                end
              end

              WRITE_WRITE: begin
                if (cache_state == MAIN_LOOKUP & cache_hit & requestBuffer_op) begin
                  write_state <= WRITE_WRITE;

                  wirteBuffer_way <= way1_hit;
                  writeBuffer_index <= requestBuffer_index;
                  writeBuffer_wstrb <= requestBuffer_wstrb;
                  writeBuffer_wdata <= requestBuffer_wdata;
                  writeBuffer_offset <= requestBuffer_offset;
                end else begin
                  write_state <= WRITE_IDLE;
                end
              end

              default: write_state <= WRITE_IDLE;
            endcase
          end
        end
      ```
      å¤ä½åï¼Œéœ€è¦æ¸…0 Write Bufferå¹¶ç½®çŠ¶æ€æ˜¯IDLE
      1. IDLEâ†’WRITEçš„æ¡ä»¶æ˜¯ ä¸»çŠ¶æ€æœºåœ¨LOOKUPå¹¶å‘½ä¸­Cacheä¸”æ˜¯å†™æ“ä½œï¼Œæ­¤æ—¶ä¹Ÿéœ€è¦å†™Write Buffer
      2. Writeâ†’Writeçš„æ¡ä»¶æ˜¯ ä¸»çŠ¶æ€æœºåœ¨LOOKUPå¹¶å‘½ä¸­Cacheä¸”æ˜¯å†™æ“ä½œ
4. MAIN\_IDLEå†…éƒ¨é€»è¾‘&#x20;

   éœ€è¦äº§ç”Ÿâ€œWrite Hitâ€é˜»å¡ä¿¡å·â€”â€”å½“å½“å‰å†™çŠ¶æ€æœºåœ¨WRITEï¼Œä¸”å½“å‰æœ‰æœ‰æ•ˆè¯·æ±‚ä¸”æ˜¯è¯»æ“ä½œ[^æ³¨é‡Š18]è¦è¯»åŒä¸€ä¸ªBankï¼Œé‚£ä¹ˆå› ä¸ºSRAM Bankå•ç«¯å£æ‰€ä»¥å¿…é¡»é˜»å¡
   ```verilog
   /* ---------------------------------------------MAIN IDLEä¿¡å·ç”Ÿæˆ---------------------------------------------- */
     assign idle2lookup_able = ~(write_state == WRITE_WRITE & valid & ~op & offset[3:2] == writeBuffer_offset[3:2]);
   ```
   æœ‰ä¸ªç–‘é—®ï¼Œå¦‚æœoffsetä¸ä¸€æ ·ï¼Œå¦‚æœè¿™ä¸ªè¯»è¯»ä¸å‘½ä¸­ï¼Œä¸”éœ€è¦æ›¿æ¢ï¼Œé‚£ä¸ªè¢«æ›¿æ¢çš„å—è¿˜è¦å†™å›ï¼Œé‚£å› ä¸ºä»£ç ä¸­çš„replace dataæ˜¯åœ¨lookupæ—¶å°±ç”Ÿæˆäº†ã€‚é‚£å¯¹åº”çš„è¿™ä¸ªreplace dataçš„å’Œè¿™ä¸ªwrite buffer offsetä¸€æ ·çš„bankè¯»çš„æ—¶å€™æ•°æ®ä¸ä¹Ÿæœ‰å†²çªä¹ˆï¼Œå¯¼è‡´æ›¿æ¢å›å»çš„å€¼ä¸æ˜¯å¯¹çš„

   æ‰€ä»¥è¿™é‡Œçš„é˜»å¡æ¡ä»¶æ˜¯ä¸æ˜¯åº”è¯¥æ›´ä¸¥æ ¼ä¸€äº›ï¼Œä¸éœ€è¦offsetçš„åˆ¤æ–­

   æˆ–è€…å†è¯»ä¸å‘½ä¸­æ—¶å†è¯·æ±‚ä¸€æ¬¡â€”â€”è¿™é‡Œåé¢åšäº†ï¼Œä½¿èƒ½æœ‰æ•ˆä¿¡å·è¿˜è€ƒè™‘äº†uncache
5. MAIN\_LOOKUPå†…éƒ¨é€»è¾‘
   1. éœ€è¦é˜»å¡hit write

      å’Œä¹‹å‰ä¸€æ ·ï¼Œä½†æ˜¯å¯¹äºICacheæ²¡æœ‰å†™åªéœ€è¦è€ƒè™‘cache\_hit
      ```verilog
        assign lookup2lookup_able = ~(write_state == WRITE_WRITE & valid & ~op & offset[3:2] == writeBuffer_offset[3:2]) & cache_hit;

      ```
   2. compare tagåˆ¤æ–­å‘½ä¸­
      ```verilog
        assign way0_v = way0_tagv_dout[0];
        assign way1_v = way1_tagv_dout[0];
        assign way0_tag = way0_tagv_dout[20:1];
        assign way1_tag = way1_tagv_dout[20:1];

        assign way0_hit = way0_v & (requestBuffer_tag == way0_tag);
        assign way1_hit = way1_v & (requestBuffer_tag == way1_tag);
        assign cache_hit = way0_hit | way1_hit;
      ```
   3. data select
      ```verilog
        assign way0_data = {way0_bank3_dout, way0_bank2_dout, way0_bank1_dout, way0_bank0_dout};
        assign way1_data = {way1_bank3_dout, way1_bank2_dout, way1_bank1_dout, way1_bank0_dout};
        assign way0_load_word = way0_data[32*requestBuffer_offset[3:2]+:32];//ä»32*requestBuffer_offsetä½ç½®å¾€é«˜ä½è¯»32ä½æ•°æ®
        assign way1_load_word = way1_data[32*requestBuffer_offset[3:2]+:32];
        
        assign hitData = {32{way0_hit}} & way0_load_word | {32{way1_hit}} & way1_load_word;

      ```
   4. forward
      ```verilog
        always @(posedge clk) begin
          if (~resetn) begin
            loadForward <= 1'b0;
          end else if (loadForward) begin
            loadForward <= 1'b0;
          end else begin
            loadForward <=  (cache_state = MAIN_LOOKUP) & requestBuffer_op  & !op & requestBuffer_offset[3:2] == offset[3:2] & requestBuffer_index == index & requestBuffer_tag == tag & cache_hit;
          end
        end
        
        assign forwardData = {
          writeBuffer_wstrb[3] ? writeBuffer_wdata[31:24] : hitData[31:24],
          writeBuffer_wstrb[2] ? writeBuffer_wdata[23:16] : hitData[23:16],
          writeBuffer_wstrb[1] ? writeBuffer_wdata[15:8] : hitData[15:8],
          writeBuffer_wstrb[0] ? writeBuffer_wdata[7:0] : hitData[7:0]
        };
      ```
   5. æš‚æ—¶çš„æ•°æ®load\_res
      ```verilog
        assign load_res = loadForward ? forwardData : hitData;
      ```
6. MAIN\_MISSå†…éƒ¨é€»è¾‘

   ç”Ÿæˆreplace\_wayã€vã€d
   ```verilog
     /* ---------------------------------------------MAIN MISSä¿¡å·ç”Ÿæˆ-------------------------------------------- */
     assign replace_way = (~way1_v | chosen_way) & way0_v;  //ç”»çœŸå€¼è¡¨
     assign way0_d = way0_D[requestBuffer_index];
     assign way1_d = way0_D[requestBuffer_index];
     assign replace_d = replace_way ? way1_d : way0_d;
     assign replace_v = replace_way ? way1_v : way0_v;
   ```
7. MAIN\_REPLACEå†…éƒ¨é€»è¾‘â€”â€”æ¶ˆè€—äº†äº›è®¸çš„æ€§èƒ½ï¼Œä½¿å¾—å¿…é¡»è¦ç­‰å¾…wr\_rdy

   ç”Ÿæˆæ›¿æ¢å†™å›çš„replace\_dataã€replace\_tagå’Œè¯»å†™è¾“å‡ºå‚æ•°
   ```verilog
    /* ---------------------------------------------MAIN REPLACEä¿¡å·ç”Ÿæˆ-------------------------------------------- */
     assign replace_data = missBuffer_replaceWay ? way1_data : way0_data; //è¿™é‡Œä¹Ÿå¯ä»¥ç”¨replace way åœ¨å³å°†è¿›å…¥replaceæ—¶
     assign replace_tag = missBuffer_replaceWay ? way1_tag : way0_tag;

     assign wr_addr = {replace_tag, requestBuffer_index, 4'b0};  //èµ·å§‹åœ°å€
     assign wr_type = 3'b100;  //å†™16B
     assign wr_data = replace_data;
     assign wr_wstrb = 4'b1111;

     assign rd_req = cache_state == MAIN_REPLACE;
     assign rd_type = 3'b100;
     assign rd_addr = {requestBuffer_tag, requestBuffer_index, 4'b0};
   ```
8. MAIN\_REFILLçš„å†…éƒ¨é€»è¾‘

   rd\_reqç¼“å†²ä¿¡æ¯
   ```verilog
     always @(posedge clk) begin
       if (~resetn) begin
           rd_req_buffer <= 1'b0;
       end
       else if (rd_req) begin
           rd_req_buffer <= 1'b1;
       end
       else if (cache_state == MAIN_REFILL & ret_valid & ret_last) begin
           rd_req_buffer <= 1'b0;
       end
     en
   ```
   ç”Ÿæˆè¦é‡å¡«çš„dataï¼Œwrite\_dataè¦åœ¨AXIæ€»çº¿å’ŒWrite bufferä¸­äºŒé€‰ä¸€
   ```verilog
     /*----------------------------------------------MAIN REFILLä¿¡å·ç”Ÿæˆ----------------------------------------------- */
     assign write_in = { 
       requestBuffer_wstrb[3] ? requestBuffer_wdata[31:24] : ret_data[31:24],
       requestBuffer_wstrb[2] ? requestBuffer_wdata[23:16] : ret_data[23:16],
       requestBuffer_wstrb[1] ? requestBuffer_wdata[15:8] : ret_data[15:8],
       requestBuffer_wstrb[0] ? requestBuffer_wdata[7:0] : ret_data[7:0]
     };
     assign refill_data = (requestBuffer_op & (requestBuffer_offset[3:2] == missBuffer_retNum)) ? write_in : ret_data;//å…¶ä»–çš„ç›´æ¥ç”¨retå¡«å……
     assign refill_write_way0 = ~missBuffer_replaceWay & ret_valid;
     assign refill_write_way1 = missBuffer_replaceWay & ret_valid;
   ```
9. æ›´æ–°D

   Dçš„ç‰‡é€‰è¦åœ¨Write bufferå’ŒRefillä¸­äºŒé€‰ä¸€ï¼Œå¯¹åº”çš„å†™åœ°å€å’Œå†™æ•°æ®ä¹Ÿä¸åŒ

   ä¹‹å‰ç”¨çš„ç»„åˆé€»è¾‘ç”Ÿæˆreplace\_dï¼Œæ‰€ä»¥Write Bufferå¯¹äºè¿™ä¸ªè¯»ä¸å‘½ä¸­æˆ–è€…å†™ä¸å‘½ä¸­çš„dæ˜¯å®æ—¶æ›´æ–°åˆ¤æ–­çš„
   ```verilog
   //å†™D
     always @(posedge clk) begin
       if (~resetn) begin
         way0_D <= 256'b0;
         way1_D <= 256'b0;
       end else if (cache_state == MAIN_REFILL & (ret_valid & ret_last == 1'b1) | ~rd_req_buffer) begin
         if (refill_write_way1) begin
           way0_D[requestBuffer_index] <= requestBuffer_op;
         end else if (refill_write_way0) begin
           way1_D[requestBuffer_index] <= requestBuffer_op;
         end
       end else if (write_state == WRITE_WRITE) begin
         if (wirteBuffer_way) begin
           way1_D[writeBuffer_index] <= 1'b1;
         end else begin
           way0_D[writeBuffer_index] <= 1'b1;
         end
       end
     end

   ```
10. æ›´æ–°{Tag,V}

    åœ°å€è¦åœ¨indexå’Œrequest bufferä¸­äºŒé€‰ä¸€â€”â€”å¦‚æœaddr\_oké‚£ä¹ˆå°±æ˜¯indexï¼Œå¦åˆ™æ˜¯request

    å†™æ•°æ®æ¥è‡ªrequest buffer

    å†™ä½¿èƒ½æ˜¯refillå³å°†åˆ°idle
    ```verilog
      //å†™TAG,V å†™å‘½ä¸­æ—¶ä¸éœ€è¦æ›´æ”¹TAGå’ŒV
      assign way0_tagv_addra = addr_ok ? index : requestBuffer_index;//è¯»çš„æ—¶å€™è¦åœ¨è¿›å…¥LOOKUPä¹‹å‰å°±å¾—åˆ°ä¿¡æ¯
      assign way1_tagv_addra = addr_ok ? index : requestBuffer_index;
      assign way0_tagv_ena = addr_ok; //è¿™é‡Œä¸ç”¨å†è®¿é—®ï¼Œå› ä¸ºWriteä¸æ›´æ–°{Tag,V}ï¼Œæ‰€ä»¥Look upè¯»æ—¶å°±æ˜¯ç¡®å®šçš„
      assign way1_tagv_ena = addr_ok;
      assign way0_tagv_wea = cache_state == MAIN_REFILL & (ret_valid & ret_last == 1'b1) & ~missBuffer_replaceWay;
      assign way1_tagv_wea = cache_state == MAIN_REFILL & (ret_valid & ret_last == 1'b1) & missBuffer_replaceWay;
      assign way0_tagv_dina = {requestBuffer_tag, 1'b1};
      assign way1_tagv_dina = {requestBuffer_tag, 1'b1};
    ```
11. æ›´æ–°Bank

    åœ°å€éœ€è¦åœ¨indexã€writebufferå’Œrequest bufferä¸­ä¸‰é€‰ä¸€â€”â€”addrok index wirteçŠ¶æ€æ—¶é€‰write buffer
    ```verilog
      assign way0_bank0_addr = match_way0_bank0 ? writeBuffer_index : (addr_ok ? index : requestBuffer_index);
      assign way0_bank1_addr = match_way0_bank1 ? writeBuffer_index : (addr_ok ? index : requestBuffer_index);
      assign way0_bank2_addr = match_way0_bank2 ? writeBuffer_index : (addr_ok ? index : requestBuffer_index);
      assign way0_bank3_addr = match_way0_bank3 ? writeBuffer_index : (addr_ok ? index : requestBuffer_index);
      assign way1_bank0_addr = match_way1_bank0 ? writeBuffer_index : (addr_ok ? index : requestBuffer_index);
      assign way1_bank1_addr = match_way1_bank1 ? writeBuffer_index : (addr_ok ? index : requestBuffer_index);
      assign way1_bank2_addr = match_way1_bank2 ? writeBuffer_index : (addr_ok ? index : requestBuffer_index);
      assign way1_bank3_addr = match_way1_bank3 ? writeBuffer_index : (addr_ok ? index : requestBuffer_index);
    ```
    å¯¹åº”bankçš„è¯»ä½¿èƒ½â€”â€”éœ€è¦è€ƒè™‘Replaceçš„å†è¯»
    ```verilog
      assign way0_bank0_ena = addr_ok | cache_state == MAIN_MISS;
      assign way0_bank1_ena = addr_ok | cache_state == MAIN_MISS;
      assign way0_bank2_ena = addr_ok | cache_state == MAIN_MISS;
      assign way0_bank3_ena = addr_ok | cache_state == MAIN_MISS;
      assign way1_bank0_ena = addr_ok | cache_state == MAIN_MISS;
      assign way1_bank1_ena = addr_ok | cache_state == MAIN_MISS;
      assign way1_bank2_ena = addr_ok | cache_state == MAIN_MISS;
      assign way1_bank3_ena = addr_ok | cache_state == MAIN_MISS;
    ```
    å¯¹åº”bankçš„å†™ä½¿èƒ½â€”â€”write bufferæ—¶éœ€è¦æ ¹æ®offsetã€wayåŒ¹é…bankï¼Œrefillæ—¶åªç”¨åŒ¹é…way
    ```verilog
      assign match_way0_bank0 = write_state == WRITE_WRITE & writeBuffer_offset == 2'h0 & ~wirteBuffer_way;
      assign match_way0_bank1 = write_state == WRITE_WRITE & writeBuffer_offset == 2'h1 & ~wirteBuffer_way;
      assign match_way0_bank2 = write_state == WRITE_WRITE & writeBuffer_offset == 2'h2 & ~wirteBuffer_way;
      assign match_way0_bank3 = write_state == WRITE_WRITE & writeBuffer_offset == 2'h3 & ~wirteBuffer_way;
      assign match_way1_bank0 = write_state == WRITE_WRITE & writeBuffer_offset == 2'h0 & wirteBuffer_way;
      assign match_way1_bank1 = write_state == WRITE_WRITE & writeBuffer_offset == 2'h1 & wirteBuffer_way;
      assign match_way1_bank2 = write_state == WRITE_WRITE & writeBuffer_offset == 2'h2 & wirteBuffer_way;
      assign match_way1_bank3 = write_state == WRITE_WRITE & writeBuffer_offset == 2'h3 & wirteBuffer_way;
      
       assign way0_bank0_wea = {4{match_way0_bank0}} & writeBuffer_wstrb |
                               {4{cache_state == MAIN_REFILL & refill_write_way0 & missBuffer_retNum[2:0] == 2'h0}} & 4'hf;
      assign way0_bank1_wea = {4{match_way0_bank1}} & writeBuffer_wstrb |
                               {4{cache_state == MAIN_REFILL & refill_write_way0 & missBuffer_retNum[2:0] == 2'h1}} & 4'hf;
      assign way0_bank2_wea = {4{match_way0_bank2}} & writeBuffer_wstrb |
                               {4{cache_state == MAIN_REFILL & refill_write_way0 & missBuffer_retNum[2:0] == 2'h2}} & 4'hf;
      assign way0_bank3_wea = {4{match_way0_bank3}} & writeBuffer_wstrb |
                               {4{cache_state == MAIN_REFILL & refill_write_way0 & missBuffer_retNum[2:0] == 2'h3}} & 4'hf;
      assign way1_bank0_wea = {4{match_way1_bank0}} & writeBuffer_wstrb |
                               {4{cache_state == MAIN_REFILL & refill_write_way1 & missBuffer_retNum[2:0] == 2'h0}} & 4'hf;
      assign way1_bank1_wea = {4{match_way1_bank1}} & writeBuffer_wstrb |
                               {4{cache_state == MAIN_REFILL & refill_write_way1 & missBuffer_retNum[2:0] == 2'h1}} & 4'hf;
      assign way1_bank2_wea = {4{match_way1_bank2}} & writeBuffer_wstrb |
                               {4{cache_state == MAIN_REFILL & refill_write_way1 & missBuffer_retNum[2:0] == 2'h2}} & 4'hf;
      assign way1_bank3_wea = {4{match_way1_bank3}} & writeBuffer_wstrb |
                               {4{cache_state == MAIN_REFILL & refill_write_way1 & missBuffer_retNum[2:0] == 2'h3}} & 4'hf;
    ```
    è¾“å…¥æ•°æ®è¦åœ¨refillå’Œwrite bufferä¸­äºŒé€‰ä¸€
    ```verilog
      assign bank_dina = {32{write_state == WRITE_WRITE}}   & writeBuffer_wdata |
                         {32{cache_state == MAIN_REFILL}}   & refill_data         ;
      assign way0_bank0_dina = bank_dina;
      assign way0_bank1_dina = bank_dina;
      assign way0_bank2_dina = bank_dina;
      assign way0_bank3_dina = bank_dina;
      assign way1_bank0_dina = bank_dina;
      assign way1_bank1_dina = bank_dina;
      assign way1_bank2_dina = bank_dina;
      assign way1_bank3_dina = bank_dina;
    ```
12. å¤–éƒ¨ä¿¡å·
    ```verilog
      /*----------------------------------------------------å¤–éƒ¨ä¿¡å·--------------------------------------------*/
      assign addr_ok = (cache_state == MAIN_IDLE & idle2lookup_able) | (cache_state == MAIN_LOOKUP & lookup2lookup_able);
      assign data_ok = (cache_hit | requestBuffer_op) & cache_state == MAIN_LOOKUP |
                        (cache_state == MAIN_REFILL & ~requestBuffer_op & ret_valid & requestBuffer_offset[1:0] == missBuffer_retNum[1:0]);
      //å†™æ—¶ä¸éœ€è¦ä½¿ç”¨è¿™ä¸ªäº’é”ï¼Œè¯»æ—¶æ˜¯éœ€è¦çš„ï¼›å› ä¸ºå†™æ—¶ï¼Œå¦‚æœå†™è¿˜åœ¨lookupé‚£ä¹ˆå¯ä»¥ç›´æ¥å‰é€’ï¼Œæ­¤æ—¶data_okæœ‰æ•ˆå³å¯;å¦‚æœä¸åœ¨ï¼Œé‚£ä¹ˆåœ¨writebufferä¼šé˜»å¡è¯»ï¼›å¦‚æœè¯»ä¸å‘½ä¸­ï¼Œé‚£ä¹ˆåœ¨refillå®Œä¹‹åï¼Œå†™ä¹Ÿå°±å®Œæˆäº†ï¼Œæ‰€ä»¥ç›´æ¥data_okæ— å½±å“
      assign rdata = cache_hit ? load_res : ret_data; //è¿™é‡Œè¿™ä¹ˆå†™ä¹Ÿæ²¡é—®é¢˜ï¼Œå› ä¸ºcache_hitæ—¶data_okä¹Ÿæœ‰æ•ˆäº†ï¼Œcahceæ²¡æœ‰hitï¼Œé‚£å°±æ˜¯refill
    ```
13. lfsr
    ```verilog
    module lfsr (
        input clk,
        input resetn,

        output random_val
    );

      reg [7:0] r_lfsr;

      always @(posedge clk) begin
        if (~resetn) begin
          r_lfsr <= 8'b0101_1001;  //ç§å­
        end else begin
          r_lfsr[0] <= r_lfsr[7] ^ r_lfsr[5] ^ r_lfsr[3] ^ r_lfsr[2];
          r_lfsr[1] <= r_lfsr[0];
          r_lfsr[2] <= r_lfsr[1];
          r_lfsr[3] <= r_lfsr[2];
          r_lfsr[4] <= r_lfsr[3];
          r_lfsr[5] <= r_lfsr[4];
          r_lfsr[6] <= r_lfsr[5];
          r_lfsr[7] <= r_lfsr[6];
        end
      end

      assign random_val = r_lfsr[7];

    endmodule
    ```
14. ICacheç‰¹æ®Šçš„è®¾è®¡
    1. icacheçš„wr\_rdyå§‹ç»ˆä¸º1'b1ï¼Œå› æ­¤å¹¶ä¸éœ€è¦åœ¨MISSâ†’REPLACEæ—¶çš„æ¡ä»¶å†™å¤ªå¤æ‚ï¼Œå§‹ç»ˆæœ‰æ•ˆ
    2. icacheå› ä¸ºä¸åŒ…å«å†™ï¼Œæ‰€ä»¥å¯¹äºidle2lookup\_ableçš„è®¾ç½®å§‹ç»ˆä¸º1'b1ï¼Œå¯¹äºlookup2lookup\_ableçš„è®¾ç½®ä¸ºcache\_mit
       ```verilog
         assign idle2lookup_able = 1'b1;

         assign lookup2lookup_able = cache_hit;

       ```
15. DCacheç‰¹æ®Šçš„è®¾è®¡
    1. dcacheçš„wr\_rdyå¹¶ä¸å§‹ç»ˆä¸º1'b1ï¼Œä¸ºäº†æ€§èƒ½çš„è€ƒè™‘ï¼Œå¯ä»¥è®¾ç½®åœ¨ä¸éœ€è¦å†™å›æ—¶çš„MISSâ†’REPLACEçš„æ¡ä»¶ç®€å•ä¸€äº›ï¼›REPLACEâ†’REFILLåŒç†ï¼Œåœ¨ä¸éœ€è¦å‘å‡ºAXIæ€»çº¿è¯»æ—¶å°±ä¸éœ€è¦ç­‰å¾…rd\_rdyï¼Œæ—¢ç„¶ä¸éœ€è¦rd\_rdyäº†ï¼Œé‚£REFILLâ†’IDLEä¹Ÿå°±ä¸éœ€è¦ç­‰å¾…æœ€åä¸€ä¸ªvalidæœ‰æ•ˆäº†
    2. dcacheåŒ…å«å†™ï¼Œæ‰€ä»¥å¯¹äºå®ƒçš„idle2lookup\_ableå’Œlookup2lookup\_ableéƒ½éœ€è¦è€ƒè™‘åŸæ¥åŒ…å«å†™çš„ä¿¡å·
       ```verilog
         assign idle2lookup_able = ~(write_state == WRITE_WRITE & valid & ~op & offset[3:2] == writeBuffer_offset[3:2]);
         
         assign lookup2lookup_able = ~(write_state == WRITE_WRITE & valid & ~op & offset[3:2] == writeBuffer_offset[3:2]) & cache_hit;

       ```

## 2 å°† Cache é›†æˆè‡³ CPU ä¸­

å°† Cache æ¨¡å—é›†æˆè‡³ CPU ä¸­ï¼Œä¸€æ–¹é¢è¦è§£å†³å…¶ä¸ CPU æµæ°´çº¿çš„äº¤äº’é€‚é…é—®é¢˜ï¼Œå¦ä¸€æ–¹é¢è¦è§£å†³å…¶ä¸æ€»çº¿æ¥å£æ–¹é¢çš„äº¤äº’é€‚é…é—®é¢˜

### 2.1 Cacheä¸æ€»çº¿æ¥å£æ–¹é¢çš„äº¤äº’é€‚é…é—®é¢˜

å³ä¿®æ”¹â€œ`axi_bridge.v`â€

AXIè½¬æ¥æ¡¥æ¨¡å—å¯¹å¤–æ˜¯AXIä¸»æ–¹ï¼Œæ¥æ”¶/å‘å‡ºäº”ä¸ªé€šé“çš„ä¿¡å·ï¼›å¯¹å†…æ˜¯Cacheä»æ–¹ï¼Œæ¥å—/å‘å‡º ICACHEã€DCACHEçš„è¯»å†™ä¿¡å·

ç›¸æ¯”åŸæ¥çš„AXIè½¬æ¥æ¡¥ï¼Œä¸»è¦æ˜¯å¯¹ä¿¡å·è¿›è¡Œäº†è°ƒæ•´ï¼Œä»¥åŠå¤šäº†Brustçš„å¤„ç†

```verilog
`include "mycpu.h"
module axi_bridge (
    //AXIä¿¡å· ä¸»æ–¹
    input clk,
    input aresetn,

    //è¯»è¯·æ±‚é€šé“
    output [ 3:0] arid,
    output [31:0] araddr,
    output [ 7:0] arlen,    //0
    output [ 2:0] arsize,
    output [ 1:0] arburst,  //2b'01
    output [ 1:0] arlock,   //0
    output [ 3:0] arcache,  //0
    output [ 2:0] arprot,   //0
    output        arvalid,
    input         arready,

    //è¯»å“åº”é€šé“
    input      [ 3:0] rid,
    input      [31:0] rdata,
    input      [ 1:0] rresp,
    input             rlast,
    input             rvalid,
    output reg        rready,

    //å†™è¯·æ±‚é€šé“              
    output     [ 3:0] awid,
    output     [31:0] awaddr,
    output     [ 7:0] awlen,
    output     [ 2:0] awsize,
    output     [ 1:0] awburst,
    output     [ 1:0] awlock,
    output     [ 3:0] awcache,
    output     [ 2:0] awprot,
    output reg        awvalid,
    input             awready,

    //å†™æ•°æ®é€šé“
    output     [ 3:0] wid,
    output     [31:0] wdata,
    output     [ 3:0] wstrb,
    output reg        wlast,
    output reg        wvalid,
    input             wready,

    //å†™å“åº”é€šé“
    input      [3:0] bid,
    input      [1:0] bresp,
    input            bvalid,
    output reg       bready,

    //ç±»SRAMä¿¡å· ä»æ–¹
    //inst
    input wire inst_rd_req,
    input wire [2:0] inst_rd_type,
    input wire [31:0] inst_rd_addr,
    output wire inst_rd_rdy,
    output wire inst_ret_last,
    output wire [31:0] inst_ret_data,
    output wire inst_ret_valid,

    
    //data
    input wire data_rd_req,
    input wire [2:0] data_rd_type,
    input wire [31:0] data_rd_addr,
    output wire data_rd_rdy,
    output wire data_ret_last,
    output wire [31:0] data_ret_data,
    output wire data_ret_valid,
    input wire data_wr_req,
    input wire [2:0] data_wr_type,
    input  wire [31:0] data_wr_addr,
    input wire [3:0] data_wr_wstrb,
    input wire [127:0] data_wr_data,
    output wire data_wr_rdy 
);
  //è¯»è¯·æ±‚é€šé“ è§¦å‘å™¨Qç«¯ä¿¡å·
  reg arvalid_r;  //è¾“å‡ºarvalid
  reg [ 3:0]  arid_r;    //è¾“å‡ºarid æ ¹æ®aridåœ¨æŒ‡ä»¤addrã€sizeå’Œæ•°æ®addrã€sizeé€‰æ‹©ç”Ÿæˆarsizeã€araddr
  reg [2:0] inst_sram_size_r;  //è¾“å‡ºè®¿æŒ‡ä»¤arsize
  reg [31:0] inst_sram_addr_r;  //è¾“å‡ºè®¿æŒ‡ä»¤å­˜araddr
  reg [2:0] rdata_sram_size_r;  //è¾“å‡ºè®¿æ•°æ®arsize
  reg [31:0] rdata_sram_addr_r;  //è¾“å‡ºè®¿æŒ‡ä»¤å­˜araddr 

  //è¯·æ±‚å®Œæ¯•ï¼Œç­‰å¾…è¯»å“åº”
  reg data_read_wait;
  reg inst_read_wait;

  reg [2:0] wdata_sram_size_r;  //è¾“å‡ºawsize
  reg [3:0] wdata_sram_wstrb_r;  //è¾“å‡ºwstrb
  reg [31:0] wdata_sram_addr_r;  //è¾“å‡ºawaddr
  reg [7:0] awlen_r; //
  reg [2:0] w_num;
  reg w_wait;

  reg [127:0] data_sram_wdata_r;  //è¾“å‡ºawaddr

  reg wdata_received;  //è¡¨ç¤ºä»è®¾å¤‡å·²æ”¶åˆ°å†™æ•°æ®ï¼Œwreadyå¯å†æœ‰æ•ˆ
  reg waddr_received;  //è¡¨ç¤ºä»è®¾å¤‡å·²æ”¶åˆ°å†™åœ°å€ï¼Œawreadyå¯å†æœ‰æ•ˆ

  //-----------------------------------è¯»è¯·æ±‚ç›¸å…³ä¿¡å·--------------------------------------//
  //å› ä¸ºè¯»è¯·æ±‚æ—¶ï¼Œéœ€è¦ä¼ è¾“åœ°å€ç­‰ä¿¡æ¯ï¼Œæ‰€ä»¥éœ€è¦åœ¨reqå’Œaddr_okç¡®è®¤å¯¹åº”è¯·æ±‚å¹¶ä¸”ç±»SRAMæ€»çº¿ä»æ–¹æ”¶åˆ°åœ°å€åå†è®¾ç½®
  //arid_r  ä¸åŒäº‹åŠ¡éƒ½ç”¨åŒä¸€ä¸ªidï¼Œå…ˆè¯·æ±‚çš„å…ˆå“åº”
  always @(posedge clk) begin
    if (~aresetn) arid_r <= 4'b0000;
    else if(inst_rd_req & inst_rd_rdy)//è¯»æŒ‡ä»¤å­˜å‚¨è¯·æ±‚ä¸”è¯»æŒ‡ä»¤åœ°å€æˆåŠŸæ”¶åˆ°
      arid_r <= 4'b0000;
    else if(data_rd_req & data_rd_rdy)//è¯»æ•°æ®å­˜å‚¨è¯·æ±‚ä¸”è¯»æ•°æ®åœ°å€æˆåŠŸæ”¶åˆ°
      arid_r <= 4'b0001;
    else
      arid_r <= arid_r;//å­˜åœ¨é˜»å¡ã€ç­‰å¾…æ—¶çš„å¤„ç† æ˜¯ä¸æ˜¯å®ç°çš„ä¸æ”¹å˜å€¼ readyè¿˜æœªä¸º1æ—¶
  end

  //arsize_ré€‰æ‹©ä¹‹ä¸€ inst_sram_size_r
  always @(posedge clk) begin
    if (~aresetn) inst_sram_size_r <= 3'b0;
    else if (inst_rd_req & inst_rd_rdy) 
      inst_sram_size_r <= inst_rd_type == 3'b100 ? 3'b010 : inst_rd_type; //å¦‚æœæ˜¯ä¸€è¡Œcacheï¼Œé‚£ä¹ˆæ¯ä¸ªæ˜¯è¦è¯»å†™32bit
    else 
      inst_sram_size_r <= inst_sram_size_r;
  end

  //araddr_ré€‰æ‹©ä¹‹ä¸€ inst_sram_addr_r
  always @(posedge clk) begin
    if (~aresetn) inst_sram_addr_r <= 32'b0;
    else if (inst_rd_req & inst_rd_rdy) 
      inst_sram_addr_r <= inst_rd_addr;
    else 
      inst_sram_addr_r <= inst_sram_addr_r;
  end

  //arsize_ré€‰æ‹©ä¹‹ä¸€ data_sram_size_r
  always @(posedge clk) begin
    if (~aresetn) rdata_sram_size_r <= 3'b0;
    else if (data_rd_req & data_rd_rdy) 
      rdata_sram_size_r <= data_rd_type == 3'b100 ? 3'b010 : data_rd_type;
    else 
      rdata_sram_size_r <= rdata_sram_size_r;
  end

  //araddr_ré€‰æ‹©ä¹‹ä¸€ data_sram_addr_r
  always @(posedge clk) begin
    if (~aresetn) rdata_sram_addr_r <= 32'b0;
    else if (data_rd_req & data_rd_rdy) 
      rdata_sram_addr_r <= data_rd_addr;
    else 
      rdata_sram_addr_r <= rdata_sram_addr_r;
  end

  //è¯»é€šé“æ­£åœ¨è¿›è¡Œè¯»æŒ‡ä»¤ï¼Œç­‰å¾…è¯»å“åº”
  always @(posedge clk) begin
    if (~aresetn) inst_read_wait <= 1'b0;
    else if (arvalid & arready & arid_r == 4'b0000) 
      inst_read_wait <= 1'b1;
    else if (rvalid & rready & rid == 4'b0000 & rlast)  //è¯»å“åº”å·²æ”¶åˆ°ï¼Œä¸”æ˜¯è¯»æŒ‡ä»¤,å¯èƒ½ä¼šè¯»å¤šä¸ªâ€”â€”éœ€è¦å¢åŠ rlastä¿¡å·åˆ¤æ–­
      inst_read_wait <= 1'b0;
  end

  //è¯»é€šé“æ­£åœ¨è¿›è¡Œè¯»æ•°æ®ï¼Œç­‰å¾…è¯»å“åº”
  always @(posedge clk) begin
    if (~aresetn) data_read_wait <= 1'b0;
    else if (arvalid & arready & arid_r == 4'b0001) 
      data_read_wait <= 1'b1;
    else if (rvalid & rready & rid == 4'b0001 & rlast)  //è¯»å“åº”å·²æ”¶åˆ°ï¼Œä¸”æ˜¯è¯»æ•°æ®
      data_read_wait <= 1'b0;
  end

  //arvalid
  always @(posedge clk) begin
    if (~aresetn)  //
      arvalid_r <= 1'b0;
    else if (arvalid & arready)  //è¯»è¯·æ±‚æ”¶åˆ°å“åº”åˆ™å¤ä½
      arvalid_r <= 1'b0; 
    else if(data_rd_req & data_rd_rdy | inst_rd_req & inst_rd_rdy) //è¿™é‡Œå¯ä»¥åŠ reqå§ï¼ŸåŠ reqæ›´å¥½ç†è§£ Brustæ—¶ä¿æŒ
      arvalid_r <= 1'b1;
  end

  //AXIä¸»æ–¹ï¼Œé™¤äº†å¸¸é‡ï¼Œå…¶ä½™è¾“å‡ºä¿¡å·çš„å‡æ¥è‡ªè§¦å‘å™¨Qç«¯ 
  //è¯»è¯·æ±‚é€šé“è¾“å‡ºä¿¡å·
  assign arvalid = arvalid_r;
  assign arid = arid_r;
  assign araddr = (arid == 4'b0000) ? inst_sram_addr_r : rdata_sram_addr_r;
  //sizeæ˜¯3ä½ï¼Œ000->1B 001->2B 010->4B 011->8B 100->16B 101->32B 110->64B 111->128B
  assign arsize = (arid == 4'b0000) ? inst_sram_size_r: rdata_sram_size_r;

  assign arlen = (inst_rd_type == 3'b100 | data_rd_type == 3'b100) ? 8'h3 : 8'h0;//å½“æ˜¯cahceè¡Œæ—¶éœ€è¦è¯»4ä¸ª
  assign arburst = 2'b01;
  assign arlock = 1'b0;
  assign arcache = 1'b0;
  assign arprot = 1'b0;

  assign data_rd_rdy = //loadä¼˜å…ˆçº§å¤§äºå–æŒ‡
      (~data_read_wait & ~arvalid & data_rd_req == 1'b1) ? 1'b1 : 1'b0; 
  assign inst_rd_rdy = 
        (~inst_read_wait & ~arvalid & inst_rd_req == 1'b1 &  data_rd_req == 1'b0) ? 1'b1 : 1'b0;

  //-----------------------------------è¯»å“åº”ç›¸å…³ä¿¡å·-------------------------------------//
  always @(posedge clk) begin
    if (~aresetn) 
      rready <= 1'b0;
    else if (rready & rvalid & rlast) //çªå‘ä¼ è¾“ï¼Œå½“è¯»æœ€åä¸€ä¸ªæœ‰æ•ˆæ—¶ï¼Œå†ç½®rreadyä¸º1'b0
      rready <= 1'b0; //å½“è¯»åˆ°æœ€åä¸€ä¸ªæ—¶ï¼Œæ‰ç½®rreadyæ˜¯1'b0
    else if (inst_read_wait | data_read_wait)  //ç­‰å¾…å‡†å¤‡æ¥æ”¶æ•°æ®
      rready <= 1'b1;
  end

  assign inst_ret_data = (rvalid & rready & rid == 4'b0000) ? rdata : 32'b0;
  assign inst_ret_valid = rvalid & rready & rid == 4'b0000;
  assign data_ret_data = (rvalid & rready & rid == 4'b0001) ? rdata : 32'b0;
  assign data_ret_valid = rvalid & rready & rid == 4'b0001;
  assign inst_ret_last = rid == 4'b0000 & rlast;
  assign data_ret_last = rid == 4'b0001 & rlast;
  //-----------------------------------å†™è¯·æ±‚ç›¸å…³ä¿¡å·-------------------------------------//
  //å¤„ç†å†™åœ°å€
  always @(posedge clk) begin
    if (~aresetn) 
      wdata_sram_addr_r <= 32'b0;
    else if (data_wr_req & data_wr_rdy) 
      wdata_sram_addr_r <= data_wr_addr;
    else 
      wdata_sram_addr_r <= wdata_sram_addr_r;
  end

  //å¤„ç†å†™é•¿åº¦
  always @(posedge clk) begin
    if (~aresetn) 
      wdata_sram_size_r <= 3'b0;
    else if (data_wr_req & data_wr_rdy) 
      wdata_sram_size_r <= data_wr_type == 3'b100 ? 3'b010 : data_wr_type;
    else 
      wdata_sram_size_r <= wdata_sram_size_r;
  end

  //å¤„ç†å†™æ•°æ® å†™è¯·æ±‚å’Œå†™æ•°æ®åŒæ—¶è®¾ç½®
  always @(posedge clk) begin
    if (~aresetn) 
      data_sram_wdata_r <= 128'b0;
    else if (data_wr_req & data_wr_rdy) 
      data_sram_wdata_r <= data_wr_data;
    else if (wvalid & wready & awlen == 8'b11) begin 
      data_sram_wdata_r <= {32'b0,data_sram_wdata_r[127:32]};  //å†™128ä½æ—¶ï¼Œæ¯æ¬¡éƒ½é‡‡å–å³ç§»32ä½ï¼Œä½¿å¾—AXIä¼ ç»™æ€»çº¿çš„32ä½æ•°æ®å§‹ç»ˆèµ‹å€¼[31:0]
    end
  end

  //å¤„ç†å†™é€‰é€š
  always @(posedge clk) begin
    if (~aresetn) wdata_sram_wstrb_r <= 4'b0000;
    else if (data_wr_req & data_wr_rdy) 
      wdata_sram_wstrb_r <= data_wr_wstrb;
    else 
      wdata_sram_wstrb_r <= wdata_sram_wstrb_r;
  end

  //å†™å¤šä¸ªæ•°æ®æ—¶ï¼Œéœ€è¦ä½¿ä¹‹åçš„å†™ç­‰å¾… 
  always @(posedge clk) begin
    if (~aresetn) w_wait <= 1'b0;
    else if (wvalid & wready & awlen == 8'h3 & w_num != 3'b001) 
      w_wait <= 1'b1;
    else 
      w_wait <= 1'b0;
  end

  //ä»è®¾å¤‡å·²æ”¶åˆ°å†™æ•°æ®
  always @(posedge clk) begin
    if (!aresetn) wdata_received <= 1'b0;
    else if (wvalid & wready) wdata_received <= 1'b1;
    else if (wdata_received & waddr_received) wdata_received <= 1'b0;
  end

  //ä»è®¾å¤‡å·²æ”¶åˆ°å†™åœ°å€
  always @(posedge clk) begin
    if (~aresetn) waddr_received <= 1'b0;
    else if (awvalid & awready) waddr_received <= 1'b1;
    else if(wdata_received & waddr_received) //å†™åœ°å€å’Œå†™æ•°æ®éƒ½è¢«ä»è®¾å¤‡æ”¶åˆ°åå†å¼€å§‹æ–°çš„å†™è¯·æ±‚
      waddr_received <= 1'b0;
  end

  //å†™è¯·æ±‚ validä¿¡å·çš„å‘é€
  always @(posedge clk) begin
    if (!aresetn) awvalid <= 1'b0;
    else if(data_wr_req & data_wr_rdy)
      awvalid <= 1'b1;
    else if (awvalid & awready) awvalid <= 1'b0;
  end

  always @(posedge clk) begin
    if (~aresetn) wvalid <= 1'b0;
    else if (data_wr_req & data_wr_rdy | w_wait)  //å†™è¯·æ±‚å’Œå†™æ•°æ®åŒæ—¶ç½®æœ‰æ•ˆ
      wvalid <= 1'b1;
    else if (wvalid & wready) wvalid <= 1'b0;
  end

  always @(posedge clk) begin
    if (~aresetn) begin
      awlen_r <= 8'b0;
    end else if (data_wr_req) begin
      awlen_r <= data_wr_type == 3'b100 ? 8'h3 : 8'h0;
    end
  end

  always @(posedge clk) begin
    if (~aresetn) begin
      w_num <= 3'b000;
    end else if (data_wr_req & data_wr_rdy & awlen == 8'h3) begin
      w_num <= 3'b100;
    end else if (wvalid & wready & awlen == 8'h3) begin
      w_num <= w_num -3'b1;
    end
  end

  always @(posedge clk)begin
    if(~aresetn) wlast <= 1'b0;
    else if(w_num==3'b001 && awlen==8'b11 || data_wr_req && awlen==8'b0)
      wlast <= 1'b1;
    else if(w_num==3'b000 && awlen==8'b11 || wvalid && wready && awlen==8'b0)
      wlast <= 1'b0;
  end

  assign awaddr             = wdata_sram_addr_r;
  assign awsize             = wdata_sram_size_r;
  assign awid               = 4'b0001;
  assign awlen              = data_wr_req ? (data_wr_type == 3'b100 ? 8'h3 : 8'h0) : awlen_r;
  assign awburst            = 2'b01;
  assign awlock             = 1'b0;
  assign awcache            = 1'b0;
  assign awprot             = 1'b0;

  assign wdata              = data_sram_wdata_r[31:0];
  assign wstrb              = wdata_sram_wstrb_r;
  assign wid                = 4'b0001;

  assign data_wr_rdy = ~awvalid & ~wvalid;

  //-------------------------------------å†™å“åº”ç›¸å…³ä¿¡å·-----------------------------------//
  always @(posedge clk) begin
    if (!aresetn) begin
      bready <= 1'b0;
    end else if (wvalid & wready & awvalid & awready) begin
      bready <= 1'b1;
    end else if (wdata_received & awvalid & awready) begin
      bready <= 1'b1;
    end else if (wvalid & wready & waddr_received) begin
      bready <= 1'b1;
    end else if (bvalid & bready) begin
      bready <= 1'b0;
    end
  end

endmodule

```

### 2.2 Cacheä¸CPUæµæ°´çº¿çš„äº¤äº’é€‚é…é—®é¢˜

#### 2.2.1 CPU HITæƒ…å†µä¸‹

ä¸ºäº†å°½å¯èƒ½åœ°ä½¿å¾—æµæ°´çº¿çš„æ‰§è¡Œæ•ˆç‡ä¸é‡‡ç”¨æŒ‡ä»¤ RAMã€æ•°æ® RAM çš„æ—¶å€™ä¸€è‡´æˆ–å°½å¯èƒ½ä¸€è‡´ï¼Œè®¾è®¡æ€è·¯æ˜¯â€œå¯¹äºICache çš„ Look Up è®¿é—®ï¼Œå…¶è¯·æ±‚ç”± pre-IF çº§å‘æ¥ï¼Œè¿”å›çš„ç»“æœé€è‡³ IF çº§ï¼›å¯¹äºDCache çš„ Look Up è®¿é—®ï¼Œå…¶è¯·æ±‚ç”± EX çº§å‘æ¥ï¼Œè¿”å›çš„ç»“æœé€è‡³ MEM çº§â€

å¯¹äºè¯»ä¸å‘½ä¸­ï¼Œå†™ä¸å‘½ä¸­ä»¥åŠå†™å‘½ä¸­åˆ°Write Bufferéƒ½æ ¹æ®addr okäº§ç”Ÿäº†é˜»å¡â€”â€”è¿™ä¸ªaddr okçš„é˜»å¡æœºåˆ¶åœ¨CPUå®ç°ç±»SRAMæ—¶å·²æ·»åŠ 
å¯¹äºå†™å‘½ä¸­åˆ°LOOKUPæ—¶ï¼Œè®¾ç½®å‰é€’

#### 2.2.2 CPU MISSæƒ…å†µä¸‹

ç”±äºé‡‡ç”¨çš„æ˜¯é˜»å¡Cacheï¼Œæ‰€ä»¥åœ¨ä¸å‘½ä¸­æœŸé—´addr\_okä¸ä¼šæœ‰æ•ˆï¼Œä»è€Œé˜»å¡å‘èµ·Cacheè¯·æ±‚çš„æŒ‡ä»¤

å¯¹äºè¯»ä¸å‘½ä¸­ï¼Œç­‰åˆ°å¯¹åº”offsetçš„ç»“æœè¿”å›å³å¯ç½®data\_okä»è€Œæµé€šæµæ°´çº¿

å¯¹äºå†™ä¸å‘½ä¸­ï¼Œç”±äºå¯¹äºä¹‹åçš„è®¿å­˜æ“ä½œä¼šé˜»å¡åˆ°REFILLâ†’IDLEï¼Œæ‰€ä»¥å¯¹äºloadçš„ç›¸å…³ä¸€å®šä¸ä¼šå¼•èµ·å†²çªï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥è®¾ç½®data\_okä¸º1ï¼Œä»è€Œä½¿å¾—éè®¿å­˜æŒ‡ä»¤å¯ä»¥åœ¨æµæ°´çº¿ä¸­ç»§ç»­å‰è¡Œâ€”â€”è€Œå¯¹äºå†™å‘½ä¸­åˆ°Write Bufferä¹Ÿæ˜¯è¿™æ ·è€ƒè™‘çš„ï¼Œå¯¹äºå†™å‘½ä¸­åˆ°LOOKUPï¼Œå› ä¸ºæ­¤æ—¶å†™è¿˜åœ¨LOOKUPï¼Œå¯ä»¥å‰é€’

### 2.3 éç¼“å­˜è®¿é—®çš„å¤„ç†

LA32Ræ”¯æŒä¸¤ç§å­˜å‚¨è®¿é—®ç±»å‹ï¼šå¼ºåºéç¼“å­˜SUCå’Œä¸€è‡´å¯ç¼“å­˜CCâ€”â€”ä¸€å®šä¸è¦å¿˜è®°SUCçš„å¤„ç†

#### 2.3.1 å­˜å‚¨è®¿é—®ç±»å‹çš„åˆ¤å®š

ç›´æ¥åœ°å€ç¿»è¯‘æ¨¡å¼ä¸‹ï¼Œå–æŒ‡çš„å­˜å‚¨è®¿é—®ç±»å‹ç”±\*\*`CSR.CRMD.DATF`\*\* å†³å®šï¼Œ load/store æŒ‡ä»¤è®¿å­˜çš„å­˜å‚¨è®¿é—®ç±»å‹ç”±\*\*â€‹`CSR.CRMD.DATM`\*\*å†³å®š

ç›´æ¥æ˜ å°„åœ°å€ç¿»è¯‘æ¨¡å¼ä¸‹ï¼Œ å–æŒ‡æˆ–è®¿å­˜çš„å­˜å‚¨è®¿é—®ç±»å‹ç”±æ‰€å‘½ä¸­çš„ç›´æ¥æ˜ å°„çª—å£ä¸­ MAT é…ç½®ä¿¡æ¯ï¼ˆæ¥è‡ªäº\*\*`CSR.DMW0/1.MAT`\*\*ï¼‰å†³å®š

é¡µè¡¨æ˜ å°„åœ°å€ç¿»è¯‘æ¨¡å¼ä¸‹ï¼Œå–æŒ‡æˆ–è®¿å­˜çš„å­˜å‚¨è®¿é—®ç±»å‹åˆ™æ˜¯ç”±è™šå®åœ°å€è½¬æ¢æ‰€ç”¨é¡µè¡¨é¡¹ä¸­çš„\*\*`MAT`\*\*åŸŸé…ç½®ä¿¡æ¯å†³å®š

#### 2.3.2 åœ¨ Cache æ¨¡å—ä¸­å¤„ç†SUC

1. éœ€è¦åœ¨Cacheæ¨¡å—å’ŒCPUçš„äº¤äº’æ¥å£ä¸­å¢åŠ 1bitçš„ä¿¡å·ï¼ŒæŒ‡ç¤ºå½“å‰è®¿å­˜è¯·æ±‚çš„å­˜å‚¨è®¿é—®ç±»å‹

   csræ¨¡å—éœ€è¦å¢åŠ `crmd_datf`ã€`crmd_datf`ã€`dmw0_mat`ã€`dmw1_mat`ä¿¡å·çš„è¾“å‡º
   ```verilog
       assign inst_mat = crmd_da == 1'b1 & crmd_pg == 1'b0 ? crmd_dataF :
                                  dmw_select != 2'b0 ? (dmw_select[0] ? dmw0_mat : dmw1_mat) :
                                  s0_mat[0];
       assign data_mat = crmd_da == 1'b1 & crmd_pg == 1'b0 ? crmd_datm :
                       dmw_select != 2'b0 ? (dmw_select[0] ? dmw0_mat : dmw1_mat) :
                       s1_mat[0];

   ```
2. éç¼“å­˜è®¿é—®åœ¨Cacheæ¨¡å—ä¸­çš„å®ç°è¦å°½å¯èƒ½åœ°å¤ç”¨Cache MISSçš„å¤„ç†æµç¨‹å’Œé€šè·¯

   ä¹Ÿå°±æ˜¯è¯´ï¼Œéç¼“å­˜è®¿é—®çš„è¯»å†™éƒ½å½“åšMISSå¤„ç†ï¼Œåªä¸è¿‡ä¸ç”¨è¯»æ›¿æ¢Cach

   ä¸€ä¸ªéç¼“å­˜çš„ load æŒ‡ä»¤æºå¸¦ç€éç¼“å­˜çš„æ ‡å¿—è¿›å…¥ Cache æ¨¡å—åï¼ŒCache æ¨¡å—å†…éƒ¨ä¹Ÿä¼šæ£€æŸ¥ä¸€ä¸‹ Cacheï¼Œç„¶åå¹¶ä¸çœ‹ Cache Tag çš„æ¯”è¾ƒç»“æœè€Œæ˜¯ç›´æ¥å°†å…¶å½“ä½œ Cache Missè¿›è¡Œåç»­å¤„ç†ã€‚å› ä¸º Cache Miss æ—¶è¦å‘æ€»çº¿å¤–å‘é€è®¿å­˜è¯·æ±‚ï¼Œæ‰€ä»¥éç¼“å­˜è‡ªç„¶å°±åˆ©ç”¨è¿™ä¸ªæµç¨‹å‘èµ·æ€»çº¿è¯·æ±‚ï¼Œç„¶åç­‰å¾…æ•°æ®è¿”å›ï¼Œåªä¸è¿‡æ­¤æ—¶ä¸éœ€è¦çœŸçš„æ›¿æ¢ä¸€ä¸ª Cache è¡Œã€‚æ¢è¨€ä¹‹ï¼Œå°±æ˜¯çŠ¶ æ€æœºå¯ä»¥è¿›è¡Œ MISSâ†’REPLACEâ†’REFILL çŠ¶æ€è½¬æ¢ï¼Œä½†æ˜¯ä¸å‘ Cache å‘é€è¯»æ“ä½œï¼Œè‡ªç„¶å°±ä¸ ä¼šäº§ç”Ÿå¯¹å¤–çš„æ›¿æ¢å†™

   éç¼“å­˜çš„ store æŒ‡ä»¤ä¹Ÿæ˜¯é‡‡ç”¨ç±»ä¼¼æ€è·¯è¿›è¡Œå¤„ç†ï¼Œå³ store æŒ‡ä»¤ä¸€å®šè®°å½•ä¸º Cache Missï¼Œç„¶ åç©ºèµ°ä¸€åœˆçŠ¶æ€ï¼Œä¸å‘èµ·æ€»çº¿è¯»ã€Cache è¯»ã€Cache å†™ï¼Œåªæ˜¯åˆ©ç”¨æ›¿æ¢å†™å‡ºçš„æ•°æ®é€šè·¯å°†æ•°æ®å†™å‡ºå»
   > ğŸ“Œä¸ºäº†ä¿è¯ä½¿ç”¨éç¼“å­˜è®¿é—® I/O å¤–è®¾çš„æ­£ç¡®æ€§ï¼Œå¼ºåºéç¼“å­˜çš„ Load/Store æ“ä½œéœ€è¦ä¿æŒä¸¥æ ¼çš„é¡ºåºã€‚å¦‚æœ AXI æ¥å£æ¨¡å—å†…æœ‰å°šæœªç­‰åˆ° bvalid çš„éç¼“å­˜å†™è¯·æ±‚ï¼Œé‚£ä¹ˆä¸€å®šè¦é˜»å¡åç»­æ‰€æœ‰éç¼“å­˜çš„è¯»æˆ– è€…å†™è¯·æ±‚ï¼ˆæ— è®ºæ˜¯å¦å­˜åœ¨åœ°å€ç›¸å…³ï¼‰ï¼Œç›´åˆ°è¿™ä¸ªéç¼“å­˜å†™è¯·æ±‚çš„ bvalid è¿”å›â€”â€”æŒ‰ç…§æœºåˆ¶ï¼Œé˜»å¡Cache
3. å¯¹Cacheçš„ä¿®æ”¹
   1. æ¥å£å¢åŠ 1bitè¡¨ç¤ºå­˜å‚¨è®¿é—®ç±»å‹ï¼ŒåŒæ—¶å¯¹äºéç¼“å­˜å†™ï¼Œéœ€è¦è®¾ç½®sizeè¡¨ç¤ºå†™ç±»å‹
      ```verilog
          input  wire        uncache,
          input  wire [2:0]  size,
      ```
   2. å¢åŠ requestBufferè®°å½•uncacheè®¿é—®ä¿¡æ¯
      ```verilog
        reg requestBuffer_uncache;
        reg [2:0] requestBuffer_size;

      ```
   3. åˆ¤æ–­å‘½ä¸å‘½ä¸­æ—¶è€ƒè™‘è®¿é—®ç±»å‹ï¼Œå¦‚æœæ˜¯SUCï¼Œé‚£ä¹ˆhitä¸€å®šä¸º0
      ```verilog
        assign cache_hit = (way0_hit | way1_hit) & ~requestBuffer_uncache; //uncacheä¸º1æ—¶ä¸€å®šä¸å‘½ä¸­

      ```
   4. å¯¹çŠ¶æ€çš„æ›´æ–°ç»“åˆè®¿é—®ç±»å‹
      1. MISSâ†’REPLACEï¼šå¦‚æœæ˜¯éç¼“å­˜è¯»æ“ä½œï¼Œé‚£ä¹ˆä¸ç”¨ç­‰å¾…wr\_rdyï¼Œå¦åˆ™éœ€è¦ç­‰å¾…

         å¯¹äºICacheä¸ç”¨åšè¿™ä¸ªè°ƒæ•´
         ```verilog
                 MAIN_MISS: begin
                   //å¦‚æœå½“å‰æ˜¯éç¼“å­˜è¯»ï¼Œé‚£ä¹ˆå°±ä¸å­˜åœ¨å†™AXIï¼Œä¹Ÿå°±ä¸éœ€è¦ç­‰å¾…wr_rdy
                   if (requestBuffer_uncache & ~requestBuffer_op ? 1'b1 : wr_rdy) begin  //reqè¦åœ¨rdyä¹‹åæœ‰æ•ˆ
                     cache_state <= MAIN_REPLACE; 

                     missBuffer_replaceWay <= replace_way;
                     wr_req <= (replace_d & replace_v & ~requestBuffer_uncache ) | requestBuffer_uncache & requestBuffer_op;
                   end
                 end
         ```
      2. REPLACEâ†’REFILLï¼šå¦‚æœæ˜¯éç¼“å­˜å†™ï¼Œé‚£ä¹ˆä¹Ÿä¸ç”¨ç­‰å¾…rd\_rdy
         ```verilog
                 MAIN_REPLACE: begin
                   if (rd_rdy | requestBuffer_op & requestBuffer_uncache) begin
                     cache_state <= MAIN_REFILL;

                     //å¼€å§‹è®°å½•è¯»äº†å‡ ä¸ª å½“æ˜¯100æ—¶å·²è¯»å®Œ
                     missBuffer_retNum <= 2'b0;
                   end
                   if (wr_req) begin
                     wr_req <= 1'b0;
                   end
                 end
         ```
      3. REFILLâ†’IDLEï¼šå¦‚æœæ˜¯éç¼“å­˜å†™ï¼Œé‚£ä¹ˆä¸ç”¨ç­‰å¾…æœ€åä¸€æ¬¡è¯»
         ```verilog
         MAIN_REFILL: begin
                   if (ret_valid & ret_last | ~rd_req_buffer | requestBuffer_op & requestBuffer_uncache) begin  //ç­”æ¡ˆä¸Šå¤šäº†ä¸€ä¸ªç¼“å­˜åˆ¤æ–­æ˜¯å¦æœ‰è¯»è¯·æ±‚
                     cache_state <= MAIN_IDLE;
                   end else if (ret_valid) begin
                     missBuffer_retNum <= missBuffer_retNum + 2'b01;
                   end
                 end
         ```
   5. è¯»å†™æ•°æ®çš„ä¿®æ”¹

      éç¼“å­˜è¯»ï¼š

      rd\_reqæ˜¯åœ¨REPLACEçŠ¶æ€æ—¶ï¼ŒMISSå’Œéç¼“å­˜è¯»ä¸‹è¯·æ±‚ï¼Œå› æ­¤éœ€è¦æ’é™¤éç¼“å­˜å†™
      rd\_typeã€rd\_addrã€data\_okå‡éœ€è¦æ ¹æ®éç¼“å­˜è¯»æ¥è°ƒæ•´
      ```verilog
        assign rd_req = cache_state == MAIN_REPLACE & ~(requestBuffer_uncache & requestBuffer_op);//åœ¨REPLACEä¸”ä¸æ˜¯éç¼“å­˜å†™
        assign rd_type = requestBuffer_uncache ? requestBuffer_size : 3'b100;
        assign rd_addr = requestBuffer_uncache ? {requestBuffer_tag,requestBuffer_index,requestBuffer_offset} : {requestBuffer_tag, requestBuffer_index, 4'b0};
        
        assign data_ok = (cache_hit | requestBuffer_op) & cache_state == MAIN_LOOKUP |
                          (cache_state == MAIN_REFILL & ~requestBuffer_op & ret_valid & (requestBuffer_offset[3:2] == missBuffer_retNum[1:0] |
                          requestBuffer_uncache));//å½“è¯»æ—¶åªè¯»äº†1ä¸ª
      ```
      éç¼“å­˜å†™ï¼š

      wr\_type
      wr\_addr
      wr\_wstrb
      wr\_data
      ```verilog
        assign wr_addr = requestBuffer_uncache ? {requestBuffer_tag,requestBuffer_index,requestBuffer_offset} : {replace_tag, requestBuffer_index, 4'b0};  //èµ·å§‹åœ°å€
        assign wr_type = requestBuffer_uncache ? requestBuffer_size : 3'b100;  //å†™16B
        assign wr_data = requestBuffer_uncache ? {96'b0, requestBuffer_wdata} :replace_data;
        assign wr_wstrb = requestBuffer_uncache ? requestBuffer_wstrb : 4'b1111;
      ```
   6. å¯¹Cacheè¡¨åœ¨REFILLä¸‹çš„ä¿®æ”¹å¿…é¡»åœ¨å¯ç¼“å­˜æƒ…å†µä¸‹
      ```verilog
      end else if (cache_state == MAIN_REFILL & (ret_valid & ret_last == 1'b1) & ~requestBuffer_uncache) begin
            if (refill_write_way1) begin
              way0_D[requestBuffer_index] <= requestBuffer_op;
            end else if (refill_write_way0) begin
              way1_D[requestBuffer_index] <= requestBuffer_op;
            end
          end
      ```
   7. å¯¹{tag,v}SRAMå’ŒBank SRAMçš„ä¿®æ”¹ä¹Ÿéƒ½éœ€è¦åœ¨\~requestBuffer\_uncacheçš„æƒ…å†µä¸‹è¿›è¡Œ

## 3 Cacheç»´æŠ¤æŒ‡ä»¤ CACOP

### 3.1 CACOPâ€”â€”ç”¨äºCacheçš„åˆå§‹åŒ–å’Œä¸€è‡´æ€§ç»´æŠ¤

æŒ‡ä»¤æ ¼å¼ï¼š`cacop code,rj,si12`

é€šç”¨å¯„å­˜å™¨rjçš„å€¼åŠ ä¸Šç¬¦å·æ‰©å±•åçš„12ä½ç«‹å³æ•°ï¼Œå¾—åˆ°CACOPæŒ‡ä»¤æ‰€ç”¨çš„è™šæ‹Ÿåœ°å€VA

CACOPæŒ‡ä»¤è®¿é—®å“ªä¸ªCacheä»¥åŠè¿›è¡Œä½•ç§CAcheæ“ä½œæ˜¯ç”±æŒ‡ä»¤ä¸­çš„5bit codeå†³å®šçš„â€”â€”code\[4:3]æŒ‡ç¤ºCACOPçš„æ“ä½œç±»å‹ï¼Œcode\[2:0]æŒ‡ç¤ºæ“ä½œçš„Cacheå¯¹è±¡

code\[2:0]å€¼ä¸º0æ—¶æ“ä½œä¸€çº§ç§æœ‰æŒ‡ä»¤Cacheã€å€¼ä¸º1æ—¶æ“ä½œä¸€çº§ç§æœ‰æ•°æ®Cacheã€ä¸º2æ—¶æ“ä½œäºŒçº§å…±äº«æ··åˆCache

code\[4:3]å€¼ä¸º0æ—¶ç”¨äºCacheçš„åˆå§‹åŒ–â€”â€”å°†æŒ‡å®šCacheè¡Œçš„æ‰€æœ‰è·¯tagç½®ä¸ºå…¨0

code\[4:3]å€¼ä¸º1æ—¶ç”¨äºé‡‡ç”¨åœ°å€ç›´æ¥ç´¢å¼•æ–¹å¼ç»´æŠ¤Cacheçš„ä¸€è‡´æ€§

ç›´æ¥åœ°å€ç´¢å¼•æ–¹å¼ï¼šå‡è®¾è¢«è®¿é—®çš„Cacheæœ‰ï¼ˆ1<\<Wayï¼‰è·¯ï¼Œæ¯ä¸€è·¯æœ‰ï¼ˆ1<\<Indexï¼‰ä¸ª Cache è¡Œï¼Œæ¯ä¸ª Cache è¡Œå¤§å°ä¸ºï¼ˆ1<\<Offsetï¼‰ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆé‡‡ç”¨åœ°å€ç›´æ¥ç´¢å¼•æ–¹å¼æ„å‘³ç€ï¼Œæ“ä½œè¯¥ Cache çš„ç¬¬ VA\[Way-1:0]è·¯çš„ç¬¬ VA\[Index+Offset-1:Offset]ä¸ªCacheè¡Œ

åœ°å€ç›´æ¥ç´¢å¼•çš„è¯ï¼Œindexä½ç½®è¿˜æ˜¯indexï¼Œç›´æ¥æ ¹æ®è¿™ä¸ªindexå»è®¿é—®é‚£ä¸ªç»„ï¼Œè‡³äºå“ªä¸€è·¯å–å†³äºVA\[Way-1:0]

ç»´æŠ¤ä¸€è‡´æ€§çš„æ“ä½œæ˜¯å¯¹æŒ‡å®šçš„Cache è¿›è¡Œæ— æ•ˆå¹¶å†™å›çš„æ“ä½œã€‚å¦‚æœè¢«æ“ä½œçš„æ˜¯æŒ‡ä»¤ Cacheï¼Œé‚£ä¹ˆä»…éœ€è¦è¿›è¡Œæ— æ•ˆæ“ä½œï¼Œå¹¶ä¸éœ€è¦å°† Cache è¡Œä¸­çš„æ•°æ®å†™å›ã€‚å†™å›çš„æ•°æ®è¿›å…¥åˆ°å“ªä¸€çº§å­˜å‚¨ä¸­ç”±å…·ä½“å®ç°çš„ Cache å±‚æ¬¡åŠå„çº§é—´çš„åŒ…å«æˆ–äº’æ–¥å…³ç³»å†³å®šã€‚å¯¹äºæ•°æ®Cache æˆ–æ··åˆCacheï¼Œç”±å…·ä½“å®ç°å†³å®šæ˜¯å¦ä»…åœ¨ Cache è¡Œæ•°æ®ä¸ºè„æ—¶æ‰å°†å…¶å†™å›

å¯¹äºICACHEï¼Œç›´æ¥ç½®è¯¥è·¯V=0
å¯¹äºDCACHEï¼Œç½®è¯¥è·¯V=0ä¸”è‹¥D=1ï¼Œå†å†™å›

code\[4:3]å€¼ä¸º2æ—¶è¡¨ç¤ºé‡‡ç”¨æŸ¥è¯¢ç´¢å¼•æ–¹å¼ç»´æŠ¤Cacheçš„ä¸€è‡´æ€§

æŸ¥è¯¢ç´¢å¼•æ–¹å¼æ˜¯æŒ‡å°†CACOPæŒ‡ä»¤çš„VAå½“åšä¸€ä¸ªæ™®é€šçš„è®¿å­˜æŒ‡ä»¤å»è®¿é—®å¾…æ“ä½œçš„Cacheã€‚å¦‚æœå‘½ä¸­åˆ™å¯¹å‘½ä¸­çš„ Cache è¡Œè¿›è¡Œæ“ä½œï¼Œå¦åˆ™ä¸åšä»»ä½•æ“ä½œ

code\[4:3]æœªå®šä¹‰ï¼Œç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰CacheåŠŸèƒ½

### 3.2 è®¾è®¡å»ºè®®

CACOPæŒ‡ä»¤çš„æ‰§è¡Œå¤ç”¨Cacheæ­£å¸¸è®¿é—®çš„æ•°æ®é€šè·¯

1. æ‰€æœ‰ CACOP æŒ‡ä»¤éƒ½æ¶‰åŠå¯¹äº Cache çš„ä¿®æ”¹ã€‚æ‰€è°“çš„ Invalid æ“ä½œå®è´¨ä¸Šå°±æ˜¯æŠŠç›¸åº” Cache è¡Œçš„ V å†™æˆ 0

   é‚£ä¹ˆæ‰€æœ‰çš„CACOPæŒ‡ä»¤å°±éœ€è¦ç»è¿‡IDLEâ†’LOOKUPâ†’MISSâ†’REPLACEâ†’REFILLâ†’IDLEçš„çŠ¶æ€æ›´è¿­

   å¯¹Vã€TAGçš„æ›´æ–°å¤ç”¨REFILLçš„é€»è¾‘

   æ­¤æ—¶tagv\_addr = indexâ€”â€”æ— è®ºæ˜¯æŸ¥è¯¢ç´¢å¼•æ–¹å¼è¿˜æ˜¯ç›´æ¥ç´¢å¼•æ–¹å¼ï¼Œè®¿é—®çš„Cacheè¡Œéƒ½ç”±indexå†³å®šï¼›æŸ¥è¯¢ç´¢å¼•æ–¹å¼æ ¹æ®æŸ¥è¯¢åˆ°å‘½ä¸­ç»“æœç½®ä½tagv0\_en/weaå’Œtagv1\_en/weaï¼›ç›´æ¥ç´¢å¼•æ–¹å¼åˆ™æ ¹æ®offset\[Way-1:0]é€‰è·¯
2. éƒ¨åˆ†CACOPæŒ‡ä»¤éœ€è¦å¯¹Cacheè¿›è¡ŒHit åˆ¤æ–­â€”â€”code\[4:3] == 2'b10
3. &#x20;éƒ¨åˆ†CACOPæŒ‡ä»¤éœ€è¦è¯»å‡ºCacheè¡Œå¹¶å°†å…¶å†™å›å†…å­˜â€”â€”code\[4:3] â‰  2'b00 code\[2:0] = 3'h1&#x20;

> ğŸ“Œæ“ä½œæŒ‡ä»¤ Cache çš„ CACOP æŒ‡ä»¤å’Œå–æŒ‡æœ‰ç‰¹æƒèµ„æºç›¸å…³å†²çªï¼Œå› æ­¤å¯¹äºcode\[2:0] == 3'b0çš„CACOPï¼Œéœ€è¦å–æ¶ˆé‡å–åç»­æŒ‡ä»¤

### 3.3 è®¾è®¡å®ç°

#### 3.3.1 å¯¹ICacheçš„ä¿®æ”¹

1. æ¥å£è¾“å…¥

   å› ä¸ºICacheä¹‹å‰è®¿é—®æ‰€ä½¿ç”¨çš„åœ°å€æ˜¯inst\_sram\_addrï¼Œè€ŒcacopæŒ‡ä»¤è¦æ±‚ä½¿ç”¨data\_sram\_addrï¼Œæ‰€ä»¥ICacheéœ€è¦æ–°å¢cacopä½¿èƒ½ç«¯å£ï¼Œæ“ä½œç±»å‹ç«¯å£ä»¥åŠåœ°å€ç«¯å£

   åˆå› ä¸ºå¯¹äºICacheä¸éœ€è¦å†™å›ï¼Œåªéœ€è¦æ“ä½œ{Tag,V}å³å¯ï¼Œæ‰€ä»¥ä¸ºäº†æ€§èƒ½çš„è€ƒè™‘ï¼Œåœ¨IDLEæ—¶å“åº”cacopæŒ‡ä»¤ï¼Œåœ¨LOOKUPå¯¹{Tag,V}è¿›è¡Œä¿®æ”¹ã€‚å› æ­¤éœ€è¦ç«¯å£æ¥è¡¨ç¤ºcacopæ“ä½œè¢«æ¥æ”¶çš„ä¿¡å·ï¼Œæ§åˆ¶æµæ°´çº¿å¯ä»¥å‘åæµåŠ¨
   ```verilog
       input               icacop_en    ,
       input  [ 1:0]       icacop_mode  ,
       input  [19:0]       icacop_tag   ,
       input  [ 7:0]       icacop_index ,
       input  [ 3:0]       icacop_offset,
       output              icacop_ok    ,
   ```
2. requestBufferä¿å­˜icacopçš„ç›¸å…³è¾“å…¥ä¿¡æ¯

   å› ä¸ºåœ¨LOOKUPçŠ¶æ€æ‰æ‰§è¡Œcacopå¯¹åº”çš„æ“ä½œï¼Œæ‰€ä»¥éœ€è¦å¯„å­˜å™¨ä¿å­˜åœ¨IDLEæ—¶cacopçš„å“åº”è¾“å…¥
   ```verilog
     reg         requestBuffer_icacop_en  ;
     reg [ 1:0]  requestBuffer_icacop_mode;
     reg [19:0]  requestBuffer_icacop_tag ;
     reg [ 7:0]  requestBuffer_icacop_index;
     reg [ 3:0]  requestBuffer_icacop_offset;
   ```
3. åœ¨IDLEâ†’LOOKUPæ—¶ï¼Œç½®ä¸ºè¿™äº›ä¿¡æ¯
   ```verilog
               requestBuffer_icacop_en  <= icacop_en;
               requestBuffer_icacop_mode<= icacop_mode;
               requestBuffer_icacop_tag <= icacop_tag;
               requestBuffer_icacop_index <= icacop_index;
               requestBuffer_icacop_offset <= icacop_offset;
   ```
4. å¯¹äºcacopçš„æ¨¡å¼2éœ€è¦åˆ¤æ–­æ˜¯å¦å‘½ä¸­ï¼Œè¿™é‡Œä¸èƒ½ç”¨ä¹‹å‰çš„cache\_hitï¼Œå› ä¸ºåœ°å€ä¸ä¸€æ ·
   ```verilog
     //icacheä¸­cacopçš„å¤„ç†ä¸éœ€è¦å†™å›ï¼Œå› æ­¤ç»Ÿä¸€åœ¨idleã€lookupæ—¶å³å¤„ç†å®Œæˆ
     wire way0_cacop_hit;
     wire way1_cacop_hit;
     wire cache_cacop_hit;

     assign way0_cacop_hit = way0_v & (requestBuffer_icacop_tag == way0_tag) & (requestBuffer_icacop_mode == 2'h2) & requestBuffer_icacop_en;
     assign way1_cacop_hit = way1_v & (requestBuffer_icacop_tag == way1_tag) & (requestBuffer_icacop_mode == 2'h2) & requestBuffer_icacop_en ;
     assign cache_cacop_hit = way0_cacop_hit | way1_cacop_hit;
   ```
5. æ›´æ”¹{tag,v}çš„ç‰‡é€‰ä½¿èƒ½ã€å†™ä½¿èƒ½ã€è¾“å…¥æ•°æ®ä»¥åŠåœ°å€

   ç‰‡é€‰ä½¿èƒ½åŒ…æ‹¬IDLEä»¥åŠ\~uncache

   è®¿é—®çš„åœ°å€éœ€è¦è€ƒè™‘addr\_okä¸‹icacop\_ençš„æœ‰æ•ˆä»¥åŠæ˜¯å¦æ˜¯æ¨¡å¼2ä¸”å‘½ä¸­

   å†™ä½¿èƒ½éœ€è¦åœ¨åŸæ¥çš„åŸºç¡€ä¸Šæ·»åŠ icacopçš„ï¼Œç»“åˆoffset\[0]ä»¥åŠå¯¹åº”è·¯çš„cacopå‘½ä¸­

   è¾“å…¥æ•°æ®åœ¨åŸæ¥çš„åŸºç¡€ä¸Šå¢åŠ äº†æ¨¡å¼1æ—¶æ¸…tagï¼Œæ¨¡å¼2æ¨¡å¼3æ—¶æ¸…v
   ```verilog
     assign way0_tagv_addra = addr_ok | icacop_en & cache_state == MAIN_IDLE ? (icacop_en ? icacop_index : index) : 
                              requestBuffer_icacop_mode == 2'h2 & cache_cacop_hit ? requestBuffer_icacop_index : requestBuffer_index;//è¯»çš„æ—¶å€™è¦åœ¨è¿›å…¥LOOKUPä¹‹å‰å°±å¾—åˆ°ä¿¡æ¯ï¼Œåœ¨lookupæ¯”è¾ƒ
     assign way1_tagv_addra = addr_ok | icacop_en & cache_state == MAIN_IDLE ? (icacop_en ? icacop_index : index) : 
                              requestBuffer_icacop_mode == 2'h2 & cache_cacop_hit ? requestBuffer_icacop_index : requestBuffer_index;//è¯»çš„æ—¶å€™è¦åœ¨è¿›å…¥LOOKUPä¹‹å‰å°±å¾—åˆ°ä¿¡æ¯ï¼Œåœ¨lookupæ¯”è¾ƒ
     assign way0_tagv_ena = cache_state == MAIN_IDLE | ~requestBuffer_uncache;
     assign way1_tagv_ena = cache_state == MAIN_IDLE | ~requestBuffer_uncache;
     assign way0_tagv_wea = cache_state == MAIN_REFILL & (ret_valid & ret_last == 1'b1) & ~missBuffer_replaceWay & ~requestBuffer_uncache |
                            (cache_state == MAIN_IDLE & icacop_en & (icacop_mode == 2'h0 | icacop_mode == 2'h1 & ~icacop_offset[0])) | (requestBuffer_icacop_mode == 2'h2 & way0_cacop_hit);
     assign way1_tagv_wea = cache_state == MAIN_REFILL & (ret_valid & ret_last == 1'b1) & missBuffer_replaceWay & ~requestBuffer_uncache |
                            (cache_state == MAIN_IDLE & icacop_en & (icacop_mode == 2'h0 | icacop_mode == 2'h1 & icacop_offset[0])) | (requestBuffer_icacop_mode == 2'h2 & way1_cacop_hit);
     assign way0_tagv_dina = icacop_mode == 2'h0 & cache_state == MAIN_IDLE & icacop_en ? {20'b0,way0_v} :
                             icacop_mode == 2'h1 & cache_state == MAIN_IDLE & icacop_en | requestBuffer_icacop_mode == 2'h2 & cache_cacop_hit ? {way0_tag,1'b0} :
                             {requestBuffer_tag, 1'b1};
     assign way1_tagv_dina = icacop_mode == 2'h0 & cache_state == MAIN_IDLE & icacop_en ? {20'b0,way1_v} :
                             icacop_mode == 2'h1 & cache_state == MAIN_IDLE & icacop_en | requestBuffer_icacop_mode == 2'h2 & cache_cacop_hit ? {way1_tag,1'b0} :
                             {requestBuffer_tag, 1'b1};
   ```

#### 3.3.2 å¯¹DCacheçš„ä¿®æ”¹

1. æ¥å£è¾“å…¥

   å¯¹äºDCacheçš„cacopï¼Œå®ƒçš„æ“ä½œåœ°å€å¯ä»¥å¤ç”¨EXEçº§å‘å‡ºçš„è¯·æ±‚ï¼Œæ‰€ä»¥åªéœ€è¦æ–°å¢ä½¿èƒ½ä¿¡å·å’Œæ¨¡å¼ä¿¡å·ä»¥åŠok
   ```verilog
       input               dcacop_en    ,
       input  [ 1:0]       dcacop_mode  ,
       output              dcacop_ok    ,
   ```
2. ç¼“å­˜è®¾ç½®
   ```verilog
     reg         requestBuffer_dcacop_en  ;
     reg [ 1:0]  requestBuffer_dcacop_mode;
   ```
3. å¯¹uncacheçš„ä¿®æ”¹

   æ‰§è¡ŒCACOPæ—¶ä¸éœ€è¦å†è€ƒè™‘å½“å‰æ˜¯ä»€ä¹ˆå­˜å‚¨è®¿é—®ç±»å‹[^æ³¨é‡Š19]ï¼Œä½†æ˜¯ç”±äºDCacheçš„cacopç¬¬äºŒç§æ¨¡å¼éœ€è¦å¤ç”¨ä¸å‘½ä¸­æ—¶çš„æ“ä½œï¼Œæ‰€ä»¥å¯¹äºDCacheçš„requestBuffer\_uncacheéœ€è¦è€ƒè™‘cacop\_enï¼Œä»è€Œä½¿å¾—cache\_hitæ’¤é”€æ‰ä¹‹å‰æ–°å¢çš„\~requestBuffer\_uncache
   ```verilog
               requestBuffer_uncache <= uncache & ~dcacop_en;

   ```
4. å› ä¸ºå¤ç”¨ä¹‹å‰compareçš„æ¯”è¾ƒï¼Œè€Œä¹‹å‰æ˜¯ç»„åˆé€»è¾‘æ‰€ä»¥éœ€è¦è®¾ç½®ç¼“å­˜ä¿å­˜ä¹‹å‰çš„æ¯”è¾ƒç»“æœæ¥åœ¨REFILLæ—¶è®¾ç½®æ¨¡å¼2çš„è¾“å…¥ä½¿èƒ½

   è€Œä¸”ä¸ç®¡cacheå‘½ä¸å‘½ä¸­åœ¨dcacopä½¿èƒ½æ—¶éƒ½éœ€è¦è¿›å…¥MISSä¹‹åçš„é˜¶æ®µæ¥å¡«å†™Bankå’Œå†™å›
   ```verilog
     reg cache_hit_r; //ä¿å­˜å‘½ä¸­ä¿¡æ¯ï¼Œä¸ºäº†cacopæŒ‡ä»¤æ¨¡å¼2åé¢çš„é€‰æ‹©åˆ¤æ–­
     reg way0_hit_r;
     reg way1_hit_r;
     
             MAIN_IDLE: begin
             if ((valid | dcacop_en) & idle2lookup_able) begin
               cache_state          <= MAIN_LOOKUP;

               requestBuffer_uncache <= uncache & ~dcacop_en;
               requestBuffer_size <= size;

               requestBuffer_op     <= op;
               requestBuffer_index  <= index;
               requestBuffer_tag    <= tag;
               requestBuffer_offset <= offset;
               requestBuffer_wstrb  <= wstrb;
               requestBuffer_wdata  <= wdata;

               requestBuffer_dcacop_en  <=  dcacop_en;
               requestBuffer_dcacop_mode<=  dcacop_mode;
             end
           end

           MAIN_LOOKUP: begin
             if (valid & lookup2lookup_able) begin
               cache_state          <= MAIN_LOOKUP;
               
               requestBuffer_uncache <= uncache;
               requestBuffer_size <= size;

               requestBuffer_op     <= op;
               requestBuffer_index  <= index;
               requestBuffer_tag    <= tag;
               requestBuffer_offset <= offset;
               requestBuffer_wstrb  <= wstrb;
               requestBuffer_wdata  <= wdata;
             end else if (~cache_hit | requestBuffer_dcacop_en) begin //ä¸ç®¡å‘½ä¸å‘½ä¸­éƒ½è¦è¿›å…¥è¿™ä¸ªé˜¶æ®µ
               cache_state <= MAIN_MISS;

               cache_hit_r <= cache_hit; //å› ä¸ºç”¨çš„ä¸€æ ·çš„tagï¼Œæ‰€ä»¥ä¸éœ€è¦è®¾ç½®æ–°çš„é‚£ä¸ªcacopæ¯”è¾ƒï¼Œå¯„å­˜è¿™ä¸ªä¸ºäº†æ¨¡å¼2ç”¨
               way0_hit_r <= way0_hit;
               way1_hit_r <= way1_hit;

             end else begin
               cache_state <= MAIN_IDLE;
             end
           end
   ```
5. å¯¹å†™è¯·æ±‚çš„æ›´æ”¹

   è¿™é‡Œè®¾ç½®ä¸ç®¡è„ä¸è„æœ‰æ•ˆä¸å¦éƒ½å†™å›
   ```verilog
           MAIN_MISS: begin
             //å¦‚æœå½“å‰æ˜¯éç¼“å­˜è¯»ï¼Œé‚£ä¹ˆå°±ä¸å­˜åœ¨å†™AXIï¼Œä¹Ÿå°±ä¸éœ€è¦ç­‰å¾…wr_rdy
             if (requestBuffer_uncache & ~requestBuffer_op ? 1'b1 : wr_rdy) begin  //reqè¦åœ¨rdyä¹‹åæœ‰æ•ˆ
               cache_state <= MAIN_REPLACE; 

               missBuffer_replaceWay <= replace_way;
               wr_req <= replace_d & replace_v & ~requestBuffer_uncache  | 
                         requestBuffer_uncache & requestBuffer_op |
                         requestBuffer_dcacop_mode == 2'h2 & cache_hit_r & requestBuffer_dcacop_en & replace_d & replace_v|
                         requestBuffer_dcacop_mode == 2'h1 & requestBuffer_dcacop_en & replace_d & replace_v;//ä¸ç®¡è„ä¸è„éƒ½å†™å›ï¼Œæœ‰æ•ˆä¸å¦éƒ½å†™å›
             end
           end
   ```
6. dcacop\_enä½¿èƒ½æ—¶ä¸éœ€è¦è€ƒè™‘è¯»æ€»çº¿ï¼Œæ‰€ä»¥REPLACEå¯ä»¥ç›´æ¥åˆ°REFILLï¼ŒREFILLåˆ°IDLEåŒç†
   ```verilog
           MAIN_REPLACE: begin
             if (rd_rdy | requestBuffer_op & requestBuffer_uncache | requestBuffer_dcacop_en) begin
               cache_state <= MAIN_REFILL;

               //å¼€å§‹è®°å½•è¯»äº†å‡ ä¸ª å½“æ˜¯100æ—¶å·²è¯»å®Œ
               missBuffer_retNum <= 2'b0;
             end
             if (wr_req) begin
               wr_req <= 1'b0;
             end
           end
          
           MAIN_REFILL: begin
             if (ret_valid & ret_last | ~rd_req_buffer | requestBuffer_op & requestBuffer_uncache | requestBuffer_dcacop_en) begin 
               cache_state <= MAIN_IDLE;
             end else if (ret_valid) begin
               missBuffer_retNum <= missBuffer_retNum + 2'b01;
             end
           end
   ```
7. ä¸ICacheåœ¨idleæ¥æ”¶å¹¶å¼€å§‹å¤„ç†cacopä¸åŒï¼ŒDCacheåˆ™æ˜¯åœ¨REPLACEæ—¶å¼€å§‹å¤„ç†ï¼ˆREPLACEå†™å›ã€REFILLæ›´æ”¹{tag,v}ï¼‰

   å› æ­¤dcacop\_okçš„äº§ç”Ÿè§„åˆ™å¦‚ä¸‹ï¼š
   ```verilog
     assign dcacop_ok = cache_state == MAIN_REPLACE & requestBuffer_dcacop_en;

   ```
8. å¯¹äºå†™å›è·¯æ•°æ®çš„é€‰æ‹©
   ```verilog
     assign replace_way = requestBuffer_dcacop_mode == 2'h1 & requestBuffer_dcacop_en ? requestBuffer_offset[0] :
                          requestBuffer_dcacop_mode == 2'h2 & requestBuffer_dcacop_en & cache_hit_r ? way1_hit_r :
                         (~way1_v | chosen_way) & way0_v;  //ç”»çœŸå€¼è¡¨ å¤ç”¨cacopå†™å›
   ```
9. å½“dcacop\_enæœ‰æ•ˆæ—¶ï¼Œä¸å‘é€è¯»è¯·æ±‚
   ```verilog
     assign rd_req = cache_state == MAIN_REPLACE & ~(requestBuffer_uncache & requestBuffer_op) & ~requestBuffer_dcacop_en;//åœ¨REPLACEä¸”ä¸æ˜¯éç¼“å­˜å†™

   ```
10. å†™{Tag,V}ä¿¡å·çš„æ›´æ”¹

    åœ°å€ï¼šè¿™é‡Œè®¿é—®çš„åœ°å€ä¸éœ€è¦æ”¹å˜ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨requestBuffer\_indexï¼Œå› ä¸ºå±äºå¤ç”¨è¯·æ±‚

    ç‰‡ä½¿èƒ½ä¿¡å·ä¹Ÿä¸éœ€è¦æ”¹å˜

    ä¸»è¦æ›´æ”¹çš„æ˜¯weaå’Œdina

    weaéœ€è¦æ–°å¢åœ¨è¿™3ç§æ¨¡å¼ä¸‹çš„å†™ä½¿èƒ½

    dinaåˆ™éœ€è¦æ–°å¢åœ¨æ¨¡å¼0ä¸‹çš„æ¸…tagï¼Œåœ¨æ¨¡å¼1æ¨¡å¼2ä¸‹çš„æ¸…v
    ```verilog
      //å†™TAG,V å†™å‘½ä¸­æ—¶ä¸éœ€è¦æ›´æ”¹TAGå’ŒV
      assign way0_tagv_addra = addr_ok ? index : requestBuffer_index;//è¯»çš„æ—¶å€™è¦åœ¨è¿›å…¥LOOKUPä¹‹å‰å°±å¾—åˆ°ä¿¡æ¯
      assign way1_tagv_addra = addr_ok ? index : requestBuffer_index;
      //å¦‚æœaddr_okå†å†™ï¼Œè¿™ä¸ªæ—¶å€™addrå·²ç»å˜äº†
      assign way0_tagv_ena = cache_state == MAIN_IDLE | ~requestBuffer_uncache;
      assign way1_tagv_ena = cache_state == MAIN_IDLE | ~requestBuffer_uncache;
      assign way0_tagv_wea = cache_state == MAIN_REFILL & (ret_valid & ret_last == 1'b1) & ~missBuffer_replaceWay & ~requestBuffer_uncache |
                             cache_state == MAIN_REFILL & requestBuffer_dcacop_en & (requestBuffer_dcacop_mode == 2'h0 | requestBuffer_dcacop_mode == 2'h1 & ~requestBuffer_offset[0] | requestBuffer_dcacop_mode == 2'h2 & way0_hit_r) ;
      assign way1_tagv_wea = cache_state == MAIN_REFILL & (ret_valid & ret_last == 1'b1) & missBuffer_replaceWay & ~requestBuffer_uncache |
                             cache_state == MAIN_REFILL & requestBuffer_dcacop_en & (requestBuffer_dcacop_mode == 2'h0 | requestBuffer_dcacop_mode == 2'h1 & requestBuffer_offset[0] | requestBuffer_dcacop_mode == 2'h2 & way1_hit_r) ;
      assign way0_tagv_dina = requestBuffer_dcacop_mode == 2'h0 & cache_state == MAIN_REPLACE & requestBuffer_dcacop_en ? {20'b0,way0_v} :
                              requestBuffer_dcacop_mode == 2'h1 & cache_state == MAIN_REPLACE & requestBuffer_dcacop_en | requestBuffer_dcacop_mode == 2'h2 & cache_hit_r & requestBuffer_dcacop_en & cache_state == MAIN_REPLACE ? {way0_tag,1'b0} :
                              {requestBuffer_tag, 1'b1};;
      assign way1_tagv_dina = requestBuffer_dcacop_mode == 2'h0 & cache_state == MAIN_REPLACE & requestBuffer_dcacop_en ? {20'b0,way1_v} :
                              requestBuffer_dcacop_mode == 2'h1 & cache_state == MAIN_REPLACE & requestBuffer_dcacop_en | requestBuffer_dcacop_mode == 2'h2 & cache_hit_r & requestBuffer_dcacop_en & cache_state == MAIN_REPLACE ? {way1_tag,1'b0} :
                              {requestBuffer_tag, 1'b1};
    ```

#### 3.3.3 CPUå®ç°cacopæŒ‡ä»¤

1. è¯‘ç æ“ä½œ
2. è®¾ç½®åœ¨æ‰§è¡Œé˜¶æ®µæ—¶æ“ä½œâ€”â€”è¿™æ ·å¯¹äºDCacheå¯ä»¥å¤ç”¨EXEçº§å‘å‡ºçš„è¯·æ±‚
3. å¯¹äºæ“ä½œICacheçš„cacopæŒ‡ä»¤éœ€è¦åœ¨MEMçº§è®¾ç½®é‡å–

## 4 ä»¿çœŸé‡åˆ°çš„é—®é¢˜

1. exeæœ‰æ•ˆæ—¶æ‰å‘å‡ºcacop\_en
2. tlb srchçš„ä¿¡æ¯åœ¨exeå‘å‡ºæ—¶å°±èƒ½æ‹¿åˆ°ï¼Œå› æ­¤éœ€è¦åœ¨exeæ”¶åˆ°æ•°æ®ï¼Œç„¶åä¼ åˆ°MEM

[^æ³¨é‡Š1]: ä¸€èˆ¬LA32Rè¯»å‡ºæ¥çš„éƒ½æ˜¯32ä½ï¼Œå†æ ¹æ®ldæŒ‡ä»¤å¤„ç†ï¼›å› æ­¤æ˜¯æ ¹æ®è™šåœ°å€çš„\[3:2]ä½ä½œç´¢å¼•è®¿é—®Cacheè¡Œ

[^æ³¨é‡Š2]: è¯»ä¸å‘½ä¸­ï¼Œå…ˆè¦è°ƒå—å…¥Cacheï¼Œç„¶åä»Cacheä¸­è¯»

[^æ³¨é‡Š3]: éœ€è¦indexã€è·¯å·ã€å­—åç§»ã€32ä½å†™ä½¿èƒ½
    ç”¨Write Bufferæ˜¯å‡ºäºæ—¶åºçš„è€ƒè™‘ï¼Œé¿å…å¼•å…¥RAMè¾“å‡ºåˆ°RAMè¾“å…¥çš„è·¯å¾„

[^æ³¨é‡Š4]: è¿™é‡ŒDataçš„éƒ¨åˆ†å­—æ˜¯ç»“åˆoffsetå®šä¹‰çš„ï¼Œè™½ç„¶å†™æ“ä½œä¸éœ€è¦è¯»Dataï¼Œä½†æ˜¯ä¸ºäº†æ›´å¥½çš„åˆ†ç±»ï¼Œå°†å…¶è¯»Dataä¹Ÿæ— å½±å“

[^æ³¨é‡Š5]: ä¹Ÿå¯ä»¥é‡‡ç”¨å…¶ä»–æ˜ å°„æ–¹å¼ã€‚æ¯”å¦‚ï¼Œä¸¤ä¸ª D è¡¨å¯ä»¥åˆå¹¶æ˜ å°„åˆ°ä¸€ä¸ªè§„æ ¼ä¸º 256Ã—2 çš„ Regfileï¼ŒWay0 å’Œ Way1 ç›¸åŒ åºå·çš„ Bank è¡¨ä¹Ÿå¯ä»¥åˆå¹¶æ˜ å°„åˆ°ä¸€ä¸ªè§„æ ¼ä¸º 256Ã—64 çš„ RAMâ€”â€”è¿™æ ·é«˜ä½æ˜¯Way1ï¼Œä½ä½æ˜¯Way0

[^æ³¨é‡Š6]: æœ¬æ¥æ˜¯CPUå‘å‡ºç±»SRAMç±»ä¼¼çš„ä¿¡å·ï¼Œç„¶åå†å‘å‡ºåˆ°AXIè½¬æ¥æ¡¥ï¼Œç»™AXIæ€»çº¿ã€‚è¿™é‡Œä¸­é—´åŠ ä¸€ä¸ªCacheâ€”â€”**CPUå‘å‡ºç±»SRAMæ€»çº¿ä¿¡å·ï¼Œç„¶åè¿™äº›æ€»çº¿ä¿¡å·ä¼ è¾“ç»™Cache(å’ŒCacheç«¯å£ç›¸åŒ¹é…)ï¼Œç„¶åCacheå†è¾“å‡ºå’ŒAXIæ€»çº¿äº¤äº’çš„æ¥å£**

[^æ³¨é‡Š7]: ä½†æ˜¯æ²¡æœ‰äº†sizeï¼Ÿâ€”â€”ç”¨typeç»™äº†axi

[^æ³¨é‡Š8]: å› æ­¤éœ€è¦ä»è®¾å¤‡å…ˆç»™å‡ºw\_rdyä¿¡å·ï¼Œç¡®ä¿ç¼“å­˜ä¸ºç©ºï¼Œä¸»æ–¹æ‰èƒ½è¯·æ±‚â€”â€”w\_reqæœ‰æ•ˆè¦åœ¨w\_rdyä¹‹å

[^æ³¨é‡Š9]: 3'b010ä¹Ÿä¸å¤ªå¤§ï¼Œéƒ½å·²ç»32ä½ï¼Œwr\_wstrbå…¨1

[^æ³¨é‡Š10]: å…¶å®æ˜¯å³å°†è¿›å…¥LOOKUP

[^æ³¨é‡Š11]: å³å°†è¿›å…¥LOOKUP

[^æ³¨é‡Š12]: idleæ—¶æŸ¥è¯¢è¯·æ±‚ï¼Œlookupåˆ¤æ–­å‘½ä¸­

[^æ³¨é‡Š13]: wr\_rdyä¿¡å·æœ‰æ•ˆè¡¨ç¤ºAXIæ€»çº¿å†…éƒ¨çš„16å­—èŠ‚çš„å†™ç¼“å†²ä¸ºç©ºï¼›å› ä¸ºæ›¿æ¢å¦‚æœD=1éœ€è¦å†è¯·æ±‚AXIå†™å›ä¸»å­˜

[^æ³¨é‡Š14]: Bankçº§çš„å†²çª

[^æ³¨é‡Š15]: â€œåœ°å€é‡å â€ æ˜¯æŒ‡ Load è¯·æ±‚åœ°å€çš„ \[3:2] ä¸ Store è¯·æ±‚åœ°å€çš„ \[3:2] ç›¸ç­‰

[^æ³¨é‡Š16]: æ¯”å¦‚uncacheè¯»ã€uncacheå†™

[^æ³¨é‡Š17]: å› ä¸ºrd\_reqæ˜¯åœ¨REPLACEæ—¶å‘å‡ºè¯·æ±‚ï¼Œæ‰€ä»¥éœ€è¦ç¼“å­˜å…¶ä¿¡å·

[^æ³¨é‡Š18]: ä¸ºäº†ä½¿Replaceå¤ç”¨ï¼Œè¿™é‡ŒLOOKUPè¦è¯»å¯¹åº”indexçš„æ‰€æœ‰è·¯çš„Bank

[^æ³¨é‡Š19]: å¯¹äºICacheï¼Œå› ä¸ºå¯¹å®ƒçš„å¤„ç†åœ¨LOOKUPå³å®Œæˆï¼Œæ‰€ä»¥ä¸ç®¡æ˜¯å‘½ä¸å‘½ä¸­éƒ½æ— å½±å“ã€‚
    è€Œå¯¹äºDCacheï¼Œéœ€è¦ç»“åˆå‘½ä¸­ä¿¡æ¯æ¥è¿›ä¸€æ­¥å¤„ç†ï¼Œæ‰€ä»¥éœ€è¦ç½®uncacheä¸º0
