# C8 AXIæ€»çº¿æ¥å£è®¾è®¡

## ç›®å½•

- [1 ç±»SRAMæ€»çº¿](#1-ç±»SRAMæ€»çº¿)
  - [1.1 ä¸»æ–¹å’Œä»æ–¹](#11-ä¸»æ–¹å’Œä»æ–¹)
  - [1.2 ç±»SRAMæ€»çº¿æ¥å£ä¿¡å·çš„å®šä¹‰](#12-ç±»SRAMæ€»çº¿æ¥å£ä¿¡å·çš„å®šä¹‰)
  - [1.3 ç±»SRAMæ€»çº¿çš„è¯»å†™æ—¶åº](#13-ç±»SRAMæ€»çº¿çš„è¯»å†™æ—¶åº)
- [2 ç±»SRAMæ€»çº¿çš„è®¾è®¡](#2-ç±»SRAMæ€»çº¿çš„è®¾è®¡)
  - [2.1 å–æŒ‡è®¾è®¡çš„è€ƒè™‘](#21-å–æŒ‡è®¾è®¡çš„è€ƒè™‘)
    - [2.1.1 è€ƒè™‘ready\_go](#211-è€ƒè™‘ready_go)
    - [2.1.2 è€ƒè™‘allowin](#212-è€ƒè™‘allowin)
    - [2.1.3 è€ƒè™‘å¼‚å¸¸æ¸…ç©ºæµæ°´çº¿](#213-è€ƒè™‘å¼‚å¸¸æ¸…ç©ºæµæ°´çº¿)
    - [2.1.4 è€ƒè™‘è½¬ç§»è®¡ç®—æœªå®Œæˆçš„æƒ…å†µ](#214-è€ƒè™‘è½¬ç§»è®¡ç®—æœªå®Œæˆçš„æƒ…å†µ)
    - [2.1.5 è®¾è®¡ç»¼è¿°](#215-è®¾è®¡ç»¼è¿°)
    - [2.1.6 ä¼˜åŒ–â€”â€”è¿˜æ²¡åš](#216-ä¼˜åŒ–è¿˜æ²¡åš)
  - [2.2 è®¿å­˜è®¾è®¡çš„è€ƒè™‘](#22-è®¿å­˜è®¾è®¡çš„è€ƒè™‘)
    - [2.2.1 Loadè®¿å­˜è®¾è®¡](#221-Loadè®¿å­˜è®¾è®¡)
    - [2.2.2 Storeè®¿å­˜è®¾è®¡](#222-Storeè®¿å­˜è®¾è®¡)
    - [2.2.3 è®¾è®¡ç»¼è¿°](#223-è®¾è®¡ç»¼è¿°)
- [3 AXIæ€»çº¿åè®®](#3-AXIæ€»çº¿åè®®)
  - [3.1 AXIæ€»çº¿åè®®åˆæ­¥è§£è¯»](#31-AXIæ€»çº¿åè®®åˆæ­¥è§£è¯»)
    - [3.1.1 æ¡æ‰‹](#311-æ¡æ‰‹)
    - [3.1.2 æ€»çº¿ä¼ è¾“å’Œæ€»çº¿äº‹åŠ¡](#312-æ€»çº¿ä¼ è¾“å’Œæ€»çº¿äº‹åŠ¡)
    - [3.1.3 åœ°å€ã€å¤§å°å’Œæ•°æ®](#313-åœ°å€å¤§å°å’Œæ•°æ®)
    - [3.1.4 å¤šä¸ªé€šé“](#314-å¤šä¸ªé€šé“)
    - [3.1.5 å¤šé€šé“é—´åŒä¸€äº‹åŠ¡çš„æ¡æ‰‹ä¾èµ–å…³ç³»](#315-å¤šé€šé“é—´åŒä¸€äº‹åŠ¡çš„æ¡æ‰‹ä¾èµ–å…³ç³»)
    - [3.1.6 å¹¶å‘è®¿é—®](#316-å¹¶å‘è®¿é—®)
    - [3.1.7 ä¹±åºå“åº”](#317-ä¹±åºå“åº”)
    - [3.1.8 ID](#318-ID)
    - [3.1.9 å†™å“åº”é€šé“çš„ä½œç”¨](#319-å†™å“åº”é€šé“çš„ä½œç”¨)
    - [3.1.10 çªå‘ä¼ è¾“æ–¹å¼](#3110-çªå‘ä¼ è¾“æ–¹å¼)
  - [3.2 ç±»SRAMæ€»çº¿æ¥å£ä¿¡å·ä¸AXIæ€»çº¿æ¥å£ä¿¡å·çš„å¯¹åº”å…³ç³»](#32-ç±»SRAMæ€»çº¿æ¥å£ä¿¡å·ä¸AXIæ€»çº¿æ¥å£ä¿¡å·çš„å¯¹åº”å…³ç³»)
- [4 ç±»SRAM-AXIè½¬æ¥æ¡¥è®¾è®¡](#4-ç±»SRAM-AXIè½¬æ¥æ¡¥è®¾è®¡)
  - [4.1 è½¬æ¥æ¡¥é¡¶å±‚æ¥å£](#41-è½¬æ¥æ¡¥é¡¶å±‚æ¥å£)
  - [4.2 è½¬æ¥æ¡¥è®¾è®¡è¦æ±‚â€”â€”ä¿è¯åŠŸèƒ½æ­£ç¡®ä¸”åŒ¹é…éªŒè¯ç¯å¢ƒ](#42-è½¬æ¥æ¡¥è®¾è®¡è¦æ±‚ä¿è¯åŠŸèƒ½æ­£ç¡®ä¸”åŒ¹é…éªŒè¯ç¯å¢ƒ)
  - [4.3 è½¬æ¥æ¡¥è®¾è®¡å»ºè®®â€”â€”ç‰ºç‰²ä¸€äº›æ€§èƒ½å’Œé¢ç§¯æ¥æ¢å–æ§åˆ¶é€»è¾‘çš„ç®€æ´æ€§](#43-è½¬æ¥æ¡¥è®¾è®¡å»ºè®®ç‰ºç‰²ä¸€äº›æ€§èƒ½å’Œé¢ç§¯æ¥æ¢å–æ§åˆ¶é€»è¾‘çš„ç®€æ´æ€§)
  - [4.4 è®¾è®¡å®ç°](#44-è®¾è®¡å®ç°)
  - [4.5 ä¼˜åŒ–â€”â€”è¿˜æ²¡åš](#45-ä¼˜åŒ–è¿˜æ²¡åš)

æœ¬ç« å°†è¿›å…¥ä¸€ä¸ªæ–°çš„é˜¶æ®µâ€”â€”ä¸ºè®¾è®¡å‡ºçš„CPUæ·»åŠ AXIæ€»çº¿æ¥å£

æ€»çº¿æ¥å£å¯ä»¥è‡ªè¡Œå®šä¹‰ï¼Œä¹Ÿå¯ä»¥éµç…§å·¥ä¸šç•Œçš„æ ‡å‡†ã€‚ä½†æ˜¯æ˜¾ç„¶ï¼Œåè€…æ›´æœ‰åŠ©äºä¸å¤§é‡çš„ç¬¬ä¸‰æ–¹IPé›†æˆï¼Œå› æ­¤æ¥ä¸‹æ¥é€‰ç”¨`AMBA AXI`æ€»çº¿åè®®ä½œä¸ºCPUæ€»çº¿æ¥å£çš„åè®®è§„èŒƒ

æœ¬ç« çš„è®¾è®¡ä»»åŠ¡æœ‰ä¸¤ä¸ªéš¾ç‚¹ï¼šä¸€æ˜¯ CPU å†…éƒ¨è¦å¦‚ä½•è°ƒæ•´ä»¥é€‚åº”æ€»çº¿æ¥å£ä¸‹çš„è®¿å­˜è¡Œä¸ºï¼ŒäºŒæ˜¯å¦‚ä½•è®¾è®¡å‡ºä¸€ä¸ªéµå¾ª AXI æ€»çº¿åè®®çš„æ¥å£ã€‚ä¸ºäº†é™ä½éš¾åº¦ï¼Œå°†è¿™ç« çš„è®¾è®¡å·¥ä½œåˆ’åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š

1. å°†åŸæœ‰ CPU è®¿é—® SRAM çš„æ¥å£è°ƒæ•´ä¸ºç±» SRAM æ€»çº¿æ¥å£
2. è®¾è®¡å®ç°ä¸€ä¸ª â€œç±» SRAM-AXIâ€ çš„è½¬æ¥æ¡¥ï¼Œæ‹¼æ¥ä¸Šé˜¶æ®µä¸€å®Œæˆçš„ CPUï¼Œå®ŒæˆAXIå›ºå®šå»¶è¿ŸéªŒè¯
3. å®Œå–„è®¾è®¡çš„CPUï¼Œé€šè¿‡AXIéšæœºå»¶è¿ŸéªŒè¯

## 1 ç±»SRAMæ€»çº¿

> ä¸ºä»€ä¹ˆè¦å¼•å…¥ç±»SRAMæ€»çº¿
>
> 1. ä¸€éƒ¨åˆ†åˆå­¦è€…å®Œå…¨ä¸çŸ¥é“å¦‚ä½•ä»ç°æœ‰å–æŒ‡å’Œè®¿å­˜çš„ SRAM æ¥å£æ”¹å‡º AXI æ¥å£
> 2. ä¸€éƒ¨åˆ†åˆå­¦è€…è¿‡äºæ¿€è¿›åœ°ä½¿ç”¨ AXI åè®®çš„ç‰¹æ€§ï¼ŒæŠŠè®¾è®¡æ”¹å¾—å¤ªå¤æ‚ï¼Œå‡ºç°å¤§é‡é”™è¯¯ã€‚

### 1.1 ä¸»æ–¹å’Œä»æ–¹

è¯»å’Œå†™è¿™ä¸¤ç§äº¤äº’è¡Œä¸ºçš„å‘èµ·æ–¹ç§°ä¸ºâ€œä¸»æ–¹â€[^æ³¨é‡Š1]ï¼Œå“åº”æ–¹ç§°ä¸ºâ€œä»æ–¹â€[^æ³¨é‡Š2]

è¯»æ“ä½œï¼šä¸»æ–¹æå‡ºè¯»è¯·æ±‚ï¼Œä»æ–¹æ¥æ”¶è¯·æ±‚å¹¶è¿”å›æ•°æ®
å†™æ“ä½œï¼šä¸»æ–¹æå‡ºå†™è¯·æ±‚å¹¶å‘å‡ºæ•°æ®ï¼Œä»æ–¹æ¥æ”¶è¯·æ±‚å’Œæ•°æ®å¹¶å“åº”

### 1.2 ç±»SRAMæ€»çº¿æ¥å£ä¿¡å·çš„å®šä¹‰

ä¿¡å·çš„è¾“å…¥ã€è¾“å‡ºæ˜¯é’ˆå¯¹äºCPU(ä¸»è®¾å¤‡)æ¥è¯´çš„

ä¸‹è¡¨åˆ—å‡ºäº†ç±»SRAMæ€»çº¿æ¥å£ä¿¡å·çš„è¯´æ˜ï¼š

| ä¿¡å·       | ä½å®½ | æ–¹å‘     | åŠŸèƒ½                                     |
| -------- | -- | ------ | -------------------------------------- |
| clk      | 1  | input  | æ—¶é’Ÿä¿¡å·                                   |
| req      | 1  | output | äº¤äº’è¯·æ±‚ä¿¡å·ï¼Œé«˜ç”µå¹³è¡¨ç¤ºæœ‰è¯»å†™è¯·æ±‚                      |
| wr       | 1  | output | å†™è¯·æ±‚ä¿¡å·ï¼Œé«˜ç”µå¹³æ—¶è¡¨ç¤ºå†™è¯·æ±‚ï¼Œä½ç”µå¹³ä¸”reqä¸ºé«˜ç”µå¹³è¡¨ç¤ºè¯»è¯·æ±‚       |
| size     | 2  | è¾“å‡º     | è¯¥æ¬¡è¯·æ±‚ä¼ è¾“çš„å­—èŠ‚æ•°&#xA;0:1Bã€1:2Bã€2:4B          |
| addr     | 32 | è¾“å‡º     | è¯¥æ¬¡è¯·æ±‚çš„åœ°å€                                |
| wstrb    | 4  | è¾“å‡º     | è¯¥æ¬¡å†™è¯·æ±‚çš„å­—èŠ‚å†™ä½¿èƒ½                            |
| wdata    | 32 | è¾“å‡º     | è¯¥æ¬¡å†™è¯·æ±‚çš„å†™æ•°æ®                              |
| addr\_ok | 1  | è¾“å…¥     | è¯¥æ¬¡è¯·æ±‚çš„åœ°å€ä¼ è¾“OK&#xA;è¯»è¯·æ±‚ï¼šåœ°å€è¢«æ¥æ”¶ï¼›å†™è¯·æ±‚ï¼šåœ°å€å’Œæ•°æ®è¢«æ¥æ”¶ |
| data\_ok | 1  | è¾“å…¥     | è¯¥æ¬¡è¯·æ±‚çš„æ•°æ®ä¼ è¾“OK&#xA;è¯»ï¼šæ•°æ®è¿”å›ç»™ä¸»æ–¹&#xA;å†™ï¼šæ•°æ®å†™å…¥å®Œæˆ |
| rdata    | 32 | è¾“å…¥     | è¯¥æ¬¡è¯»è¯·æ±‚è¿”å›çš„æ•°æ®                             |

1. clkå¯¹åº”äºcpuçš„`clk`
2. reqå¯¹åº”äºåŸè®¿å­˜çš„`en`ä¿¡å·
3. wrå¯¹åº”äºåŸè®¿å­˜çš„`|wen`ä¿¡å·
4. sizeæ˜¯æ–°å¢çš„ä¿¡å·

   è®¿æŒ‡ä»¤å­˜å‚¨æ—¶sizeè®¾ç½®ä¸º2'b10

   è®¿æ•°æ®å­˜å‚¨æ—¶sizeéœ€è¦ç»“åˆè®¿å­˜æŒ‡ä»¤è®¾ç½®
5. addrå¯¹åº”äºåŸè®¿å­˜çš„`addr`ä¿¡å·
6. wstrbå¯¹åº”äºåŸè®¿å­˜çš„`wen`ä¿¡å·
7. wdataå¯¹åº”äºåŸè®¿å­˜çš„`wdata`ä¿¡å·
8. addr\_okæ˜¯æ–°å¢çš„ä¿¡å·

   addr\_okæ˜¯ç”¨äºå’Œreqä¿¡å·ä¸€èµ·å®Œæˆè¯»å†™è¯·æ±‚çš„æ¡æ‰‹â€”â€”åœ¨clkä¸Šå‡æ²¿çš„åŒæ—¶çœ‹åˆ°reqå’Œaddr\_okå‡ä¸ºé«˜æœ‰æ•ˆæ‰æ˜¯è¯·æ±‚æ¡æ‰‹æˆåŠŸ
9. data\_okæ˜¯æ–°å¢çš„ä¿¡å·

   data\_okå¯¹åº”è¯»äº‹åŠ¡æ—¶ï¼Œæ˜¯æ•°æ®è¿”å›çš„æœ‰æ•ˆä¿¡å·ï¼›å¯¹åº”å†™äº‹åŠ¡æ—¶ï¼Œæ˜¯å†™å…¥å®Œæˆçš„æœ‰æ•ˆä¿¡å·

   å’Œaddr\_okä¸åŒçš„æ˜¯ï¼Œåœ¨ç±»SRAMæ¥å£ä¸­ä¸»æ–¹å¯¹äºdata\_okæ˜¯æ€»å¯ä»¥æ¥æ”¶çš„ï¼Œæ‰€ä»¥ä¸è®¾ç½®data\_okçš„æ¡æ‰‹ä¿¡å·
10. rdataå¯¹åº”äºåŸè®¿å­˜çš„`rdata`ä¿¡å·

### 1.3 ç±»SRAMæ€»çº¿çš„è¯»å†™æ—¶åº

![](image/image_C-83ap41uh.png)

å·¦å›¾ä¸ºç±»SRAMæ€»çº¿ä¸Šçš„ä¸€æ¬¡è¯»äº‹åŠ¡æ—¶åºå…³ç³»

åœ¨clkä¸Šå‡æ²¿æ—¶ï¼Œè‹¥addr\_okå’Œreqå‡ä¸ºé«˜ç”µå¹³åˆ™è¯´æ˜åœ°å€æ¡æ‰‹æˆåŠŸâ€”â€”è¯»åœ°å€å·²æˆåŠŸä¼ é€’ç»™ä»æ–¹

åœ¨clkä¸Šå‡æ²¿æ—¶ï¼Œè‹¥data\_okä¸ºé«˜ç”µå¹³åˆ™è¯´æ˜æ•°æ®å·²æˆåŠŸä¼ è¾“ç»™ä¸»æ–¹ï¼Œæ­¤æ—¶çš„rdataå³ä¸ºç»™å®šä½ç½®è¯»å‡ºçš„æ•°æ®

![](image/image_05SoGBlJLX.png)

å·¦å›¾ä¸ºç±»SRAMæ€»çº¿ä¸Šçš„ä¸€æ¬¡å†™äº‹åŠ¡æ—¶åºå…³ç³»

åœ¨clkä¸Šå‡æ²¿æ—¶ï¼Œè‹¥addr\_okå’Œreqå‡ä¸ºé«˜ç”µå¹³åˆ™è¯´æ˜åœ°å€æ¡æ‰‹æˆåŠŸâ€”â€”è¯»åœ°å€å·²æˆåŠŸä¼ é€’ç»™ä»æ–¹

åœ¨clkä¸Šå‡æ²¿æ—¶ï¼Œè‹¥data\_okä¸ºé«˜ç”µå¹³åˆ™è¯´æ˜æ•°æ®å·²æˆåŠŸå†™å…¥è‡³ä»æ–¹

> ğŸ“Œ**è¿ç»­å†™è¯»æ—¶ï¼Œä»æ–¹è¿”å›çš„data\_okæ˜¯ä¸¥æ ¼æŒ‰ç…§è¯·æ±‚å‘å‡ºçš„é¡ºåºè¿”å›çš„**
>
> **ä¸ºäº†ç®€åŒ–è®¾è®¡ï¼Œéœ€è¦æ§åˆ¶è¿ç»­å†™è¯»çš„æ•°ç›®ï¼Œå¯ä»¥****åœ¨ä¸»æ–¹æ‹‰ä½reqä¿¡å·****æ¥æš‚åœå‘é€æ–°äº‹åŠ¡çš„è¯·æ±‚ï¼Œ****åœ¨ä»æ–¹æ‹‰ä½addr\_ok****ä¿¡å·æ¥æš‚åœæ¥æ”¶æ–°äº‹åŠ¡çš„è¯·æ±‚**

![](image/image_sc73QJARTj.png)

å·¦å›¾ä¸ºç±»SRAMæ€»çº¿ä¸Šçš„è¿ç»­å†™è¯»çš„æ—¶åºå…³ç³»ã€‚

åœ¨å·¦å›¾ä¸­ï¼Œå†™è¯·æ±‚æ¡æ‰‹æˆåŠŸååˆé©¬ä¸Šè¿›è¡Œè¯»è¯·æ±‚çš„æ¡æ‰‹ï¼Œå› æ­¤å“åº”çš„data\_okä¹Ÿæ˜¯å…ˆå“åº”å†™è¯·æ±‚ï¼Œå†å“åº”è¯»è¯·æ±‚

## 2 ç±»SRAMæ€»çº¿çš„è®¾è®¡

æ ¹æ®ç±»SRAMæ€»çº¿æ¥å£ä¿¡å·çš„å®šä¹‰ä¸­å¯¹ç±»SRAMæ€»çº¿æ¥å£ä¿¡å·çš„åˆ†æï¼Œå¯ä»¥å¾—åˆ°å°†æ ‡å‡† SRAM æ¥å£æ”¹é€ ä¸ºç±» SRAM æ¥å£åªéœ€è¦å¢åŠ  3 ä¸ªä¿¡å·ï¼š`size`ã€`addr_ok` å’Œ`data_ok`

sizeä¿¡å·çš„ç”Ÿæˆéå¸¸ç®€å•ï¼Œç€é‡åˆ†æaddr\_okå’Œdata\_okæ€ä¹ˆåŠ å…¥åˆ°ç°æœ‰çš„cpu rtl codeä¸­

### 2.1 å–æŒ‡è®¾è®¡çš„è€ƒè™‘

ä¹‹å‰æ‰€è®¾è®¡çš„CPUæ˜¯åœ¨preIFçº§å‘é€insRAMçš„è¯·æ±‚ä¿¡å·ã€åœ¨IFçº§å¾—åˆ°è¯»æ•°æ®ï¼Œç»“åˆaddr\_okå’Œdata\_okçš„æ€§è´¨ï¼Œå¾ˆæ˜æ˜¾addr\_okåº”è¯¥ç”¨äºpreIFã€data\_okåº”è¯¥ç”¨äºIF

#### 2.1.1 è€ƒè™‘ready\_go

ready\_goä¿¡å·çš„ä½œç”¨å½“å‰é˜¶æ®µçš„ç»„åˆé€»è¾‘å·¥ä½œæ˜¯å¦å®Œæˆ

1. preIFæ’å…¥addr\_okçš„åº”ç”¨

   å½“preIFçº§æ¥æ”¶ä¸åˆ°addr\_okå’Œreqé«˜æœ‰æ•ˆçš„æ¡æ‰‹æ—¶ï¼ŒpreIF çš„å·¥ä½œæ²¡æœ‰å®Œæˆï¼Œéœ€è¦ç»§ç»­å‘é€è¯·æ±‚

   ç»“åˆäº’é”æµæ°´çº¿çš„validã€allowinã€readygoå¯çŸ¥åœ¨preIFçº§ä¹Ÿåº”è¯¥å­˜åœ¨ä¸€ä¸ªreadygoï¼Œè¯¥readygoåªæœ‰å½“reqå’Œaddr\_okå‡é«˜æœ‰æ•ˆæ—¶ä¸º1'b1

   readygoçš„è®¾ç½®å°±å¯ä»¥ç»“åˆto\_validï¼Œä»è€Œæ— æ³•å°†nextpcä¼ è‡³ IF é˜¶æ®µçš„ PC
   ```verilog
      preIF_readygo = req & addr_ok;
      preIF_to_IF_valid = resetn & preIF_readygo;
   ```
2. IFæ’å…¥data\_okçš„åº”ç”¨

   data\_okæ˜¯è¡¨ç¤ºæ•°æ®å·²è¯»å‡ºï¼Œå¯ä»¥æ¥æ”¶ã€‚å› æ­¤åªæœ‰å½“data\_okæœ‰æ•ˆæ—¶ï¼ŒIFçº§æ‰å¾—åˆ°äº†å¯¹åº”åœ°å€çš„æŒ‡ä»¤ï¼Œå†…éƒ¨çš„å·¥ä½œæ‰å¤„ç†å®Œæˆå¯ä»¥å‡†å¤‡å¥½å‘ID çº§æµåŠ¨ï¼Œæ‰€ä»¥if\_readygoåº”è¯¥è®¾ç½®ä¸ºdata\_ok
   ```verilog
      if_readygo = data_ok;
   ```

#### 2.1.2 è€ƒè™‘allowin

è¦è¾¾åˆ°æµæ°´çº¿äº’é”çš„ç›®çš„ï¼Œè¿˜éœ€è¦ä½¿ç”¨allowinä¿¡å·

1. preIFçº§å‘IFçº§æµåŠ¨

   è¿™ä¸€è¿‡ç¨‹æ˜¯ï¼špreIFçº§ç”ŸæˆnextPCï¼Œå¹¶æ ¹æ®è¯¥nextPCå‘èµ·å–æŒ‡è¯·æ±‚ï¼Œå½“æ”¶åˆ°addr\_okæ—¶ï¼ŒpreIF\_readygoæœ‰æ•ˆï¼›æ­¤æ—¶è‹¥IFçº§if\_allowinä¸º1ï¼Œåˆ™preIFçº§çš„nextPCå°±æµå‘IFçº§çš„PCï¼ŒpreIFçº§ç»´æŠ¤ä¸‹ä¸€æ¡æŒ‡ä»¤çš„å–æŒ‡è¯·æ±‚

   æ ¹æ®preIF\_readygoå’Œif\_allowinçš„ç»„åˆæƒ…å†µï¼Œæœ‰ä»¥ä¸‹å‡ ç§å¯èƒ½
   1. preIF\_readygoä¸º0ï¼Œif\_allowinä¸º0ï¼šè¯·æ±‚æœªæˆåŠŸï¼ŒpreIFç»§ç»­å‘é€å–æŒ‡è¯·æ±‚
   2. preIF\_readygoä¸º0ï¼Œif\_allowinä¸º1ï¼šè¯·æ±‚æœªæˆåŠŸï¼ŒpreIFç»§ç»­å‘é€å–æŒ‡è¯·æ±‚
   3. preIF\_readygoä¸º1ï¼Œif\_allowinä¸º1ï¼šnextPCâ†’PC
   4. preIF\_readygoä¸º1ï¼Œif\_allowinä¸º0ï¼šè¿™ç§æƒ…å†µéœ€è¦è¯¦ç»†è®¨è®º
      1. è¢«å µåœ¨preIFçº§çš„æŒ‡ä»¤ä¸‹ä¸€æ‹ä¸èƒ½å†ç»§ç»­è¯»åœ°å€è¯·æ±‚

         è¿™æ˜¯å› ä¸ºæ­¤æ—¶preIF\_readygoå·²ä¸º1ï¼Œè¡¨æ˜å‘é€åˆ°åœ°å€è¯·æ±‚å·²ç»è¢«ç±»SRAMæ¥æ”¶ã€‚å¦‚æœä¸‹ä¸€æ‹å†ç½®èµ·reqï¼Œé‚£ä¹ˆç±»SRAMä¼šå°†å®ƒè§†ä¸ºä¸€ä¸ªæ–°çš„è¯·æ±‚

         CPU å¤–éƒ¨æ¥æ”¶äº†å¤šå°‘ä¸ªè¯»è¯·æ±‚ï¼Œå°±ä¼šä¸€ä¸ªä¸æ¼åœ°è¿”å›åŒæ ·æ•°ç›®çš„æ•°æ®
      2. åœ°å€è¯·æ±‚å·²æˆåŠŸï¼Œæ•°æ®å¯èƒ½ä¼šéšæ—¶è¿”å›

         å¦‚æœåœ¨if\_allowinä¸º1å‰IFçº§å°±æ¥å—åˆ°è¯¥æŒ‡ä»¤ï¼Œé‚£ä¹ˆif\_readygoä¸º1ï¼Œä½†æ˜¯å› ä¸ºif\_allowinä¸º0ï¼Œæ­¤æ—¶nextPCè¿˜æ— æ³•è¿›å…¥IFçº§ã€‚è€Œç±»SRAMçš„rdataæ¥å£æ•°æ®åªèƒ½ä¿æŒä¸€æ‹ï¼Œæ‰€ä»¥å°±éœ€è¦é¢ä¸´ä¸€ä¸ªé€‰æ‹©ï¼šâ€œæ˜¯ä¿æŒè¯¥æŒ‡ä»¤åˆ°ç¼“å­˜[^æ³¨é‡Š3]è¿˜æ˜¯é‡æ–°è®©preIFå‘é€å–æŒ‡è¯·æ±‚â€
         ä¸€ç§ç®€å•ä½†ç›¸å¯¹ä½æ•ˆçš„è§£å†³æ–¹æ³•æ˜¯ï¼Œåªæœ‰å½“if\_allowinä¸º1æ—¶preIFæ‰èƒ½å‘é€åœ°å€è¯·æ±‚â€”â€”è¿™é‡Œé‡‡ç”¨è¿™ç§ä½æ•ˆçš„æ–¹æ³•ï¼Œä¸ºäº†å®ç°ç®€å•
   > ğŸ“Œç»¼ä¸Šæ‰€è¿°ï¼Œè¦ä¹ˆéœ€è¦å»ºç«‹æŒ‡ä»¤ç¼“å­˜ï¼Œä¸”preIF\_readygoçš„æœ‰æ•ˆä¸èƒ½ä»…ä»…åªçœ‹reqã€addr\_okè¿˜éœ€è¦è€ƒè™‘è¯·æ±‚å·²è¢«æ¥æ”¶åçš„æƒ…å†µï¼›è¦ä¹ˆç›´æ¥è®¾ç½®å½“if\_allowinä¸º1æ—¶preIFæ‰èƒ½å‘é€åœ°å€è¯·æ±‚
2. IFçº§å‘IDçº§æµåŠ¨

   è¿™ä¸€è¿‡ç¨‹æ˜¯ï¼šIFçº§ç­‰å¾…data\_okæ¥ç½®if\_readygoï¼Œå½“if\_readygoä¸º1ä¸”id\_allowinä¸º1æ—¶ï¼ŒIFçº§çš„æŒ‡ä»¤æµå‘IDçº§ï¼ŒIFçº§ç»´æŠ¤ä¸‹ä¸€æ¡æŒ‡ä»¤çš„å–æŒ‡æ•°æ®æˆ–è€…è¿›å…¥æ— æ•ˆçŠ¶æ€

   å’ŒpreIFâ†’IFç±»ä¼¼ï¼ŒIFâ†’IDçš„readygoå’Œallowinä¹Ÿå­˜åœ¨å››ç§æƒ…å†µï¼š
   1. if\_readygoä¸º0ï¼Œid\_allowinä¸º0ï¼šIFçº§ç»§ç»­ç­‰å¾…æŒ‡ä»¤è¿”å›
   2. if\_readygoä¸º0ï¼Œid\_allowinä¸º1ï¼šIFçº§ç»§ç»­ç­‰å¾…æŒ‡ä»¤è¿”å›
   3. if\_readygoä¸º1ï¼Œid\_allowinä¸º1ï¼šifâ†’id
   4. if\_readygoä¸º1ï¼Œid\_allowinä¸º0ï¼šæŒ‰ç…§ä¹‹å‰çš„å†™æ³•ï¼Œå–æŒ‡è¿”å›æ˜¯assignèµ‹å€¼ç»™if\_instï¼Œé‚£ä¹ˆåŒpreIFâ†’IFå­˜åœ¨çš„é—®é¢˜ä¸€æ ·ï¼ŒæŒ‡ä»¤åªèƒ½ä¿æŒä¸€æ‹ï¼Œé‚£ä¹ˆå°±éœ€è¦ä¸¢å¼ƒç„¶åpreIFé‡æ–°è¯·æ±‚æˆ–è€…æš‚å­˜æŒ‡ä»¤ï¼Œç»“åˆpreIFâ†’IFçš„å¤„ç†ï¼Œè¿™é‡Œé‡‡ç”¨æš‚å­˜æŒ‡ä»¤çš„æ–¹æ³•â€”â€”è®¾ç½®ä¸€ç»„è§¦å‘å™¨æ¥ä¿å­˜ IF çº§å–å›çš„æŒ‡ä»¤ï¼Œå½“è¯¥ç»„è§¦å‘å™¨å­˜æœ‰æœ‰æ•ˆæ•°æ®æ—¶ï¼Œ åˆ™é€‰æ‹©è¯¥ç»„è§¦å‘å™¨ä¿å­˜çš„æ•°æ®ä½œä¸º IF çº§å–å›çš„æŒ‡ä»¤é€å¾€ ID çº§ï¼Œåœ¨ ID çº§ allowin ä¸º 1 åï¼Œè¯¥æŒ‡ä»¤ç«‹å³è¿›å…¥ ID çº§
      åŒæ ·if\_readygoä¸èƒ½åªçœ‹data\_okè¿˜éœ€è¦çœ‹ä¸´æ—¶ç¼“å­˜ä¸­æ˜¯å¦æœ‰æœ‰æ•ˆæŒ‡ä»¤

#### 2.1.3 è€ƒè™‘å¼‚å¸¸æ¸…ç©ºæµæ°´çº¿

åœ¨å¼•å…¥ç±» SRAM æ€»çº¿æ¥å£åï¼Œå¼‚å¸¸æ¸…ç©ºæµæ°´çº¿çš„æƒ…å†µä¹Ÿéœ€è¦ç‰¹åˆ«è€ƒè™‘

1. preIFï¼šæ ¹æ®preIFæ˜¯å¦å®Œæˆäº†åœ°å€è¯·æ±‚åˆ†ä¸¤ç§æƒ…å†µè®¨è®º
   1. preIF\_to\_IF\_validä¸º0

      æŒ‰ç…§ä¹‹å‰æ‰€è¿°ï¼ŒpreIF\_to\_IF\_validçš„èµ‹å€¼ä¸èƒ½ä»…ä»…çœ‹resetnè¿˜éœ€è¦çœ‹preIF\_readygo

      ä¸è€ƒè™‘å¤ä½çš„æƒ…å†µï¼Œé‚£ä¹ˆæ­¤æ—¶`preIF_to_IF_valid=0â†’preIF_readygo=0`ã€‚å› æ­¤æ­¤æ—¶åœ°å€è¯·æ±‚å¹¶æœªè¢«ç±»SRAMæ¥æ”¶ã€‚è€Œç±» SRAM æ€»çº¿å…è®¸è¯·æ±‚ä¸­é€”æ›´æ”¹è¯·æ±‚[^æ³¨é‡Š4]ï¼Œå› æ­¤ç›´æ¥æ ¹æ® Cancel ä¿¡æ¯è°ƒ æ•´ pre-IF çº§å‘é€çš„åœ°å€è¯·æ±‚ä¸ä¼šæœ‰ä»»ä½•å½±å“
   2. preIF\_to\_IF\_validä¸º1

      è€ŒpreIF\_to\_IF\_validä¸º1æ—¶ï¼Œæ­¤æ—¶è¯»è¯·æ±‚åœ°å€å·²æˆåŠŸè¢«ç±»SRAMæ¥æ”¶ï¼Œæ­¤æ—¶è‹¥å­˜åœ¨å¼‚å¸¸æ¸…ç©ºæµæ°´çº¿è™½ç„¶preIFçš„nextPCå¯ä»¥é©¬ä¸Šä¿®æ”¹å‘å‡ºæ–°çš„å–æŒ‡è¯·æ±‚ï¼Œä½†æ˜¯IFçº§æ”¶åˆ°çš„ç¬¬ä¸€ä¸ªè¿”å›çš„æŒ‡ä»¤æ•°æ®æ˜¯å¯¹å½“å‰è¢«å–æ¶ˆçš„å–æŒ‡è¯·æ±‚çš„è¿”å›
2. IFï¼šæ ¹æ®if\_allowinåˆ†ä¸¤ç§æƒ…å†µè®¨è®º
   1. if\_allowinä¸º1

      å› ä¸º`if_allowin=~if_valid | if_ready_go & id_allowin`ï¼Œæ‰€ä»¥if\_allowin=1å¯ä»¥å¾—åˆ°è¦ä¹ˆifçº§æ²¡æœ‰æœ‰æ•ˆæŒ‡ä»¤if\_valid=0ï¼Œè¦ä¹ˆifé˜¶æ®µç»„åˆé€»è¾‘å·¥ä½œå·²ç»å®Œæˆæœ‰æŒ‡ä»¤ä¸”å³å°†è¦è¿›å…¥idçº§
   2. if\_allowinä¸º0

      å¦‚æœif\_allowinä¸º0ï¼Œé‚£ä¹ˆifçº§æŒ‡ä»¤æœ‰æ•ˆä¸”æ— æ³•è¿›å…¥IDçº§ï¼Œè¿™æ—¶åˆå¯ä»¥æ ¹æ®if\_readygoæ¥åˆ†ä¸ºä¸¤ç§æƒ…å†µ
      1. if\_readygoä¸º1

         è¡¨æ˜ifçº§å·²æ”¶åˆ°è¿‡data\_okï¼Œæ­¤æ—¶ifçº§ä¸å­˜åœ¨æœªå®Œæˆçš„ç±»SRAMæ€»çº¿äº‹åŠ¡ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡if\_valid=0æ¥å–æ¶ˆifçº§ä¸‹ä¸€æ‹çš„æŒ‡ä»¤

         æŒ‰ç…§ä¹‹å‰æ‰€é‡‡ç”¨çš„æ–¹æ³•ï¼Œifçº§å­˜åœ¨æŒ‡ä»¤ç¼“å­˜ï¼Œä¹Ÿéœ€è¦æ¸…é™¤æŒ‡ä»¤ç¼“å­˜æœ‰æ•ˆä¿¡å·â€”â€”preIF\_to\_IF\_validä¸º0ä¹Ÿæ˜¯ï¼Œè¦æ¸…é™¤ç¼“å­˜æœ‰æ•ˆä¿¡å·
      2. if\_readygoä¸º0

         ifçº§è¿˜åœ¨ç­‰å¾… data\_okï¼Œæ­¤æ—¶ if çº§æœ‰å¾…å®Œæˆçš„ç±» SRAM æ€»çº¿äº‹åŠ¡ï¼Œå¯ä»¥ç›´æ¥å°† IF-valid ç½®0ï¼Œä½†æ˜¯è¦æ³¨æ„ifçº§åç»­æ”¶åˆ°çš„ç¬¬ä¸€ä¸ªè¿”å›çš„æŒ‡ä»¤æ•°æ®æ˜¯å¯¹å½“å‰è¢« Cancel çš„å–æŒ‡è¯·æ±‚çš„è¿”å›

ä¸Šè¿°éƒ½å­˜åœ¨ä¸€ç§å…±åŒçš„æƒ…å†µï¼šå¼‚å¸¸å–æ¶ˆä»¥åï¼Œifçº§æ”¶åˆ°çš„ç¬¬ä¸€ä¸ªè¿”å›çš„æŒ‡ä»¤æ•°æ®æ˜¯è¢«å–æ¶ˆçš„å–æŒ‡è¯·æ±‚çš„è¿”å›ã€‚å¾ˆæ˜æ˜¾è¿™ä¸€ä¸ªæŒ‡ä»¤æ•°æ®åº”è¯¥è¢«ä¸¢å¼ƒï¼Œå¦åˆ™ä¼šå‡ºç°ifçº§æŒ‡ä»¤å’Œpcç ä¸å¯¹åº”çš„æƒ…å†µã€‚åœ¨æœ€å¤šåªå–æ¶ˆä¸€ä¸ªæŒ‡ä»¤æ•°æ®çš„å‰æä¸‹[^æ³¨é‡Š5]ï¼Œè§£å†³æ–¹æ³•æœ‰ä¸¤ä¸ªï¼š

1. åœ¨ifçº§çŠ¶æ€æœºï¼Œå¼•å…¥æ–°çš„çŠ¶æ€

   è¯¥çŠ¶æ€è¡¨æ˜ç­‰ä¸€ä¸ªdata\_okå¹¶ä¸¢å¼ƒå½“æ¬¡è¿”å›çš„æŒ‡ä»¤æ•°æ®
2. åœ¨ifçº§æ–°å¢ä¸€ä¸ªè§¦å‘å™¨â€”â€”ç”¨è¿™ç§æ–¹æ³•

   è¯¥è§¦å‘å™¨å¤ä½å€¼ä¸º0ï¼Œé‡åˆ°ä¸Šè¿°çš„ä¸¤ç§æƒ…å†µæ—¶ï¼Œè¯¥è§¦å‘å™¨ç½®ä¸º1ï¼›åœ¨æ”¶åˆ°data\_okæ—¶ï¼Œè¯¥è§¦å‘å™¨ç½®ä¸º0

   å½“è§¦å‘å™¨å€¼ä¸º1æ—¶ï¼Œä¼šå°†ifçº§readygoç½®ä¸º0ä»è€Œä¸¢å¼ƒç¬¬ä¸€ä¸ªè¿”å›çš„æŒ‡ä»¤æ•°æ®

#### 2.1.4 è€ƒè™‘è½¬ç§»è®¡ç®—æœªå®Œæˆçš„æƒ…å†µ

åœ¨RAWæ•°æ®ç›¸å…³ä¸­å­˜åœ¨ä¸€ç§ç‰¹æ®Šæƒ…å†µï¼š`Load-to-Branch`ï¼Œå³ç¬¬iæ¡æŒ‡ä»¤æ˜¯Loadï¼Œç¬¬i+1æ¡æŒ‡ä»¤æ˜¯è½¬ç§»æŒ‡ä»¤ï¼Œè½¬ç§»æŒ‡ä»¤è‡³å°‘æœ‰ä¸€ä¸ªæºå¯„å­˜å™¨ä¸LoadæŒ‡ä»¤çš„ç›®çš„å¯„å­˜å™¨ç›¸åŒ

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå½“è½¬ç§»æŒ‡ä»¤åœ¨IDçº§æ—¶ï¼ŒLoad æŒ‡ä»¤åœ¨æ‰§è¡Œçº§å°šæ— æ³•è·å¾— Load ç»“æœï¼Œå› è€Œè½¬ç§»æŒ‡ä»¤æ— æ³•è®¡ç®—æ­£ç¡®çš„è·³è½¬æ–¹å‘æˆ–è·³è½¬ç›®æ ‡ï¼Œç§°ä¸º â€œè½¬ç§»è®¡ç®—æœªå®Œæˆâ€

å‡ºç°è½¬ç§»è®¡ç®—æœªå®Œæˆçš„æƒ…å†µæ—¶ï¼ŒpreIFæ‰€è¿›è¡Œå–æŒ‡è¯·æ±‚çš„nextPCå°±æ˜¯ä¸æ­£ç¡®çš„[^æ³¨é‡Š6]ï¼Œè§£å†³æ–¹æ³•æœ‰ä¸¤ç§ï¼š

1. é˜»å¡å–æŒ‡â€”â€”ç”¨è¿™ç§æ–¹æ³•

   åœ¨IDçº§é€åˆ°IFçº§çš„ busä¸Šæ–°å¢ä¸€ä¸ªæ§åˆ¶ä¿¡å· `br_stall`ï¼Œå½“IDçº§ä¸Šå­˜åœ¨è½¬ç§»æŒ‡ä»¤ä¸”å¤„äºè®¡ç®—æœªå®ŒæˆçŠ¶æ€æ—¶ï¼Œå°† br\_stall ç½®ä¸º 1ï¼›pre-IF çº§çœ‹åˆ° br\_stall ä¸º 1 æ—¶å°†æš‚åœå‘å‡ºå–æŒ‡è¯·æ±‚ç›´è‡³ br\_stallé‡æ–°ä¸º 0
2. ä¸¢å¼ƒé”™è¯¯å–æŒ‡

#### 2.1.5 è®¾è®¡ç»¼è¿°

1. ä¸ºäº†æ’¤é”€â€œpreIF\_to\_IF\_readygo=1,if\_allowin=0çš„ç‰¹æ®Šæƒ…å†µâ€ï¼Œè®¾ç½®åªæœ‰åœ¨if\_allowinæ—¶æ‰èƒ½å‘é€å–æŒ‡è¯·æ±‚
   ```verilog
     assign inst_sram_req   = if_allowin & ~ADEF_EXCP & ~br_stall;  //å› ä¸ºpreIF_to_IF_validçš„æ›´æ”¹æ˜¯ç”±preIF_readygoè®¾ç½®çš„ï¼Œå› æ­¤ä¸èƒ½ä½œä¸ºreqç”Ÿæˆçš„ä¿¡å·

   ```
2. é’ˆå¯¹â€œif\_readygo=1,id\_allowin=0â€çš„æƒ…å†µï¼Œéœ€è¦æ·»åŠ æŒ‡ä»¤ç¼“å­˜ï¼Œä¿å­˜åœ¨ifçº§åªèƒ½ç»´æŒä¸€æ‹çš„æŒ‡ä»¤
   ```verilog
     //if->idçš„æŒ‡ä»¤ç¼“å­˜
     reg [31:0] inst_sram_rdata_r;
     reg inst_sram_rdata_r_valid;

     always @(posedge clk) begin
       if (~resetn | if_reflush) begin
         inst_sram_rdata_r_valid <= 1'b0;
       end else if (if_valid & if_ready_go & ~id_allowin) begin
         inst_sram_rdata_r <= inst_sram_rdata;
         inst_sram_rdata_r_valid <= 1'b1;
       end else if (id_allowin) begin
         inst_sram_rdata_r_valid <= 1'b0;
       end
     end
   ```
   ![](image/image__yD3vr71g1.png)

   ä½†æ˜¯ç¼“å­˜çš„è®¾è®¡ä¹Ÿéœ€è¦çœ‹data\_okæ—¶çš„æŒ‡ä»¤ï¼Œä¸ç„¶ä¼šå› ä¸ºç¼“å­˜æœ‰æ•ˆè€Œä¸€ç›´æ›´æ¢ç¼“å­˜æ•°æ®
   ```verilog
     //if->idçš„æŒ‡ä»¤ç¼“å­˜
     reg [31:0] inst_sram_rdata_r;
     reg inst_sram_rdata_r_valid;

     always @(posedge clk) begin
       if (~resetn | if_reflush) begin
         inst_sram_rdata_r_valid <= 1'b0;
       end else if (if_valid & inst_sram_data_ok & ~id_allowin) begin
         inst_sram_rdata_r <= inst_sram_rdata;
         inst_sram_rdata_r_valid <= 1'b1;
       end else if (id_allowin) begin
         inst_sram_rdata_r_valid <= 1'b0;
       end
     end
   ```
3. å¯¹äºè½¬ç§»é—®é¢˜
   1. å› ä¸ºæŒ‡ä»¤ç¼“å­˜è§£å†³äº†`"if_readygo=1,id_allowin=0"`çš„ç‰¹æ®Šæƒ…å†µï¼Œè€Œå¯¹äº`"if_readygo=0"`çš„æƒ…å†µï¼Œé˜»å¡ç­‰å¾…data\_okï¼Œå› æ­¤è¿™ç§æ·»åŠ äº†ç±»SRAMçš„æœºåˆ¶ä½¿å¾—æŒ‡ä»¤éƒ½å¯ä»¥æµç»åˆ°IDé˜¶æ®µâ€”â€”ä¸å†ä½¿ç”¨id\_to\_if\_busçš„br\_taken\_cancel[^æ³¨é‡Š7]ï¼Œæ‰€æœ‰è½¬ç§»æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„å–æ¶ˆéƒ½æ”¾åˆ°IDé˜¶æ®µè¿›è¡Œï¼Œä¹Ÿå› æ­¤IDé˜¶æ®µçš„è½¬ç§»æŒ‡ä»¤çš„è½¬ç§»ä¿¡æ¯éœ€è¦ç¼“å­˜ï¼Œå¦åˆ™ä¼šå‡ºç°ä¸‹å›¾çš„æƒ…å†µ

      ![](image/image_8ntzY2UKQT.png)

      ä¸Šå›¾ä¸­å…‰æ ‡æ‰€åœ¨ä½ç½®ï¼ŒnextPCæ˜¯é‡‡å–äº†br\_takençš„ï¼Œä½†æ˜¯ç”±äºpreIFé˜¶æ®µçš„addr\_okè¿˜æ²¡æ”¶åˆ°ï¼Œä¸èƒ½æ›´æ–°IFï¼ŒnextPCä¹Ÿå°±æ²¡æ³•è¿›å…¥åˆ°PCâ€”â€”ä½†æ˜¯è¯¥nextPCæ˜¯å¯ä»¥è¿›è¡Œå–æŒ‡è¯·æ±‚çš„ã€‚è€ŒIDé˜¶æ®µå› ä¸ºä¸‹ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸå·²ç»æ˜¯æ— æ•ˆçš„æŒ‡ä»¤äº†â€”â€”è½¬ç§»å–æ¶ˆä¸‹ä¸€ä¸ªIDæŒ‡ä»¤ï¼Œæ‰€ä»¥nextPCä¸å†æ˜¯è½¬ç§»çš„nextPCï¼Œå› æ­¤éœ€è¦ä¿æŒbrä¿¡æ¯åˆ°ç¼“å­˜ã€‚ç¼“å­˜çš„æ¡ä»¶æ˜¯ä¸‹ä¸€æ‹è¦é‡‡ç”¨è½¬ç§»`br_taken`ä¸”idé˜¶æ®µçš„æŒ‡ä»¤å‡†å¤‡å¥½æµè¿›ä¸‹ä¸€æ‹`id_ready_go`ä½†ä¸‹ä¸€æ‹ç”±ifè¿›å…¥idçš„æŒ‡ä»¤æ˜¯æ— æ•ˆçš„`if_to_id_valid`
      ```verilog
        //å¤„ç†è½¬ç§»æŒ‡ä»¤ä»¥åçš„ä¸‹ä¸€æ¡æŒ‡ä»¤å› ä¸ºdata_oké•¿æœŸæœªåˆ°å¯¼è‡´çš„br_taken_cancelçš„å¤±æ•ˆé—®é¢˜
        wire br_cancel;
        wire br_taken_cancel;
        reg  br_cancel_r;
        reg  br_cancel_r_valid;
        assign br_cancel = br_taken;
        assign br_taken_cancel = br_cancel_r_valid ? br_cancel_r : br_cancel;

        always @(posedge clk) begin
          if (~resetn | mem_to_id_flush_excp_ertn) begin
            br_cancel_r_valid <= 1'b0;
          end else if (br_taken & ~if_to_id_valid & id_ready_go) begin 
            br_cancel_r_valid <= 1'b1;
            br_cancel_r <= br_cancel;
          end else if (br_cancel_r_valid & if_to_id_valid) begin
            br_cancel_r_valid <= 1'b0;
          end
        end
        
        always @(posedge clk) begin
          if (~resetn | mem_to_id_flush_excp_ertn) begin
            id_valid <= 1'b0;
          end else if (br_taken_cancel) begin  //å¦‚æœé‡‡å–åˆ†æ”¯ï¼Œé‚£ä¹ˆå–æ¶ˆå½“å‰IFé˜¶æ®µçš„æŒ‡ä»¤
            id_valid <= 1'b0;
          end else if (id_allowin) begin
            id_valid <= if_to_id_valid;
          end
          if (id_allowin & if_to_id_valid) begin
            id_data <= if_to_id_bus;
          end
        end
      ```
   2. å¯¹äº`load-to-branch`çš„é˜»å¡é—®é¢˜ï¼Œéœ€è¦åœ¨IDé˜¶æ®µæ£€æµ‹â€œæ˜¯å¦branchæ‰€è¯»çš„å¯„å­˜å™¨æ˜¯exeé˜¶æ®µloadçš„ç›®çš„å¯„å­˜å™¨â€ï¼Œå¦‚æœæ˜¯åˆ™ç½®br\_stallæœ‰æ•ˆå¹¶ä¼ è¾“åˆ°IFé˜¶æ®µï¼Œç¦æ­¢preIFçš„å–æŒ‡è¯·æ±‚
      ```verilog
        assign br_stall = id_valid & load_delay & br_taken;


        //å°åŒ…idç»„åˆé€»è¾‘ä¼ é€’ç»™ifç»„åˆé€»è¾‘preIFçš„æ•°æ®
        assign id_to_if_bus = {br_stall, br_taken, br_target};
        
        assign inst_sram_req   = if_allowin & ~ADEF_EXCP & ~br_stall;  //å› ä¸ºpreIF_to_IF_validçš„æ›´æ”¹æ˜¯ç”±preIF_readygoè®¾ç½®çš„ï¼Œå› æ­¤ä¸èƒ½ä½œä¸ºreqç”Ÿæˆçš„ä¿¡å·

      ```
   3. å½“nextPCæ— æ³•è¢«æ›´æ–°æ—¶ï¼Œéœ€è¦ç¼“å­˜id\_to\_if\_bus
      1. è½¬ç§»æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€è¯·æ±‚è¿˜æ²¡è¢«å“åº”ï¼Œæ— æ³•è¿›å…¥IFçº§
      2. å› ä¸ºç±»SRAMæ€»çº¿çš„å­˜åœ¨ï¼Œå¯¼è‡´ifçº§çš„å†…å®¹å¹¶ä¸å§‹ç»ˆæœ‰æ•ˆã€‚è€Œè½¬ç§»å¯ä»¥ç«‹å³æ›´æ–°çš„æ¡ä»¶æ˜¯ifçº§æœ‰æ•ˆä¸”preIFå³å°†è¿›å…¥ifçº§
      3. å½“åœ°å€è¯·æ±‚å®Œæˆï¼Œç­‰å¾…æ•°æ®å“åº”æ—¶ï¼Œå¯ä»¥æ›´æ–°nextPCè¿›è¡Œä¸‹ä¸€ä¸ªå–æŒ‡è¯·æ±‚
         å› æ­¤å¯ä»¥æ›´æ–°çš„æ¡ä»¶æ˜¯â€”â€”æœ‰æ•ˆæŒ‡ä»¤è¿›å…¥idæ®µ|å½“å‰å–æŒ‡è¯·æ±‚æˆåŠŸå¾—åˆ°åœ°å€å“åº”è¿›å…¥ifæ®µï¼Œå…¶ä¸æ»¡è¶³çš„æ¡ä»¶æ˜¯\~preIF\_readygo | \~if\_allowin | \~if\_valid
      ```verilog
        reg [`ID_TO_IF_WD-1:0] id_to_if_bus_r;
        reg                    id_to_if_bus_r_valid;
        reg                    bd_done;
        always @(posedge clk) begin
          if (~resetn | if_reflush) begin
            id_to_if_bus_r_valid <= 1'b0;
          end else if (id_to_if_bus[32] & id_allowin & ~(preIF_ready_go & if_valid & if_allowin)) begin //è€Œè½¬ç§»çš„å–æ¶ˆå¿…é¡»éƒ½è¿›å…¥åˆ°idé˜¶æ®µï¼Œå› æ­¤è¿™é‡Œæ˜¯ä¹Ÿéœ€è¦if_validå’Œif_allowin
            id_to_if_bus_r <= id_to_if_bus;
            id_to_if_bus_r_valid <= 1'b1;
          end else if ((bd_done | if_valid) & preIF_ready_go & if_allowin) begin //å¯ä»¥æˆåŠŸæ›´æ–°nextPC
            id_to_if_bus_r_valid <= 1'b0;
          end
        end
      ```
   4. ä½¿ç”¨bd\_doneè§£å†³if\_validæ— æ•ˆæ—¶çš„nextPCæ›´æ–°é—®é¢˜
      > ğŸ“Œæ€»çš„æ¥è¯´ï¼ŒnextPCçš„æ›´æ–°æ˜¯è¦ä¹ˆè½¬ç§»æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤åˆ°è¾¾ifçº§ï¼Œè¦ä¹ˆè½¬ç§»æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤åˆ°è¾¾idçº§
      > å› æ­¤å½“if\_validæ— æ•ˆæ—¶ï¼Œå³è½¬ç§»æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤ç›®å‰è¿˜åœ¨å–æŒ‡è¯·æ±‚æˆ–è€…å³å°†è¿›å…¥ifçº§ï¼Œæ­¤æ—¶ä¹Ÿåº”è¯¥è¦æ›´æ–°PCã€‚ä½†æ˜¯if\_validæ— æ•ˆï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨å¦å¤–çš„ä¿¡å·æ¥è®°å½•è¿™ä¸€ç§å¯ä»¥æ›´æ–°çš„æƒ…å†µâ€”â€”bd\_done
      ```verilog
        always @(posedge clk) begin 
          if (~resetn | if_reflush) begin
            bd_done <= 1'b0;
          end else if (br_taken & ~bd_done & (if_valid ^ (preIF_ready_go & if_allowin))) begin
            bd_done <= 1'b1;
          end else if (bd_done & preIF_ready_go & if_allowin) begin
            bd_done <= 1'b0;
          end
        end
      ```
4. å¼‚å¸¸å¤„ç†

   è®°å½•å¼‚å¸¸çš„ç¬¬äºŒç§æƒ…å†µçš„æ¸…é™¤ifçº§æŒ‡ä»¤
   ```verilog
     //brä¿¡æ¯ä¹Ÿéœ€è¦ä¿æŒåˆ°ç¼“å­˜ï¼Œä»¥åœ¨preIF_ready_goæ— æ•ˆæ—¶ä¿æŒè¿›å…¥åˆ°IFï¼ŒåŒæ ·MEMåˆ°IDçš„æ›´æ–°nextpcçš„ä¿¡æ¯ä¹Ÿéœ€è¦ä¿æŒ
     reg [`MEM_TO_ID_WD-1:0] mem_to_if_bus_r;
     reg mem_to_if_bus_r_valid;
     always @(posedge clk) begin
       if (~resetn) begin
         mem_to_if_bus_r_valid <= 1'b0;
       end else if (~mem_to_if_bus_r_valid & (mem_to_if_bus[1] | mem_to_if_bus[0]) & ~preIF_ready_go) begin
         mem_to_if_bus_r <= mem_to_if_bus;  //è¿™ä¹Ÿåº”è¯¥åŠ ä¸€ä¸ªif_allowinå§ï¼Ÿä¸ç”¨ï¼Œå¼‚å¸¸é’ˆå¯¹if_readygoä¸ä¸º1æœ‰å¤„ç†
         mem_to_if_bus_r_valid <= 1'b1;
       end else if (mem_to_if_bus_r_valid & preIF_ready_go) begin
         mem_to_if_bus_r_valid <= 1'b0;
       end
     end
     
     wire if_reflush;
     assign if_reflush = mem_to_if_bus[1] | mem_to_if_bus[0];
     wire if_reflush_r;
     assign if_reflush_r = excp | ertn;
     
     assign if_allowin     = ~if_valid | if_ready_go & id_allowin | if_reflush_r;
     
     always @(posedge clk) begin
       if (~resetn) begin
         if_valid <= 1'b0;
         if_pc <= 32'h1bff_fffc;
       end else if (if_allowin) begin
         if_valid <= preIf_to_if_valid;
       end else if (if_ready_go & if_reflush) begin
         if_valid <= 1'b0;
       end
       if (if_allowin & preIf_to_if_valid) begin //åŸæ¥åœ¨if_valid & (~id_allowin | ~if_ready_go)æ—¶åˆ©ç”¨brcancelå–æ¶ˆæŒ‡ä»¤çš„æ–¹æ³•ï¼Œéƒ½ç”¨åˆ°idé˜¶æ®µå¤„ç†äº†ï¼Œå› ä¸ºç°åœ¨éƒ½èƒ½æµç»åˆ°idé˜¶æ®µ
         if_pc <= nextpc;
         if_ADEF_EXCP <= ADEF_EXCP;
       end
     end
     
     //å¼‚å¸¸æ¸…ç©ºæ—¶çš„ç‰¹æ®Šå¤„ç†
     reg excp_reg;
     always @(posedge clk) begin
       if (~resetn) begin
         excp_reg <= 1'b0;
       end else if (if_valid & if_reflush & ~if_ready_go) begin
         excp_reg <= 1'b1;
       end else if (inst_sram_data_ok) begin
         excp_reg <= 1'b0;
       end
     end

   ```
   > ğŸ“Œå½“æ­¤æ—¶if\_ready\_goæ— æ•ˆæ—¶ï¼Œå³è¡¨æ˜ifçº§æŒ‡ä»¤æ­£åœ¨ç­‰å¾…data\_okï¼Œå¦‚æœæ”¶åˆ°äº†data\_okæ—¶ä¹Ÿä¸è¦æŠŠä»–è¿›å…¥idçº§

#### 2.1.6 ä¼˜åŒ–â€”â€”è¿˜æ²¡åš

è®¾è®¡æ—¶preIFâ†’IFä¹Ÿå»ºç«‹ç¼“å­˜ï¼Œå–æŒ‡è¯·æ±‚ä¸å†çœ‹if\_allowin

### 2.2 è®¿å­˜è®¾è®¡çš„è€ƒè™‘

å°†è®¿å­˜åˆ†ä¸ºloadå’Œstoreä¸¤ç±»åˆ†åˆ«è¿›è¡Œåˆ†æ

#### 2.2.1 Loadè®¿å­˜è®¾è®¡

load æŒ‡ä»¤è®¾è®¡çš„é€»è¾‘æ”¹åŠ¨å¾ˆå¤§ç¨‹åº¦ä¸Šå¯ä»¥å€Ÿé‰´å‰ä¸€å°èŠ‚ä¸­ä»‹ç»çš„å–æŒ‡è®¾è®¡è°ƒæ•´ã€‚å…¶ä¸­å‘å‡º load è®¿å­˜è¯·æ±‚çš„ EX çº§å¯¹åº”å‘å‡ºå–æŒ‡è¯·æ±‚çš„ pre-IF çº§ï¼Œæ¥æ”¶æ•°æ®è¿”å›çš„ MEM çº§å¯¹åº”æ¥æ”¶å–æŒ‡è¿”å›çš„ IF çº§

æ ¸å¿ƒæ˜¯ä»¥ä¸‹å‡ ç‚¹ï¼š

1. æŒ‡ä»¤åœ¨å‘èµ·è®¿å­˜çš„é‚£ä¸€çº§ï¼Œéƒ½è¦å®Œæˆåœ°å€è¯·æ±‚çš„æ¡æ‰‹ï¼ˆaddr\_ok æ­£åœ¨æˆ–å·²ç»ä¸º 1ï¼‰æ‰èƒ½è¿›å…¥ä¸‹ä¸€çº§æµæ°´
2. æŒ‡ä»¤åœ¨æ¥æ”¶æ•°æ®çš„é‚£ä¸€çº§ï¼Œéƒ½è¦ç­‰å¾…æ•°æ®è¿”å›æ¡æ‰‹å®Œæˆï¼ˆdata\_ok æ­£åœ¨æˆ–å·²ç»ä¸º 1ï¼‰æ‰èƒ½è¿›å…¥ä¸‹ä¸€çº§æµæ°´
3. å¯¹äºæŸæŒ‡ä»¤è®¿å­˜è¯·æ±‚è¢«æ¥æ”¶åæ•°æ®å·²è¿”å›ï¼Œè€Œè¯¥æŒ‡ä»¤å´å› ä¸ºä¸‹ä¸€çº§åé¦ˆçš„ allowin æ— æ•ˆè€Œæ—  æ³•è¿›å…¥ä¸‹ä¸€çº§çš„æƒ…å†µï¼Œå»ºè®®åœ¨çœ‹åˆ°ä¸‹ä¸€çº§åé¦ˆçš„ allowin æœ‰æ•ˆæ—¶æ‰å‘å‡ºè®¿å­˜è¯·æ±‚ä»¥ç®€åŒ–è®¾è®¡
4. å¯¹äºå·²ç»è¢«æ¥æ”¶çš„è®¿å­˜è¯·æ±‚ï¼Œå¦‚æœå…¶å¯¹åº”çš„æŒ‡ä»¤å› ä¸ºå¼‚å¸¸æ¸…ç©ºæµæ°´çº¿è€Œè¢«å–æ¶ˆæ—¶ï¼Œä¸€å®šè¦è®° å½•ä¸‹è¿™äº›è®¿å­˜è¯·æ±‚ï¼Œè¿›è€Œåœ¨å®ƒä»¬çš„æ•°æ®è¿”å›æ—¶å°†å…¶ä¸¢å¼ƒ

   store æŒ‡ä»¤å·²ä¸ºå®ç°ç²¾ç¡®å¼‚å¸¸è€Œä¿è¯äº†å…¶å‘èµ·è®¿å­˜è¯·æ±‚æ—¶å°±ä¸€å®šä¸ä¼šå†è¢«å¼‚å¸¸å–æ¶ˆ[^æ³¨é‡Š8]ï¼Œå¦‚æœå°† load æŒ‡ä»¤å‘è®¿å­˜è¯·æ±‚çš„æ¡ä»¶ä¹Ÿè®¾ç½®çš„åŒ æ ·ä¸¥æ ¼ï¼Œé‚£ä¹ˆå°±ä¸ä¼šå‡ºç°è¿™ç§æƒ…å†µï¼Œä¹Ÿå°±æ— é¡»é¢å¤–å¤„ç†

æ­¤å¤–ï¼Œå¦‚æœMEMçº§å‚ä¸å‰é€’çš„æœ‰æ•ˆä¿¡å·æ˜¯mem\_validéœ€è¦ä¿®æ”¹è‡³ms\_to\_ws\_valid

#### 2.2.2 Storeè®¿å­˜è®¾è®¡

storeæŒ‡ä»¤åœ¨EXEçº§çš„æ”¹åŠ¨å’ŒloadæŒ‡ä»¤ä¸€è‡´ï¼Œå› ä¸ºç±»SRAMæ€»çº¿ä¸­å…³äºaddr\_okçš„å®šä¹‰æ˜¯â€œå½“æ“ä½œæ˜¯å†™æ“ä½œæ—¶ï¼Œaddr\_ok ä¸º 1 è¡¨ç¤ºå†™åœ°å€å’Œå†™æ•°æ®å‡è¢«æ¥æ”¶â€ï¼›storeæŒ‡ä»¤åœ¨MEMçº§ä¹Ÿéœ€è¦åœ¨data\_okæœ‰æ•ˆåæ‰èƒ½è¿›å…¥WBçº§ï¼Œè¿™æ˜¯å› ä¸ºç±»SRAMæ€»çº¿å¯¹äºè¯»å†™æ“ä½œå‡ä¼šäº§ç”Ÿdata\_ok[^æ³¨é‡Š9]ï¼Œå¦‚æœstoreä¸æ¥å—è¿™ä¸ªdata\_oké‚£ä¹ˆå¯èƒ½ä¼šè¢«loadå½“åšå®ƒçš„data\_ok

æ­¤å¤–åœ¨MEMé˜¶æ®µï¼Œå› ä¸ºå¦‚æœæ˜¯loadå¼•å‘çš„å‰é€’ï¼Œä¼šéœ€è¦ç­‰å¾…data\_okå› æ­¤éœ€è¦å†è®¾ç½®idçš„é˜»å¡â€”â€”å³å¦‚æœmemé˜¶æ®µå­˜åœ¨å†™å¯„å­˜å™¨ä¸”å†™å¯„å­˜å™¨çš„æ¥æºæ¥è‡ªäºmemä¸”data\_okå°šæœªæ»¡è¶³ï¼Œé‚£ä¹ˆé˜»å¡id

#### 2.2.3 è®¾è®¡ç»¼è¿°

1. EXEçº§çš„ready\_goéœ€è¦æ·»åŠ â€œå¦‚æœæœ‰å‘å‡ºè®¿å­˜è¯·æ±‚ï¼Œé‚£ä¹ˆexeéœ€è¦é˜»å¡ç›´åˆ°reqå’Œaddr\_okå‡æœ‰æ•ˆâ€ï¼Œé€šè¿‡ç”»çœŸå€¼è¡¨å¾—åˆ°è¡¨è¾¾å¼æ˜¯`~((exe_memW | res_from_mem) & ~(data_sram_req & data_sram_addr_ok))`
2. ä¸ºæ¶ˆé™¤â€œexe\_ready\_goæœ‰æ•ˆè€Œmem\_allowinæ— æ•ˆâ€çš„æƒ…å†µï¼Œè®¿å­˜è¯·æ±‚éœ€è¦åœ¨mem\_allowinæœ‰æ•ˆæ—¶å‘é€
3. æœ‰å¼‚å¸¸æ—¶ä¸å‘å‡ºè¯·æ±‚reqï¼Œå®ç°ç²¾ç¡®å¼‚å¸¸
4. memå‚ä¸å‰é€’çš„mem\_validéœ€è¦æ›´æ”¹ä¸ºmem\_to\_wb\_valid
5. mem\_ready\_goéœ€è¦æ ¹æ®â€œå½“å‰é˜¶æ®µæ˜¯å¦æ˜¯è®¿å­˜æŒ‡ä»¤â€æ¥è®¾ç½®ï¼Œå¦‚æœæ˜¯é‚£ä¹ˆéœ€è¦ç­‰å¾…data\_ok
   `~((mem_memW | res_from_mem) & ~data_sram_data_ok)` exeçº§éœ€è¦å¢åŠ exe\_memWä¿¡å·åˆ°memçº§çš„ä¼ é€’
6. å› ä¸ºdata\_okä¸æ˜¯æ€»æœ‰æ•ˆçš„ï¼Œæ‰€ä»¥å¦‚æœidé˜¶æ®µæ¶‰åŠåˆ°load-delayï¼Œä¸”loadæŒ‡ä»¤åœ¨memçº§é˜»å¡ï¼Œé‚£ä¹ˆä¹Ÿéœ€è¦é˜»å¡idçº§çš„æŒ‡ä»¤ç›´åˆ°memçº§çš„loadæŒ‡ä»¤æ”¶åˆ°data\_ok

   memçº§éœ€è¦ä¼ é€’mem\_ready\_goä¿¡å·åˆ°idçº§

   idçº§éœ€ç»“åˆmemçº§æ˜¯å¦å­˜åœ¨loadæŒ‡ä»¤ä»¥åŠæ˜¯å¦æœ‰memçº§çš„å‰é€’æ¥è®¾ç½®é˜»å¡
   ```verilog
     wire mem_data_ok_stall = ~mem_ready_go & mem_regW & mem_valid & id_valid & ((need_rj & regAddrA != 5'b0 & mem_regWAddr == regAddrA) |
                                     (need_rkd & regAddrB != 5'b0 & mem_regWAddr == regAddrB));
     assign id_ready_go = ~load_delay & ~csr_delay & ~mem_data_ok_stall;
   ```
   è¿™é‡Œé‡åˆ°äº†ä¸€äº›é—®é¢˜

   ![](image/image_UhaO53H6CI.png)

   æ­¤æ—¶mem\_validæ˜¯æ— æ•ˆçš„ï¼Œå› æ­¤ä¸èƒ½\&mem\_valid

   å¯èƒ½ä¼šæœ‰çŸ­å»¶æ—¶çš„idçº§å­˜åœ¨çš„é—®é¢˜ï¼Œå¯¼è‡´ldæŒ‡ä»¤å·²ç»å°†æ•°æ®å†™å›ï¼Œidè¿˜åœ¨åˆ¤æ–­é˜»å¡ï¼Œè¿™é‡Œå¯ä»¥åŠ ä¸Šwbpcå’Œmempcçš„æ¯”è¾ƒæ¥æ¶ˆé™¤é˜»å¡

## 3 AXIæ€»çº¿åè®®

AMBA AXIæ€»çº¿æ¥å£åŸºæœ¬ä»‹ç»

### 3.1 AXIæ€»çº¿åè®®åˆæ­¥è§£è¯»

#### 3.1.1 æ¡æ‰‹

ä¸ºäº†å®ç°å¤„ç†å™¨å’Œå†…å­˜ã€å¤–è®¾äº¤äº’çš„æ­¥è°ƒä¸€è‡´ï¼ŒAXIæ€»çº¿åè®®é‡‡ç”¨çš„æ˜¯æ¡æ‰‹æœºåˆ¶â€”â€”æ¯ä¸ªé€šé“çš„validå’Œreadyä¿¡å·ã€‚ä¸”å› ä¸º AXI åè®®æ˜¯é¢å‘ä¸€ä¸ªåŒæ­¥çš„æ•°å­—é€»è¾‘ç”µè·¯è®¾è®¡æ¥å®šä¹‰çš„ï¼Œæ‰€ä»¥validå’Œreadyä¿¡å·ä¸æ˜¯å¼‚æ­¥çš„äº’é”ï¼Œç»Ÿä¸€åœ¨æ—¶é’Ÿä¸Šå‡æ²¿çœ‹è¿™ä¸€å¯¹ä¿¡å·

> ğŸ“Œä¸ºäº†é¿å…æ­»é”ï¼ŒAXIè§„èŒƒä¸­æ˜ç¡®äº†æ¯ä¸ªé€šé“ä¸­validå’Œreadyçš„ä¾èµ–å…³ç³»ï¼š
>
> validçš„ç½®æœ‰æ•ˆä¸€å®šä¸èƒ½ä¾èµ–äºreadyæ˜¯å¦æœ‰æ•ˆï¼›ä½†readyçš„æœ‰æ•ˆå¯ä»¥ä¾èµ–äºvalidçš„æœ‰æ•ˆ
>
> åœ¨ä¹‹å‰çš„CPUè®¾è®¡ä¸­ï¼Œvalidç›¸å½“äºp1\_to\_p2\_validï¼Œè€Œreadyç›¸å½“äºp2\_allowin

#### 3.1.2 æ€»çº¿ä¼ è¾“å’Œæ€»çº¿äº‹åŠ¡

æ€»çº¿äº‹åŠ¡çš„æ¦‚å¿µæ˜¯ä¸ºäº†æ›´æ–¹ä¾¿çš„æè¿°æ€»çº¿çš„è¡Œä¸ºè€Œäº§ç”Ÿçš„[^æ³¨é‡Š10]ï¼Œä¸€æ¬¡æ€»çº¿äº‹åŠ¡å¯¹åº”ä¸€æ¬¡å®Œæ•´çš„è¯»/å†™è¿‡ç¨‹

ä¸€ä¸ªæ€»çº¿äº‹åŠ¡åŒ…å«å¤šä¸ªæ€»çº¿ä¼ è¾“ã€‚æ€»çº¿ä¼ è¾“åªé’ˆå¯¹ valid å’Œ ready åŒæ—¶æœ‰æ•ˆï¼ˆå³æ¡æ‰‹æˆåŠŸï¼‰çš„é‚£ä¸ªæ—¶é’Ÿå‘¨æœŸã€‚å¦‚ä¸‹å›¾ä¸­çš„ä¸€æ¬¡AXIè¯»äº‹åŠ¡ï¼ŒåŒ…æ‹¬è¯»è¯·æ±‚ä¸Šçš„ä¸€æ¬¡ä¼ è¾“ï¼ˆè“è‰²æ¡†ï¼‰å’Œè¯»å“åº”ä¸Šçš„å››æ¬¡ä¼ è¾“ï¼ˆçº¢è‰²æ¡†ï¼‰

![](image/image_PgmFM-gDZJ.png)

#### 3.1.3 åœ°å€ã€å¤§å°å’Œæ•°æ®

æ ¹æ®åœ°å€ï¼ˆARADDRã€AWADDRï¼‰æ¥åŒºåˆ†æ•°æ®ï¼ˆå†™æ•°æ®WDATAï¼Œè¯»æ•°æ®RDATAï¼‰ï¼Œåœ°å€èƒ½å¤Ÿå¯»å€çš„æœ€å°ç²’åº¦æ˜¯å­—èŠ‚ï¼ˆWSTRBï¼‰ï¼Œæ¯æ¬¡äº¤äº’æ•°æ®é‡çš„å¤§å°ï¼ˆARSIZEã€AWSIZEï¼‰ä»¥åŠäº¤äº’å¤šå°‘æ¬¡ï¼ˆARLENã€AWLENï¼‰å¯ä»¥ç”±ä¸»æ–¹å‘Šè¯‰ä»æ–¹

AXIæ€»çº¿åè®®æ˜¯å•å‘çš„ï¼Œä¸ç”¨è€ƒè™‘æ–¹å‘

#### 3.1.4 å¤šä¸ªé€šé“

AXIä¸ºäº†å®ç°éå¸¸é«˜çš„æ€»çº¿ä¼ è¾“æ€§èƒ½å®šä¹‰äº†5ä¸ªé€šé“ï¼šå†™åœ°å€è¯·æ±‚ã€å†™æ•°æ®ã€å†™å“åº”ã€è¯»åœ°å€è¯·æ±‚ã€è¯»å“åº”

å› ä¸ºè¯»å’Œå†™æ“ä½œéƒ½éœ€è¦äº¤äº’åœ°å€å’Œæ•°æ®ï¼Œåˆåœ¨ä¸€èµ·çš„é€šé“å°±å¿…é¡»åœ¨è¿›è¡Œè¯»æ“ä½œå’Œå†™æ“ä½œä¹‹é—´äºŒé€‰ä¸€ï¼›è€Œåˆ†å¼€çš„è¯»å†™é€šé“ï¼Œåˆ™å¯ä»¥å¹¶è¡Œè¿›è¡Œè¯»æ“ä½œå’Œå†™æ“ä½œâ€”â€”åœ¨èµ„æºå’Œæ€§èƒ½ä¹‹é—´å¹³è¡¡

å¯ä»¥ç”¨ç½‘è´­ä¸‹è®¢å•æ¥ç±»æ¯”è¯»é€šé“ï¼Œç”¨é€€è´§æ¥ç±»æ¯”å†™é€šé“

#### 3.1.5 å¤šé€šé“é—´åŒä¸€äº‹åŠ¡çš„æ¡æ‰‹ä¾èµ–å…³ç³»

![](image/image_-2IyRri_h9.png)

è¯»äº‹åŠ¡ï¼šåªæœ‰åœ¨ARVALIDå’ŒARREADYéƒ½æœ‰æ•ˆæ—¶ï¼Œä»æ–¹æ‰èƒ½å°†RVALIDç½®æœ‰æ•ˆ

å†™äº‹åŠ¡ï¼šåªæœ‰å†™è¯·æ±‚å’Œå†™æ•°æ®çš„æœ€åä¸€æ¬¡ä¼ è¾“éƒ½è¢«ä»æ–¹æ¥æ”¶ä»¥åï¼Œä»æ–¹æ‰ä¼šåé¦ˆå†™å“åº”æœ‰æ•ˆä¿¡å·

å†™è¯·æ±‚å’Œå†™æ•°æ®å¹¶æ²¡æœ‰ä»»ä½•ä¾èµ–å…³ç³»ï¼Œä½†æ˜¯å»ºè®®AWVALIDå’ŒWVALIDä¸€å¹¶ç½®æœ‰æ•ˆ

#### 3.1.6 å¹¶å‘è®¿é—®

å¯¹äºæŸä¸ªä¸»æ–¹æ¥è¯´ï¼Œå®ƒå¯ä»¥è¿ç»­å‘å‡ºå¤šä¸ªè¯·æ±‚ï¼Œå³ä½¿å…ˆå‰å‘å‡ºçš„è¯·æ±‚æ‰€éœ€è¦çš„æ•°æ®è¿˜æ²¡æœ‰ä¼ è¾“å®Œæ¯•ã€‚å¯¹äºæŸä¸ªä»æ–¹æ¥è¯´ï¼Œå®ƒå¯ä»¥åœ¨æ²¡æœ‰ä¼ è¾“å®Œä¹‹å‰è¯·æ±‚æ‰€éœ€è¦çš„æ•°æ®çš„æ—¶å€™ï¼Œå°±æ¥æ”¶æ¥è‡ªä¸€ä¸ªæˆ–å¤šä¸ªä¸»æ–¹å‘æ¥çš„æ–°è¯·æ±‚

#### 3.1.7 ä¹±åºå“åº”

é€šä¿—åœ°è¯´ï¼Œäº‹åŠ¡çš„ä¹±åºå“åº”å°±æ˜¯åå‘å‡ºçš„è¯·æ±‚å¯èƒ½å…ˆè¿”å›æ•°æ®ã€‚å…è®¸äº‹åŠ¡çš„ä¹±åºå“åº”æ˜¯ä¸ºäº†æå‡æ€»çº¿çš„ä¼ è¾“æ€§èƒ½ã€‚å½“ç³»ç»Ÿä¸­é›†æˆäº†å¤šä¸ªä¸»æ–¹ï¼Œæˆ–è€…ä¸»æ–¹æ”¯æŒä¹±åºæ‰§è¡Œæœºåˆ¶ï¼Œé‚£ä¹ˆæ€»çº¿ä¹±åºå“åº”ä¼šæ˜¾è‘—æå‡æ€§èƒ½

> ğŸ“Œé™¤éå‘å‡ºçš„ä¸€è¿ä¸²è¯»è¯·æ±‚éƒ½æ˜¯é‡‡ç”¨åŒä¸€ä¸ª IDï¼Œå¦åˆ™å°±è¦è€ƒè™‘åå‘çš„è¯·æ±‚çš„æ•°æ®å…ˆè¿”å›çš„æƒ…å†µ
>
> å¦‚æœå¸Œæœ›å…ˆå‘å‡ºçš„è¯·æ±‚ä¸€å®šå…ˆè¿”å›ï¼Œé‚£ä¹ˆå°±å¿…é¡»å°†è¿™äº›è¯·æ±‚çš„ ID ç½®ä¸ºç›¸åŒå€¼

#### 3.1.8 ID

æ ¹æ®äº‹åŠ¡çš„IDæ¥åŒºåˆ†å¹¶å‘è¿›è¡Œçš„ä¸åŒäº‹åŠ¡ï¼ŒåŒä¸€äº‹åŠ¡æ‰€ä½¿ç”¨çš„é€šé“çš„IDç›¸åŒâ€”â€”è¯»é€šé“ARID==RIDï¼Œå†™é€šé“AWID==WID==BID

> ğŸ“Œä¸åŒçš„äº‹åŠ¡çš„IDä¹‹é—´æ²¡æœ‰ç›¸å…³æ€§â†’ä¸åŒäº‹åŠ¡å¯ä»¥è®¾ç½®åŒä¸€ä¸ªIDâ†’è¿™æ ·çš„ä½œç”¨æ˜¯ä¿è¯å…ˆè¯·æ±‚çš„å…ˆå“åº”

#### 3.1.9 å†™å“åº”é€šé“çš„ä½œç”¨

ä¹‹æ‰€ä»¥è¦è®¾ç½®å†™å“åº”é€šé“ï¼Œæ˜¯ä¸ºäº†è§£å†³â€œRAWâ€ç›¸å…³

å› ä¸ºè¯»å†™é€šé“åˆ†ç¦»ä¸”AXIæ€»çº¿ä»ä¸»æ–¹åˆ°ä»æ–¹ä¹‹é—´å¯ä»¥æœ‰ä»»æ„å±‚ç¼“å­˜çš„åŸå› ï¼Œä¼šå­˜åœ¨è¿™æ ·çš„æƒ…å†µï¼šå‡è®¾ç³»ç»Ÿä¸­åªæœ‰ä¸€ä¸ªä¸»è®¾å¤‡æ˜¯ CPUï¼Œåœ°å€ A å¤„çš„åŸå€¼æ˜¯ 0ï¼Œç°åœ¨ CPU é€šè¿‡ AXI æ€»çº¿å‘ A åœ°å€å¤„å†™ 1ï¼Œåœ¨æœ€åä¸€ä¸ªæ•°æ®å†™å‡ºå»ï¼ˆwvalid && wlast && wready == 1ï¼‰ä¹‹åï¼ŒCPU å†é€š è¿‡ AXI æ€»çº¿è¯» A åœ°å€ã€‚æ­¤æ—¶å› ä¸ºä¸Šè¿°çš„ä¸¤ä¸ªåŸå› ï¼Œå†™åœ°å€ã€å†™æ•°æ®å¯èƒ½ä¼šå µå¡åœ¨å†™é€šé“çš„æŸå¤„ï¼Œè€Œè¯»é€šé“ä¸å½±å“ï¼Œä»è€Œä½¿å¾—è¯»åœ°å€å’Œè¯»å“åº”å…ˆåˆ°è¾¾ä»è®¾å¤‡ï¼Œæœ€ç»ˆå°†åŸå€¼0è¯»å“åº”ç»™ä¸»æ–¹

å› æ­¤éœ€è¦è®¾ç½®ä¸€ä¸ªä¿¡å·ï¼Œå¯¹äºè¯»å†™åŒä¸€åœ°å€ä¸”å†™å…ˆäºè¯»çš„è¯·æ±‚ï¼Œéœ€è¦åœ¨æ¥æ”¶åˆ°å†™å“åº”ä»¥åå†å‘å‡ºè¯»è¯·æ±‚

#### 3.1.10 çªå‘ä¼ è¾“æ–¹å¼

çªå‘ä¼ è¾“æ–¹å¼æ˜¯ä¸ºäº†å‡å°‘å¤šèŠ‚æ‹ä¼ è¾“æ•°æ®çš„æ¡æ‰‹æ—¶é—´ï¼Œå®ç°æ›´é«˜æ€§èƒ½çš„ä¼ è¾“[^æ³¨é‡Š11]â€”â€”åªæ¡æ‰‹ä¸€æ¬¡ï¼Œç»™å‡ºè®¿é—®æ•°æ®çš„é¦–åœ°å€ï¼Œå…¶ä½™æ•°æ®åœ°å€è‡ªåŠ¨é€’å¢æ¨ç®—

è€Œä¸ºäº†å®ç°åœ°å€çš„è‡ªåŠ¨é€’å¢æ¨ç®—ï¼Œéœ€è¦èµ·å§‹åœ°å€ã€åœ°å€å˜åŒ–è§„å¾‹å’Œå¢é‡ä¸‰ä¸ªå‚æ•°ï¼Œåˆ†åˆ«å¯¹åº”AXIçš„addrã€burstã€len

### 3.2 ç±»SRAMæ€»çº¿æ¥å£ä¿¡å·ä¸AXIæ€»çº¿æ¥å£ä¿¡å·çš„å¯¹åº”å…³ç³»

1. å½“req=1ä¸”wr=0æ—¶ï¼Œå¯¹åº”arvalidä¿¡å·
2. å½“req=1ä¸”wr=1æ—¶ï¼Œå¯¹åº”awvalidä¿¡å·
3. å½“å‰æ€»çº¿äº‹åŠ¡æ˜¯è¯»äº‹åŠ¡æ—¶ï¼Œaddr\_okå¯¹åº”areadyä¿¡å·
4. å½“å‰æ€»çº¿äº‹åŠ¡æ˜¯å†™äº‹åŠ¡æ—¶ï¼Œaddr\_okå¯¹åº”AXIæ€»çº¿ä¸Šçš„awreadyå’Œwreadyéƒ½å·²ç»æˆ–è€…æ­£åœ¨ä¸º1
5. å½“å‰æ€»çº¿äº‹åŠ¡æ˜¯è¯»äº‹åŠ¡æ—¶ï¼Œdata\_okå¯¹åº”rvalidä¿¡å·
6. å½“å‰æ€»çº¿äº‹åŠ¡æ˜¯å†™äº‹åŠ¡æ—¶ï¼Œdata\_okå¯¹åº”bvalidä¿¡å·
7. å½“å‰æ€»çº¿äº‹åŠ¡æ˜¯è¯»äº‹åŠ¡æ—¶ï¼Œaddrå¯¹åº”araddrã€sizeå¯¹åº”arsizeã€rdataå¯¹åº”rdata
8. å½“å‰æ€»çº¿äº‹åŠ¡æ˜¯å†™äº‹åŠ¡æ—¶ï¼Œaddrå¯¹åº”awaddrã€sizeå¯¹åº”awsizeã€wdataå¯¹åº”wdataã€wstrbå¯¹åº”wstrb

## 4 ç±»SRAM-AXIè½¬æ¥æ¡¥è®¾è®¡

### 4.1 è½¬æ¥æ¡¥é¡¶å±‚æ¥å£

è½¬æ¥æ¡¥å¯¹å†…æ˜¯åŒCPUå‘å‡ºçš„ç±»SRAMæ€»çº¿ä¿¡å·å¯¹æ¥ï¼ˆCPUå‘å‡ºæŒ‡ä»¤çš„ç±»SRAMè¯·æ±‚å’Œæ•°æ®çš„ç±»SRAMè¯·æ±‚ï¼‰ï¼Œå¯¹å¤–éœ€è¦å¯¹æ¥AXIæ€»çº¿ä¿¡å·ã€‚å› æ­¤è½¬æ¥æ¡¥éœ€è¦æœ‰ä¸¤ä¸ªç±»SRAMæ¥å£ï¼Œä¸€ä¸ªAXIæ¥å£

æ•´ä¸ªè½¬æ¥æ¡¥ä¸ CPU å…¶ä½™éƒ¨åˆ†ï¼Œä»¥åŠä¸ SoC ä¸­çš„å…¶ä»–éƒ¨åˆ†çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](image/image_IFKUAVHeXs.png)

æ³¨æ„è½¬æ¥æ¡¥çš„ç±»SRAMæ¥å£æ˜¯ä»æ–¹ï¼ŒAXIæ¥å£æ˜¯ä¸»æ–¹

### 4.2 è½¬æ¥æ¡¥è®¾è®¡è¦æ±‚â€”â€”ä¿è¯åŠŸèƒ½æ­£ç¡®ä¸”åŒ¹é…éªŒè¯ç¯å¢ƒ

1. ARESETNæœ‰æ•ˆæœŸé—´ï¼ŒAXIä¸»æ–¹ç«¯å£çš„VALIDä¿¡å·è¾“å‡ºå¿…é¡»æ˜¯0ï¼ŒREADYä¿¡å·ä¸èƒ½æ˜¯ä¸å®šæ€
2. AXIä¸»æ–¹ç«¯å£çš„æ‰€æœ‰validè¾“å‡ºä¿¡å·çš„ç½®1é€»è¾‘ä¸­ï¼Œä¸€å®šä¸èƒ½å…è®¸ç»„åˆé€»è¾‘æ¥è‡ªåŒä¸€é€šé“çš„readyè¾“å…¥ä¿¡å·ï¼Œä½†æ˜¯å¯ä»¥æ¥è‡ªäºæ—¶åºé€»è¾‘çš„readyè¾“å…¥â€”â€”validæœ‰æ•ˆä¸€å®šä¸èƒ½æ ¹æ®readyå¾—åˆ°
3. AXIä¸»æ–¹ç«¯å£çš„æ‰€æœ‰readyè¾“å‡ºä¿¡å·ï¼Œä¸€å®šä¸èƒ½å…è®¸ç»„åˆé€»è¾‘æ¥è‡ªåŒä¸€é€šé“çš„validè¾“å…¥ä¿¡å·ï¼Œä½†æ˜¯å¯ä»¥æ¥è‡ªäºæ—¶åºé€»è¾‘çš„validè¾“å…¥â€”â€”è®¾è®¡è¦æ±‚

> ğŸ“Œ2å’Œ3ä½¿å¾—ä¸»æ–¹è¾“å‡ºçš„validã€readyåˆ†åˆ«å’Œå½“å‰æ—¶åˆ»è¾“å…¥çš„readyã€validæ— å…³ï¼Œä½†å¯ä»¥å’Œä¸Šä¸€æ—¶åˆ»çš„æœ‰å…³

1. æ— è®ºè¯»ã€å†™è¯·æ±‚ï¼Œç±» SRAM æ¥å£ä¸Šçš„äº‹åŠ¡è¦å’Œ AXI æ¥å£ä¸Šçš„äº‹åŠ¡ä¸¥æ ¼ä¸€ä¸€å¯¹åº”
2. åœ¨AXIä¸»æ–¹çš„è¯»è¯·æ±‚ã€å†™è¯·æ±‚ã€å†™æ•°æ®é€šé“ä¸Šï¼Œå¦‚æœä¸»æ–¹è¾“å‡ºçš„validç½®ä¸º1æ—¶çš„ä»æ–¹readyè¾“å…¥æ˜¯0ï¼Œé‚£ä¹ˆåœ¨ready ä¿¡å·å˜ä¸º 1 ä¹‹å‰ï¼Œä¸å…è®¸ä¸»æ–¹å˜æ›´è¯¥é€šé“çš„æ‰€æœ‰è¾“å‡ºä¿¡å·â€”â€”ä¸ç±» SRAM æ€»çº¿ä¸åŒï¼Œç±» SRAM æ€»çº¿å…è®¸ä¸­é€”æ›´æ”¹è¯·æ±‚
3. AXIä¸»æ–¹åœ¨å‘èµ·è¯»è¯·æ±‚æ—¶ï¼Œè¦å…ˆç¡®ä¿â€œè¯¥è¯·æ±‚ä¸â€˜å·²å‘å‡ºè¯·æ±‚ä½†å°šæœªæ¥æ”¶åˆ°å†™å“åº”çš„å†™è¯·æ±‚â€™â€ä¸å­˜åœ¨ç›¸å…³

   å¦‚æœå­˜åœ¨ï¼Œé‚£ä¹ˆéœ€è¦é˜»å¡è¯»è¯·æ±‚çš„å‘å‡ºï¼Œä¸èƒ½ä½¿ç”¨å‰é€’

   ç®€å•çš„æ–¹æ³•æ˜¯ï¼šåªè¦æœ‰å†™è¯·æ±‚å°±åœæ­¢å‘é€è¯»è¯·æ±‚ï¼Œç›´è‡³ä¸»æ–¹æ”¶åˆ°å†™å“åº”

   é«˜æ•ˆçš„æ–¹æ³•æ˜¯ï¼šè®°å½•é‚£äº› â€œå·²å‘å‡ºè¯·æ±‚ä½†å°šæœªæ¥æ”¶åˆ°å†™å“ åº”çš„å†™è¯·æ±‚â€ çš„åœ°å€waddrã€ä½å®½wsizeã€å­—èŠ‚å†™ä½¿èƒ½wstrbç­‰ä¿¡æ¯ï¼Œåç»­è¯»è¯·æ±‚æŸ¥è¯¢å¹¶æ¯”è¾ƒè¿™äº›ä¿¡æ¯åå†å†³å®š æ˜¯å¦å‘å‡º

### 4.3 è½¬æ¥æ¡¥è®¾è®¡å»ºè®®â€”â€”ç‰ºç‰²ä¸€äº›æ€§èƒ½å’Œé¢ç§¯æ¥æ¢å–æ§åˆ¶é€»è¾‘çš„ç®€æ´æ€§

1. é™¤äº†å¯ä»¥ç½®ä¸ºå¸¸å€¼çš„ä¿¡å·å¤–ï¼Œæ‰€æœ‰ AXI ä¸»æ–¹çš„è¾“å‡ºç›´æ¥æ¥è‡ªè§¦å‘å™¨ Q ç«¯
2. ä¸ºè¯»æ•°æ®é¢„ç•™ç¼“å­˜ï¼Œä» rdata ç«¯å£ä¸Šæ”¶åˆ°çš„æ•°æ®å…ˆä¿å­˜åˆ°è¿™ä¸ªé¢„ç•™ç¼“å­˜ä¸­ã€‚AXI ä¸Šæœ€å¤šæ”¯æŒå‡ ä¸ª â€œå·²å®Œæˆè¯»è¯·æ±‚æ¡æ‰‹ä½†æ•°æ®å°šæœªè¿”å›çš„è¯»äº‹åŠ¡â€ï¼Œå°±é¢„ç•™åŒæ ·æ•°ç›®çš„ rdata ç¼“å­˜&#x20;
3. å–æŒ‡å¯¹åº”çš„ arid æ’ä¸º 0ï¼Œload å¯¹åº”çš„ arid æ’ä¸º 1
4. æ§åˆ¶ AXI è¯»å†™çš„çŠ¶æ€æœºåˆ†ä¸ºç‹¬ç«‹çš„ 4 ä¸ªçŠ¶æ€æœºï¼šè¯»è¯·æ±‚é€šé“ä¸€ä¸ªï¼Œè¯»å“åº”é€šé“ä¸€ä¸ªï¼Œå†™è¯·æ±‚å’Œå†™æ•°æ®å…±ç”¨ä¸€ä¸ªï¼Œå†™å“åº”ä¸€ä¸ª
5. ç±» SRAM ä»æ–¹ç«¯çš„è¾“å…¥ä¿¡å·ä¸ç”¨é”å­˜åå†ä½¿ç”¨
6. æ•°æ®ç«¯å‘æ¥çš„ç±» SRAM æ€»çº¿çš„è¯»è¯·æ±‚ä¼˜å…ˆçº§å›ºå®šé«˜äºå–æŒ‡ç«¯å‘æ¥çš„ç±» SRAM æ€»çº¿çš„è¯»è¯·æ±‚
   **loadä¼˜å…ˆçº§å¤§äºå–æŒ‡**
7. ç±» SRAM ä»ç«¯è¾“å‡ºçš„ addr\_ok å’Œ data\_ok ä¿¡å·è‹¥æ˜¯æ¥è‡ªç»„åˆé€»è¾‘ï¼Œé‚£ä¹ˆè¿™ä¸ªç»„åˆé€»è¾‘ä¸­ä¸è¦å¼•å…¥ AXI æ¥å£ä¸Šçš„ valid å’Œ ready ä¿¡å· ï¼Ÿ

### 4.4 è®¾è®¡å®ç°

```verilog
`include "mycpu.h"
module axi_bridge(
    //AXIä¿¡å· ä¸»æ–¹
    input         clk,
    input         aresetn,
    
    //è¯»è¯·æ±‚é€šé“
    output  [3:0]   arid,
    output  [31:0]  araddr,
    output  [7:0]   arlen,  //0
    output  [2:0]   arsize,
    output  [1:0]   arburst,//2b'01
    output  [1:0]   arlock, //0
    output  [3:0]   arcache,//0
    output  [2:0]   arprot, //0
    output          arvalid,
    input           arready,
    
    //è¯»å“åº”é€šé“
    input   [3:0]    rid,
    input   [31:0]   rdata,
    input   [1:0]    rresp,
    input            rlast,
    input            rvalid,
    output  reg      rready,
               
    //å†™è¯·æ±‚é€šé“              
    output  [3:0]   awid,
    output  [31:0]  awaddr,
    output  [7:0]   awlen,
    output  [2:0]   awsize,
    output  [1:0]   awburst,
    output  [1:0]   awlock,
    output  [3:0]   awcache,
    output  [2:0]   awprot,
    output  reg     awvalid,
    input           awready,
    
    //å†™æ•°æ®é€šé“
    output  [3:0]   wid,
    output  [31:0]  wdata,
    output  [3:0]   wstrb,
    output          wlast,
    output  reg     wvalid,
    input           wready,
    
    //å†™å“åº”é€šé“
    input   [3:0]   bid,
    input   [1:0]   bresp,
    input           bvalid,
    output  reg     bready,
  
    //ç±»SRAMä¿¡å· ä»æ–¹
    //inst
    input inst_sram_req,
    input inst_sram_wr,
    input [1:0] inst_sram_size,
    input [3:0] inst_sram_wstrb,
    input [31:0] inst_sram_addr,
    input [31:0] inst_sram_wdata,
    output  inst_sram_addr_ok,
    output  inst_sram_data_ok,
    output [31:0] inst_sram_rdata,

    //data
    input data_sram_req,
    input data_sram_wr,
    input [1:0] data_sram_size,
    input [3:0] data_sram_wstrb,
    input [31:0] data_sram_addr,
    input [31:0] data_sram_wdata,
    output  data_sram_addr_ok,
    output  data_sram_data_ok,
    output  [31:0] data_sram_rdata
);

//è¯»å†™é€šé“åˆ†ç¦» åˆ†ç¦»addr_okä¿¡å·
wire        rdata_sram_addr_ok;
wire        wdata_sram_addr_ok;

//è¯»è¯·æ±‚é€šé“ è§¦å‘å™¨Qç«¯ä¿¡å·
reg         arvalid_r; //è¾“å‡ºarvalid
reg [ 3:0]  arid_r;    //è¾“å‡ºarid æ ¹æ®aridåœ¨æŒ‡ä»¤addrã€sizeå’Œæ•°æ®addrã€sizeé€‰æ‹©ç”Ÿæˆarsizeã€araddr
reg [ 1:0]  inst_sram_size_r; //è¾“å‡ºè®¿æŒ‡ä»¤arsize
reg [31:0]  inst_sram_addr_r; //è¾“å‡ºè®¿æŒ‡ä»¤å­˜araddr
reg [ 1:0]  rdata_sram_size_r; //è¾“å‡ºè®¿æ•°æ®arsize
reg [31:0]  rdata_sram_addr_r; //è¾“å‡ºè®¿æŒ‡ä»¤å­˜araddr 

//è¯·æ±‚å®Œæ¯•ï¼Œç­‰å¾…è¯»å“åº”
reg         data_read_wait; 
reg         inst_read_wait;

reg [ 1:0]  wdata_sram_size_r; //è¾“å‡ºawsize
reg [ 3:0]  wdata_sram_wstrb_r;//è¾“å‡ºwstrb
reg [31:0]  wdata_sram_addr_r;//è¾“å‡ºawaddr

reg [31:0]  data_sram_wdata_r;//è¾“å‡ºawaddr

reg         wdata_received;//è¡¨ç¤ºä»è®¾å¤‡å·²æ”¶åˆ°å†™æ•°æ®ï¼Œwreadyå¯å†æœ‰æ•ˆ
reg         waddr_received;//è¡¨ç¤ºä»è®¾å¤‡å·²æ”¶åˆ°å†™åœ°å€ï¼Œawreadyå¯å†æœ‰æ•ˆ

//-----------------------------------è¯»è¯·æ±‚ç›¸å…³ä¿¡å·--------------------------------------//
//å› ä¸ºè¯»è¯·æ±‚æ—¶ï¼Œéœ€è¦ä¼ è¾“åœ°å€ç­‰ä¿¡æ¯ï¼Œæ‰€ä»¥éœ€è¦åœ¨reqå’Œaddr_okç¡®è®¤å¯¹åº”è¯·æ±‚å¹¶ä¸”ç±»SRAMæ€»çº¿ä»æ–¹æ”¶åˆ°åœ°å€åå†è®¾ç½®
//arid_r  ä¸åŒäº‹åŠ¡éƒ½ç”¨åŒä¸€ä¸ªidï¼Œå…ˆè¯·æ±‚çš„å…ˆå“åº”
always @(posedge clk)begin
    if(~aresetn)
        arid_r <= 4'b0000;
    else if(inst_sram_req & inst_sram_addr_ok)//è¯»æŒ‡ä»¤å­˜å‚¨è¯·æ±‚ä¸”è¯»æŒ‡ä»¤åœ°å€æˆåŠŸæ”¶åˆ°
        arid_r <= 4'b0000;
    else if(data_sram_req & rdata_sram_addr_ok)//è¯»æ•°æ®å­˜å‚¨è¯·æ±‚ä¸”è¯»æ•°æ®åœ°å€æˆåŠŸæ”¶åˆ°
        arid_r <= 4'b0001;
    else
        arid_r <= arid_r;//å­˜åœ¨é˜»å¡ã€ç­‰å¾…æ—¶çš„å¤„ç† æ˜¯ä¸æ˜¯å®ç°çš„ä¸æ”¹å˜å€¼ readyè¿˜æœªä¸º1æ—¶
end

//arsize_ré€‰æ‹©ä¹‹ä¸€ inst_sram_size_r
always @(posedge clk)begin
    if(~aresetn)
        inst_sram_size_r <= 2'b00;
    else if(inst_sram_req & inst_sram_addr_ok)
        inst_sram_size_r <= inst_sram_size;
    else
        inst_sram_size_r <= inst_sram_size_r;
end

//araddr_ré€‰æ‹©ä¹‹ä¸€ inst_sram_addr_r
always @(posedge clk)begin
    if(~aresetn)
        inst_sram_addr_r <= 32'b0;
    else if(inst_sram_req & inst_sram_addr_ok)
        inst_sram_addr_r <= inst_sram_addr;
    else
        inst_sram_addr_r <= inst_sram_addr_r;
end

//arsize_ré€‰æ‹©ä¹‹ä¸€ data_sram_size_r
always @(posedge clk)begin
    if(~aresetn)
        rdata_sram_size_r <= 2'b00;
    else if(data_sram_req & rdata_sram_addr_ok)
        rdata_sram_size_r <= data_sram_size;
    else
        rdata_sram_size_r <= rdata_sram_size_r;
end

//araddr_ré€‰æ‹©ä¹‹ä¸€ data_sram_addr_r
always @(posedge clk)begin
    if(~aresetn)
        rdata_sram_addr_r <= 32'b0;
    else if(data_sram_req & rdata_sram_addr_ok)
        rdata_sram_addr_r <= data_sram_addr;
    else
        rdata_sram_addr_r <= rdata_sram_addr_r;
end

//è¯»é€šé“æ­£åœ¨è¿›è¡Œè¯»æŒ‡ä»¤ï¼Œç­‰å¾…è¯»å“åº”
always @(posedge clk)begin
    if(~aresetn)
        inst_read_wait <= 1'b0;
    else if(arvalid & arready & arid_r == 4'b0000)
        inst_read_wait <= 1'b1;
    else if(rvalid & rready & rid == 4'b0000)//è¯»å“åº”å·²æ”¶åˆ°ï¼Œä¸”æ˜¯è¯»æŒ‡ä»¤
        inst_read_wait <= 1'b0;
end

//è¯»é€šé“æ­£åœ¨è¿›è¡Œè¯»æ•°æ®ï¼Œç­‰å¾…è¯»å“åº”
always @(posedge clk)begin
    if(~aresetn)
        data_read_wait <= 1'b0;
    else if(arvalid & arready & arid_r == 4'b0001)
        data_read_wait <= 1'b1;
    else if(rvalid & rready & rid == 4'b0001)//è¯»å“åº”å·²æ”¶åˆ°ï¼Œä¸”æ˜¯è¯»æ•°æ®
        data_read_wait <= 1'b0;
end

//arvalid
always @(posedge clk)begin
    if(~aresetn) //
        arvalid_r <= 1'b0;
    else if(arvalid & arready) //è¯»è¯·æ±‚æ”¶åˆ°å“åº”åˆ™å¤ä½
        arvalid_r <= 1'b0;
    else if(data_sram_req & rdata_sram_addr_ok | inst_sram_req & inst_sram_addr_ok) //è¿™é‡Œå¯ä»¥åŠ reqå§ï¼ŸåŠ reqæ›´å¥½ç†è§£
        arvalid_r <= 1'b1;
end

//AXIä¸»æ–¹ï¼Œé™¤äº†å¸¸é‡ï¼Œå…¶ä½™è¾“å‡ºä¿¡å·çš„å‡æ¥è‡ªè§¦å‘å™¨Qç«¯ 
//è¯»è¯·æ±‚é€šé“è¾“å‡ºä¿¡å·
assign arvalid = arvalid_r;
assign arid    = arid_r;
assign araddr  = (arid == 4'b0000) ? inst_sram_addr_r : rdata_sram_addr_r; 
//sizeæ˜¯3ä½ï¼Œ000->1B 001->2B 010->4B 011->8B 100->16B 101->32B 110->64B 111->128B
assign arsize  = (arid == 4'b0000) ? {1'b0, inst_sram_size_r} : {1'b0, rdata_sram_size_r};

assign arlen   = 8'b0;
assign arburst = 2'b01;
assign arlock  = 1'b0;
assign arcache = 1'b0;
assign arprot  = 1'b0;

assign rdata_sram_addr_ok = //è¿™ä¸ºä»€ä¹ˆä¸ç”¨data_read_wait loadä¼˜å…ˆçº§å¤§äºå–æŒ‡ è®¾ç½®äº†æœ‰å†™è¯·æ±‚å°±æš‚åœè¯» addr_okæ— æ•ˆ
        (~arvalid & data_sram_req == 1'b1 & data_sram_wr == 1'b0) ? 1'b1 : 1'b0; //è¯»é€šé“æ²¡æœ‰è¢«å ç”¨ä¸”è¿›è¡Œè¯»æ•°æ®RAMè¯·æ±‚
assign inst_sram_addr_ok = 
        (~inst_read_wait & ~arvalid & inst_sram_req == 1'b1 & inst_sram_wr == 1'b0 & 
            (data_sram_req == 1'b0 | data_sram_wr == 1'b1)) ? 1'b1 : 1'b0;//loadä¼˜å…ˆçº§å¤§äºå–æŒ‡ï¼Œéœ€è¦åˆ¤æ–­æ²¡æœ‰è¯»æ•°æ®è¯·æ±‚æˆ–è€…æœ‰ä½†æ˜¯æ˜¯å†™æ•°æ®

//-----------------------------------è¯»å“åº”ç›¸å…³ä¿¡å·-------------------------------------//
always @(posedge clk)begin
    if(~aresetn)
        rready <= 1'b0;
    else if(rready & rvalid)
        rready <= 1'b0;
    else if(inst_read_wait | data_read_wait) //ç­‰å¾…å‡†å¤‡æ¥æ”¶æ•°æ®
        rready <= 1'b1;
end

assign inst_sram_data_ok = (rvalid & rready & rid == 4'b0000);
assign data_sram_data_ok = (rvalid & rready & rid == 4'b0001) | bvalid & bready;//æ•°æ®å­˜å‚¨çš„data_okåŒ…æ‹¬è¯»æ•°æ®å­˜å‚¨å’Œå†™å“åº”

assign inst_sram_rdata   = (rvalid & rready & rid == 4'b0000) ? rdata : 32'b0;
assign data_sram_rdata   = (rvalid & rready & rid == 4'b0001) ? rdata : 32'b0;

assign data_sram_addr_ok = rdata_sram_addr_ok | wdata_sram_addr_ok;//è¯»å†™é€šé“åˆ†ç¦»

//-----------------------------------å†™è¯·æ±‚ç›¸å…³ä¿¡å·-------------------------------------//
//å¤„ç†å†™åœ°å€
always @(posedge clk)begin 
    if(~aresetn)
        wdata_sram_addr_r <= 32'b0;
    else if(data_sram_req & wdata_sram_addr_ok)
        wdata_sram_addr_r <= data_sram_addr;
    else
        wdata_sram_addr_r <= wdata_sram_addr_r;
end

//å¤„ç†å†™é•¿åº¦
always @(posedge clk)begin
    if(~aresetn)
        wdata_sram_size_r <= 2'b00;
    else if(data_sram_req & wdata_sram_addr_ok)
        wdata_sram_size_r <= data_sram_size;
    else
        wdata_sram_size_r <= wdata_sram_size_r;
end

//å¤„ç†å†™æ•°æ® å†™è¯·æ±‚å’Œå†™æ•°æ®åŒæ—¶è®¾ç½®
always @(posedge clk)begin
    if(~aresetn)
        data_sram_wdata_r <= 32'b0;
    else if(data_sram_req & wdata_sram_addr_ok)
        data_sram_wdata_r <= data_sram_wdata;
    else
        data_sram_wdata_r <= data_sram_wdata_r;
end

//å¤„ç†å†™é€‰é€š
always @(posedge clk)begin
    if(~aresetn)
        wdata_sram_wstrb_r <= 4'b0000;
    else if(data_sram_req & wdata_sram_addr_ok)
        wdata_sram_wstrb_r <= data_sram_wstrb;
    else
        wdata_sram_wstrb_r <= wdata_sram_wstrb_r;
end

//ä»è®¾å¤‡å·²æ”¶åˆ°å†™æ•°æ®
always @(posedge clk)begin
    if(!aresetn)
        wdata_received <= 1'b0;
    else if(wvalid & wready)
        wdata_received <= 1'b1;
    else if(wdata_received & waddr_received)
        wdata_received <= 1'b0;
end

//ä»è®¾å¤‡å·²æ”¶åˆ°å†™åœ°å€
always @(posedge clk)begin
    if(~aresetn)
        waddr_received <= 1'b0;
    else if(awvalid & awready)
        waddr_received <= 1'b1;
    else if(wdata_received & waddr_received) //å†™åœ°å€å’Œå†™æ•°æ®éƒ½è¢«ä»è®¾å¤‡æ”¶åˆ°åå†å¼€å§‹æ–°çš„å†™è¯·æ±‚
        waddr_received <= 1'b0;
end

//å†™è¯·æ±‚ validä¿¡å·çš„å‘é€
always @(posedge clk)begin
    if(!aresetn)
        awvalid <= 1'b0;
    else if(data_sram_req & data_sram_wr)//è¿™é‡Œæ˜¯ä¸æ˜¯å¯ä»¥æ›¿æ¢æˆreq&addr å¯ä»¥ ç»„åˆé€»è¾‘
        awvalid <= 1'b1;
    else if(awvalid & awready)
        awvalid <= 1'b0;
end

always @(posedge clk)begin
    if(~aresetn)
        wvalid <= 1'b0;
    else if(data_sram_req & data_sram_wr)//å†™è¯·æ±‚å’Œå†™æ•°æ®åŒæ—¶ç½®æœ‰æ•ˆ
        wvalid <= 1'b1;
    else if(wvalid & wready)
        wvalid <= 1'b0;
end

assign awaddr   = wdata_sram_addr_r;
assign awsize   = wdata_sram_size_r;
assign awid     = 4'b0001;
assign awlen    = 8'b0;
assign awburst  = 2'b01;
assign awlock   = 1'b0;
assign awcache  = 1'b0;
assign awprot   = 1'b0;

assign wdata    = data_sram_wdata_r;
assign wstrb    = wdata_sram_wstrb_r;
assign wid      = 4'b0001;
assign wlast    = 1'b1;  

assign wdata_sram_addr_ok = (data_sram_req == 1'b1 && data_sram_wr == 1'b1) ? 1'b1 : 1'b0;

//-------------------------------------å†™å“åº”ç›¸å…³ä¿¡å·-----------------------------------//
always @(posedge clk)begin
    if (!aresetn) begin
        bready <= 1'b0;
    end
    else if (wvalid & wready & awvalid & awready) begin
        bready <= 1'b1;
    end
    else if (wdata_received & awvalid & awready) begin
        bready <= 1'b1;
    end
    else if (wvalid & wready & waddr_received) begin
        bready <= 1'b1;
    end
    else if (bvalid & bready) begin
        bready <= 1'b0;
    end
end

endmodule
```

> ä»¿çœŸæ—¶é€šè¿‡è®¾ç½®confreg.vçš„RANDOM\_SEEDæ¥è¾¾åˆ°éšæœºå»¶æ—¶çš„æ•ˆæœ
>
> ![](image/image_Le-fxaYHdL.png)

### 4.5 ä¼˜åŒ–â€”â€”è¿˜æ²¡åš

è®°å½•å†™ç›¸å…³ä¿¡æ¯ï¼Œå†åˆ¤æ–­é˜»å¡ï¼›ä¹Ÿæ²¡æœ‰è®¾ç½®ç¼“å­˜

è®°å½•å†™ç›¸å…³ä¿¡æ¯ä¹Ÿéœ€è¦è®¾ç½®ç¼“å­˜å³éœ€è¦è¯»ç¼“å­˜å’Œå†™ç¼“å­˜

ç¼“å­˜çš„è®¾ç½®æ–¹æ³•å¯ä»¥å‚ç…§ç±»SRAMæ€»çº¿çš„wrap ç±»SRAMæ€»çº¿æ¥å£ï¼Œæ­¤æ—¶çš„addr\_okå’Œdata\_okéœ€è¦ç»“åˆç¼“å­˜é˜Ÿåˆ—æ¥åˆ¤æ–­

[^æ³¨é‡Š1]: CPU

[^æ³¨é‡Š2]: ä»è®¾å¤‡

[^æ³¨é‡Š3]: ä¿æŒæŒ‡ä»¤åˆ°ç¼“å­˜ä¹Ÿéœ€è¦æš‚åœpreIFçš„å–æŒ‡è¯·æ±‚ï¼Œå¦åˆ™æ–°çš„è¢«æ¥æ”¶çš„è¯·æ±‚åˆä¼šè¿”å›æ–°çš„æŒ‡ä»¤ç ï¼Œå°†è¦†ç›–æ‰ç¼“å­˜ä¸­ä¿å­˜çš„æŒ‡ä»¤ï¼›å½“è¿™ä¸ªæŒ‡ä»¤ç¼“å­˜æœ‰æ•ˆæ—¶ï¼ŒæŒ‡ä»¤ä» pre-IF çº§è¿›å…¥ IF çº§åï¼Œå°†æ— éœ€å†ç­‰å¾…ç±»SRAMæ¥å£è¿”å›çš„ çš„ data\_okï¼Œè€Œæ˜¯ç›´æ¥ä»æŒ‡ä»¤ç¼“å­˜ä¸­æ‹¿æŒ‡ä»¤

[^æ³¨é‡Š4]: å¤šè¿”å›çš„addr\_okæ€ä¹ˆå¼„

[^æ³¨é‡Š5]: å…¶ä»–è®¾è®¡æƒ…å†µéœ€è¦è‡ªå·±ç»“åˆè¿™ä¸¤ç§æ–¹æ³•ä¿®æ”¹

[^æ³¨é‡Š6]: å¯èƒ½æœ‰çš„è¯»è€…ä¼šè®¤ä¸ºï¼šå¦‚æœæˆ‘çš„è®¾è®¡ä¸­ pre-IF çº§å‘å–æŒ‡è¯·æ±‚æ—¶å·²ç»çœ‹äº† IF çº§åé¦ˆçš„ allowin æ˜¯å¦ä¸º 1 äº†ï¼Œé‚£ä¹ˆå½“è¯‘ç çº§çš„è½¬ç§»æŒ‡ä»¤è®¡ç®—æœªå®Œæˆæ—¶ï¼Œå®ƒå°±ä¼šå µä½æµæ°´çº¿ï¼Œç„¶å IF çº§ä¹Ÿè¢«å µç€ï¼Œ IF çº§ä¼ é€’åˆ° pre-IF çº§çš„ allowin å°±æ˜¯ 0ï¼Œé‚£ä¹ˆ pre-IF ä¹Ÿå°±ä¸ä¼šå‘å‡ºè¯·æ±‚äº†ï¼Œä¹Ÿå°±ä¸ä¼šå‡ºç°ä¸Šé¢ åˆ†æçš„å‡ºé”™æƒ…å†µï¼Œä¸éœ€è¦é¢å¤–å¤„ç†çš„ã€‚è¿™é‡Œçš„åˆ†æä¹ä¸€çœ‹ä¸Šå»å¥½åƒæŒºæœ‰é“ç†ï¼Œä½†æ˜¯å…¶æ¨å¯¼è¿‡ç¨‹ä¸­ å¼•å…¥äº†ä¸€ä¸ªé”™è¯¯çš„éšå«æ¡ä»¶ï¼Œå³ â€œå®ƒå°±ä¼šå µä½æµæ°´çº¿ï¼Œç„¶å IF çº§ä¹Ÿè¢«å µç€â€ è¿™å¥è¯æ˜¯æœ‰é—®é¢˜çš„ã€‚ å½“æŒ‡ä»¤ RAM ä¸å†æ˜¯å›ºå®šä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸè¿”å›æ•°æ®è€Œæ˜¯å¯èƒ½éšæœºå¤šä¸ªæ—¶é’Ÿè¿”å›æ•°æ®æ—¶ï¼ŒID çº§å­˜åœ¨ æŒ‡ä»¤çš„æ—¶å€™ï¼ŒIF çº§æœªå¿…å­˜åœ¨æŒ‡ä»¤ã€‚æ‰€ä»¥ï¼Œè½¬ç§»æŒ‡ä»¤å› ä¸ºè®¡ç®—æœªå®Œæˆåœ¨ ID çº§ç­‰å¾…æ—¶ï¼Œpre-IF çº§çœ‹ åˆ° IF çº§åé¦ˆçš„ allowin ä»ç„¶å¯èƒ½ä¸º 1ã€‚æ€»çº¿æ¥å£å¼•å…¥çš„å†…å­˜è®¿é—®å»¶è¿Ÿæ—¶é’Ÿå‘¨æœŸæ•°éšæœºåŒ–ï¼Œæ˜¯åˆå­¦ è€…æœ€å®¹æ˜“å¿½è§†çš„è®¾è®¡éš¾ç‚¹ï¼Œä¸€å®šè¦æ—¶åˆ»æé˜²

[^æ³¨é‡Š7]: åŸæ¥ä½¿ç”¨çš„æ¡ä»¶æ˜¯ if\_valid&(\~if\_ready\_go | \~id\_allowin)

[^æ³¨é‡Š8]: storeçš„å†™æ˜¯åœ¨æ— å¼‚å¸¸æ—¶è¿›è¡Œï¼Œæœ‰å¼‚å¸¸æ—¶å†™å‘½ä»¤æ— æ•ˆ

[^æ³¨é‡Š9]: åŸå› æ˜¯

[^æ³¨é‡Š10]: å› ä¸ºè¿™ä¸ªè¿‡ç¨‹å¯èƒ½æ¶‰åŠå¾ˆå¤šä¿¡å·ä¸”åœ¨æ€»çº¿ä¸ŠæŒç»­å¤šä¸ªå‘¨æœŸï¼Œä¸”å¯¹äºé«˜æ€§èƒ½ç‰‡ä¸Šæ€»çº¿è€Œè¨€ï¼ŒåŒä¸€æ—¶åˆ»ä¸Šè¿˜å¯èƒ½è¿›è¡Œç€å¤šä¸ªä¸åŒçš„è¯»å†™æ“ä½œ

[^æ³¨é‡Š11]: å‡è®¾æ€»çº¿ä¸Šè¯»æ•°æ®çš„å®½åº¦æ˜¯ 32 æ¯”ç‰¹ï¼Œé‚£ ä¹ˆå½“ä½ æƒ³è¯» 512 æ¯”ç‰¹åœ°å€è¿ç»­çš„æ•°æ®æ—¶ï¼Œè¯¥æ€ä¹ˆå‘é€æ€»çº¿è¯·æ±‚å‘¢ï¼Ÿä¸€ç§æ–¹å¼æ˜¯ï¼Œå‘é€ 16 æ¬¡ 4 å­— èŠ‚çš„è¯»åœ°å€è¯·æ±‚ï¼Œè¿™æ„å‘³ç€è¦åœ¨è¯»åœ°å€é€šé“è¿›è¡Œ 16 æ¬¡æ¡æ‰‹ã€‚å¦‚æœå› ä¸ºæ—¶åºçš„åŸå› ï¼Œä¸»ã€ä»æ–¹ä¹‹é—´ çš„æ¡æ‰‹ä¸å¯èƒ½é€æ‹è¿ç»­å®Œæˆï¼Œé‚£ä¹ˆè¿™ 16 æ¬¡æ¡æ‰‹å°±ä¼šè€—è´¹å¾ˆå¤šæ—¶é—´
