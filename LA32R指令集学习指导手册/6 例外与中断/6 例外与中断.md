# 6 例外与中断

## 目录

-   [6.1中断](#61中断)
    -   [6.1.1中断类型](#611中断类型)
    -   [6.1.2中断优先级](#612中断优先级)
    -   [6.1.3 处理器响应中断处理过程](#613-处理器响应中断处理过程)
    -   [6.1.4中断入口](#614中断入口)
-   [6.2异常](#62异常)
    -   [6.2.1异常入口](#621异常入口)
    -   [6.2.2异常优先级](#622异常优先级)
    -   [6.2.3异常硬件通用处理过程](#623异常硬件通用处理过程)
-   [6.3复位](#63复位)

## 6.1中断

### 6.1.1中断类型

LA32R的中断采用线中断[^注释1]的形式，所有的线中断都是电平中断、高有效

每个处理器核内部可记录12个线中断，分别是1个核间中断IPI、一个定时器中断TI、8个硬中断HWI0\~HWI7、2个软中断SWI0\~SWI1

IPI的中断输入来自于核外的中断控制器，其被处理器核采样记录在CSR.ESTAT.IS\[12]

TI的中断输入来自于核内的恒定频率定时器，当恒定频率定时器倒计时为全0时，该中断被置起，置起后的定时器中断被处理器核采样记录在 CSR.ESTAT.IS\[11]位。清除定时器中断需要通过软件向CSR.TICLR 寄存器的 TI 位写 1 来完成

硬中断的中断源来自于处理器核外部，其直接来源通常是核外的中断控制器。8 个硬中断HWI\[7:0]被处理器核采样记录在 CSR.ESTAT.IS\[9:2]位

软中断的中断源来自于处理器核内部，软件通过 CSR 指令对 CSR.ESTAT.IS\[1:0]写1 则置起软中断，写0 则清除软中断

中断在CSR.ESTAT.IS域中记录的位置的索引值也被称为中断号；SWI0中断号为0……IPI中断号为12

### 6.1.2中断优先级

同一时刻的多个中断的响应采用固定优先级仲裁机制。中断号越大优先级越高

### 6.1.3 处理器响应中断处理过程

各中断源发来的中断信号被处理器采样至 CSR.ESTAT.IS 域中，CSR.ESTAT.IS[^注释2]域值和CSR.ECFG.LIE[^注释3]值相与得到中断请求向量int\_vec，若CSR.CRMD.IE=1且int\_vec不全为0，那么处理器认为就需要有响应的中断[^注释4]，于是从执行的指令流中挑选出一条指令，将其标记上一种特殊的异常——中断异常

然后按照普通异常的处理过程处理这个中断异常6.2.3异常硬件通用处理过程

### 6.1.4中断入口

中断被处理器硬件标记到指令上以后就被当作一种特殊的异常进行处理，因此中断入口的计算遵循普通异常入口的计算规则：6.2.1异常入口

## 6.2异常

### 6.2.1异常入口

TLB重填异常的入口来自于CSR.TLBRENTRY

除TLB重填异常之外的所有普通异常入口相同，都来自于CSR.EENTRY，此时需要软件通过CSR.ESTA.Ecode和CSR.ESTA.IS域信息来判断具体的异常类型

### 6.2.2异常优先级

异常优先级遵循两个基本原则：

1.  中断优先级高于异常
2.  对于异常，取指阶段检测出的优先级>译码阶段检测出的优先级>执行阶段检测出的优先级

    取指阶段检测出的异常：ADEF优先级最高，取指TLB相关异常优先级次之

    译码阶段检测出的异常彼此互斥

    执行阶段仅访存指令可同时产生多种异常，其优先级从高到低依次是：ALE>TLB相关异常

### 6.2.3异常硬件通用处理过程

当触发异常时，处理器硬件会进行如下操作：

1.  将CSR.CRMD的PLV、IE分别存放到CSR.PRMD的PPLV、PIE中，然后将CSR.CRMD的PLV、IE置0
2.  将触发异常的指令的PC值记录到CSR.ERA中
3.  跳转到异常入口处取指

当软件执行ERTN指令从异常执行返回时，处理器硬件会完成如下操作：

1.  将CSR.PRMD的PPLV、PIE恢复到CSR.CRMD的PLV、IE中
2.  跳转到CSR.ERA所记录的地址处取指

针对上述硬件实现，软件在例外处理过程的中途如果需要开启中断，需要保存CSR.PRMD中的PPLV、PIE 等信息，并在例外返回前，将所保存的信息恢复到 CSR.PRMD 中

## 6.3复位

复位将重新确定处理器核中的所有逻辑，将电路置于确定的状态

复位后处理器状态的定义如下：

1.  复位后第一条指令的PC是0x1c000000[^注释5]，由于复位撤销后的MMU一定处于直接地址翻译模式，因此复位后所取的第一条指令的物理地址也是0x1c000000
2.  复位撤销后，CSR.CRMD的PLV=0，IE=0，DA=1，PG=0，DATF=0，DATM=0
3.  复位撤销后，CSR.EUEN的FPE=0
4.  复位撤销后，CSR.ECFG的LIE\[12:0]=13'b0
5.  复位撤销后，CSR.ESTAT中的IS\[1:0]=2'b0
6.  复位撤销后，CSR.TCFG中的En=0
7.  复位撤销后，CSR.LLBCTL中的KLO=0
8.  所有实现的CSR.DMW中的PLV0、PLV3均为0

除了上述内容外，复位撤销后其余软件可见的寄存器的值都是不确定的，软件在使用前都要将其状态置于确定状态

TLB 和 Cache 在复位期间是否进行硬件复位由实现决定，若未实现则需要进行软件复位

[^注释1]: 还不太懂

[^注释2]: 是否有中断源置位中断请求

[^注释3]: 中断屏蔽向量

[^注释4]: 然后从int\_vec倒序按照优先级响应中断

[^注释5]: 所以复位信号会将PC置位0x1bffffff
